<!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Transitional//EN" "http://www.w3.org/TR/xhtml1/DTD/xhtml1-transitional.dtd">
<html xmlns="http://www.w3.org/1999/xhtml">
<head>
  <meta http-equiv="Content-Type" content="text/html; charset=utf-8" />
  <meta http-equiv="Content-Style-Type" content="text/css" />
  <meta name="generator" content="pandoc" />
  <title></title>
  <style type="text/css">code{white-space: pre;}</style>
  <style type="text/css">
table.sourceCode, tr.sourceCode, td.lineNumbers, td.sourceCode {
  margin: 0; padding: 0; vertical-align: baseline; border: none; }
table.sourceCode { width: 100%; line-height: 100%; }
td.lineNumbers { text-align: right; padding-right: 4px; padding-left: 4px; color: #aaaaaa; border-right: 1px solid #aaaaaa; }
td.sourceCode { padding-left: 5px; }
code > span.kw { color: #007020; font-weight: bold; }
code > span.dt { color: #902000; }
code > span.dv { color: #40a070; }
code > span.bn { color: #40a070; }
code > span.fl { color: #40a070; }
code > span.ch { color: #4070a0; }
code > span.st { color: #4070a0; }
code > span.co { color: #60a0b0; font-style: italic; }
code > span.ot { color: #007020; }
code > span.al { color: #ff0000; font-weight: bold; }
code > span.fu { color: #06287e; }
code > span.er { color: #ff0000; font-weight: bold; }
  </style>
  <link rel="stylesheet" href="/home/astral/Google Drive/Shared/Raporty i prezentacje/TDDEBook/temp_manuscript/Stylesheets/Global.css" type="text/css" />
</head>
<body>
<div id="TOC">
<ul>
<li><a href="#dedications">Dedications</a></li>
<li><a href="#thanks">Thanks!</a></li>
<li><a href="#part-1-justthe-basics">Part 1: Just the basics</a></li>
<li><a href="#motivation-the-first-step-to-learning-tdd">Motivation – the first step to learning TDD</a><ul>
<li><a href="#how-tdd-feels-like">How TDD feels like</a></li>
</ul></li>
<li><a href="#the-three-most-essential-tools">The three most essential tools</a><ul>
<li><a href="#our-shiny-tools">Our shiny tools</a></li>
</ul></li>
<li><a href="#it-is-not-atest">It is not a test</a><ul>
<li><a href="#when-atest-becomes-something-else">When a test becomes something else</a></li>
<li><a href="#taking-it-to-the-software-development-land">Taking it to the software development land</a></li>
<li><a href="#a-specification-instead-of-atest-suite">A Specification instead of a Test Suite</a></li>
<li><a href="#what-is-the-point-of-writing-specification-after-the-fact">What is the point of writing specification after the fact?</a></li>
<li><a href="#the-benefit-of-failure">The benefit of failure</a></li>
</ul></li>
<li><a href="#practicing-what-we-have-already-learned">Practicing what we have already learned</a><ul>
<li><a href="#let-me-tell-you-astory">Let me tell you a story</a></li>
<li><a href="#act-1-the-car">Act 1: The Car</a></li>
<li><a href="#act-2-the-customer">Act 2: The Customer</a></li>
<li><a href="#act-3-test-driven-development">Act 3: Test-Driven Development</a></li>
<li><a href="#epilogue">Epilogue</a></li>
</ul></li>
<li><a href="#sorting-out-the-bits">Sorting Out The Bits</a></li>
<li><a href="#how-to-start">How to start?</a><ul>
<li><a href="#start-with-agood-name">Start with a good name</a></li>
<li><a href="#start-by-filling-the-given-when-then-structure-with-the-obvious">Start by filling the GIVEN-WHEN-THEN structure with the obvious</a></li>
<li><a href="#start-from-the-end">Start from the end</a></li>
<li><a href="#start-by-invoking-amethod-when-you-have-one">Start by invoking a method when you have one</a></li>
<li><a href="#summary-1">Summary</a></li>
</ul></li>
<li><a href="#how-is-tdd-about-analysis-and-what-does-given-when-then-mean">How is TDD about analysis and what does “GIVEN-WHEN-THEN” mean?</a><ul>
<li><a href="#is-there-really-acommonality-between-analysis-and-tdd">Is there really a commonality between analysis and TDD?</a></li>
<li><a href="#gherkin">Gherkin</a></li>
<li><a href="#todo-list-again">TODO list… again!</a></li>
</ul></li>
<li><a href="#developing-a-tdd-style-and-constrained-non-determinism">Developing a TDD style and Constrained Non-Determinism</a><ul>
<li><a href="#a-style">A style?</a></li>
<li><a href="#principle-tests-as-specification">Principle: Tests As Specification</a></li>
<li><a href="#first-technique-anonymous-input">First technique: Anonymous Input</a></li>
<li><a href="#second-technique-derived-values">Second technique: Derived Values</a></li>
<li><a href="#third-technique-distinct-generated-values">Third technique: Distinct Generated Values</a></li>
<li><a href="#fourth-technique-constant-specification">Fourth technique: Constant Specification</a></li>
<li><a href="#summary-of-the-example">Summary of the example</a></li>
<li><a href="#constrained-non-determinism">Constrained non-determinism</a></li>
<li><a href="#summary-2">Summary</a></li>
</ul></li>
<li><a href="#what-is-the-scope-of-aunit-level-statement-in-tdd">What is the scope of a unit-level Statement in TDD?</a></li>
<li><a href="#specifying-boundaries-and-conditions">Specifying Boundaries and Conditions</a><ul>
<li><a href="#sometimes-anonymous-value-is-not-enough">Sometimes, anonymous value is not enough</a></li>
<li><a href="#exceptions-to-the-rule">Exceptions to the rule</a></li>
<li><a href="#rules-valid-within-boundaries">Rules valid within boundaries</a></li>
<li><a href="#combination-of-boundaries-ranges">Combination of boundaries – ranges</a></li>
<li><a href="#summary-3">Summary</a></li>
</ul></li>
<li><a href="#triangulation">Triangulation</a><ul>
<li><a href="#type-the-obvious-implementation">Type The Obvious Implementation</a></li>
<li><a href="#fake-it-til-you-make-it">Fake It (‘Til You Make It)</a></li>
<li><a href="#triangulation-1">Triangulation</a></li>
<li><a href="#summary-4">Summary</a></li>
</ul></li>
<li><a href="#part-2-test-driven-development-in-object-oriented-world">Part 2: Test-Driven Development in Object Oriented World</a></li>
<li><a href="#on-objects-composability">On Objects Composability</a><ul>
<li><a href="#another-task-for-johnny-and-benjamin">Another task for Johnny and Benjamin</a></li>
<li><a href="#a-quick-retrospective">A Quick Retrospective</a></li>
</ul></li>
<li><a href="#telling-not-asking">Telling, not asking</a><ul>
<li><a href="#contractors">Contractors</a></li>
<li><a href="#a-quick-retrospective-1">A Quick Retrospective</a></li>
</ul></li>
<li><a href="#the-need-for-mock-objects">The need for mock objects</a><ul>
<li><a href="#composability-again">Composability… again!</a></li>
</ul></li>
<li><a href="#why-do-we-need-composability">Why do we need composability?</a><ul>
<li><a href="#pre-object-oriented-approaches">Pre-object oriented approaches</a></li>
<li><a href="#object-oriented-programming-to-the-rescue">Object oriented programming to the rescue!</a></li>
<li><a href="#the-power-of-composition">The power of composition</a></li>
<li><a href="#summary-are-you-still-with-me">Summary – are you still with me?</a></li>
</ul></li>
<li><a href="#web-messages-and-protocols">Web, messages and protocols</a><ul>
<li><a href="#so-again-what-does-it-mean-to-compose-objects">So, again, what does it mean to compose objects?</a></li>
<li><a href="#alarms-again">Alarms, again!</a></li>
<li><a href="#summary-5">Summary</a></li>
</ul></li>
<li><a href="#composing-a-web-of-objects">Composing a web of objects</a><ul>
<li><a href="#three-important-questions">Three important questions</a></li>
<li><a href="#a-preview">A preview</a></li>
<li><a href="#when-are-objects-composed">When are objects composed?</a></li>
<li><a href="#how-does-a-sender-obtain-a-reference-to-a-recipient-i.e.how-connections-are-made">How does a sender obtain a reference to a recipient (i.e. how connections are made)?</a></li>
<li><a href="#where-are-objects-composed">Where are objects composed?</a></li>
<li><a href="#summary-6">Summary</a></li>
</ul></li>
<li><a href="#interfaces">Interfaces</a><ul>
<li><a href="#classes-vs-interfaces">Classes vs interfaces</a></li>
<li><a href="#eventscallbacks-vs-interfaces-few-words-on-roles">Events/callbacks vs interfaces – few words on roles</a></li>
<li><a href="#small-interfaces">Small interfaces</a></li>
</ul></li>
<li><a href="#protocols">Protocols</a><ul>
<li><a href="#protocols-exist">Protocols exist</a></li>
<li><a href="#protocol-stability">Protocol stability</a></li>
<li><a href="#craft-messages-to-reflect-senders-intention">Craft messages to reflect sender’s intention</a></li>
<li><a href="#model-interactions-after-the-problem-domain">Model interactions after the problem domain</a></li>
<li><a href="#message-recipients-should-be-told-what-to-do-instead-of-being-asked-for-information">Message recipients should be told what to do, instead of being asked for information</a></li>
<li><a href="#most-of-the-getters-should-be-removed-return-values-should-be-avoided">Most of the getters should be removed, return values should be avoided</a></li>
<li><a href="#protocols-should-be-small-and-abstract">Protocols should be small and abstract</a></li>
<li><a href="#summary-7">Summary</a></li>
</ul></li>
<li><a href="#classes">Classes</a><ul>
<li><a href="#single-responsibility-principle">Single Responsibility Principle</a></li>
<li><a href="#static-recipients">Static recipients</a></li>
<li><a href="#summary-8">Summary</a></li>
</ul></li>
<li><a href="#this-is-all-i-have-for-now.-what-follows-is-raw-unordered-material-thats-not-yet-ready-to-be-consumed-as-part-of-this-tutorial">THIS IS ALL I HAVE FOR NOW. WHAT FOLLOWS IS RAW, UNORDERED MATERIAL THAT’S NOT YET READY TO BE CONSUMED AS PART OF THIS TUTORIAL</a></li>
<li><a href="#object-composition-as-a-language">Object Composition as a Language</a><ul>
<li><a href="#more-readable-composition-root">More readable composition root</a></li>
<li><a href="#refactoring-for-readability">Refactoring for readability</a></li>
<li><a href="#composition-as-a-language">Composition as a language</a></li>
<li><a href="#the-significance-of-higher-level-language">The significance of higher-level language</a></li>
<li><a href="#some-advice">Some advice</a></li>
<li><a href="#summary-9">Summary</a></li>
</ul></li>
<li><a href="#value-objects">Value Objects</a><ul>
<li><a href="#example-problem">Example problem</a></li>
</ul></li>
<li><a href="#mock-objects">Mock Objects</a></li>
</ul>
</div>
<div class="figure">
<img src="images/homemade_title_page.png" />

</div>
<h1 id="dedications">Dedications</h1>
<p><em>Ad Deum qui laetificat iuventutem meam.</em></p>
<p><em>To my beloved wife Monika.</em></p>
<h1 id="thanks">Thanks!</h1>
<p>I would like to thank the following people (listed alphabetically by name) for valuable feedback, suggestions, typo fixes and other contributions:</p>
<ul>
<li>Brad Appleton</li>
<li>Daniel Żołopa (cover image)</li>
<li>Donghyun Lee</li>
<li>Michael Whelan</li>
<li>Reuven Yagel</li>
<li>Rémi Goyard</li>
<li>Sławomir Pająk</li>
<li>Wiktor Żołnowski</li>
</ul>
<p>This book is not original at all. It presents various topics that others invented and I just picked up. Thus, I would also like to thank my mentors and authorities on test-driven development and object oriented design that I gained all my knowledge from (listed alphabetically by name):</p>
<ul>
<li>Amir Kolsky</li>
<li>Dan North</li>
<li>Ken Pugh</li>
<li>Kent Beck</li>
<li>Mark Seemann</li>
<li>Martin Fowler</li>
<li>Nat Pryce</li>
<li>Philip Schwarz</li>
<li>Robert C. Martin</li>
<li>Scott Bain</li>
<li>Steve Freeman</li>
</ul>
<h1 id="part-1-justthe-basics">Part 1: Just the basics</h1>
<p>This is a part where I introduce the basic TDD philosophy and practices (as well as some advanced ones) without going much into object orientation and how to do TDD for systems where multiple objects collaborate together (which is a topic of Part 2).</p>
<p>So, for the most chapters of this part, I will be giving you examples where single object (plus some small ones like strings etc.) is exercised to slowly introduce some concepts in an easy to grasp manner.</p>
<p>After reading part 1, you will be able to quite effectively develop classes that have no dependencies on other classes (and on operating system resources).</p>
<h1 id="motivation-the-first-step-to-learning-tdd">Motivation – the first step to learning TDD</h1>
<p>So, you want to learn TDD, huh? First off, let me ask a question ‘why?’.</p>
<p>I want to tell you a story – few years ago, I had an apprentice, who wanted to learn TDD as well. We started working on a small project together for him to grasp the necessary skills through practice, with me sitting next to him, providing guidance. He showed up three, four times, then he resigned, having ‘more urgent things’ and ‘no time’. Since then, he did not progress in TDD at all. Did he really want to learn?</p>
<p>See, sometimes people don’t really want to learn something or don’t want so much as to dedicate the necessary time and resources to this. Sometimes they just think they need to do it for whatever reasons – getting promotion at work, gaining a certificate, add something to CV or just ‘stay up to date’ with recent hypes, one of them being Test-Driven Development.</p>
<p>Others want to learn TDD for reasons they themselves made up. Knowing that TDD is valued and praised by others, they draw conclusions that it has to be good. Why is that so? Err… maybe… “the code will be more tested”? Or… ekhem… “the network of tests will be tighter”? And why do Test-First? Well… hmm… “to ensure tests are written for everything”? While these statements might be partially true, they don’t even touch the essence of the “why” of TDD, and quickly turn into something like: “I don’t really need TDD, because I need tests that give me confidence on broader scope” or: “Why do I need unit tests when I already have integration tests, smoke tests, sanity tests, exploration tests…?”. Then TDD gets abandoned, before actually ever being achieved in the first place.</p>
<p>You need to be highly motivated on this one. If you are not, hey, I heard the new series of Game Of Thrones is on TV, why don’t you check it out instead? Ok, I’m just teasing, however, as some say, TDD is “easy to learn, hard to master” (don’t actually know who said it first, I searched the web and found it in few places where none of the writers gave credit to anyone else for it, so I decided just to mention that I’m not the one that coined this description) , so without some guts to move on, it will be hard.</p>
<h2 id="how-tdd-feels-like">How TDD feels like</h2>
<p>Me and my brother liked to play video games in our childhood – one of the most memorable being Tekken 3 – a Japanese tournament beat’em up for Sony Playstation. To finish the game with all warriors, unlock all hidden characters, mini-games etc. took about a day. Some could say the game had nothing to offer since then. Why then did we spend over a year on it?</p>
<div class="figure">
<img src="images/Tekken3-gray.png" alt="Tekken3" />
<p class="caption">Tekken3</p>
</div>
<p>It is because each fighter in the game had a lot of combos, kicks and punches that could be mixed in a variety of ways. Some were only usable in some situations, others were something you could throw at your opponent almost anytime without a big risk of being exposed to counterattacks. You could side-step to evade enemy’s attacks and, most of all, you could kick another fighter up in the air where they could not block your attacks and you were able to land some nice attacks on them before they fell down. These in-the-air techniques were called “juggles”. There were magazines that published lists of new possible juggles each month and the hype has stayed in the gaming community for well over a year.</p>
<p>Yes, Tekken was easy to learn – you could put one hour into training the core moves of a character and then be able to “use them”, but what made you a great fighter was the experience and knowledge on which techniques were risky or not, which ones could be used in which situations, which ones, if used one after another, gave the opponent little chance to counterattack etc. No wonder that soon, many tournaments sprang, where players could clash for glory, fame and rewards. Even today, you can watch some of the matches on youtube.</p>
<p>TDD is like Tekken. You have probably heard the mantra “red-green-refactor” or the general advice “write your test first, then the code”, maybe you even did some experiments on your own where you were trying to implement a bubble-sort algorithm or other simple stuff by starting with a test. But that is all like practicing Tekken by trying out each move on its own on dummy opponent, without the context of real-world issues that make the fight really challenging. And while I think such exercises are useful (especially at the beginning), you need to understand the bigger picture as well.</p>
<p>Some people I talk with about TDD sum up what I say to them as: “That is really demotivating – there are so many things I have to watch out for that it makes me never want to start!”. Easy, don’t panic – remember the first time you tried to ride a bike – you must have been really far back then from knowing traffic regulations and following road signs, but that did not really keep you away, did it? I myself found TDD very exciting. Some guys my age already think they know all about coding, are bored with it and cannot wait until they move to management or requirements or business analysis, but hey! I have a new technique that makes my coding career challenging again! And it’s not something I can use only when I pay to Microsoft or Oracle or anybody else – it’s quite portable, making me a better developer overall!</p>
<h1 id="the-three-most-essential-tools">The three most essential tools</h1>
<p>Ever watched Karate Kid, either the old version or the new one? The thing they have in common is that when the kid starts learning Karate (or Kung-Fu) from his master, he is given a basic, repetitive task (like taking off a jacket, and putting it on again), not knowing yet where it would lead him. Or look at the first Rocky film (yeah, the one starring Sylvester Stallone), where Rocky was chasing a chicken in order to train agility.</p>
<p>When I first tried to learn how to play guitar, I found two advices on the web: the first was to start by mastering a single, difficult song. The second was to play with a single string, learn how to make it sound in different ways and try to play some melodies by ear just with this one string. Do I have to tell you that the second advice worked better?</p>
<p>Honestly, I could dive right into the core techniques of TDD, but this would be like putting you on a ring with a demanding opponent – you would most probably be discouraged before gaining the necessary skills. So, instead of explaining how to win a race, in this chapter we will take a look at what shiny cars we will be driving.</p>
<p>In other words, I will give you a brief tour of the three most essential tools we will be using throughout this book.</p>
<h2 id="our-shiny-tools">Our shiny tools</h2>
<h3 id="a-disclaimer">A disclaimer</h3>
<p>In this chapter, I will oversimplify some things just to get you up and running without getting into the philosophy of TDD yet (think: physics lessons in primary school). Do not worry about it :-), we will fix that in the coming chapters!</p>
<h3 id="xunit-framework">xUnit framework</h3>
<p>The first and most essential tool we are going to use is an xUnit framework.</p>
<p>Let’s assume that our application looks like this:</p>
<pre class="sourceCode java"><code class="sourceCode java"><span class="kw">public</span> <span class="dt">static</span> <span class="dt">void</span> <span class="fu">Main</span>(string[] args) 
{
  <span class="kw">try</span>
  {
    <span class="dt">int</span> firstNumber = Int32.<span class="fu">Parse</span>(args[<span class="dv">0</span>]);
    <span class="dt">int</span> secondNumber = Int32.<span class="fu">Parse</span>(args[<span class="dv">1</span>]);

    var result = 
      <span class="kw">new</span> <span class="fu">Multiplication</span>(firstNumber, secondNumber).<span class="fu">Perform</span>();

    Console.<span class="fu">WriteLine</span>(<span class="st">&quot;Result is: &quot;</span> + result);
  }
  <span class="kw">catch</span>(Exception e)
  {
    Console.<span class="fu">WriteLine</span>(<span class="st">&quot;Addition failed because of: &quot;</span> + e);
  } 
}</code></pre>
<p>Now, let’s assume we want to check whether it produces correct results. The most obvious way would be to invoke the application from command line with some exemplary arguments, check the output to the console and compare it with what we expect to see. Such session could look like this:</p>
<pre class="text"><code>C:\MultiplicationApp\MultiplicationApp.exe 3 7
21
C:\MultiplicationApp\</code></pre>
<p>As you can see, the application produced a result of 21 for multiplication of 7 by 3. This is correct, so we assume the test is passed. But what if we produced an application that additionally does addition, subtraction, division, calculus etc.? How many times would we have to invoke the application to make sure every operation works correct?</p>
<p>But wait, we are programmers, right? So we can write programs that can do this for us! In order to do this, we will create a second application that will also use the Multiplication class, but in a little different way:</p>
<pre class="sourceCode java"><code class="sourceCode java"><span class="kw">public</span> <span class="dt">static</span> <span class="dt">void</span> <span class="fu">Main</span>(string[] args) 
{
  var multiplication = <span class="kw">new</span> <span class="fu">Multiplication</span>(<span class="dv">3</span>,<span class="dv">7</span>);
  
  var result = multiplication.<span class="fu">Perform</span>();
  
  <span class="kw">if</span>(result != <span class="dv">21</span>)
  {
    <span class="kw">throw</span> <span class="kw">new</span> Exception(<span class="st">&quot;Failed! Expected: 21 but was: &quot;</span> + result);
  }
}</code></pre>
<p>Sounds easy, right? Let’s take another step and extract the result check into something more reusable – after all, we will be adding division in a second, remember? So here goes:</p>
<pre class="sourceCode java"><code class="sourceCode java"><span class="kw">public</span> <span class="dt">static</span> <span class="dt">void</span> <span class="fu">Main</span>(string[] args) 
{
  var multiplication = <span class="kw">new</span> <span class="fu">Multiplication</span>(<span class="dv">3</span>,<span class="dv">7</span>);
  
  var result = multiplication.<span class="fu">Perform</span>();
  
  <span class="fu">AssertTwoIntegersAreEqual</span>(expected: <span class="dv">21</span>, actual: result);
}

<span class="kw">public</span> <span class="dt">static</span> <span class="dt">void</span> <span class="fu">AssertTwoIntegersAreEqual</span>(
  <span class="dt">int</span> expected, <span class="dt">int</span> actual)
{
  <span class="kw">if</span>(actual != expected)
  {
    <span class="kw">throw</span> <span class="kw">new</span> Exception(
      <span class="st">&quot;Failed! Expected: &quot;</span> 
        + expected + <span class="st">&quot; but was: &quot;</span> + actual);
  }
}</code></pre>
<p>Note that I started the name of the method with “Assert” – we will get back to the naming soon, for now just assume that this is just a good name for the method. Let’s take one last round and put the test into its own method:</p>
<pre class="sourceCode java"><code class="sourceCode java"><span class="kw">public</span> <span class="dt">static</span> <span class="dt">void</span> <span class="fu">Main</span>(string[] args) 
{
  <span class="fu">Multiplication_ShouldResultInAMultiplicationOfTwoPassedNumbers</span>();
}

<span class="kw">public</span> <span class="dt">void</span> 
<span class="fu">Multiplication_ShouldResultInAMultiplicationOfTwoPassedNumbers</span>()
{
  <span class="co">//Assuming...</span>
  var multiplication = <span class="kw">new</span> <span class="fu">Multiplication</span>(<span class="dv">3</span>,<span class="dv">7</span>);
  
  <span class="co">//when this happens:</span>
  var result = multiplication.<span class="fu">Perform</span>();
  
  <span class="co">//then the result should be...</span>
  <span class="fu">AssertTwoIntegersAreEqual</span>(expected: <span class="dv">21</span>, actual: result);
}

<span class="kw">public</span> <span class="dt">static</span> <span class="dt">void</span> <span class="fu">AssertTwoIntegersAreEqual</span>(
  <span class="dt">int</span> expected, <span class="dt">int</span> actual)
{
  <span class="kw">if</span>(actual != expected)
  {
    <span class="kw">throw</span> <span class="kw">new</span> Exception(
    <span class="st">&quot;Failed! Expected: &quot;</span> + expected + <span class="st">&quot; but was: &quot;</span> + actual);
  }
}</code></pre>
<p>And we are finished. Now if we need another test, e.g. for division, we can just add a new method call to the <code>Main()</code> method and implement it. When implementing it, we can reuse the <code>AssertTwoIntegersAreEqual()</code> method, since the check for division would be analogous.</p>
<p>As you can see, we can easily write automated checks like this, but this way has some disadvantages:</p>
<ol style="list-style-type: decimal">
<li>Every time we add new test, we have to maintain the <code>Main()</code> method, adding a call to the new test. If you forget to add such a call, the test will never be run. At first it isn’t a big deal, but as soon as we have dozens of tests, it will get really hard to notice.</li>
<li>Imagine your system consists of more than one application – you would have some problems trying to gather summary results for all of the applications that your system consists of.</li>
<li>A need will very quickly arise to write a lot of other checks like the existing <code>AssertTwoIntegersAreEqual()</code> – this one compares two integers for equality, but what if you wanted to check a different condition, e.g. that one integer is greater than another? What if you wanted to check equality not for integers, but for characters, strings, floats etc.? What if you wanted to check some conditions on collections, e.g. that a collection is sorted or that all items in the collection are unique?</li>
<li>Given that a test fails, it would be hard to navigate from the commandline output to the line in your IDE. Would it not be easier if you could click on the call stack to take you immediately to the code where the failure took place?</li>
</ol>
<p>For these and other reasons, automated testing tools were born. Those testing tools are generally referenced to as <strong>xUnit family</strong>, because many of them have names that end with the word “Unit”, e.g. CppUnit (for C++), JUnit (for Java), NUnit (for .NET) etc.</p>
<p>To be honest, I cannot wait to show you how the test we wrote just a minute ago looks like when xUnit framework is used. However, before I do this, I would like to recap quickly what we have in our brute-force naive approach to writing automated tests:</p>
<ol style="list-style-type: decimal">
<li>The <code>Main()</code> method serves as a <strong>Test List</strong></li>
<li>The <code>Multiplication_ShouldResultInAMultiplicationOfTwoPassedNumbers()</code> method is a <strong>Test Method</strong></li>
<li>The <code>AssertTwoIntegersAreEqual()</code> method is <strong>an Assertion</strong></li>
</ol>
<p>To our joy, those three elements are present in xUnit frameworks as well. To illustrate it, here is (finally!) the same test we wrote, but with an xUnit framework (this one is called <a href="http://xunit.github.io/">XUnit.Net</a>):</p>
<pre class="sourceCode java"><code class="sourceCode java">[Fact] <span class="kw">public</span> <span class="dt">void</span> 
<span class="fu">Multiplication_ShouldResultInAMultiplicationOfTwoPassedNumbers</span>()
{
  <span class="co">//Assuming...</span>
  var multiplication = <span class="kw">new</span> <span class="fu">Multiplication</span>(<span class="dv">3</span>,<span class="dv">7</span>);
  
  <span class="co">//when this happens:</span>
  var result = multiplication.<span class="fu">Perform</span>();
  
  <span class="co">//then the result should be...</span>
  Assert.<span class="fu">Equal</span>(<span class="dv">21</span>, result);
}</code></pre>
<p>As you can see, it looks like two methods that we previously had are gone now and the test is the only thing that is left. Well, to tell you the truth, they are not gone – it is just that the framework handles these for us. Let’s reiterate through the three elements of the previous version of the test that I promised would be there after the transition to xUnit framework:</p>
<ol style="list-style-type: decimal">
<li><strong>Test List</strong> is now created automatically by the framework from all methods marked with a [Fact] attribute, so no need to maintain one or more central lists. Thus, the <code>Main()</code> method is gone.</li>
<li>The <strong>Test Method</strong> is here and looks almost the same as the last time.</li>
<li>The <strong>Assertion</strong> took the form of a call to static <code>Assert.Equal()</code> method – the xUnit.NET framework is bundled with a wide range of pre-made assertions for your convenience. Of course, no one stops you from writing your own custom one if you do not find what you are looking for in a default set.</li>
</ol>
<p>Phew, I hope I made the transition quite painless for you. Now the last thing to add – as there is not <code>Main()</code> method anymore in the last example, you surely must wonder how we run those tests, right? Ok, the last big secret unveiled – we use an external application for this (we will refer to it using a term <strong>Test Runner</strong>) – we tell it which assemblies to run and it loads them, runs them, reports results etc. It can take various forms, e.g. it can be a console application, a GUI application or a plugin to our IDEs. Here is an example of a stand-alone runner for xUnit.NET framework:</p>
<div class="figure">
<img src="images/XUnit_NET_Window.png" alt="XUnit.NET window" />
<p class="caption">XUnit.NET window</p>
</div>
<h3 id="mocking-library">Mocking library</h3>
<p>Mocking libraries automate runtime creation of objects (called “mocks”) that adhere to specified interface. Aside from the creation itself, the libraries provide an API to configure our mocks on how they behave when certain methods are called on them and to let us inspect which calls they received.</p>
<p>Mocking libraries are not as old as xUnit frameworks and were not present in TDD at very beginning. As you might be wondering why on earth do we need something like this, I will let you in on a secret: they were born with a goal of aiding a specific approach to object oriented design in mind. This kind of design is what TDD can support quite well as you will soon experience.</p>
<p>For now, however, I am trying to keep things simple. I will defer explaining the actual rationale for mocking libraries until later and instead give you a quick example where you can see them in action.</p>
<p>Ready? Let’s go!</p>
<p>Let’s pretend that we have the following code for adding new set of orders for products to a database and handling exceptions (by writing a message to a log) when it fails:</p>
<pre class="sourceCode java"><code class="sourceCode java"><span class="kw">public</span> <span class="kw">class</span> OrderProcessing
{
  <span class="co">//other code...</span>

  <span class="kw">public</span> <span class="dt">void</span> <span class="fu">Place</span>(Order order)
  {
    <span class="kw">try</span>
    {
      <span class="kw">this</span>.<span class="fu">orderDatabase</span>.<span class="fu">Insert</span>(order);
    }
    <span class="kw">catch</span>(Exception e)
    {
      <span class="kw">this</span>.<span class="fu">log</span>.<span class="fu">Write</span>(<span class="st">&quot;Could not insert an order. Reason: &quot;</span> + e);
    }
  }

  <span class="co">//other code...</span>
}</code></pre>
<p>Now, imagine we need to test it – how do we do it? I can already see you shaking your head and saying: “Let’s just create this database, invoke this method and see if the record is added properly”. In such case, the first test would look like this:</p>
<pre class="sourceCode java"><code class="sourceCode java">[Fact]
<span class="kw">public</span> <span class="dt">void</span> <span class="fu">ShouldInsertNewOrderToDatabase</span>()
{
  <span class="co">//GIVEN</span>
  var orderDatabase = <span class="kw">new</span> <span class="fu">MySqlOrderDatabase</span>();
  orderDatabase.<span class="fu">Connect</span>();
  orderDatabase.<span class="fu">Clean</span>();
  var orderProcessing = <span class="kw">new</span> <span class="fu">OrderProcessing</span>(orderDatabase, <span class="kw">new</span> <span class="fu">FileLog</span>());
  var order = <span class="kw">new</span> <span class="fu">Order</span>(
    name: <span class="st">&quot;Grzesiek&quot;</span>, 
    surname: <span class="st">&quot;Galezowski&quot;</span>, 
    product: <span class="st">&quot;Agile Acceptance Testing&quot;</span>, 
    date: DateTime.<span class="fu">Now</span>,
    quantity: <span class="dv">1</span>);

  <span class="co">//WHEN</span>
  orderProcessing.<span class="fu">Place</span>(order);

  <span class="co">//THEN</span>
  var allOrders = orderDatabase.<span class="fu">SelectAllOrders</span>();
  Assert.<span class="fu">Contains</span>(order, allOrders);
}</code></pre>
<p>As you see, at the beginning of the test, we are opening a connection and cleaning all existing orders (more on that shortly!), then creating an order object, inserting it into a database and then querying the database to give us all of the held instances. At the end, we make an assertion that the order we tried to insert must be inside all orders in a database.</p>
<p>Why do we clean up the database? Remember a database is a persistent storage, so if we did not clean it up and run this test again, the database may have already contained the item (maybe another test already added it?) and would probably not allow us to add the same item again. Thus, the test would fail. Ouch! It hurts so bad, because we wanted our tests to prove something works, but looks like it can fail even when the logic is coded correctly. What use is such a test if it cannot reliably provide the information we demand from it (whether the implemented logic is correct or not)? Thus, we clean up before each run to make sure the state of the persistent storage is the same every time we run this test.</p>
<p>So, got what you want? Well, I did not. Personally, I would not go this way. There are several reasons:</p>
<ol style="list-style-type: decimal">
<li>The test is going to be slow. It is not uncommon to have more than thousand tests in a suite and I do not want to wait half an hour for results every time I run them. Do you?</li>
<li>Everyone running this test will have to set up a local database on their machine. What if their setup is slightly different than yours? What if the schema gets outdated – will everyone manage to notice it and update schema of their local databases accordingly? Will you re-run your database creation script only to ensure you have got the latest schema available to run your tests against?</li>
<li>There may not be an implementation of the database engine for the operating system running on your development machine if your target is an exotic or mobile platform.</li>
<li>Note that this test you wrote is only one out of two. You will have to write another one for the scenario where inserting an order ends with exception. How do you setup your database in a state where it throws an exception? It is possible, but requires significant effort (e.g. deleting a table and recreating it after the test for other tests that might need the table to run correctly), which may lead you to a conclusion that it is not worth to write such tests at all.</li>
</ol>
<p>Now, let’s try something else. Let’s assume that our database works OK (or will be tested by black-box tests) and the only thing we want to test is our implementation. In this situation, we can create fake object, which is an instance of another custom class that implements the same interface as MySqlOrderDatabase, but does not write to a database at all – it only stores the inserted records in a list:</p>
<pre class="sourceCode java"><code class="sourceCode java"><span class="kw">public</span> <span class="kw">class</span> FakeOrderDatabase : OrderDatabase
{
  <span class="kw">public</span> Order _receivedArgument;

  <span class="kw">public</span> <span class="dt">void</span> <span class="fu">Insert</span>(Order order)
  {
    _receivedArgument = order;
  }

  <span class="kw">public</span> List&lt;Order&gt; <span class="fu">SelectAllOrders</span>()
  {
    <span class="kw">return</span> <span class="kw">new</span> List&lt;Order&gt;() { _receivedOrder; };
  }
}</code></pre>
<p>Now, we can substitute the real implementation of order database with the fake instance:</p>
<pre class="sourceCode java"><code class="sourceCode java">[Fact] <span class="kw">public</span> <span class="dt">void</span> 
<span class="fu">ShouldInsertNewOrderToDatabase</span>()
{
  <span class="co">//GIVEN</span>
  var orderDatabase = <span class="kw">new</span> <span class="fu">FakeOrderDatabase</span>();
  var orderProcessing = <span class="kw">new</span> <span class="fu">OrderProcessing</span>(orderDatabase, <span class="kw">new</span> <span class="fu">FileLog</span>());
  var order = <span class="kw">new</span> <span class="fu">Order</span>(
    name: <span class="st">&quot;Grzesiek&quot;</span>, 
    surname: <span class="st">&quot;Galezowski&quot;</span>, 
    product: <span class="st">&quot;Agile Acceptance Testing&quot;</span>, 
    date: DateTime.<span class="fu">Now</span>,
    quantity: <span class="dv">1</span>);

  <span class="co">//WHEN</span>
  orderProcessing.<span class="fu">Place</span>(order);

  <span class="co">//THEN</span>
  var allOrders = orderDatabase.<span class="fu">SelectAllOrders</span>();
  Assert.<span class="fu">Contains</span>(order, allOrders);
}</code></pre>
<p>Note that we do not clean the fake database object, since we create it as fresh each time the test is run. Also, the test is going to be much quicker now. But, that is not the end! We can easily write a test for an exception situation. How do we do it? Just make another fake object implemented like this:</p>
<pre class="sourceCode java"><code class="sourceCode java"><span class="kw">public</span> <span class="kw">class</span> ExplodingOrderDatabase : OrderDatabase
{
  <span class="kw">public</span> <span class="dt">void</span> <span class="fu">Insert</span>(Order order)
  {
    <span class="kw">throw</span> <span class="kw">new</span> Exception();
  }

  <span class="kw">public</span> List&lt;Order&gt; <span class="fu">SelectAllOrders</span>()
  {
  }
}</code></pre>
<p>Ok, so far so good, but the bad thing is that now we have got two classes of fake objects to maintain (and chances are we will need even more). Any method or argument added will need to be propagated to all these objects. We can spare some coding by making our mocks a little more generic so their behavior can be configured using lambda expressions:</p>
<pre class="sourceCode java"><code class="sourceCode java"><span class="kw">public</span> <span class="kw">class</span> ConfigurableOrderDatabase : OrderDatabase
{
  <span class="kw">public</span> Action&lt;Order&gt; doWhenInsertCalled;
  <span class="kw">public</span> Func&lt;List&lt;Order&gt;&gt; doWhenSelectAllOrdersCalled;

  <span class="kw">public</span> <span class="dt">void</span> <span class="fu">Insert</span>(Order order)
  {
    <span class="fu">doWhenInsertCalled</span>(order);
  }

  <span class="kw">public</span> List&lt;Order&gt; <span class="fu">SelectAllOrders</span>()
  {
    <span class="kw">return</span> <span class="fu">doWhenSelectAllOrdersCalled</span>();
  }
}</code></pre>
<p>Now, we do not have to create additional classes for new scenarios, but our syntax gets awkward. See for yourself how we configure the fake order database to remember and yield the inserted order:</p>
<pre class="sourceCode java"><code class="sourceCode java">var db = <span class="kw">new</span> <span class="fu">ConfigurableOrderDatabase</span>();
Order gotOrder = <span class="kw">null</span>;
db.<span class="fu">doWhenInsertCalled</span> = o =&gt; {gotOrder = o;};
db.<span class="fu">doWhenSelectAllOrdersCalled</span> = () =&gt; <span class="kw">new</span> List&lt;Order&gt;() { gotOrder };</code></pre>
<p>And if we want it to throw an exception when anything is inserted:</p>
<pre class="sourceCode java"><code class="sourceCode java">var db = <span class="kw">new</span> <span class="fu">ConfigurableOrderDatabase</span>();
db.<span class="fu">doWhenInsertCalled</span> = o =&gt; {<span class="kw">throw</span> <span class="kw">new</span> Exception();};</code></pre>
<p>Thankfully, some smart programmers created libraries that provide further automation in such scenarios. One of them is called <a href="http://nsubstitute.github.io/"><strong>NSubstitute</strong></a> and provides an API in a form of extension methods (that is why it might seem a bit magical at first. Do not worry, you will get used to it).</p>
<p>Using NSubstitute, our first test can be rewritten as such:</p>
<pre class="sourceCode java"><code class="sourceCode java">[Fact] <span class="kw">public</span> <span class="dt">void</span> 
<span class="fu">ShouldInsertNewOrderToDatabase</span>()
{
  <span class="co">//GIVEN</span>
  var orderDatabase = <span class="kw">new</span> Substitute.<span class="fu">For</span>&lt;OrderDatabase&gt;();
  var orderProcessing = <span class="kw">new</span> <span class="fu">OrderProcessing</span>(orderDatabase, <span class="kw">new</span> <span class="fu">FileLog</span>());
  var order = <span class="kw">new</span> <span class="fu">Order</span>(
    name: <span class="st">&quot;Grzesiek&quot;</span>, 
    surname: <span class="st">&quot;Galezowski&quot;</span>, 
    product: <span class="st">&quot;Agile Acceptance Testing&quot;</span>, 
    date: DateTime.<span class="fu">Now</span>,
    quantity: <span class="dv">1</span>);

  <span class="co">//WHEN</span>
  orderProcessing.<span class="fu">Place</span>(order);

  <span class="co">//THEN</span>
  orderDatabase.<span class="fu">Received</span>(<span class="dv">1</span>).<span class="fu">Insert</span>(order);
}</code></pre>
<p>Note that we do not need the <code>SelectAllOrders()</code> method. If no one except this test needs it, we can delete it and spare some more maintainability trouble. The last line of this test is actually a camouflaged assertion that checks whether Insert method was called once with order object as parameter.</p>
<p>I will get back to mocks, since, as I said, there is a huge philosophy behind them and we have only scratched the surface here.</p>
<h3 id="anonymous-values-generator">Anonymous values generator</h3>
<p>Look at the test in the previous section. Does it not trouble you that we fill the order object with so many values that are totally irrelevant to the test logic itself? They actually hinder readability of the test. Also, they make us believe that the tested object really cares what these values are, although it does not (the database does, but we already got rid of it from the test). Let’s move it to a method with a descriptive name:</p>
<pre class="sourceCode java"><code class="sourceCode java">[Fact] <span class="kw">public</span> <span class="dt">void</span> 
<span class="fu">ShouldInsertNewOrderToDatabase</span>()
{
  <span class="co">//GIVEN</span>
  var orderDatabase = <span class="kw">new</span> Substitute.<span class="fu">For</span>&lt;OrderDatabase&gt;();
  var orderProcessing = <span class="kw">new</span> <span class="fu">OrderProcessing</span>(orderDatabase, <span class="kw">new</span> <span class="fu">FileLog</span>());
  var order = <span class="fu">AnonymousOrder</span>();

  <span class="co">//WHEN</span>
  orderProcessing.<span class="fu">Place</span>(order);

  <span class="co">//THEN</span>
  orderDatabase.<span class="fu">Received</span>(<span class="dv">1</span>).<span class="fu">Insert</span>(order);
}

<span class="kw">public</span> Order <span class="fu">AnonymousOrder</span>()
{
  <span class="kw">return</span> <span class="kw">new</span> <span class="fu">Order</span>(
    name: <span class="st">&quot;Grzesiek&quot;</span>, 
    surname: <span class="st">&quot;Galezowski&quot;</span>, 
    product: <span class="st">&quot;Agile Acceptance Testing&quot;</span>, 
    date: DateTime.<span class="fu">Now</span>,
    quantity: <span class="dv">1</span>);
}</code></pre>
<p>Now that is better. Not only did we make the test shorter, we also provided a hint to the test reader that the actual values used to create an order do not matter from the perspective of tested order processing logic, hence the name <code>AnonymousOrder()</code>.</p>
<p>By the way, would it not be nice if we did not have to provide the anonymous objects ourselves, but rely on another library to generate them for us? Susprise, surprise, there is one! It is called <a href="https://github.com/AutoFixture/AutoFixture"><strong>Autofixture</strong></a>. It is an example of an anonymous values generator (although its creator likes to say that it is an implementation of Test Data Builder pattern, but let’s skip this discussion here). After refactoring our test to use AutoFixture, we arrive at the following:</p>
<pre class="sourceCode java"><code class="sourceCode java">[Fact] <span class="kw">public</span> <span class="dt">void</span> 
<span class="fu">ShouldInsertNewOrderToDatabase</span>()
{
  <span class="co">//GIVEN</span>
  var orderDatabase = <span class="kw">new</span> Substitute.<span class="fu">For</span>&lt;OrderDatabase&gt;();
  var orderProcessing = <span class="kw">new</span> <span class="fu">OrderProcessing</span>(orderDatabase, <span class="kw">new</span> <span class="fu">FileLog</span>());
  var order = any.<span class="fu">Create</span>&lt;Order&gt;();

  <span class="co">//WHEN</span>
  orderProcessing.<span class="fu">Place</span>(order);

  <span class="co">//THEN</span>
  orderDatabase.<span class="fu">Received</span>(<span class="dv">1</span>).<span class="fu">Insert</span>(order);
}

<span class="kw">private</span> Fixture any = <span class="kw">new</span> <span class="fu">Fixture</span>();</code></pre>
<p>Nice, huh? AutoFixture has a lot of advanced features, but personally I am conservative and wrap it behind a static class called <code>Any</code>:</p>
<pre class="sourceCode java"><code class="sourceCode java"><span class="kw">public</span> <span class="dt">static</span> <span class="kw">class</span> Any
{
  <span class="kw">private</span> <span class="dt">static</span> any = <span class="kw">new</span> <span class="fu">Fixture</span>();
  
  <span class="kw">public</span> <span class="dt">static</span> T ValueOf&lt;T&gt;()
  {
    <span class="kw">return</span> any.<span class="fu">Create</span>&lt;T&gt;();
  }
}</code></pre>
<p>In the next chapters, you will see me using a lot of different methods from the <code>Any</code> type. The more you use this class, the more it grows with other methods for creating customized objects. For now, however, let’s stop here.</p>
<h3 id="summary">Summary</h3>
<p>In this chapter, I tried to show you the three essential tools which we will be using in this book and which, when mastered, will make your test-driven development smoother. If this chapter leaves you with insufficient justification for their use, do not worry – we will dive into the philosophy behind them in the coming chapters. For now, I just want you to get familiar with the tools themselves and their syntax. Go on, download these tools, launch them, try to write something simple with them. You do not need to understand their full purpose yet, just go out and play :-).</p>
<h1 id="it-is-not-atest">It is not a test</h1>
<p>Up to now, I was cheating on you. I told you that the little executable snippets of code are ‘tests’ and that they’re here to ‘check’ or ‘verify’ something. Now it is time to reveal the truth.</p>
<h2 id="when-atest-becomes-something-else">When a test becomes something else</h2>
<p>I studied in Łódź, a large city in the center of Poland. As probably all other students in all other countries, we have had lectures, exercises and exams. The exams were pretty hard, especially considered that my computer science group was on the faculty of electronic and electric engineering, so we had to grasp a lot of classes that did not have anything to do with programming, for instance electrotechnics, solid-state physics or electronic and electrical metrology.</p>
<p>Knowing that the exams were difficult and that it was hard to learn everything during preparation, the lecturers would give us exemplary exams from previous years. The questions were different than during actual exams, but the structure and types of questions asked (practice vs. theory etc.) was similar. We would usually get these exemplary questions before we started learning really hard (which was usually at the end of semester). Guess what happened then? As you might suspect, we did not use the tests we received just to ‘verify’ or ‘check’ our knowledge after we finished learning. Those tests were actually the first thing we went to before even starting to learn. Why was that so? What use were the tests when we knew we would not know most of the answers?</p>
<p>I guess my lecturers would disagree with me, but I find it quite amusing that what we were really doing back then was ‘Lean’. Lean is an approach where, among others, there is a rigorous emphasis on eliminating waste. Every feature or product that is produced while not being needed by anyone is considered waste. That is because if something is not needed, there is no reason to assume it will ever be needed. In such case the entire feature or product is a waste – it has no value. Even if it WILL be ever needed, it will require some rework anyway to fit the real customer needs. In this case, the initial amount of work that went into the parts of solution that had to be replaced by another parts anyway is a waste – it never brought any money (I am not talking about such things as customer demos, but finished, polished features or products).</p>
<p>So, in order to eliminate waste, there is huge pressure nowadays to “pull features from demand” instead of “pushing them” into the product. In other words, every feature is there to satisfy concrete need. If not, the effort is considered wasted and the money drown.</p>
<p>Going back to the exams, why the approach of first looking through the exemplary tests can be considered ‘lean’? That is because, when we treat passing an exam as our goal, then everything that does not put us closer to this goal is considered a waste. Let’s suppose the exam is theory only – why then practice the exercises? It would probably pay off a lot more to study theoretical side of the topics. Such knowledge could be obtained from those exemplary tests. So, the tests were a kind of specification of what was needed to pass the exam, letting us pull the value (i.e. our knowledge) from demand (information obtained from a realistic tests) rather that pushing it from implementation (i.e. learning everything in a course book chapter after chapter).</p>
<p>So the tests became something else. They proved very valuable before the ‘implementation’ (i.e. learning for the exam) because:</p>
<ol style="list-style-type: decimal">
<li>they helped us focus on what was needed to reach our goal</li>
<li>they brought our attention away from what was <strong>not</strong> needed to reach our goal</li>
</ol>
<p>That was the value of a test before learning. Note that the tests we would usually receive were not exactly what we would encounter at the time of exam, so we still had to guess. Still, the role of a <strong>test as specification of a need</strong> was already visible.</p>
<h2 id="taking-it-to-the-software-development-land">Taking it to the software development land</h2>
<p>I chose this lengthy metaphor to show you that ‘test’ is really another way of specifying a requirement or a need and that it is not something that is counter-intuitive – it occurs in our everyday lives. This is also true in software development. Let’s take the following ‘test’ and see what kind of needs it specifies:</p>
<pre class="sourceCode java"><code class="sourceCode java">var reporting = <span class="kw">new</span> <span class="fu">ReportingFeature</span>();
var anyPowerUser = Any.<span class="fu">Of</span>(Users.<span class="fu">Admin</span>, Users.<span class="fu">Auditor</span>);
Assert.<span class="fu">True</span>(reporting.<span class="fu">CanBePerformedBy</span>(anyPowerUser));</code></pre>
<p>(In this example, we used <code>Any.Of()</code> method that returns any enumeration value from the specified list. Here, we say “give me a value that is either <code>Users.Admin</code> or <code>Users.Auditor</code>“.)</p>
<p>Let’s look at those (only!) three lines of code, imagining that the production code that makes this ‘test’ pass does not exist yet. What can we learn from these three lines about what the code needs to supply? Count with me:</p>
<ol style="list-style-type: decimal">
<li>We need a reporting feature</li>
<li>We need to support a notion of users and privileges</li>
<li>We need to support a domain concept of power user, who is either an administrator or an auditor</li>
<li>Power users will need to be privileged to use the reporting feature (note that it does not specify which other users should or should not be able to use this feature – we would need a separate ‘test’ for that).</li>
</ol>
<p>Also, are already after the phase of designing an API that will fulfill the need. Don’t you think it is pretty much information about the application from just three lines of code?</p>
<h2 id="a-specification-instead-of-atest-suite">A Specification instead of a Test Suite</h2>
<p>I hope that you can see now that what we called ‘a test’ is really a kind of specification. The discovery is very recent, so there isn’t a clear terminology on it yet. Some like to call the process of using tests as specifications: Specification By Example, to say that the tests are really examples that help specify and clarify the behavior of developed part of functionality. The terminology is still not rock-solid, so you might encounter different naming for different things. For example, a ‘test’ is often referred to as ‘spec’, or an ‘example’, or a ‘behavior description’, or a ‘specification statement’ or a ‘fact about the developed system’ (the xUnit.NET framework marks each ‘test’ with a <code>[Fact]</code> attribute, suggesting that by writing it, we are stating a single fact about developed code. By the way, xUnit.NET also allows us to state ‘theories’ about our code, but let’s leave it for now).</p>
<p>The time has come to make a deal: I will establish some naming conventions for this book to be consistent, but leave you with the freedom to follow your own if you so desire. The terminology shift is for pedagogical reasons – I am not trying to create a movement to change established terms or to invent a new methodology or anything – my hope is that using this terminology throughout the book will let you look differently at some things<a href="#fn1" class="footnoteRef" id="fnref1"><sup>1</sup></a>. So, let’s agree that for the sake of this book:</p>
<dl>
<dt><strong>Specification Statement</strong> (or simply <strong>Statement</strong>, starting with capital letter)</dt>
<dd><p>will be used instead of ‘test’ or ‘test method’</p>
</dd>
<dt><strong>Specification</strong> (or simply <strong>Spec</strong>), also starting with capital letter</dt>
<dd><p>will be used instead of ‘test suite’ or ‘test list’</p>
</dd>
<dt><strong>False Statement</strong></dt>
<dd><p>will be used instead of ‘failing test’</p>
</dd>
<dt><strong>True Statement</strong></dt>
<dd><p>will be used instead of ‘passing test’</p>
</dd>
</dl>
<p>From time to time, I will refer back to the ‘traditional’ terminology, because it is better established and you’ve probably heard some terms already and may wonder how it should be understood in context of thinking of tests as specification.</p>
<p>From your experience, you may know paper or word specifications, written in plain English or other spoken language. Our specification is different than these specifications in at least few ways:</p>
<ol style="list-style-type: decimal">
<li>it is not written fully up-front (more on this in the next chapters).</li>
<li>it is executable – you can run it to see whether the code adheres to the specification or not.</li>
<li>it is written in source code rather than in spoken language – which is both good (less room for misunderstanding – source code is the most formal and structured way of writing specifications) and bad (great care must be taken to keep the specification readable).</li>
</ol>
<h2 id="what-is-the-point-of-writing-specification-after-the-fact">What is the point of writing specification after the fact?</h2>
<p>In the last chapter, I said that in TDD a ‘test’ takes another role – one of a statement being a part of a specification. If we put things this way, then the whole controversial concept of “writing a test before the code” does not pose a problem at all. Quite the contrary – it only seems natural to specify what we are going to write before we attempt to write it. Does the other way round even make sense? A specification written after completing the implementation is nothing more than an attempt at documenting the existing solution. Sure, such attempts can provide some value when done as a kind of reverse-engineering (i.e. writing specification for something that was implemented long ago and we do not really know the exact business rules or policies, which we discover as we document the existing solution) – it has an excitement of discovery in it, but doing it just after we, ourselves, made all the decisions seems like a waste of time, not to mention that it is dead boring (Do not believe me? Try implementing a simple calculator app and then write specification for it just after it is implemented and working). Anyway, specifying how something should work after the fact can hardly be considered creative.</p>
<p>Oh, and did I tell you that without a specification of any kind we do not really know whether we are done implementing our changes or not (because in order to know it, we need to compare the implemented functionality to ‘something’, even if this ‘something’ is only in the customer’s head).</p>
<p>Another thing I mentioned in the previous chapter was that one of the differences between a textual specification and our Specification consisting of executable Statements is that, although the code follows the Specification, we do not write our Specification fully up-front. The usual sequence is to specify a bit first and then code a bit, then repeat one Statement at a time. When doing TDD, we are traversing repeatedly through few phases that make up a cycle. We like these cycles to be short, so that we can get a quick feedback. Being able to get this quick feedback is essential, because it allows us to move forward with confidence that what we already have works as we intended. Also, it allows us to use the knowledge we gained in the previous cycle to make the next cycle more efficient (if you do not believe me that quick feedback is good, ask yourself a question: “how many times a day do I compile the code I work on?”).</p>
<p>Reading so much about cycles, it is probably no surprise to you that the traditional illustration of the TDD process is modeled visually as a circle-like flow:</p>
<div class="figure">
<img src="images/RedGreenRefactor.png" alt="Basic TDD cycle" />
<p class="caption">Basic TDD cycle</p>
</div>
<p>Note that the above form uses the traditional terminology of TDD, so before I explain the steps, I will translate it to use our terms of Specification and Statements:</p>
<div class="figure">
<img src="images/RedGreenRefactor2.png" alt="Basic TDD cycle with changed terminology" />
<p class="caption">Basic TDD cycle with changed terminology</p>
</div>
<p>The second version seems more like common sense than the first one – specifying how something should behave before putting that behavior in place is way more intuitive than testing something that does not exist.</p>
<p>Anyway, these three steps demand some explanation. In the coming chapters, I will give you some examples of how this process works in practice and introduce an expanded version, but in the meantime, its sufficient to say that:</p>
<dl>
<dt>Write a Statement you wish was true but is not</dt>
<dd>means that the Statement evaluates to false (it shows on the test list as failing – in most xUnit frameworks, it will be marked with red color)
</dd>
<dt>Add code to make it true</dt>
<dd>means that we write just enough code to make the Statement true (in most xUnit frameworks, the true Statement will be marked with green color). Later in the course of the book, you will see how small can be “just enough”
</dd>
<dt>Refactor</dt>
<dd>is a step that I have silently discarded so far (and will do so for at least few next chapters. Do not worry, we will get back to it eventually). Basically, it boils down to using the safety net of executable specification we already have in place to safely enhance the quality of the covered code while all mistakes we make in the process are quickly discovered by the running Specification.
</dd>
</dl>
<p>By the way, this process is sometimes referred to as “Red-Green-Refactor”. I am just mentioning it here for the record – I am not planning to use this term further in the book.</p>
<h2 id="the-benefit-of-failure">The benefit of failure</h2>
<p>When I showed you a drawing with a TDD process, I specifically said that you are supposed to write a Statement that you wish was true <strong>but is not</strong>. It means that when you write a Statement, you have to evaluate it (i.e. run it) and watch it fail its assertions before providing implementation that makes this Statement true. Why is that so important? Is it not just enough to write the Statement first? Why run it and watch it fail?</p>
<p>There are multiple reasons and I will try to outline few of them briefly.</p>
<h3 id="you-do-not-know-whether-the-statement-can-ever-be-false-until-you-see-it-evaluate-as-false">You do not know whether the Statement can ever be false until you see it evaluate as false</h3>
<p>Every accurate Statement (do I have to tell you that such Statements are what we are interested in?) fails when it isn’t fulfilled and passes when it is. That is one of the main reasons we write it – to receive this feedback. Also, after being fulfilled, the Statement becomes a part of the executable specification and starts failing as soon as the code stops fulfilling it (e.g. as a result of mistake made during code rework). When your run a Statement after it is implemented and it is evaluated as true, how do you know whether it really describes a need accurately? You did not ever watch it fail, so how do you know it ever will?</p>
<p>The first time I encountered this argument (it was before I started thinking of unit tests as executable specification), it quickly raised my self-defense mechanism: “seriously?” – I thought – “I am a wise person, I know what I am writing. If I make my unit tests small enough, it is self-evident that I am describing the correct behavior. This is paranoid”. However, life quickly verified my claims and I was forced to withdraw my arguments. Let me describe, from my experience, three ways (there are more, I just forgot the rest :-D) one can really put in a Statement that is always evaluated as true, regardless of the code being correct or not (i.e. a Statement that cheats you into thinking it is fulfilled even when it is not):</p>
<h4 id="accidental-omission-of-adding-astatement-to-specification">1. Accidental omission of adding a Statement to Specification</h4>
<p>However funny this may sound, it happened to me few times. The example I am going to give is from C#, but almost every xUnit framework in almost every language has some kind of mechanism of marking methods as Statements, whether by attributes (C#, e.g. xUnit.Net’s <code>Fact</code> attribute) or annotations (Java) or with macros (C and C++) or by inheriting from common class, or just a naming convention.</p>
<p>Let’s take xUnit.Net as an example. As I stated previously, In xUnit.Net, to turn a method into a Statement, you mark it with <code>[Fact]</code> attribute the following way:</p>
<pre class="sourceCode java"><code class="sourceCode java"><span class="kw">public</span> <span class="kw">class</span> CalculatorSpecification
{
  [Fact]
  <span class="kw">public</span> <span class="dt">void</span> <span class="fu">ShouldDisplayAdditionResultAsSumOfArguments</span>() 
  {
    <span class="co">//... </span>
  }
}</code></pre>
<p>Now, imagine that you are writing this Statement post-factum as a unit test in an environment that has, let’s say, more than thirty Statements – you have written the code, now you are just creating a test after test “to ensure” (as you see, this is not my favorite reason for writing unit tests) the code works. Code, test – pass, test – pass, test – pass. You almost always evaluate your code against the whole Specification, since it is usually easier than selecting what to evaluate each time, plus, you get more confidence this way that you did not break by mistake something that is already working. So, this is really: Code, Test – all pass, test – all pass, test – all pass… Hopefully, you use some kind of snippets mechanism for creating new Statements, but if not (and many do not actually do this), once in a while, you do something like this:</p>
<pre class="sourceCode java"><code class="sourceCode java"><span class="kw">public</span> <span class="kw">class</span> CalculatorSpecification
{
  <span class="co">//... some Statements here</span>

  <span class="co">//oops... forgot to copy-paste the attribute!</span>
  <span class="kw">public</span> <span class="dt">void</span> <span class="fu">ShouldDisplayZeroWhenResetIsPerformed</span>()
  {
    <span class="co">//... </span>
  }
}</code></pre>
<p>And you do not even notice that this will not be evaluated with the rest of the Specification, because it already consists of so many Statements that it is almost irrational to search for your added Statement in the list and make sure it is there each time. Also, note that the fact that you omitted the addition, does not disturb your work flow: test – all pass, test – all pass, test – all pass… In other words, your process does not give you any feedback on your mistake. So, what you end up is a Statement that not only will never be false – <strong>it will never be evaluated</strong>.</p>
<p>How does treating tests as Statements and evaluating them before making them true help here? <strong>Because then, a Statement that starts off being evaluated as true is what DOES disturb your work flow.</strong> In TDD, the work flow is: Statement – unfulfilled – fulfilled (ok, and refactor, but for the sake of THIS discussion, it does not matter so much), Statement – unfulfilled – fulfilled, Statement – unfulfilled – fulfilled… So every time you fail to see the “unfulfilled” stage, you get feedback from your process that something suspicious is happening. This lets you investigate and, if necessary, fix the situation at hand.</p>
<h4 id="misplacing-mock-setup">2. Misplacing mock setup</h4>
<p>Ok, this may sound even funnier (well, honestly, most mistakes sound funny), but it also happened to me a couple of times, so it makes sense to mention it. The example I am going to show uses manual mocks, but this can happen with dynamic mocks as well, especially if you are in a hurry.</p>
<p>Let’s take a look at the following Statement saying that setting a value higher than allowed to a field of a frame should produce error result:</p>
<pre class="sourceCode java"><code class="sourceCode java">[Fact]
<span class="kw">public</span> <span class="dt">void</span> <span class="fu">ShouldRecognizeTimeSlotAboveMaximumAllowedAsInvalid</span>()
{
  <span class="co">//GIVEN</span>
  var frame = <span class="kw">new</span> <span class="fu">FrameMock</span>(); <span class="co">//manual mock</span>
  var validation = <span class="kw">new</span> <span class="fu">Validation</span>();
  var timeSlotAboveMaximumAllowed = TimeSlot.<span class="fu">MaxAllowed</span> + <span class="dv">1</span>;

  <span class="co">//WHEN</span>
  var result = validation.<span class="fu">PerformForTimeSlotIn</span>(frame);
  frame.<span class="fu">GetTimeSlot_Returns</span> 
    = timeSlotAboveMaximumAllowed;

  <span class="co">//THEN</span>
  Assert.<span class="fu">False</span>(result.<span class="fu">Passed</span>);
  Assert.<span class="fu">Equal</span>(
    ValidationFailureReasons.<span class="fu">AboveAcceptableLimit</span>, 
    result.<span class="fu">Reason</span>);
}</code></pre>
<p>Note how the method <code>PerformForTimeSlotIn()</code>, which triggers the specified behavior is accidentally called BEFORE the mock is actually set up and the set up return value is never taken into account. By some strange coincidence, this error did not alter the expected end result so we did not even notice. It sometimes turns out like this, most often in case of various boundary values (nulls etc.).</p>
<h4 id="using-static-data-inside-production-code">3. Using static data inside production code</h4>
<p>Once in a while, you have to jump in and add some new Statements to some class Specification and some logic to the class itself. Let’s assume that the class and its existing specification was written by someone else. Imagine this code is a wrapper around your product XML configuration file. You decide to write your Statements AFTER applying the changes (“well”, you can say, “I am all protected by the Specification that is already in place, so I can make my change without risking regression, then just test my changes and it is all good…”).</p>
<p>So, you start writing the new Statement. The Specification class already contains a field member like this:</p>
<pre class="sourceCode java"><code class="sourceCode java"><span class="kw">public</span> <span class="kw">class</span> XmlConfigurationSpecification
{
  XmlConfiguration config = <span class="kw">new</span> <span class="fu">XmlConfiguration</span>(xmlFixtureString);
  
  <span class="co">//...</span>
  <span class="co">//...</span></code></pre>
<p>What it does is to set up an object used by every Statement. So, each Statement uses a <code>config</code> object initialized with the same <code>xmlConfiguration</code> string value. The string is already pretty huge and messy, since it was made to contain what is required by all existing Statements. You need to write tests for is a little corner case that does not need all this crap that is inside this string. So, you decide to start fresh and create a separate object of <code>XmlConfiguration</code> class with your own, minimal string. Your Statement begins like this:</p>
<pre class="sourceCode java"><code class="sourceCode java">string customFixture = <span class="fu">CreateMyOwnFixtureForThisTestOnly</span>();
var configuration = <span class="kw">new</span> <span class="fu">XmlConfiguration</span>(customFixture);
...</code></pre>
<p>And it passes – cool… not. Ok, what is wrong with this? Nothing big, unless you read the source code of XmlConfiguration class carefully. Inside, you can see, how the xml string is stored:</p>
<pre class="sourceCode java"><code class="sourceCode java"><span class="kw">private</span> <span class="dt">static</span> string xmlText; <span class="co">//note the static keyword!</span></code></pre>
<p>What the…? Well, well, here is what happened: the author of this class coded in a small little optimization. He thought: “In this app, the configuration is only modified by members of the support staff and to do it, they have to shut down the system, so, there is no need to read the XML file every time an XmlConfiguration object is created. I can save some CPU cycles and I/O operations by reading it only once when the first object is created. Another created object will just use the same XML!”. Good for him, not so good for you. Why? Because (unless your Statement is evaluated prior to being fulfilled), your custom xml string will never actually be used!</p>
<h3 id="test-after-ends-up-as-test-never">“Test-After” ends up as “Test-Never”</h3>
<p>I will ask this question again: ever had to write a requirement or design document for something that you already implemented? Was it fun? Was it valuable? Was it creative? No, I do not think so. The same is with our executable specification. After we write the code, we have little motivation to specify what is already written – some of the pieces of code “we can just see are correct”, other pieces “we already saw working” when we copied our code over to our deployment machine and ran few sanity checks… The design is ready… Specification? Maybe next time…</p>
<p>Another reason might be time pressure. Let’s be honest – we are all in a hurry, we are all under pressure and when this pressure is too high, it triggers heroic behaviors in us, especially when there is a risk of not making it with the sprint commitment. Such heroic behavior usually goes by the following rules: drop all the “baggage”, stop learning and experimenting, revert to all of the old “safe” behaviors and “save what we can!”. If Specification is written at the end, it is often sacrificed on the altar of making it with the commitment, since the code is already written, “and it will be tested anyway by real tests” (box tests, smoke tests, sanity tests etc.). It is quite the contrary when starting with a Statement, where the Statement evaluating to false is <strong>a reason</strong> to write any code. Thus, if we want to write code, Specification become irremovable part of your development. By the way, I bet in big corporations no one sane ever thinks they can abandon checking in the code to source control, at the same time treating Specification as “an optional addition”.</p>
<h3 id="not-starting-from-specification-leads-to-waste-of-time-on-making-objects-testable">Not starting from specification leads to waste of time on making objects testable</h3>
<p>It so happens, that I like watching and reading Uncle Bob. One day, I was listening to <a href="http://www.confreaks.com/videos/759-rubymidwest2011-keynote-architecture-the-lost-years">his keynote at Ruby Midwest 2011, called Architecture The Lost Years</a>. At the end, Robert made some digressions, one of them being about TDD. He said that writing unit tests after the code is not TDD. It is a waste of time.</p>
<p>My initial thought was that the comment was only about missing all the benefits that starting with false Statement brings you: the ability to see the Statement fail, the ability to do a clean-sheet analysis etc., however, now I am of opinion that there is more to it. It is something I got from Amir Kolsky and Scott Bain – in order to be able to write maintainable Specification for a piece of code, the code has to have a high level of a quality called <strong>testability</strong> (we will talk about testability later on, do not worry – for now let’s assume that the easier it is to write a Statement for a behavior of a class, the higher testability it has). That does not tell us much about where is the waste I mentioned, does it? To see it, let’us see how dealing with testability looks like in Statement-first workflow (let’s assume that we are creating new code, not adding stuff to dirty, ugly legacy code):</p>
<ol style="list-style-type: decimal">
<li>Write false Statement (this step ensures that code has high testability)</li>
<li>Write code to make the Statement true</li>
</ol>
<p>Now, how does it usually look like when we write the code first (extra steps marked with <strong>strong text</strong>):</p>
<ol style="list-style-type: decimal">
<li>Write some production code (probably spans few classes until we are satisfied)</li>
<li><strong>Start writing unit tests</strong></li>
<li><strong>Notice that unit testing the whole set of classes is cumbersome and unsustainable and contains high redundancy.</strong></li>
<li><strong>Restructure the code to be able to isolate objects and use mocks (this step ensures that code has high testability)</strong></li>
<li>Write unit tests</li>
</ol>
<p>What is the equivalent of the marked steps in Statement-first approach? Nothing! Doing these things is a waste of time! Sadly, this is a waste I see done over and over again.</p>
<p>Do you like wasting your time?</p>
<h1 id="practicing-what-we-have-already-learned">Practicing what we have already learned</h1>
<blockquote>
<p>And now, a taste of things to come!</p>
<p>– Shang Tsung, Mortal Kombat The Movie</p>
</blockquote>
<p>The above quote took place just before a fighting scene in which a nameless warrior jumped at Sub-Zero only to be frozen and broken into multiple pieces upon hitting the wall. The scene was not spectacular in terms of fighting technique or length. Also, the nameless guy did not even try hard – the only thing he did was to jump only to be hit by a freezing ball, which, by the way, he actually saw coming. It looked a lot like the fight was set up only to showcase Sub-Zero’s freezing ability. Guess what? In this chapter, we are gonna do roughly the same thing – set up a fake, easy scenario just to showcase some of the basic TDD elements!</p>
<p>The previous chapter was filled with a lot of theory and philosophy, don’t you think? I really hope you did not fall asleep while reading it. To tell you the truth, we need to grasp much more theory until we are really able to write real-world applications using TDD. To compensate for this somehow, I propose we make a side trip from the trail and try what we already learned on a quick and easy example. As we go through the example, you might wonder how on earth could you possibly write real applications the way we will write our simple program. Do not worry, I will not show you all the tricks yet, so treat it as a “taste of things to come”. In other words, the example will be as close to real world problems as the fight between Sub-Zero and nameless ninja was to real martial arts fight, but will show you some of the elements of TDD process.</p>
<h2 id="let-me-tell-you-astory">Let me tell you a story</h2>
<p>Meet Johnny and Benjamin, two developers from Buthig Company. Johnny is quite fluent in programming and Test-Driven Development, while Benjamin is an intern under Johnny’s mentorship and is eager to learn TDD. They are on their way to their customer, Jane, who requested their presence as she wants them to do write a small program for her. Together with them, we will see how they interact with the customer and how Benjamin tries to understand the basics of TDD. Just as you, Benjamin is a novice so his questions may reflect yours. However, if you find anything explained in not enough details, do not worry – in the next chapters, we will be expanding on this material.</p>
<h2 id="act-1-the-car">Act 1: The Car</h2>
<p><strong>Johnny:</strong> How do you feel on your first assignment?</p>
<p><strong>Benjamin:</strong> I am pretty excited! I hope I can learn some of the TDD stuff you promised to teach me.</p>
<p><strong>Johnny:</strong> Not only TDD, but we are also gonna use some of the practices associated with a process called Acceptance Test Driven Development, albeit in a simplified form.</p>
<p><strong>Benjamin:</strong> Acceptance Test-Driven Development? What is that?</p>
<p><strong>Johnny:</strong> While TDD is usually referred to as a development technique, ATDD is something more of a collaboration method. Both ATDD and TDD have a bit of analysis in them and work very well together as both use the same underlying principles, just on different levels. We will need only a small subset of what ATDD has to offer, so do not get over-excited.</p>
<p><strong>Benjamin:</strong> Sure.</p>
<h2 id="act-2-the-customer">Act 2: The Customer</h2>
<p><strong>Johnny:</strong> Hi, Jane, how are you?</p>
<p><strong>Jane:</strong> Thanks, I am fine, how about you?</p>
<p><strong>Johnny:</strong> Same here, thanks. So, can you tell us a bit about the software you need us to write?</p>
<p><strong>Jane:</strong> Sure. Recently, I bought a new smartphone as a replacement for my old one. The thing is, I am really used to the calculator application that was running on the previous phone and I cannot find it for my current device.</p>
<p><strong>Benjamin:</strong> Can’t you just use another calculator app? There are plenty of them available to download from the web.</p>
<p><strong>Jane:</strong> That is right. I checked them all and none has exactly the same behavior as the one I was using for my tax calculations. You know, the program was like right hand to me and it had some really nice shortcuts that made my life easier.</p>
<p><strong>Johnny:</strong> So you want us to reproduce the application to run on your new device?</p>
<p><strong>Jane:</strong> Yes.</p>
<p><strong>Johnny:</strong> Are you aware that apart from the fancy features that you were using we will have to allocate some effort to implement the basics that all the calculators have?</p>
<p><strong>Jane:</strong> Sure, I am OK with that. I am so used to my calculator application so much that if I use something else for more than few months, I will have to pay psychotherapist instead of you guys. Apart from that, writing a calculator app seems like a simple task in my mind, so the cost isn’t going to be overwhelming, right?</p>
<p><strong>Johnny:</strong> I think I get it. Let’s get it going then. We will be implementing the functionality incrementally, starting with the most essential ones. Which feature of the calculator would you consider the most essential?</p>
<p><strong>Jane:</strong> That would be addition of numbers, I guess.</p>
<p><strong>Johnny:</strong> Ok, that will be our target for the first iteration. After the iteration, we will deliver this part of functionality for you to try out and give us some feedback. However, before we can even implement addition, we will have to implement displaying digits on the screen as you enter them. Is that correct?</p>
<p><strong>Jane:</strong> yes, I want the display stuff to work as well – it is the most basic feature, so…</p>
<p><strong>Johnny:</strong> Ok then, this is a simple functionality, so let me suggest some user stories as I understand what you already said and you will correct me where I am wrong. Here we go:</p>
<ol style="list-style-type: decimal">
<li><strong>In order to</strong> know that the calculator is turned on, <strong>As a</strong> tax payer <strong>I want</strong> to see “0” on the screen as soon as I turn it on.</li>
<li><strong>In order to</strong> see what numbers I am currently operating on, <strong>As a</strong> tax payer, <strong>I want</strong> the calculator to display the values I enter</li>
<li><strong>In order to</strong> calculate sum of my different incomes, <strong>As a</strong> tax payer <strong>I want</strong> the calculator to enable addition of multiple numbers</li>
</ol>
<p>What do you think?</p>
<p><strong>Jane</strong>: The stories pretty much reflect what I want for the first iteration. I do not think I have any corrections to make.</p>
<p><strong>Johnny:</strong> Now we will take each story and collect some examples of how it should work.</p>
<p><strong>Benjamin:</strong> Johnny, don’t you think it is obvious enough to proceed with implementation straight away?</p>
<p><strong>Johnny:</strong> Trust me, Benjamin, if there is one word I fear most in communication, it is “obvious”. Miscommunication happens most often around things that people consider obvious, simply because other people do not.</p>
<p><strong>Jane:</strong> Ok, I am in. What do I do?</p>
<p><strong>Johnny:</strong> Let’s go through stories one by one and see if we can find some key examples of how the features work. The first story is…</p>
<h3 id="in-order-to-know-that-the-calculator-is-turned-on-as-a-tax-payer-i-want-to-see-0-on-the-screen-as-soon-as-iturn-it-on."><strong>In order to</strong> know that the calculator is turned on, <strong>As a</strong> tax payer <strong>I want</strong> to see “0” on the screen as soon as I turn it on.</h3>
<p><strong>Jane:</strong> I do not think there is much to talk about. If you display “0”, I will be happy. That is all.</p>
<p><strong>Johnny:</strong> Let’s write down this example:</p>
<table>
<thead>
<tr class="header">
<th align="left">key sequence</th>
<th align="left">Displayed output</th>
<th align="left">Notes</th>
</tr>
</thead>
<tbody>
<tr class="odd">
<td align="left">N/A</td>
<td align="left">0</td>
<td align="left">Initial displayed value</td>
</tr>
</tbody>
</table>
<p><strong>Benjamin:</strong> That makes me wonder… what should happen when I press “0” again at this stage?</p>
<p><strong>Johnny:</strong> Good catch, that is what these examples are for – they make our thinking concrete. As Ken Pugh says: “Often the complete understanding of a concept does not occur until someone tries to use the concept”. We would normally put it on a TODO list, because it is part of a different story, but we are actually done with this one, so let’s move straight to the story about displaying entered digits. How about it, Jane?</p>
<p><strong>Jane:</strong> Agree.</p>
<h3 id="in-order-to-see-what-numbers-iam-currently-operating-on-as-a-tax-payer-i-want-the-calculator-to-display-the-values-ienter"><strong>In order to</strong> see what numbers I am currently operating on, <strong>As a</strong> tax payer, <strong>I want</strong> the calculator to display the values I enter</h3>
<p><strong>Johnny:</strong> Let’s begin with the case raised by Benjamin. What should happen when I input “0” multiple times after I have only “0” on the display?</p>
<p><strong>Jane:</strong> Just one “0” should be displayed</p>
<p><strong>Johnny:</strong> Do you mean this?</p>
<table>
<thead>
<tr class="header">
<th align="left">key sequence</th>
<th align="left">Displayed output</th>
<th align="left">Notes</th>
</tr>
</thead>
<tbody>
<tr class="odd">
<td align="left">0,0,0</td>
<td align="left">0</td>
<td align="left">Zero is a special case – it is displayed only once</td>
</tr>
</tbody>
</table>
<p><strong>Jane:</strong> That is right. Other than this, the digits should just show on the screen, like this:</p>
<table>
<thead>
<tr class="header">
<th align="left">key sequence</th>
<th align="left">Displayed output</th>
<th align="left">Notes</th>
</tr>
</thead>
<tbody>
<tr class="odd">
<td align="left">1,2,3</td>
<td align="left">123</td>
<td align="left">Entered digits are displayed</td>
</tr>
</tbody>
</table>
<p><strong>Benjamin:</strong> How about this:</p>
<table>
<thead>
<tr class="header">
<th align="left">key sequence</th>
<th align="left">Displayed output</th>
<th align="left">Notes</th>
</tr>
</thead>
<tbody>
<tr class="odd">
<td align="left">1,2,3,4,5,6,7,1,2,3,4,5,6</td>
<td align="left">1234567123456?</td>
<td align="left">Entered digits are displayed?</td>
</tr>
</tbody>
</table>
<p><strong>Jane:</strong> Actually, no. My old calculator app has a limit of six digits that I can enter, so it should be:</p>
<table>
<thead>
<tr class="header">
<th align="left">key sequence</th>
<th align="left">Displayed output</th>
<th align="left">Notes</th>
</tr>
</thead>
<tbody>
<tr class="odd">
<td align="left">1,2,3,4,5,6,7,1,2,3,4,5,6</td>
<td align="left">123456</td>
<td align="left">Display limited to six digits</td>
</tr>
</tbody>
</table>
<p><strong>Johnny:</strong> another good catch, Benjamin!</p>
<p><strong>Benjamin:</strong> I think I am beginning to understand why you like working with examples!</p>
<p><strong>Johnny:</strong> Good. Is there anything else, Jane?</p>
<p><strong>Jane:</strong> No, that is pretty much it. Let’s start working on another story.</p>
<h3 id="in-order-to-calculate-sum-of-my-different-incomes-as-a-tax-payer-i-want-the-calculator-to-enable-addition-of-multiple-numbers"><strong>In order to</strong> calculate sum of my different incomes, <strong>As a</strong> tax payer <strong>I want</strong> the calculator to enable addition of multiple numbers</h3>
<p><strong>Johnny:</strong> Is the following all we have to support?</p>
<table>
<thead>
<tr class="header">
<th align="left">key sequence</th>
<th align="left">Displayed output</th>
<th align="left">Notes</th>
</tr>
</thead>
<tbody>
<tr class="odd">
<td align="left">2,+,3,+,4,=</td>
<td align="left">9</td>
<td align="left">Simple addition of numbers</td>
</tr>
</tbody>
</table>
<p><strong>Jane:</strong> This scenario is correct, however, there is also a case when I start with “+” without inputting any number before. This should be treated as adding to zero:</p>
<table>
<thead>
<tr class="header">
<th align="left">key sequence</th>
<th align="left">Displayed output</th>
<th align="left">Notes</th>
</tr>
</thead>
<tbody>
<tr class="odd">
<td align="left">+,1,=</td>
<td align="left">1</td>
<td align="left">Addition shortcut – treated as 0+1</td>
</tr>
</tbody>
</table>
<p><strong>Benjamin:</strong> How about when the output is a number longer than six digits limit? Is it OK that we truncate it like this?</p>
<table>
<thead>
<tr class="header">
<th align="left">key sequence</th>
<th align="left">Displayed output</th>
<th align="left">Notes</th>
</tr>
</thead>
<tbody>
<tr class="odd">
<td align="left">9,9,9,9,9,9,+,9,9,9,9,9,9,=</td>
<td align="left">199999</td>
<td align="left">Our display is limited to six digits only</td>
</tr>
</tbody>
</table>
<p><strong>Jane:</strong> Sure, I do not mind. I do not add such big numbers anyway.</p>
<p><strong>Johnny:</strong> There is still one question we missed. Let’s say that I input a number, then press “+” and then another number without asking for result with “=”. What should I see?</p>
<p><strong>Jane:</strong> Every time you press “+”, the calculator should consider entering current number finished and overwrite it as soon as you press any other digit:</p>
<table>
<thead>
<tr class="header">
<th align="left">key sequence</th>
<th align="left">Displayed output</th>
<th align="left">Notes</th>
</tr>
</thead>
<tbody>
<tr class="odd">
<td align="left">2,+,3</td>
<td align="left">3</td>
<td align="left">Digits entered after + operator are treated as digits of a new number, the previous one is stored</td>
</tr>
</tbody>
</table>
<p><strong>Jane:</strong> Oh, and just asking for result after the calculator is turned on should result in “0”.</p>
<table>
<thead>
<tr class="header">
<th align="left">key sequence</th>
<th align="left">Displayed output</th>
<th align="left">Notes</th>
</tr>
</thead>
<tbody>
<tr class="odd">
<td align="left">=</td>
<td align="left">0</td>
<td align="left">Result key in itself does nothing</td>
</tr>
</tbody>
</table>
<p><strong>Johnny:</strong> Let’s sum up our discoveries:</p>
<table>
<thead>
<tr class="header">
<th align="left">key sequence</th>
<th align="left">Displayed output</th>
<th align="left">Notes</th>
</tr>
</thead>
<tbody>
<tr class="odd">
<td align="left">N/A</td>
<td align="left">0</td>
<td align="left">Initial displayed value</td>
</tr>
<tr class="even">
<td align="left">1,2,3</td>
<td align="left">123</td>
<td align="left">Entered digits are displayed</td>
</tr>
<tr class="odd">
<td align="left">0,0,0</td>
<td align="left">0</td>
<td align="left">Zero is a special case – it is displayed only once</td>
</tr>
<tr class="even">
<td align="left">1,2,3,4,5,6,7</td>
<td align="left">123456</td>
<td align="left">Our display is limited to six digits only</td>
</tr>
<tr class="odd">
<td align="left">2,+,3</td>
<td align="left">3</td>
<td align="left">Digits entered after + operator are treated as digits of a new number, the previous one is stored</td>
</tr>
<tr class="even">
<td align="left">=</td>
<td align="left">0</td>
<td align="left">Result key in itself does nothing</td>
</tr>
<tr class="odd">
<td align="left">+,1,=</td>
<td align="left">1</td>
<td align="left">Addition shortcut – treated as 0+1</td>
</tr>
<tr class="even">
<td align="left">2,+,3,+,4,=</td>
<td align="left">9</td>
<td align="left">Simple addition of numbers</td>
</tr>
<tr class="odd">
<td align="left">9,9,9,9,9,9,+,9,9,9,9,9,9,=</td>
<td align="left">199999</td>
<td align="left">Our display is limited to six digits only</td>
</tr>
</tbody>
</table>
<p><strong>Johnny:</strong> The limiting of digits displayed looks like a whole new feature, so I suggest we add it to the backlog and do it in another sprint. In this sprint, we will not handle such situation at all. How about that, Jane?</p>
<p><strong>Jane:</strong> Fine with me. Looks like a lot of work. Nice that we discovered it up-front. For me, the limiting capability seemed so obvious that I did not even think it would be worth mentioning.</p>
<p><strong>Johnny:</strong> See? That is why I do not like the word “obvious”. Jane, we will get back to you if any more questions arise. For now, I think we know enough to implement these three stories for you.</p>
<p><strong>Jane:</strong> good luck!</p>
<h2 id="act-3-test-driven-development">Act 3: Test-Driven Development</h2>
<p><strong>Benjamin:</strong> Wow, that was cool. Was that Acceptance Test-Driven Development?</p>
<p><strong>Johnny:</strong> In a greatly simplified version, yes. The reason I took you with me was to show you the similarities between working with customer the way we did and working with the code using TDD process. They are both applying the same set of principles, just on different levels.</p>
<p><strong>Benjamin:</strong> I am dying to see it with my own eyes. Shall we start?</p>
<p><strong>Johnny:</strong> Sure. If we followed the ATDD process, we would start writing what we call acceptance-level specification. In our case, however, a unit-level specification will be enough. Let’s take the first example:</p>
<h3 id="statement-1-calculator-should-display-0-on-creation">Statement 1: Calculator should display 0 on creation</h3>
<table>
<thead>
<tr class="header">
<th align="left">key sequence</th>
<th align="left">Displayed output</th>
<th align="left">Notes</th>
</tr>
</thead>
<tbody>
<tr class="odd">
<td align="left">N/A</td>
<td align="left">0</td>
<td align="left">Initial displayed value</td>
</tr>
</tbody>
</table>
<p><strong>Johnny:</strong> Benjamin, try to write the first Statement.</p>
<p><strong>Benjamin:</strong> Boy, I do not know how to start.</p>
<p><strong>Johnny:</strong> start by writing the statement in a plain English. What should the calculator do?</p>
<p><strong>Benjamin:</strong> It should display “0” when I turn the application on.</p>
<p><strong>Johnny:</strong> In our case, “turning on” is creating a calculator. Let’s write it down as a method name:</p>
<pre class="sourceCode java"><code class="sourceCode java"><span class="kw">public</span> <span class="kw">class</span> CalculatorSpecification
{

[Fact] <span class="kw">public</span> <span class="dt">void</span>
<span class="fu">ShouldDisplay0WhenCreated</span>()
{

}

}</code></pre>
<p><strong>Benjamin:</strong> Why is the name of the class <code>CalculatorSpecification</code> and the name of the method <code>ShouldDisplay0WhenCreated</code>?</p>
<p><strong>Johnny:</strong> It is a naming convention. There are many others, but this is the one that I like. The rule is that when you take the name of the class without the <code>Specification</code> part followed by the name of the method, it should form a legit sentence. For instance, if I apply it to what we wrote, it would make a sentence: “Calculator should display 0 when created”.</p>
<p><strong>Benjamin:</strong> Ah, I see now. So it is a statement of behavior, isn’t it?</p>
<p><strong>Johnny:</strong> That is right. Now, the second trick I can sell to you is that if you do not know what code to start with, start with the expected result. In our case, we are expecting that the behavior will end up as displaying “0”, right? So let’s just write it in form of an assertion.</p>
<p><strong>Benjamin:</strong> You mean something like this?</p>
<pre class="sourceCode java"><code class="sourceCode java"><span class="kw">public</span> <span class="kw">class</span> CalculatorSpecification
{

[Fact] <span class="kw">public</span> <span class="dt">void</span>
<span class="fu">ShouldDisplay0WhenCreated</span>()
{
 Assert.<span class="fu">Equal</span>(<span class="st">&quot;0&quot;</span>, displayedResult);
}

}</code></pre>
<p><strong>Johnny:</strong> Precisely.</p>
<p><strong>Benjamin:</strong> But that does not even compile. What use is it?</p>
<p><strong>Johnny:</strong> the code not compiling is the feedback that you needed to proceed. While previously you did not know where to start, now you have a clear goal – make this code compile. Firstly, where do you get the displayed value from?</p>
<p><strong>Benjamin:</strong> From the calculator display, of course!</p>
<p><strong>Johnny:</strong> Then write it down how you get the value form the display.</p>
<p><strong>Benjamin:</strong> like how?</p>
<p><strong>Johnny:</strong> like this:</p>
<pre class="sourceCode java"><code class="sourceCode java"><span class="kw">public</span> <span class="kw">class</span> CalculatorSpecification
{

[Fact] <span class="kw">public</span> <span class="dt">void</span>
<span class="fu">ShouldDisplay0WhenCreated</span>()
{
 var displayedResult = calculator.<span class="fu">Display</span>();

 Assert.<span class="fu">Equal</span>(<span class="st">&quot;0&quot;</span>, displayedResult);
}

}</code></pre>
<p><strong>Benjamin:</strong> I see. Now the calculator is not created anywhere. I need to create it somewhere now or it will not compile and this is my next step. Is this how it works?</p>
<p><strong>Johnny:</strong> Yes, you are catching on quickly.</p>
<p><strong>Benjamin:</strong> Ok then, here goes:</p>
<pre class="sourceCode java"><code class="sourceCode java"><span class="kw">public</span> <span class="kw">class</span> CalculatorSpecification
{

[Fact] <span class="kw">public</span> <span class="dt">void</span>
<span class="fu">ShouldDisplay0WhenCreated</span>()
{
 var calculator = <span class="kw">new</span> <span class="fu">Calculator</span>();

 var displayedResult = calculator.<span class="fu">Display</span>();

 Assert.<span class="fu">Equal</span>(<span class="st">&quot;0&quot;</span>, displayedResult);
}

}</code></pre>
<p><strong>Johnny:</strong> Bravo!</p>
<p><strong>Benjamin:</strong> Now the code still does not compile, because I do not have the <code>Calculator</code> class at all…</p>
<p><strong>Johnny:</strong> sounds like a good reason to create it.</p>
<p><strong>Benjamin:</strong> OK.</p>
<pre class="sourceCode java"><code class="sourceCode java"><span class="kw">public</span> <span class="kw">class</span> Calculator
{
}</code></pre>
<p><strong>Benjamin:</strong> Looks like the <code>Display()</code> method is missing too. I will add it.</p>
<pre class="sourceCode java"><code class="sourceCode java"><span class="kw">public</span> <span class="kw">class</span> Calculator
{
  <span class="kw">public</span> string <span class="fu">Display</span>()
  {
    <span class="kw">return</span> <span class="st">&quot;0&quot;</span>;
  } 
}</code></pre>
<p><strong>Johnny:</strong> Hey hey, not so fast!</p>
<p><strong>Benjamin:</strong> What?</p>
<p><strong>Johnny:</strong> You already provided an implementation that will make our current Statement true. Remember its name? <code>ShouldDisplay0WhenCreated</code> – and that is exactly what the code you wrote does. Before we arrive at this point, let’s make sure this Statement can ever be evaluated as false. You won’t achieve this by providing a correct implementation out of the box. So for now, let’s change it to this:</p>
<pre class="sourceCode java"><code class="sourceCode java"><span class="kw">public</span> <span class="kw">class</span> Calculator
{
  <span class="kw">public</span> string <span class="fu">Display</span>()
  {
    <span class="kw">return</span> <span class="st">&quot;Once upon a time in Africa&quot;</span>;
  } 
}</code></pre>
<p><strong>Johnny:</strong> Look, now we can run the Specification and watch that Statement evaluate to false, because it expects “0”, but gets “Once upon a time in Africa…”.</p>
<p><strong>Benjamin:</strong> Running… Ok, it is false. By the way, do you always use such silly values to make Statements false?</p>
<p><strong>Johnny:</strong> Hahaha, no, I just did it to emphasize the point. Normally, I would write <code>return &quot;&quot;;</code> or something similarly simple. Now we can evaluate the Statement and see it evaluate to false. Now we are sure that we have not yet implemented what is required for the Statement to be true.</p>
<p><strong>Benjamin:</strong> I think I get it. For now, the Statement shows that we do not have something we need and gives us a reason to add this “thing”. When we do so, this Statement will show that we do have what we need. So what do we do now?</p>
<p><strong>Johnny:</strong> Write the simplest thing that makes this Statement true.</p>
<p><strong>Benjamin:</strong> like this?</p>
<pre class="sourceCode java"><code class="sourceCode java"><span class="kw">public</span> <span class="kw">class</span> Calculator
{
  <span class="kw">public</span> string <span class="fu">Display</span>()
  {
    <span class="kw">return</span> <span class="st">&quot;0&quot;</span>;
  } 
}</code></pre>
<p><strong>Johnny:</strong> Yes.</p>
<p><strong>Benjamin:</strong> But that is not a real implementation. What is the value behind putting in a hardcoded string? The final implementation is not going to be like this for sure!</p>
<p><strong>Johnny:</strong> You’re right. The final implementation is most probably going to be different. What we did, however, is still valuable because:</p>
<ol style="list-style-type: decimal">
<li>You’re one step closer to implementing the final solution</li>
<li>This feeling that this is not the final implementation points you towards writing more Statements. When there is enough Statements to make your implementation complete, it usually means that you have a complete Specification of class behaviors as well.</li>
<li>If you treat making every Statement true as an achievement, this practice allows you to evolve your code without losing what you already achieved. If by accident you break any of the behaviors you’ve already implemented, the Specification is going to tell you because one of the existing Statements that were previously true will then evaluate to false. You can then either fix it or undo your changes using version control and start over from the point where all existing Statements were true.</li>
</ol>
<p><strong>Benjamin:</strong> looks like quite a few benefits. Still, I will have to get used to this kind of working.</p>
<p><strong>Johnny:</strong> do not worry, it is central to TDD, so you will grasp it in no time. Now, before we proceed to the next Statement, let’s look at what we already achieved. First, we wrote a Statement that turned out false. Then, we wrote just enough code to make the Statement true. Time for a step called Refactoring. In this step, we will take a look at the Statement and the code and remove duplication. Can you see what is duplicated between the Statement and the code?</p>
<p><strong>Benjamin:</strong> both of them contain the literal “0”. The Statement has it here:</p>
<pre class="sourceCode java"><code class="sourceCode java">Assert.<span class="fu">Equal</span>(<span class="st">&quot;0&quot;</span>, displayedResult);</code></pre>
<p>and the implementation here:</p>
<pre class="sourceCode java"><code class="sourceCode java"><span class="kw">return</span> <span class="st">&quot;0&quot;</span>;</code></pre>
<p><strong>Johnny:</strong> Good, let’s eliminate this duplication by introducing a constant called <code>InitialValue</code>. The Statement will now look like this:</p>
<pre class="sourceCode java"><code class="sourceCode java">[Fact] <span class="kw">public</span> <span class="dt">void</span>
<span class="fu">ShouldDisplayInitialValueWhenCreated</span>()
{
 var calculator = <span class="kw">new</span> <span class="fu">Calculator</span>();

 var displayedResult = calculator.<span class="fu">Display</span>();

 Assert.<span class="fu">Equal</span>(Calculator.<span class="fu">InitialValue</span>, displayedResult);
}</code></pre>
<p>and the implementation:</p>
<pre class="sourceCode java"><code class="sourceCode java"><span class="kw">public</span> <span class="kw">class</span> Calculator
{
  <span class="kw">public</span> <span class="dt">const</span> string InitialValue = <span class="st">&quot;0&quot;</span>;
  <span class="kw">public</span> string <span class="fu">Display</span>()
  {
    <span class="kw">return</span> InitialValue;
  } 
}</code></pre>
<p><strong>Benjamin:</strong> The code looks better and having the constant in one place will make it more maintainable, but I think the Statement in its current form is weaker than before. We could change the <code>InitialValue</code> to anything and the Statement would still be true, since it does not force this constant to be “0”.</p>
<p>That is right. We need to add it to our TODO list to handle this case. Can you write it down?</p>
<p><strong>Benjamin:</strong> Sure. I will write it as “TODO: 0 should be used as an initial value.”</p>
<p><strong>Johnny:</strong> Ok. We should handle it now, especially that it is part of the story we are currently implementing, but I will leave it for later just to show you the power of TODO list in TDD – whatever is on the list, we can forget and get back to when we have nothing better to do. Our next item from the list is this:</p>
<h3 id="statement-2-calculator-should-display-entered-digits">Statement 2: Calculator should display entered digits</h3>
<table>
<thead>
<tr class="header">
<th align="left">key sequence</th>
<th align="left">Displayed output</th>
<th align="left">Notes</th>
</tr>
</thead>
<tbody>
<tr class="odd">
<td align="left">1,2,3</td>
<td align="left">123</td>
<td align="left">Entered digits are displayed</td>
</tr>
</tbody>
</table>
<p><strong>Johnny:</strong> Benjamin, can you come up with a Statement for this behavior?</p>
<p><strong>Benjamin:</strong> I will try. Here goes:</p>
<pre class="sourceCode java"><code class="sourceCode java">[Fact] <span class="kw">public</span> <span class="dt">void</span> 
<span class="fu">ShouldDisplayEnteredDigits</span>()
{
  var calculator = <span class="kw">new</span> <span class="fu">Calculator</span>();
  
  calculator.<span class="fu">Enter</span>(<span class="dv">1</span>);
  calculator.<span class="fu">Enter</span>(<span class="dv">2</span>);
  calculator.<span class="fu">Enter</span>(<span class="dv">3</span>);
  var displayedValue = calculator.<span class="fu">Display</span>();

  Assert.<span class="fu">Equal</span>(<span class="st">&quot;123&quot;</span>, displayedValue);
}</code></pre>
<p><strong>Johnny:</strong> I am glad that you got the part about naming and writing a Statement. One thing we will have to work on here though.</p>
<p><strong>Benjamin:</strong> what is it?</p>
<p><strong>Johnny:</strong> When we talked to Jane, we used examples with real values. These real values were extremely helpful in pinning down the corner cases and uncovering missing scenarios. They were easier to imagine as well, so they were a perfect suit for conversation. If we were automating these examples on acceptance level, we would use those real values as well. When we write unit-level Statements, however, we use a different technique to get this kind of specification more abstract. First of all, let me enumerate the weaknesses of the approach you just used:</p>
<ol style="list-style-type: decimal">
<li>Making a method <code>Enter()</code> accept an integer value suggests that one can enter more than one digit at once, e.g. <code>calculator.Enter(123)</code>, which is not what we want. We could detect such cases and throw exceptions if the value is outside the 0-9 range, but there are better ways when we know we will only be supporting ten digits (0,1,2,3,4,5,6,7,8,9).</li>
<li>The Statement does not clearly show the relationship between input and output. Of course, in this simple case it is pretty self-evident that the sum is a concatenation of entered digits, we do not want anyone who will be reading this Specification in the future to have to guess.</li>
<li>The Statement suggests that what you wrote is sufficient for any value, which isn’t true, since the behavior for “0” is different (no matter how many times we enter “0”, the result is just “0”)</li>
</ol>
<p>Hence, I propose the following:</p>
<pre class="sourceCode java"><code class="sourceCode java">[Fact] <span class="kw">public</span> <span class="dt">void</span> 
<span class="fu">ShouldDisplayAllEnteredDigitsThatAreNotLeadingZeroes</span>()
{
 <span class="co">//GIVEN</span>
 var calculator = <span class="kw">new</span> <span class="fu">Calculator</span>();
 var nonZeroDigit = Any.<span class="fu">Besides</span>(DigitKeys.<span class="fu">Zero</span>);
 var anyDigit1 = Any.<span class="fu">Of</span>&lt;DigitKeys&gt;();
 var anyDigit2 = Any.<span class="fu">Of</span>&lt;DigitKeys&gt;();

 <span class="co">//WHEN</span>
 calculator.<span class="fu">Enter</span>(nonZeroDigit);
 calculator.<span class="fu">Enter</span>(anyDigit1);
 calculator.<span class="fu">Enter</span>(anyDigit2);
          
 <span class="co">//THEN</span>
 Assert.<span class="fu">Equal</span>(
  string.<span class="fu">Format</span>(<span class="st">&quot;{0}{1}{2}&quot;</span>, 
   (<span class="dt">int</span>)nonZeroDigit, 
   (<span class="dt">int</span>)anyDigit1, 
   (<span class="dt">int</span>)anyDigit2
  ),
  calculator.<span class="fu">Display</span>()
 );
}</code></pre>
<p><strong>Benjamin:</strong> Johnny, I am lost! Can you explain what is going on here?</p>
<p><strong>Johnny:</strong> Sure, what do you want to know?</p>
<p><strong>Benjamin:</strong> For instance, what is this <code>DigitKeys</code> type doing here?</p>
<p><strong>Johnny:</strong> It is supposed to be an enumeration (note that it does not exist yet, we just assume that we have it) to hold all the possible digits user can enter, which are 0-9. This is to ensure that user will not write <code>calculator.Enter(123)</code>. Instead of allowing to enter any number and then detecting errors, we are giving our users a choice from among only the valid values.</p>
<p><strong>Benjamin:</strong> Now I get it. So how about the <code>Any.Besides()</code> and <code>Any.Of()</code>? What do they do?</p>
<p><strong>Johnny:</strong> They are methods from a small utility library I am using when writing unit-level Specifications. <code>Any.Besides()</code> returns any value from enumeration besides the one supplied as an argument. Hence, the call <code>Any.Besides(DigitKeys.Zero)</code> means “any of the values contained in DigitKeys enumeration, but not DigitKeys.Zero”.</p>
<p>The <code>Any.Of()</code> is simpler – it just returns any value in an enumeration. Note that when I create the values this way, I state explicitly that this behavior occurs when first digit is non-zero. This technique of using generated values instead of literals has its own principles, but let’s leave it for later. I promise to give you a detailed lecture on it. Agree?</p>
<p><strong>Benjamin:</strong> You better do, because for now, I feel a bit uneasy with generating the values – it seems like the Statement we are writing is getting less deterministic this way. The last question – what about those weird comments you put in the code? Given? When? Then?</p>
<p><strong>Johnny:</strong> Yes, this is a convention that I use, not only in writing, but in thinking as well. I like to think about every behavior in terms of three elements: assumptions (given), trigger (when) and expected result (then). Using the words, we can summarize the Statement we are writing in the following way: “<strong>Given</strong> a calculator, <strong>when</strong> I enter some digits first one being other than zero, <strong>then</strong> they should all be displayed in order they were entered”. This is also something that I will tell you more about later.</p>
<p><strong>Benjamin:</strong> Sure, for now I need just enough detail to understand what is going on – we can talk about the principles, pros and cons later. By the way, the following sequence of casts looks a little bit ugly:</p>
<pre class="sourceCode java"><code class="sourceCode java">string.<span class="fu">Format</span>(<span class="st">&quot;{0}{1}{2}&quot;</span>, 
 (<span class="dt">int</span>)nonZeroDigit, 
 (<span class="dt">int</span>)anyDigit1, 
 (<span class="dt">int</span>)anyDigit2
)</code></pre>
<p><strong>Johnny:</strong> We will get back to it and make it more “smarter” in a second after we make this statement true. For now, we need something obvious. Something we know works. let’s evaluate this Statement. What is the result?</p>
<p><strong>Benjamin:</strong> Failed, expected “331”, but was “0”.</p>
<p><strong>Johnny:</strong> Good, now let’s write some code to make this Statement true. First, we’re going to introduce an enumeration of digits:</p>
<pre class="sourceCode java"><code class="sourceCode java"><span class="kw">public</span> <span class="kw">enum</span> DigitKeys
{
 Zero = <span class="dv">0</span>,
 TODO1, <span class="co">//TODO</span>
 TODO2, <span class="co">//TODO</span>
 TODO3, <span class="co">//TODO</span>
 TODO4, <span class="co">//TODO</span>
}</code></pre>
<p><strong>Benjamin:</strong> What is with all those bogus values? Should we not just enter all the digits we support?</p>
<p><strong>Johnny:</strong> Nope, not yet. We still do not have a Statement which would say what digits are supported and thus make us add them, right?.</p>
<p><strong>Benjamin:</strong> You say you need a Statement for an element to be in an enum??</p>
<p><strong>Johnny:</strong> This is a specification we are writing, remember? It should say somewhere which digits we support, should it not?</p>
<p><strong>Benjamin:</strong> It is difficult to agree with, especially that I am used to write unit tests, not Statements and in unit tests, I wanted to verify what I was unsure of.</p>
<p><strong>Johnny:</strong> I will try to give you more arguments later. For now, just bear with me and note that adding such Statement will be almost effortless.</p>
<p><strong>Benjamin:</strong> OK.</p>
<p><strong>Johnny:</strong> Now for the implementation. Just to remind you – up to now, it looked like this:</p>
<pre class="sourceCode java"><code class="sourceCode java"><span class="kw">public</span> <span class="kw">class</span> Calculator
{
 <span class="kw">public</span> <span class="dt">const</span> string InitialValue = <span class="st">&quot;0&quot;</span>;
 <span class="kw">public</span> string <span class="fu">Display</span>()
 {
  <span class="kw">return</span> InitialValue;
 } 
}</code></pre>
<p>This is not enough to support displaying multiple digits (as we saw, because the Statement saying they should be supported was evaluated to false). So let’s evolve the code to handle this case:</p>
<pre class="sourceCode java"><code class="sourceCode java"><span class="kw">public</span> <span class="kw">class</span> Calculator
{
 <span class="kw">private</span> <span class="dt">int</span> _result = <span class="dv">0</span>;
      
 <span class="kw">public</span> <span class="dt">void</span> <span class="fu">Enter</span>(DigitKeys digit)
 {
  _result *= <span class="dv">10</span>;
  _result += (<span class="dt">int</span>)digit; 
 }

 <span class="kw">public</span> string <span class="fu">Display</span>()
 {
  <span class="kw">return</span> _result.<span class="fu">ToString</span>();
 }
}</code></pre>
<p><strong>Johnny:</strong> Now the Statement is true so we can go back to it and make it a little bit prettier. Let’s take a second look at it:</p>
<pre class="sourceCode java"><code class="sourceCode java">[Fact] <span class="kw">public</span> <span class="dt">void</span> 
<span class="fu">ShouldDisplayAllEnteredDigitsThatAreNotLeadingZeroes</span>()
{
 <span class="co">//GIVEN</span>
 var calculator = <span class="kw">new</span> <span class="fu">Calculator</span>();
 var nonZeroDigit = Any.<span class="fu">Besides</span>(DigitKeys.<span class="fu">Zero</span>);
 var anyDigit1 = Any.<span class="fu">Of</span>&lt;DigitKeys&gt;();
 var anyDigit2 = Any.<span class="fu">Of</span>&lt;DigitKeys&gt;();
          
 <span class="co">//WHEN</span>
 calculator.<span class="fu">Enter</span>(nonZeroDigit);
 calculator.<span class="fu">Enter</span>(anyDigit1);
 calculator.<span class="fu">Enter</span>(anyDigit2);
          
 <span class="co">//THEN</span>
 Assert.<span class="fu">Equal</span>(
  string.<span class="fu">Format</span>(<span class="st">&quot;{0}{1}{2}&quot;</span>, 
   (<span class="dt">int</span>)nonZeroDigit, 
   (<span class="dt">int</span>)anyDigit1, 
   (<span class="dt">int</span>)anyDigit2
  ),
  calculator.<span class="fu">Display</span>()
 );
}</code></pre>
<p><strong>Johnny:</strong> Remember you said that you do not like the part where <code>string.Format()</code> is used?</p>
<p><strong>Benjamin:</strong> Yeah, it seems a bit unreadable.</p>
<p><strong>Johnny:</strong> Let’s extract this part into a utility method and make it more general – we will need a way of constructing expected displayed output in many of our future Statements. Here is my go at this helper method:</p>
<pre class="sourceCode java"><code class="sourceCode java">string <span class="fu">StringConsistingOf</span>(params DigitKeys[] digits)
{
 var result = string.<span class="fu">Empty</span>;
      
 <span class="fu">foreach</span>(var digit in digits) 
 {
  result += (<span class="dt">int</span>)digit;
 }
 <span class="kw">return</span> result;
}</code></pre>
<p>Note that this is more general as it supports any number of parameters. And the Statement after this extraction looks like this:</p>
<pre class="sourceCode java"><code class="sourceCode java">[Fact] <span class="kw">public</span> <span class="dt">void</span> 
<span class="fu">ShouldDisplayAllEnteredDigitsThatAreNotLeadingZeroes</span>()
{
 <span class="co">//GIVEN</span>
 var calculator = <span class="kw">new</span> <span class="fu">Calculator</span>();
 var nonZeroDigit = Any.<span class="fu">Besides</span>(DigitKeys.<span class="fu">Zero</span>);
 var anyDigit1 = Any.<span class="fu">Of</span>&lt;DigitKeys&gt;();
 var anyDigit2 = Any.<span class="fu">Of</span>&lt;DigitKeys&gt;();
          
 <span class="co">//WHEN</span>
 calculator.<span class="fu">Enter</span>(nonZeroDigit);
 calculator.<span class="fu">Enter</span>(anyDigit1);
 calculator.<span class="fu">Enter</span>(anyDigit2);
          
 <span class="co">//THEN</span>
 Assert.<span class="fu">Equal</span>(
  <span class="fu">StringConsistingOf</span>(nonZeroDigit, anyDigit1, anyDigit2),
  calculator.<span class="fu">Display</span>()
 );
}</code></pre>
<p><strong>Benjamin:</strong> Looks better to me. The Statement is still evaluated as true, which means we got it right, did we not?</p>
<p><strong>Johnny:</strong> Not exactly. With moves such as this one, I like to be extra careful. Let’s comment out the body of the <code>Enter()</code> method and see if this Statement can still be made false by the implementation:</p>
<pre class="sourceCode java"><code class="sourceCode java"><span class="kw">public</span> <span class="dt">void</span> <span class="fu">Enter</span>(DigitKeys digit)
 {
  <span class="co">//_result *= 10;</span>
  <span class="co">//_result += (int)digit; </span>
 }</code></pre>
<p><strong>Benjamin:</strong> Running… Ok, it is false now. Expected “243”, got “0”.</p>
<p><strong>Johnny:</strong> good, now we are pretty sure that it works OK. Let’s uncomment the lines we just commented out and move forward.</p>
<h3 id="statement-3-calculator-should-display-only-one-zero-digit-if-it-is-the-only-entered-digit-even-if-it-is-entered-multiple-times">Statement 3: Calculator should display only one zero digit if it is the only entered digit even if it is entered multiple times</h3>
<p><strong>Johnny:</strong> Benjamin, this should be easy for you, so go ahead and try it. It is really a variation of previous Statement.</p>
<p><strong>Benjamin:</strong> Let me try… ok, here it is:</p>
<pre class="sourceCode java"><code class="sourceCode java">[Fact] <span class="kw">public</span> <span class="dt">void</span> 
<span class="fu">ShouldDisplayOnlyOneZeroDigitWhenItIsTheOnlyEnteredDigitEvenIfItIsEnteredMultipleTimes</span>()
{
 var zero = DigitKeys.<span class="fu">Zero</span>;
 var calculator = <span class="kw">new</span> <span class="fu">Calculator</span>();
      
 calculator.<span class="fu">Enter</span>(zero);
 calculator.<span class="fu">Enter</span>(zero);      
 calculator.<span class="fu">Enter</span>(zero);
      
 Assert.<span class="fu">Equal</span>(
  <span class="fu">StringConsistingOf</span>(DigitKeys.<span class="fu">Zero</span>), 
  calculator.<span class="fu">Display</span>()
 );
}</code></pre>
<p><strong>Johnny:</strong> Good, you are learning fast! Let’s evaluate this Statement.</p>
<p><strong>Benjamin:</strong> It seems that our current code already fulfills the Statement. Should I try to comment some code to make sure this Statement can fail just like you did in the previous Statement?</p>
<p><strong>Johnny:</strong> That would be wise thing to do. When a Statement is true without requiring you to change any production code, it is always suspicious. Just like you said, we have to modify production code for a second to force this Statement to be false, then undo this modification to make it true again. This isn’t as obvious as previously, so let me do it. I will mark all the added lines with <code>//+</code> comment so that you can see them easily:</p>
<pre class="sourceCode java"><code class="sourceCode java"><span class="kw">public</span> <span class="kw">class</span> Calculator
{
 <span class="dt">int</span> _result = <span class="dv">0</span>;
 string fakeResult = <span class="st">&quot;0&quot;</span>; <span class="co">//+</span>
      
 <span class="kw">public</span> <span class="dt">void</span> <span class="fu">Enter</span>(DigitKeys digit)
 {
  _result *= <span class="dv">10</span>;
  _result += (<span class="dt">int</span>)digit; 
  <span class="kw">if</span>(digit == DigitKeys.<span class="fu">Zero</span>) <span class="co">//+</span>
  {  <span class="co">//+</span>
   fakeResult += <span class="st">&quot;0&quot;</span>;  <span class="co">//+</span>
  } <span class="co">//+</span>
 }

 <span class="kw">public</span> string <span class="fu">Display</span>()
 {
  <span class="kw">if</span>(_result == <span class="dv">0</span>)  <span class="co">//+</span>
  {  <span class="co">//+</span>
   <span class="kw">return</span> fakeResult;  <span class="co">//+</span>
  }  <span class="co">//+</span>
  <span class="kw">return</span> _result.<span class="fu">ToString</span>();
 }
}</code></pre>
<p><strong>Benjamin:</strong> Wow, looks like a lot of code just to make the Statement false! Is it worth the hassle? We will undo this whole modification in a second anyway</p>
<p><strong>Johnny:</strong> Depends on how confident you want to feel. I would say that it is usually worth it – at least you know that you got everything right. It might seem like a lot of work, but it actually took me about a minute to add this code and imagine you got it wrong and had to debug it on a production environment. _That_ would be a waste of time.</p>
<p><strong>Benjamin:</strong> Ok, I think I get it. Since we saw this Statement turn false, I will undo this modification to make it true again.</p>
<p><strong>Johnny:</strong> Sure.</p>
<h2 id="epilogue">Epilogue</h2>
<p>Time to leave Johnny and Benjamin, at least for now. I actually planned to make this chapter longer, and cover all the other operations, but I fear I would make this too long and get you bored. You should have a feel of how the TDD cycle looks like, especially that Johnny and Benjamin had a lot of conversations on many other topics in the meantime. I will be revisiting these topics later in the book. For now, so if you felt lost or unconvinced on any of the topics mentioned by Johnny, do not worry – I do not expect you to be proficient with any of the techniques shown in this chapter just yet. Time will come for that.</p>
<h1 id="sorting-out-the-bits">Sorting Out The Bits</h1>
<p>In the previous chapter, there has been a lively conversation between Johnny and Benjamin. Even in such a short session, Benjamin, as a TDD novice, had a lot of questions and a lot of things he needed sorted out. We will pick up all those questions and explain them one by one. Here they are:</p>
<ul>
<li>How to name a Statement?</li>
<li>How to start writing a Statement?</li>
<li>How is TDD about analysis and what does this “GIVEN-WHEN-THEN” mean?</li>
<li>What exactly is the scope of a Statement? A class, a method, or something else?</li>
<li>What is the role of TODO list in TDD?</li>
<li>Why use anonymous generated values instead of literals as input of a specified behavior?</li>
<li>Why and how to use the Any class?</li>
<li>What code to extract from a Statement to shared utility method?</li>
<li>Why such a strange approach to create enumerated constants?</li>
</ul>
<p>A lot of questions, isn’t it? It is unfortunate that TDD has this high entry barrier, at least for someone used to the traditional way of writing code. Anyway, that is what this tutorial is for – to answer such questions and lower this barrier. Thus, we will try to answer those questions one by one.</p>
<h1 id="how-to-start">How to start?</h1>
<p>Whenever I sat down with a person that was about to write their first code in a Statement-first manner, the person would first stare at the screen, then at me, then would say: “what now?”. It is easy to say: “You know how to write code, you know how to write a unit test for it, just this time start with the latter rather than the first”, but for many people, this is something that blocks them completely. If you are one of them, do not worry – you are not alone. I decided to dedicate this chapter solely to techniques for kicking off a Statement when there is no code.</p>
<h2 id="start-with-agood-name">Start with a good name</h2>
<p>It may sound obvious, but some people are having serious trouble describing the behavior they expect from their code. If you can name such behavior, it is a great starting point.</p>
<p>I know not everybody pays attention to naming their Statements, mainly because the Statements are considered as tests and second-level citizens – as long as they run and “prove the code does not contain defects”, they are considered sufficient. We will take a look at some examples of bad names and then I will introduce to you some rules of good naming.</p>
<h3 id="consequences-of-bad-naming">Consequences of bad naming</h3>
<p>As I said, many people do not really care how their Statements are named. This is a symptom of treating the Specification as garbage or leftovers – such situation is dangerous, because as soon as this kind of thinking is established, it leads to bad, unmaintainable Specification that looks more like lumps of accidental code put together in a haste than a living documentation. Imagine that your Specification consists of names like this:</p>
<ul>
<li><code>TrySendPacket()</code></li>
<li><code>TrySendPacket2()</code></li>
<li><code>testSendingManyPackets()</code></li>
<li><code>testWrongPacketOrder1()</code></li>
<li><code>testWrongPacketOrder2()</code></li>
</ul>
<p>and try for yourself how difficult it is to answer the following questions:</p>
<ol style="list-style-type: decimal">
<li>How do you know what situation each Statement describes?</li>
<li>How do you know whether the Statement describes a single situation, or few of them at the same time?</li>
<li>How do you know whether the assertions inside those Statements are really the right ones assuming each Statement was written by someone else or a long time ago?</li>
<li>How do you know whether the Statement should stay or be removed when you modify the functionality it specifies?</li>
<li>If your changes in production code make a Statement evaluate to false, how do you know whether the Statement is no longer correct or the production code is wrong?</li>
<li>How do you know whether you will not introduce a duplicate Statement for a behavior that is already specified by another Statement when adding to Specification originally created by another team member?</li>
<li>How do you estimate, by looking at the runner tool report, whether the fix for failing Statement will be easy or not?</li>
<li>How do you answer a new developer in your team when they ask you “what is this Statement for?”</li>
<li>How can you keep track of the Statements already made about the specified class vs those that still need to be made?</li>
</ol>
<h3 id="what-does-agood-name-contain">What does a good name contain?</h3>
<p>For the name of the Statement to be of any use, it has to describe the expected behavior. At minimum, it should describe what happens under what circumstances. let’s take a look at one of the names Steve freeman and Nat Pryce came up in their great book Growing Object Oriented Software Guided By Tests:</p>
<pre class="sourceCode java"><code class="sourceCode java"><span class="fu">notifiesListenersThatServerIsUnavailableWhenCannotConnectToItsMonitoringPort</span>()</code></pre>
<p>Note few things about the name of the Statement:</p>
<ol style="list-style-type: decimal">
<li>It describes a behavior of an instance of a specified class. Note that it does not contain method name that triggers the behavior, because what is specified is not a method, but the behavior itself. The Statement name simply tells what an instance does (“notifies listeners that server is unavailable”) under certain circumstances (“when cannot connect to its monitoring port”). It is important because such description is what you can derive from thinking about responsibilities of a class, so you do not need to know any of its method signature or the code that is inside of the class. Hence, this is something you can come up with before implementing – you just need to know why you created this class and build on this knowledge.</li>
<li><p>The name is relatively long. Really, really, <strong>really</strong> do not worry about it. As long as you are describing a single behavior, it’s fine. I know usually people are hesitant to give long names to the Statements, because they try to apply the same rules to those names as to method names in production code (and in production code too long method name can be a sign of it having too many responsibilities). Let me make it clear – these two cases are different. In case of Statements, methods are not invoked by anyone besides the automatic runner applications, so they will not obfuscate any code that would need to call them with their long names. Sure, we could put all the information in the comment instead of Statement name and leave the name short, like this:</p>
<pre class="csharp"><code>[Fact]
//Notifies listeners that server 
//is unavailable when cannot connect
//to its monitoring port
public void Statement_002()
{
  //...
}</code></pre>
<p>There are two downsides to this solution: one is that we now have to put extra information (<code>Statement_002</code>) which is required only by compiler, because every method needs to have a name – there is usually no value a human could derive from such a name. The second downside is that when the Statement is evaluated to false, the automated runner shows you the following line: <code>Statement_002: FAILED</code> – note that all the information included in the comment isn’t present in the failure report. It is really better to receive a report such as:</p>
<p><code>notifiesListenersThatServerIsUnavailableWhenCannotConnectToItsMonitoringPort: FAILED</code></p>
<p>because then a lot of information about the Statement that fails is available from the runner window.</p></li>
<li><p>Using a name that describes a (single) behavior allows you to track quickly why the Statement is false when it is. Suppose a Statement is true when you start refactoring, but at one point it starts being evaluated as false and the report in the runner looks like this: <code>TrySendingHttpRequest: FAILED</code> – it does not really tell you anything more than that an attempt is made to send a HTTP request, but, for instance, does not tell you whether your specified object is the sender (that should try to send this request under some circumstances) or the receiver (that should handle such request properly). To actually know what went wrong, you have to go Statement body and scan its source code. Now compare it to the following name: <code>ShouldRespondWithAnAckWheneverItReceivesAHttpRequest</code>. Now when it evaluates to false, you can tell what is broken – the object no longer responds with an ACK to HTTP request. Sometimes this is enough to identify which part of the code is in fault of this evaluation failure.</p></li>
</ol>
<h3 id="my-favourite-convention">My favourite convention</h3>
<p>There are many conventions for naming Statements appropriately. My favorite is the one developed by Dan North, which makes each Statement name begin with the word <code>Should</code>. So for example, I would name a Statement:</p>
<p><code>ShouldReportAllErrorsSortedAlphabeticallyWhenErrorsOccurDuringSearch()</code></p>
<p>The name of the Specification (i.e. class name) answers the question “who should do it?”, i.e. when I have a class named <code>SortingOperation</code> and want to say that it “should sort all items in ascending order when performed”, I say it like this:</p>
<pre class="sourceCode java"><code class="sourceCode java"><span class="kw">public</span> <span class="kw">class</span> SortingOperationSpecification
{
 [Fact] <span class="kw">public</span> <span class="dt">void</span>
 <span class="fu">ShouldSortAllItemsInAscendingOrderWhenPerformed</span>()
 {
 }
}</code></pre>
<p>The “should” word was introduced by Dan to weaken the statement following it and thus, to allow questioning what you are stating and ask yourself the question: “should it really?”. If this causes uncertainty, then it is high time to talk to a domain expert and make sure you understand well what you need to accomplish. If you are not a native English speaker, the “should” prefix will probably have a weaker influence on you – that is why I don’t insist on you using it. I like it though.</p>
<p>When inventing a name, It is important to put the main focus on what result or action is expected from an object. If you do not, you quickly find it troublesome. As an example, one of my colleagues was specifying a class <code>UserId</code> and wrote the following name for the Statement about comparison of two identifiers:</p>
<p><code>EqualOperationShouldPassForTwoInstancesWithTheSameUserName()</code>.</p>
<p>Note that this is not from the perspective of a single object, but rather from the perspective of an operation that is executed on it, which means that we stopped thinking in terms of object responsibilities and started thinking in terms of operation correctness, which is farther away from our assumption that we are writing a Specification consisting of Statements. This name should be something more like:</p>
<p><code>ShouldReportThatItIsEqualToAnotherIdThatHasTheSameUserName()</code>.</p>
<p>In general, when I find myself having trouble with naming like this, I am suspicious of the following things possibly happening:</p>
<ol style="list-style-type: decimal">
<li>I am not specifying a behavior class, but rather an outcome of a method</li>
<li>I am specifying more than one behavior</li>
<li>The behavior is too complicated and hence I need to change my design (more on this later)</li>
<li>I am naming the behavior on too low level of abstraction, putting too many details in the name - my personal rule is that I can only come to this conclusion when all the previous points fail me.</li>
</ol>
<h3 id="but-cant-the-name-really-get-too-long">But can’t the name really get too long?</h3>
<p>Few paragraphs ago, I told you not to worry about a length of Statement names. But I have to admit that there are times when the name really gets too long. A rule I try to follow is that a name of a Statement should be more readable than its content. Thus, if it takes me less time to understand the point of a Statement by reading its body than by reading its name, then the name is too long. In such case, I try to apply the heuristics described above to find and fix the root cause of the problem.</p>
<h2 id="start-by-filling-the-given-when-then-structure-with-the-obvious">Start by filling the GIVEN-WHEN-THEN structure with the obvious</h2>
<p>This is a technique that is applicable when you come up with a GIVEN-WHEN-THEN structure for the Statement or a good name for it (GIVEN-WHEN-THEN structure can be easily derived from a good name and vice versa). Anyway, this technique is about taking the GIVEN, WHEN and THEN parts and translating them into code in almost literal, brute-force way, then add all the missing pieces that are required for the code to compile and run.</p>
<h3 id="example">Example</h3>
<p>let’s try this on a simple problem of comparing two users. We assume that a user should be equal to another when it has the same name as the other one:</p>
<pre class="gherkin"><code>Given a user with any name
When I compare it to another user with the same name
Then it should appear equal to this other user</code></pre>
<p>Let’s start with the translation</p>
<p>The first line:</p>
<pre class="gherkin"><code>Given a user with any name</code></pre>
<p>can be translated literally to code like this:</p>
<pre class="sourceCode java"><code class="sourceCode java">var user = <span class="kw">new</span> <span class="fu">User</span>(anyName);</code></pre>
<p>Then the second line:</p>
<pre class="gherkin"><code>When I compare it to another user with the same name</code></pre>
<p>can be written as:</p>
<pre class="sourceCode java"><code class="sourceCode java">user.<span class="fu">Equals</span>(anotherUserWithTheSameName);</code></pre>
<p>Great! Now the last line:</p>
<pre class="gherkin"><code>Then it should appear equal to this other user</code></pre>
<p>and its translation into the code:</p>
<pre class="sourceCode java"><code class="sourceCode java">Assert.<span class="fu">True</span>(areUsersEqual);</code></pre>
<p>Ok, so we have made the translation, now let’s summarize this and see what is missing to make this code compile:</p>
<pre class="sourceCode java"><code class="sourceCode java">[Fact] <span class="kw">public</span> <span class="dt">void</span> 
<span class="fu">ShouldAppearEqualToAnotherUserWithTheSameName</span>()
{
  <span class="co">//GIVEN</span>
  var user = <span class="kw">new</span> <span class="fu">User</span>(anyName);

  <span class="co">//WHEN</span>
  user.<span class="fu">Equals</span>(anotherUserWithTheSameName);

  <span class="co">//THEN</span>
  Assert.<span class="fu">True</span>(areUsersEqual);
}</code></pre>
<p>As we expected, this will not compile. Notably, our compiler might point us towards the following gaps:</p>
<ol style="list-style-type: decimal">
<li>A declaration of <code>anyName</code> variable.</li>
<li>A declaration of <code>anotherUserWithTheSameName</code> object.</li>
<li>The variable <code>areUsersEqual</code> is both not declared and it does not hold the comparison result.</li>
<li>If this is our first Statement, we might not even have the <code>User</code> class defined at all.</li>
</ol>
<p>The compiler created a kind of a small TODO list for us, which is nice. Note that, while we do not have full compiling code, filling the gaps boils down to making a few trivial declarations and assignments:</p>
<ol style="list-style-type: decimal">
<li><p><code>anyName</code> can be declared as</p>
<p><code>var anyName = Any.String();</code></p></li>
<li><p><code>anotherUserWithTheSameName</code> can be declared as</p>
<p><code>var anotherUserWithTheSameName = new User(anyName);</code></p></li>
<li><p><code>areUsersEqual</code> can be declared and assigned this way:</p>
<p><code>var areUsersEqual = user.Equals(anotherUserWithTheSameName);</code></p></li>
<li><p>If <code>User</code> class does not exist, we can add it by simply stating:</p>
<p><code>public class User {}</code></p></li>
</ol>
<p>Putting it all together:</p>
<pre class="sourceCode java"><code class="sourceCode java">[Fact] <span class="kw">public</span> <span class="dt">void</span> 
<span class="fu">ShouldAppearEqualToAnotherUserWithTheSameName</span>()
{
  <span class="co">//GIVEN</span>
  var anyName = Any.<span class="fu">String</span>();
  var user = <span class="kw">new</span> <span class="fu">User</span>(anyName);
  var anotherUserWithTheSameName = <span class="kw">new</span> <span class="fu">User</span>(anyName);

  <span class="co">//WHEN</span>
  var areUsersEqual = user.<span class="fu">Equals</span>(anotherUserWithTheSameName);

  <span class="co">//THEN</span>
  Assert.<span class="fu">True</span>(areUsersEqual);
}</code></pre>
<p>And that’s it – the Statement is complete!</p>
<h2 id="start-from-the-end">Start from the end</h2>
<p>This is a technique that I suggest to people that seem to have absolutely no idea how to start. I got it from Kent Beck’s book Test Driven Development by Example. It seems funny at start, but is quite powerful. The trick is to write the Statement ‘backwards’, i.e. starting with what the Statement asserts to be true (in terms of the GIVEN-WHEN-THEN structure, we would say that we start with our THEN).</p>
<p>This works because, while we are many times quite sure of our goal (i.e. what the outcome of the behavior should be), but are unsure of how to get there.</p>
<h3 id="example-1">Example</h3>
<p>Imagine we are writing a class for granting access to a reporting functionality based on roles. We do not have any idea what the API should look like and how to write our Statement, but we know one thing: in our domain the access can be either granted or denied. Let’s take the successful case (just because it is the first one we can think of) and, starting backwards, start with the following assertion:</p>
<pre class="sourceCode java"><code class="sourceCode java"><span class="co">//THEN</span>
Assert.<span class="fu">True</span>(accessGranted);</code></pre>
<p>Ok, that part was easy, but did we make any progress with that? Of course we did – we now have a non-compiling code and the compilation error is because of the <code>accessGranted</code> variable. Now, in contrast to the previous approach (with translating our GIVEN-WHEN-THEN structure into a Statement), our goal is not to make this compile as soon as possible. The goal is to answer ourselves a question: how do I know whether the access is granted or not? The answer: it is the result of authorization of the allowed role. Ok, so let’s just write it down, ignoring everything that stands in our way (I know that most of us have a habit to add a class or a variable as soon as we find out that we need it. If you are like that, then please turn off this habit while writing Statements – it will only throw you off the track and steal your focus from what is important. The key to doing TDD successfully is to learn to use something that does not exist yet like it existed):</p>
<pre class="sourceCode java"><code class="sourceCode java"><span class="co">//WHEN</span>
var accessGranted 
 = authorization.<span class="fu">IsAccessToReportingGrantedTo</span>(
  roleAllowedToUseReporting);</code></pre>
<p>Note that we do not know what <code>roleAllowedToUseReporting</code> is, neither do we know what is <code>authorization</code>, but that did not stop us from writing this line. Also, the <code>IsAccessToReportingGrantedTo()</code> method is just taken from the top of our head. It is not defined anywhere, it just made sense to write it like this, because it is the most direct translation of what we had in mind.</p>
<p>Anyway, this new line answers the question on where do we take the <code>accessGranted</code> from, but makes us ask further questions:</p>
<ol style="list-style-type: decimal">
<li>Where does the <code>authorization</code> variable come from?</li>
<li>Where does the <code>roleAllowedToUseReporting</code> variable come from?</li>
</ol>
<p>As for <code>authorization</code>, we do not have anything specific to say about it other than that it is an object of a class that we do not have yet. In order to proceed, let’s pretend that we have such a class. How do we call it? The instance name is <code>authorization</code>, so it is quite straightforward to name the class <code>Authorization</code> and instantiate it in the simplest way we can think of:</p>
<pre class="sourceCode java"><code class="sourceCode java"><span class="co">//GIVEN</span>
var authorization = <span class="kw">new</span> <span class="fu">Authorization</span>();</code></pre>
<p>Now for the <code>roleAllowedToUseReporting</code>. The first question that comes to mind when looking at this is: which roles are allowed to use reporting? Let’s assume that in our domain, this is either an Administrator or an Auditor. Thus, we know what is going to be the value of this variable. As for the type, there are various ways we can model a role, but the most obvious one for a type that has few possible values is an enum. So:</p>
<pre class="sourceCode java"><code class="sourceCode java"><span class="co">//GIVEN</span>
var roleAllowedToUseReporting = Any.<span class="fu">Of</span>(Roles.<span class="fu">Admin</span>, Roles.<span class="fu">Auditor</span>);</code></pre>
<p>And so, working our way backwards, we have arrived at the final solution (we still need to give this Statement a name, but, provided what we already know, this is an easy task):</p>
<pre class="sourceCode java"><code class="sourceCode java">[Fact] <span class="kw">public</span> <span class="dt">void</span>
<span class="fu">ShouldAllowAccessToReportingWhenAskedForEitherAdministratorOrAuditor</span>()
{
 <span class="co">//GIVEN</span>
 var roleAllowedToUseReporting = Any.<span class="fu">Of</span>(Roles.<span class="fu">Admin</span>, Roles.<span class="fu">Auditor</span>);
 var authorization = <span class="kw">new</span> <span class="fu">Authorization</span>();

 <span class="co">//WHEN</span>
 var accessGranted = authorization
  .<span class="fu">IsAccessToReportingGrantedTo</span>(roleAllowedToUseReporting);

 <span class="co">//THEN</span>
 Assert.<span class="fu">True</span>(accessGranted);
}</code></pre>
<h2 id="start-by-invoking-amethod-when-you-have-one">Start by invoking a method when you have one</h2>
<p>Sometimes, we have to add a new class that implements an existing interface required by another class. The fact of implementing an interface imposes what methods should the new class support. If this point is already decided, we can start our Statement by first calling the method and then discovering what we need to supply.</p>
<h3 id="example-2">Example</h3>
<p>Suppose we have an application holding a lot of data that, among other things, handles importing am existing database from another instance of the application. As importing a database can be a lengthy process, a message box is displayed each time when user chooses to perform the import and this message box displays the following message: “Johnny, please sit down and enjoy your coffee for a few minutes as we take time to import your database” (given user name is Johnny). The class that implements it looks like this:</p>
<pre class="sourceCode java"><code class="sourceCode java"><span class="kw">public</span> <span class="kw">class</span> FriendlyMessages
{
  <span class="kw">public</span> string 
  <span class="fu">HoldOnASecondWhileWeImportYourDatabase</span>(string userName)
  {
    <span class="kw">return</span> string.<span class="fu">Format</span>(<span class="st">&quot;{0}, &quot;</span>
      + <span class="st">&quot;please sit down and enjoy your coffee &quot;</span>
      + <span class="st">&quot;for a few minutes as we take time &quot;</span>
      + <span class="st">&quot;to import your database&quot;</span>,
      userName);
  }
}</code></pre>
<p>Now, imagine that our management told us that they need to ship a trial version with some features disabled, including importing an existing database. Among all the things we need to do to make it happen, we also need to display a different string with message saying that this is a trial version and the feature is locked. We can do it by extracting an interface from the <code>FriendlyMessages</code> class and using it to put in an instance of another class implementing this interface when the application discovers that it is being run as a trial version. The extracted interface looks like this:</p>
<pre class="sourceCode java"><code class="sourceCode java"><span class="kw">public</span> <span class="kw">interface</span> Messages
{
  string <span class="fu">HoldOnASecondWhileWeImportYourDatabase</span>(string userName);
}</code></pre>
<p>So our new implementation is forced to support the <code>HoldOnASecondWhileWeImportYourDatabase</code> method. Thus, we when implementing the class, we start with the following:</p>
<pre class="sourceCode java"><code class="sourceCode java"><span class="kw">public</span> <span class="kw">class</span> TrialVersionMessages : Messages
{
 <span class="kw">public</span> string <span class="fu">HoldOnASecondWhileWeImportYourDatabase</span>(string userName)
 {
   <span class="kw">throw</span> <span class="kw">new</span> <span class="fu">NotImplementedException</span>();
 }
}</code></pre>
<p>Now, we are ready to start writing a Statement. Assuming we do not know where to start, we just start with creating an object and invoking the method that needs to be implemented:</p>
<pre class="sourceCode java"><code class="sourceCode java">[Fact] 
<span class="kw">public</span> <span class="dt">void</span> <span class="fu">TODO</span>()
{
 <span class="co">//GIVEN</span>
 var trialMessages = <span class="kw">new</span> <span class="fu">TrialVersionMessages</span>();
 
 <span class="co">//WHEN</span>
 trialMessages.<span class="fu">HoldOnASecondWhileWeImportYourDatabase</span>();

 <span class="co">//THEN</span>
 Assert.<span class="fu">True</span>(<span class="kw">false</span>); <span class="co">//to remember about it</span>
}</code></pre>
<p>As you can see, we added an assertion that always fails at the end because we do not have any assertions yet and the Statement would otherwise be already evaluated as true and we would rather have it remind ourselves that it is not finished. Other than this, the Statement does not compile anyway, because the method <code>HoldOnASecondWhileWeImportYourDatabase</code> takes a string argument and we passed none. This makes us ask the question what is this argument and what is its role in the behavior triggered by the <code>HoldOnASecondWhileWeImportYourDatabase</code> method. Seems like it is a user name and we want it to be somewhere in the result of the method. Thus, we can add it to the Statement like this:</p>
<pre class="sourceCode java"><code class="sourceCode java">[Fact] 
<span class="kw">public</span> <span class="dt">void</span> <span class="fu">TODO</span>()
{
 <span class="co">//GIVEN</span>
 var trialMessages = <span class="kw">new</span> <span class="fu">TrialVersionMessages</span>();
 var userName = Any.<span class="fu">String</span>();
 
 <span class="co">//WHEN</span>
 trialMessages.
  <span class="fu">HoldOnASecondWhileWeImportYourDatabase</span>(userName);

 <span class="co">//THEN</span>
 Assert.<span class="fu">True</span>(<span class="kw">false</span>); <span class="co">//to remember about it</span>
}</code></pre>
<p>Now, this compiles but is evaluated as false because of the guard assertion that we put at the end. Our goal is to substitute it with a real assertion for a real expected result. The return value of the <code>HoldOnASecondWhileWeImportYourDatabase</code> is a string message, so all we need to do is to come up with the message that we expect in case of trial version:</p>
<pre class="sourceCode java"><code class="sourceCode java">[Fact] 
<span class="kw">public</span> <span class="dt">void</span> <span class="fu">TODO</span>()
{
 <span class="co">//GIVEN</span>
 var trialMessages = <span class="kw">new</span> <span class="fu">TrialVersionMessages</span>();
 var userName = Any.<span class="fu">String</span>();
 
 <span class="co">//WHEN</span>
 var message = trialMessages.
  <span class="fu">HoldOnASecondWhileWeImportYourDatabase</span>(userName);

 <span class="co">//THEN</span>
 var expectedMessage = 
  string.<span class="fu">Format</span>(<span class="st">&quot;{0}, better get some pocket money!&quot;</span>, userName);

 Assert.<span class="fu">Equal</span>(expectedMessage, message);
}</code></pre>
<p>and all that is left is to find a good name for the Statement. This isn’t an issue since we already specified the desired behavior in the code, so we can just summarize it as something like <code>ShouldYieldAMessageSayingThatFeatureIsLockedWhenAskedForImportDatabaseMessage</code>.</p>
<h2 id="summary-1">Summary</h2>
<p>These few techniques can be useful when you are stuck and do not know how to start. Note that the examples given are simplistic and assume that there is one object that takes some kind of input parameter and returns a well defined result. This is not how most of the object-oriented world is built. In object oriented world, we have a lot of objects communicating with other objects, sending messages, invoking methods on each other and often having no return values. Do not worry, all of these techniques work in this concept and we’ll be revisiting them as soon as we learn how to do TDD in fully object-oriented world (that is, after we introduce a concept of mock objects). For now, I’m trying to keep it simple.</p>
<h1 id="how-is-tdd-about-analysis-and-what-does-given-when-then-mean">How is TDD about analysis and what does “GIVEN-WHEN-THEN” mean?</h1>
<h2 id="is-there-really-acommonality-between-analysis-and-tdd">Is there really a commonality between analysis and TDD?</h2>
<p>From Wikipedia:</p>
<blockquote>
<p>Analysis is the process of breaking a complex topic or substance into smaller parts to gain a better understanding of it.</p>
</blockquote>
<p>Thus, in order for TDD to be about analysis, it has to fulfill two conditions:</p>
<ol style="list-style-type: decimal">
<li>Be a process of breaking a complex topic into smaller parts</li>
<li>Allow gaining a better understanding of such broken topics</li>
</ol>
<p>In the story about Johnny, Benjamin and Jane, I included a part where they analyze requirements using concrete examples. Johnny explained that this is a part of a technique called Acceptance Test-Driven Development. The process followed by the three characters fulfilled both mentioned conditions for a process to be analytical. But what about TDD itself?</p>
<p>Actually, I used parts of ATDD process in the story to make the analysis part more obvious, but similar things happen at pure technical levels. For example, when starting development with a failing application-wide Statement (we will talk about levels of granularity of Statements later. For now the only thing you need to know is that the so called “unit tests level” is not the only level of granularity we write Statements on), we may encounter a situation where we need to call a web method and assert its result. This makes us think: what should this method be called? What are the scenarios supported? What do I need to get out of it? How should its user be notified about errors? Many times, this leads us to either a conversation (if there is another stakeholder that needs to be involved in the decision) or rethinking our assumptions. This is how we gain a better understanding of the topic we are analyzing, which makes TDD fulfill the first of the two requirements for it to be an analysis method.</p>
<p>But what about the first requirement? What about breaking a complex logic into smaller parts?</p>
<p>If you go back to our example, you will note that both when talking to a customer and when writing code, Johnny and Benjamin used a TODO list. This list was first filled with whatever scenarios they came up with, but later, they would add a smaller unit of work. This is one way complex topics are decomposed into smaller items that all land on the TODO list (the other way is mocking, but we will not get into that yet). Thanks to this, we can focus on one thing at a time, crossing off item after item from the list after it is done. If we learn something new or encounter new issue that needs our attention, we can add it to the TODO list and get back to it later, for now continuing our work on the current point of focus.</p>
<p>An example TODO list from the middle of implementation may look like this (do not read through it, I put it here only to give you a glimpse):</p>
<ol style="list-style-type: decimal">
<li>— Create entry point to the module (top-level abstraction)</li>
<li>— Implement main workflow of the module</li>
<li>— Implement Message interface</li>
<li>— Implement MessageFactory interface</li>
<li>Implement ValidationRules interface</li>
<li>— Implement behavior required from Wrap method in LocationMessageFactory class</li>
<li>Implement behavior required from ValidateWith method in LocationMessage class for Speed field</li>
<li>Implement behavior required from ValidateWith method in LocationMessage class for Age field</li>
<li>Implement behavior required from ValidateWith method in LocationMessage class for Sender field</li>
</ol>
<p>Note that some items are already crossed out as done, while other remain undone and waiting to be addressed.</p>
<p>Ok, that is it for the discussion. Now that we are sure that TDD is about analysis, let’s focus on the tools we can use to aid and inform it. You already saw both of them in this book, now we are going to have a closer look.</p>
<h2 id="gherkin">Gherkin</h2>
<p>Hungry? Too bad, because the Gkerkin I am gonna talk about is not edible. It is a notation and a way of thinking about behaviors of the specified piece of code. It can be applied on different levels of granularity – any behavior, whether of a whole system or a single class, may be described using it.</p>
<p>We actually talked about Gherkin before in this book, just did not name it. It is the GIVEN-WHEN-THEN structure that you can see everywhere, even in code samples as comments. This time, we are stamping a name on it and analyzing it further.</p>
<p>In Gherkin, a behavior description consists of three parts:</p>
<ol style="list-style-type: decimal">
<li>Given – a context</li>
<li>When – a cause</li>
<li>Then – a effect</li>
</ol>
<p>In other words, the emphasis is on causality in a given context.</p>
<p>As I said, there are different levels you can apply this. Here is an example for such a behavior description from the perspective of its end user (this is called acceptance-level Statement):</p>
<pre class="gherkin"><code>Given a bag of tea costs $20
When I buy two of them
Then I should be charged 30$ due to promotion</code></pre>
<p>And here is one for unit-level (note the line starting with “And” that adds to the context):</p>
<pre class="gherkin"><code>Given a list with 2 items
When I add another item
And check items count
Then the count should be 3</code></pre>
<p>While on acceptance level we put such behavior descriptions together with code as the same artifact (If this does not ring a bell, look at tools like SpecFlow or Cucumber or FIT to get some examples), on the unit level the description is usually not written down literally, but in form of code only. Still, this structure is useful when thinking about behaviors required from an object or objects, as we saw when we talked about starting from Statement rather than code. I like to put the structure explicitly in my Statements – I find that it makes them more readable. So most of my unit-level Statements follow this template:</p>
<pre class="sourceCode java"><code class="sourceCode java">[Fact]
<span class="kw">public</span> <span class="dt">void</span> <span class="fu">Should__BEHAVIOR__</span>()
{
  <span class="co">//GIVEN</span>
  ...<span class="fu">context</span>...

  <span class="co">//WHEN</span>
  ...<span class="fu">trigger</span>...

  <span class="co">//THEN</span>
  ...<span class="fu">assertions</span> etc....
}</code></pre>
<p>Sometimes the WHEN and THEN sections are not so easily separable – then I join them, like in case of the following Statement specifying that an object throws an exception when asked to store null:</p>
<pre class="sourceCode java"><code class="sourceCode java">[Fact]
<span class="kw">public</span> <span class="dt">void</span> <span class="fu">ShouldThrowExceptionWhenAskedToStoreNull</span>()
{
  <span class="co">//GIVEN</span>
  var safeList = <span class="kw">new</span> <span class="fu">SafeList</span>();

  <span class="co">//WHEN - THEN</span>
  Assert.<span class="fu">Throws</span>&lt;Exception&gt;(
    () =&gt; safeList.<span class="fu">Store</span>(<span class="kw">null</span>)
  );
}</code></pre>
<p>By thinking in terms of these three parts of behavior, we may arrive at different circumstances (GIVEN) at which the behavior takes place, or additional ones that are needed. The same goes for triggers (WHEN) and effects (THEN). If anything like this comes to our mind, we add it to the TODO list.</p>
<h2 id="todo-list-again">TODO list… again!</h2>
<p>As we said previously, a TODO list is a repository for anything that comes to our mind when writing or thinking about a Statement, but is not a part o the current Statement we are writing. We do not want to forget it, neither do we want it to haunt us and distract us from our current task, so we write it down as soon as possible and continue with our current task.</p>
<p>Suppose you are writing a piece of small logic that allows user access when he is an employee of a zoo, but denies access if he is a guest of the zoo. Then, after starting writing a Statement it gets to you that actually any employee can be a guest as well – for example, he might choose to visit the zoo with his family during his vacation. Still, the two previous rules hold, so not to allow this case to distract you, you quickly add an item to the TODO list (like “TODO: what if someone is an employee, but comes to the zoo as a guest?”) and finish the current Statement. When you are finished, you can always come back to the list and pick item to do next.</p>
<p>There are two important questions related to TODO lists: “what exactly should we add as a TODO list item?” and “How to efficiently manage the TODO list?”. We will take care of these two questions now.</p>
<h3 id="what-to-put-on-the-todo-list">What to put on the TODO list?</h3>
<p>Everything that you need addressed but is not part of the current Statement. Those items may be related to implementing unimplemented methods, to add whole functionalities (such items are usually followed my more fine-grained sub tasks as soon as you start implementing the item), there might be reminders to take a better look at something (e.g. “investigate what is this component’s policy for logging errors”) or questions about the domain that need to get answered. If you get carried away too much in coding that you forget to eat, you can even add a reminder (“TODO: get something to eat!”). The list is yours!</p>
<h3 id="how-to-pick-items-from-todo-list">How to pick items from TODO list?</h3>
<p>Which item to choose from the TODO list when you have several? I have no clear rule, although I tend to take into account the following factors:</p>
<ol style="list-style-type: decimal">
<li>Risk – if what I learn by implementing or discussing a particular item from the list can have big impact on design or behavior of the system, I tend to pick such items first. An example of such item is that you start implementing validation of a request that arrives to your application and want to return different error depending on which part of the request is wrong. Then, during the development, you discover that more than one part of the request can be wrong at a time and you have to answer yourself a question: which error code should be returned in such case? Or maybe the return codes should be accumulated for all validations and then returned as a list?</li>
<li>Difficulty – depending on my mental condition (how tired I am, how much noise is currently around my desk etc.), I tend to pick items with difficulty that best matches this condition. For example, after finishing an item that requires a lot of thinking and figuring out things, I tend to take on some small and easy items to feel wind blowing in my sails and to rest a little bit.</li>
<li>Completeness – in simplest words, when I finish test-driving an “if” case, I usually pick up the “else” next. For example, after I finish implementing a Statement saying that something should return true for values less than 50, then the next item to pick up is the “greater or equal to 50” case. Usually, when I start test-driving a class, I take items related to this class until I run out of them, then go on to another one.</li>
</ol>
<h3 id="where-to-put-atodo-list">Where to put a TODO list?</h3>
<p>There are two ways of maintaining a TODO list. The first one is on a sheet of paper, which is nice, but requires you to take your hands off the keyboard, grab a pen or pencil and then get back to coding every time you think of something. Also, the only way a TODO item written on a sheet of paper can tell you which place in code it is related to, is (obviously) by its text.</p>
<p>Another alternative is to use a TODO list functionality built-in into an IDE. Most IDEs, such as Visual Studio (and Resharper plugin has its own enhanced version), Xamarin Studio or eclipse-based IDEs have such functionality. The rules are simple – you put special comments in the code and a special view in your IDE aggregates them for you, allowing you to navigate to each. Such lists are great because:</p>
<ol style="list-style-type: decimal">
<li>They do not force you to take your hands off keyboard to add an item to the list.</li>
<li>You can put such item in a certain place in the code where is makes sense and then navigate back to it with a click of a mouse. This, apart from other advantages, lets you write shorter notes than if you had to do it on paper. For example, a TODO item saying “TODO: what if it throws an exception?” looks out of place on the paper, but when added as a comment to your code in the right place, it is mighty sufficient.</li>
<li>Many TODO lists automatically add items for certain things. E.g. in C#, when you are yet to implement a method that was automatically generated by a tool, its body usually consists of a line that throws a <code>NotImplementedException</code> exception. Guess what – <code>NotImplementedException</code> occurences are added to the TODO list automatically, so we do not have to manually add items to the TODO list for implementing the methods where they occur.</li>
</ol>
<h3 id="expanded-tdd-process-with-atodo-list">Expanded TDD process with a TODO list</h3>
<p>In one of the previous chapters, I introduced you to the basic TDD process that contained three steps: write unfulfilled Statement, fulfill it and refactor the code. TODO list adds new steps to this process leading to the following list of steps:</p>
<ol style="list-style-type: decimal">
<li>Examine TODO list and pick an item that makes most sense to implement next</li>
<li>Write unfulfilled Statement</li>
<li>Make it unfulfilled for the right reason</li>
<li>Fulfill the Statement and make sure all already fulfilled Statements are still fulfilled</li>
<li>Cross out the item from TODO list</li>
<li>Repeat until no item is left on the TODO list</li>
</ol>
<p>Of course, we are free to add new items to the TODO list as we make progress with the existing ones and at the beginning of each cycle the list is re-evaluated to choose the most important item to implement next taking into account what was added during the previous cycle.</p>
<h3 id="potential-downsides">Potential downsides</h3>
<p>There are also some downsides. The biggest is that people often add TODO items for other means than to support TDD and they never go back to such items. Some people joke that a TODO left in the code means “Once, I wanted to…”. Anyway, such items may pollute your TDD-related TODO list with so much cruft that your own items are barely findable. To work around it, I tend to use a different tag than TODO (many IDEs let you define your own tags, or support multiple tag types out of the box. E.g. with Resharper, I like to use “bug” tag, because this is something no one would leave in the code) and filter by it. Another options is, of course, getting rid of the leftover TODO items – if no one addressed it for a year, then probably no one ever will.</p>
<p>Another downside is that when you work with multiple workspaces/solutions, your IDE will gather TODO items only from current solution/workspace, so you will have few TODO lists – one per workspace or solution. Fortunately, this isn’t usually a big deal.</p>
<h1 id="developing-a-tdd-style-and-constrained-non-determinism">Developing a TDD style and Constrained Non-Determinism</h1>
<p>In one of the first chapters, I introduced to you the idea of anonymous values generator idea, which I have wrapped in a static class called <code>Any</code>. Throughout the next chapters, you have seen me using it quite extensively in many of the Statements I wrote.</p>
<p>The time has come to explain a little bit more carefully what principles lie under this technique and tool. I will also use this technique as a case study to show you how one develops a style of Test-Driven Development.</p>
<h2 id="a-style">A style?</h2>
<p>Yep. Why am I wasting your time writing about style instead of giving you the hardcore technical details? The answer is simple. Before I started writing this tutorial, I read four or five books solely on TDD and maybe two others that contain chapters on TDD. All of this sums up to about two or three thousands of paper pages, plus numerous posts on many blogs. And you know what I noticed? No two authors use exactly the same sets of techniques for test-driving their code! I mean, sometimes, when you look at the techniques they are suggesting, two authorities contradict each other. As each authority has their followers, it is not uncommon to observe and take part in discussions about whether this or that technique is better than a competing one or which one leads to trouble in the long run.</p>
<p>I did this, too. I also tried to understand how come people praise techniques I KNEW were wrong and led to disaster. Then, Finally, I got it. I understood that it is not a “technique A vs. technique B” debate. There are certain sets of techniques that work together and choosing one technique leaves us with issues we have to resolve by adopting other techniques. This is how a style is created.</p>
<p>Developing a style starts with a set of problems to solve and an underlying set of principles we consider important. These principles lead us to adopt our first technique, which makes us adopt another one and, ultimately, a coherent style emerges. Using Constrained Non-Determinism as an example, I will try to show you how part of a style gets derived from a technique that is derived from a principle.</p>
<h2 id="principle-tests-as-specification">Principle: Tests As Specification</h2>
<p>As I already stressed, I strongly believe that unit tests constitute an executable specification. Thus, they should not only pass input values to an object and assert on the output, they should also convey to their reader the rules according to which objects and functions work. The following oversimplified example shows a Statement where it is not explicitly stated what is the relationship between input and output:</p>
<pre class="sourceCode java"><code class="sourceCode java">[Fact] <span class="kw">public</span> <span class="dt">void</span> 
<span class="fu">ShouldCreateBackupFileNameContainingPassedHostName</span>()
{
  <span class="co">//GIVEN</span>
  var fileNamePattern = <span class="kw">new</span> <span class="fu">BackupFileNamePattern</span>();
  
  <span class="co">//WHEN</span>
  var name = fileNamePattern.<span class="fu">ApplyTo</span>(<span class="st">&quot;MY_HOST_NAME&quot;</span>);
  
  <span class="co">//THEN</span>
  Assert.<span class="fu">Equal</span>(<span class="st">&quot;backup_MY_HOST_NAME.zip&quot;</span>, name);
}</code></pre>
<p>Although the relationship can be guessed quite easily, remember it is just an example. Also, seeing code like that makes me ask questions like: is the “backup_” prefix always applied? What if I actually pass “backup_” instead of “MY_HOST_NAME”? Will the name be “backup_backup_.zip”, or “backup_.zip”? Also, is this object responsible for any validation of passed string?</p>
<p>This makes me invent a first technique to provide my Statements with better support for the principle I believe in.</p>
<h2 id="first-technique-anonymous-input">First technique: Anonymous Input</h2>
<p>I can wrap the actual value “MY_HOST_NAME” with a method and give it a name that better documents the constraints imposed on it by the specified functionality. In our case, we can pass whatever string we want (the object is not responsible for input validation), so we will name our method <code>AnyString()</code>:</p>
<pre class="sourceCode java"><code class="sourceCode java">[Fact] <span class="kw">public</span> <span class="dt">void</span> 
<span class="fu">ShouldCreateBackupFileNameContainingPassedHostName</span>()
{
  <span class="co">//GIVEN</span>
  var hostName = <span class="fu">AnyString</span>();
  var fileNamePattern = <span class="kw">new</span> <span class="fu">BackupFileNamePattern</span>();
  
  <span class="co">//WHEN</span>
  var name = fileNamePattern.<span class="fu">ApplyTo</span>(hostName);
  
  <span class="co">//THEN</span>
  Assert.<span class="fu">Equal</span>(<span class="st">&quot;backup_MY_HOST_NAME.zip&quot;</span>, name);
}

<span class="kw">public</span> string <span class="fu">AnyString</span>()
{
  <span class="kw">return</span> <span class="st">&quot;MY_HOST_NAME&quot;</span>;
}</code></pre>
<p>By using <strong>anonymous input</strong>, we provide a better documentation of the input value. Here, I wrote <code>AnyString()</code>, but of course, there can be a situation where I use more constrained data, e.g. <code>AnyAlphaNumericString()</code> when I need a string that does not contain any characters other than letters and digits. Note that this technique <strong>is applicable only when the particular value of the variable is not important, but rather its “trait”</strong>. Taking authorization as an example, when a certain behavior occurs only when the input value is <code>Users.Admin</code>, there is <strong>no sense</strong> making it anonymous. On the other hand, for a behavior that occurs for all values other than <code>Users.Admin</code>, it makes sense to use a method like <code>AnyUserOtherThan(Users.Admin)</code> or even <code>AnyNonAdminUser()</code>.</p>
<p>Now that the Statement itself is freed from the knowledge of the concrete value of <code>hostName</code> variable, the concrete value of “backup_MY_HOST_NAME.zip” looks kind of weird. There is no clear indication of the kind of relationship between input and output and whether there is any at all (one may reason whether the output is always the same string or maybe it depends on the string length). It is unclear which part is added by the production code and which part depends on the input we pass to the method. This leads us to another technique.</p>
<h2 id="second-technique-derived-values">Second technique: Derived Values</h2>
<p>To better document the relationship between input and output, we have to simply derive the expected value we assert on from the input value. Here is the same Statement with the assertion changed:</p>
<pre class="sourceCode java"><code class="sourceCode java">[Fact] <span class="kw">public</span> <span class="dt">void</span> 
<span class="fu">ShouldCreateBackupFileNameContainingPassedHostName</span>()
{
  <span class="co">//GIVEN</span>
  var hostName = <span class="fu">AnyString</span>();
  var fileNamePattern = <span class="kw">new</span> <span class="fu">BackupFileNamePattern</span>();
  
  <span class="co">//WHEN</span>
  var name = fileNamePattern.<span class="fu">ApplyTo</span>(hostName);
  
  <span class="co">//THEN</span>
  Assert.<span class="fu">Equal</span>(
    string.<span class="fu">Format</span>(<span class="st">&quot;backup_{0}.zip&quot;</span>, hostName),
    name);
}
<span class="kw">public</span> string <span class="fu">AnyString</span>()
{
  <span class="kw">return</span> <span class="st">&quot;MY_HOST_NAME&quot;</span>;
}</code></pre>
<p>This looks more like a part of specification, because we are documenting the format of the backup file name and show which part of the format is variable and which part is fixed. This is something you would probably find documented in a paper specification for the application you are writing – it would probably contain a sentence saying: “The format of a backup file should be <strong>backup_H.zip</strong>, where <strong>H</strong> is the current local host name”.</p>
<p><strong>Derived values</strong> are about defining expected output in terms of the input that was passed to provide a clear indication on what is the “transformation” of the input required of the specified production code.</p>
<h2 id="third-technique-distinct-generated-values">Third technique: Distinct Generated Values</h2>
<p>Let’s assume that some time after our initial version is shipped, we are asked to make the backup feature applied locally per user only for this user’s data. As the customer does not want to confuse files from different users, we are asked to add name of the user doing backup to the backup file name. Thus, the new format is “backup_H_U.zip”, where H is still the host name and U is the user name. Our Statement for the pattern must change as well to include this information. Of course, we are trying to use the anonymous input again as a proven technique and we end up with:</p>
<pre class="sourceCode java"><code class="sourceCode java">[Fact] <span class="kw">public</span> <span class="dt">void</span> 
<span class="fu">ShouldCreateBackupFileNameContainingPassedHostNameAndUserName</span>()
{
  <span class="co">//GIVEN</span>
  var hostName = <span class="fu">AnyString</span>();
  var userName = <span class="fu">AnyString</span>();
  var fileNamePattern = <span class="kw">new</span> <span class="fu">BackupFileNamePattern</span>();
  
  <span class="co">//WHEN</span>
  var name = fileNamePattern.<span class="fu">ApplyTo</span>(hostName, userName);
  
  <span class="co">//THEN</span>
  Assert.<span class="fu">Equal</span>(string.<span class="fu">Format</span>(
    <span class="st">&quot;backup_{0}_{1}.zip&quot;</span>, hostName, userName),
    name);
}

<span class="kw">public</span> string <span class="fu">AnyString</span>()
{
  <span class="kw">return</span> <span class="st">&quot;MY_HOST_NAME&quot;</span>;
}</code></pre>
<p>Now, we can clearly see that there is something wrong with this Statement. AnyString() is used twice and each time it returns the same value, which means that evaluating the Statement does not give us any guarantee, that both values are applied and that they are applied in the correct places. For example, the Statement will be evaluated to true when user name is used instead of host name in specified production code. This means that if we still want to use the anonymous input effectively, we have to make the two values distinct, e.g. like this:</p>
<pre class="sourceCode java"><code class="sourceCode java">[Fact] <span class="kw">public</span> <span class="dt">void</span> 
<span class="fu">ShouldCreateBackupFileNameContainingPassedHostNameAndUserName</span>()
{
  <span class="co">//GIVEN</span>
  var hostName = <span class="fu">AnyString</span>();
  var userName = <span class="fu">AnyString2</span>();
  var fileNamePattern = <span class="kw">new</span> <span class="fu">BackupFileNamePattern</span>();
  
  <span class="co">//WHEN</span>
  var name = fileNamePattern.<span class="fu">ApplyTo</span>(hostName, userName);
  
  <span class="co">//THEN</span>
  Assert.<span class="fu">Equal</span>(string.<span class="fu">Format</span>(
    <span class="st">&quot;backup_{0}_{1}.zip&quot;</span>, hostName, userName),
    name);
}

<span class="kw">public</span> string <span class="fu">AnyString</span>()
{
  <span class="kw">return</span> <span class="st">&quot;MY_HOST_NAME&quot;</span>;
}

<span class="kw">public</span> string <span class="fu">AnyString2</span>()
{
  <span class="kw">return</span> <span class="st">&quot;MY_USER_NAME&quot;</span>;
}</code></pre>
<p>We solved the problem (for now) by introducing another helper method. However, this, as you can see, is not a very scalable solution. Thus, let’s try to reduce the amount of helper methods for string generation to one and make it return a different value each time:</p>
<pre class="sourceCode java"><code class="sourceCode java">[Fact] <span class="kw">public</span> <span class="dt">void</span> 
<span class="fu">ShouldCreateBackupFileNameContainingPassedHostNameAndUserName</span>()
{
  <span class="co">//GIVEN</span>
  var hostName = <span class="fu">AnyString</span>();
  var userName = <span class="fu">AnyString</span>();
  var fileNamePattern = <span class="kw">new</span> <span class="fu">BackupFileNamePattern</span>();
  
  <span class="co">//WHEN</span>
  var name = fileNamePattern.<span class="fu">ApplyTo</span>(hostName, userName);
  
  <span class="co">//THEN</span>
  Assert.<span class="fu">Equal</span>(string.<span class="fu">Format</span>(
    <span class="st">&quot;backup_{0}_{1}.zip&quot;</span>, hostName, userName),
    name);
}

<span class="kw">public</span> string <span class="fu">AnyString</span>()
{
  <span class="kw">return</span> Guid.<span class="fu">NewGuid</span>.<span class="fu">ToString</span>();
}</code></pre>
<p>This time, we are not returning an understandable string, but rather a guid, which gives us the fairly strong guarantee of generating distinct value each time. The string not being understandable (contrary to something like “MY_HOST_NAME”) may leave you worried that maybe we are losing something, but hey, didn’t we say <strong>Any</strong>String()?</p>
<p><strong>Distinct generated values</strong> means that each time we need a value of a particular type, we get something different (if possible) than the last time and each value is generated automatically using some kind of heuristics.</p>
<h2 id="fourth-technique-constant-specification">Fourth technique: Constant Specification</h2>
<p>Let’s consider another modification that we are requested to make – this time, the backup file name needs to contain version number of our application as well. Remembering that we want to use Derived Values, we will not hardcode the version number into our Statement. Instead, we are going to use a constant that is already defined somewhere else in the application (this way we also avoid duplication of this version number across the application):</p>
<pre class="sourceCode java"><code class="sourceCode java">[Fact] <span class="kw">public</span> <span class="dt">void</span> 
<span class="fu">ShouldCreateBackupFileNameContainingPassedHostNameAndUserNameAndVersion</span>()
{
  <span class="co">//GIVEN</span>
  var hostName = <span class="fu">AnyString</span>();
  var userName = <span class="fu">AnyString</span>();
  var fileNamePattern = <span class="kw">new</span> <span class="fu">BackupFileNamePattern</span>();
  
  <span class="co">//WHEN</span>
  var name = fileNamePattern.<span class="fu">ApplyTo</span>(hostName, userName);
  
  <span class="co">//THEN</span>
  Assert.<span class="fu">Equal</span>(
    string.<span class="fu">Format</span>(
      <span class="st">&quot;backup_{0}_{1}_{2}.zip&quot;</span>, 
      hostName, userName, Version.<span class="fu">Number</span>),
    name);
}

<span class="kw">public</span> string <span class="fu">AnyString</span>()
{
  <span class="kw">return</span> Guid.<span class="fu">NewGuid</span>.<span class="fu">ToString</span>();
}</code></pre>
<p>Note that I didn’t use the literal constant value, but rather, the value inside the <code>Version.Number</code> constant. This allows us to use derived value, but leaves us a little worried about whether the value of the constant is correct – after all, we are using it for creation of our expected value, but it is a part of production code – i.e. is something that should be specified itself!</p>
<p>To keep everyone happy, we write a single Statement just for the constant to specify what the value should be:</p>
<pre class="sourceCode java"><code class="sourceCode java">[Fact] <span class="kw">public</span> <span class="dt">void</span> 
<span class="fu">ShouldContainNumberEqualTo1_0</span>()
{
  Assert.<span class="fu">Equal</span>(<span class="st">&quot;1.0&quot;</span>, Version.<span class="fu">Number</span>);
}</code></pre>
<p>By doing so, we make the value in the production code just echo what is in our executable Specification, which we can fully trust.</p>
<h2 id="summary-of-the-example">Summary of the example</h2>
<p>In this example, I tried to show you how a style can evolve from the principles you value when doing TDD. I did so for two reasons:</p>
<ol style="list-style-type: decimal">
<li>To introduce to you a set of techniques I personally use and recommend and to do it in a fluent and logical way.</li>
<li>To help you better communicate with people that are using different styles. Instead of just throwing “you are doing it wrong” at them, try to understand their principles and how their techniques of choice support those principles.</li>
</ol>
<p>Now, let’s take a quick summary of all the techniques introduced in example:</p>
<dl>
<dt>Anonymous Input</dt>
<dd>moving the output out of the Statement code and hide it behind a method that to emphasize the constrain on the data used rather than what is its value
</dd>
<dt>Derived Values</dt>
<dd>defining expected output in terms of the input in order to document the relationship between input and output
</dd>
<dt>Distinct Generated Values</dt>
<dd>When using Anonymous Input, generate a distinct value each time (in case of types that have very few values, like boolean, try at least not to generate the same value twice in a row) in order to make the Statement more reliable.
</dd>
<dt>Constant Specification</dt>
<dd>Write a separate Statement for a constant and use the constant instead of its literal value in all other Statements to create a Derived Value.
</dd>
</dl>
<h2 id="constrained-non-determinism">Constrained non-determinism</h2>
<p>When we combine anonymous input together with distinct generated values, we get something that is called <strong>Constrained Non-Determinism</strong>. This is a term coined by Mark Seemann and basically means three things:</p>
<ol style="list-style-type: decimal">
<li>Values are anonymous i.e. we do not know the actual value we are using</li>
<li>The values are generated in as distinct as possible sequence (which means that, whenever possible, no two values generated one after another hold the same value)</li>
<li>The non-determinism in generation of the values is constrained, which means that the algorithms for generating values are carefully picked in order to provide values that are not special in any way (e.g. when generating integers, we do not allow generating ‘0’ as it is usually a special-case-value)) and that are not “evil” (e.g. for integers, we generate small positive values first and go with bigger numbers only when we run out of those small ones).</li>
</ol>
<p>There are multiple ways to implement constrained non-determinism. Mark Seemann himself has invented the AutoFixture library for C# that is <a href="https://github.com/AutoFixture/AutoFixture">freely available to download</a>. Here is a shortest possible snippet to generate an anonymous integer using AutoFixture:</p>
<pre class="sourceCode java"><code class="sourceCode java">Fixture fixture = <span class="kw">new</span> <span class="fu">Fixture</span>();
var anonymousInteger = fixture.<span class="fu">Create</span>&lt;<span class="dt">int</span>&gt;();</code></pre>
<p>I, after Amir Kolsky and Scott Bain, like to use Any class as seen in the previous chapters of this book. Any takes a slightly different approach than AutoFixture (although it uses AutoFixture internally). My implementation of Any class is <a href="https://github.com/grzesiek-galezowski/tdd-toolkit">available to download as well</a>.</p>
<h2 id="summary-2">Summary</h2>
<p>That was a long ride, wasn’t it? I hope that this chapter, gave you some understanding of how different TDD styles came into existence and why I use some of the techniques I do (and how these techniques are not just a series of random choices). In the next chapters, I will try to introduce some more techniques to help you grow a bag of neat tricks – a coherent style.</p>
<h1 id="what-is-the-scope-of-aunit-level-statement-in-tdd">What is the scope of a unit-level Statement in TDD?</h1>
<p>Ha, now I have to admit that I deferred for a long time an answer to a pretty fundamental question: what should be the scope of a single Statement? If I put the whole system together, can I write a Statement for its behavior? Or maybe the other way round – there should be a Statement for each method of each class, including the private ones? Well, first thing I want to explain is that there are multiple levels we can write our Statements on. This varies depending on the TDD authority, but in this book, we will cover two of such levels – unit level and acceptance level. For now, let’s stick to the unit level, which is what we have done so far anyway. The time will come for the rest.</p>
<p>For unit level, let’s consider the kind of Statements that you already saw in this book – where we take one object, invoke a method on it and assert on the result. This is actually a special case of unit-level Statement and we will cover more in the coming chapters. This is, however, a good moment to stop and consider the “scope” of a single unit-level Statement in TDD. Is it method scope? Class scope? Feature scope?</p>
<p>Let’s try to answer the question by examining some TDD unit-level Statements:</p>
<h3 id="is-it-class-scope">Is it class scope?</h3>
<p>Let’s see the first example and try to answer this question:</p>
<pre class="sourceCode java"><code class="sourceCode java">[Fact] <span class="kw">public</span> <span class="dt">void</span>
<span class="fu">ShouldThrowValidationExceptionWithFatalErrorLevelWhenValidatedStringIsEmpty</span>()
{
  <span class="co">//GIVEN</span>
  var emptyString = string.<span class="fu">Empty</span>;
  var validation = <span class="kw">new</span> <span class="fu">Validation</span>();

  <span class="co">//WHEN</span>
  var exceptionThrown = Assert.<span class="fu">Throws</span>&lt;CustomException&gt;(
    () =&gt; validation.<span class="fu">Perform</span>(emptyString) 
  );
  
  <span class="co">//THEN</span>
  Assert.<span class="fu">True</span>(exceptionThrown.<span class="fu">IsFatalError</span>);
}</code></pre>
<p>This is an example of a well-written unit-level Statement. Ok, so let’s see… how many real classes take part in this spec? Three: a string, an exception and the validation. So the class scope is not the most accurate description.</p>
<h3 id="or-amethod-scope">Or a method scope?</h3>
<p>So, maybe the scope covers a single method, meaning a Statement always exercises one method of a specified object?</p>
<p>Let’s consider the following example:</p>
<pre class="sourceCode java"><code class="sourceCode java">[Fact] <span class="kw">public</span> <span class="dt">void</span> 
<span class="fu">ShouldBeFulfilledWhenEventOccursThreeTimes</span>()
{
  <span class="co">//GIVEN</span>
  var rule = <span class="kw">new</span> <span class="fu">FullQueueRule</span>();
  rule.<span class="fu">Queued</span>();
  rule.<span class="fu">Queued</span>();

  <span class="co">//WHEN</span>
  rule.<span class="fu">Queued</span>();

  <span class="co">//THEN</span>
  Assert.<span class="fu">True</span>(rule.<span class="fu">IsFulfilled</span>());
}</code></pre>
<p>Count with me: how many methods are called? Depending on how we count, it is two (<code>Queued()</code> and <code>IsFulfilled()</code>) or four (<code>Queued(), Queued(), Queued(), IsFulfilled()</code>). In any case, not one. So it is not method scope either.</p>
<h3 id="it-is-the-scope-of-class-behavior">It is the scope of class behavior!</h3>
<p>The proper answer is: behavior! Each TDD Statement specifies a single behavior. I like how <a href="http://sustainabletdd.com">Amir Kolsky and Scott Bain</a> phrase it, by saying that each unit-level Statement should “introduce a behavioral distinction not existing before”.</p>
<p>It may look that “behavior” scope is actually broader than method or class levels, since such Statement can span multiple classes and multiple methods. This is only partially true. That is because e.g. Statements with method scope can span multiple behaviors (which, by the way, is a sign of poorly written Statement). Let’s take a look at an example:</p>
<pre class="sourceCode java"><code class="sourceCode java">[Fact] <span class="kw">public</span> <span class="dt">void</span> 
<span class="fu">ShouldReportItCanHandleStringWithLengthOf3ButNotOf4AndNotNullString</span>()
{
  <span class="co">//GIVEN</span>
  var bufferSizeRule = <span class="kw">new</span> <span class="fu">BufferSizeRule</span>();
  
  <span class="co">//WHEN</span>
  var resultForLength3 
    = bufferSizeRule.<span class="fu">CanHandle</span>(Any.<span class="fu">StringOfLength</span>(<span class="dv">3</span>));
  <span class="co">//THEN</span>
  Assert.<span class="fu">True</span>(resultForLength3);

  <span class="co">//WHEN again?</span>
  var resultForLength4 
    = bufferSizeRule.<span class="fu">CanHandle</span>(Any.<span class="fu">StringOfLength</span>(<span class="dv">4</span>))
  <span class="co">//THEN again?</span>
  Assert.<span class="fu">False</span>(resultForLength4);

  <span class="co">//WHEN again??</span>
  var resultForNull = bufferSizeRule.<span class="fu">CanHandle</span>(<span class="kw">null</span>);
  <span class="co">//THEN again??</span>
  Assert.<span class="fu">False</span>(resultForNull);
}</code></pre>
<p>Note that it specifies three (or two – depending on how you count) behaviors: acceptance of string of allowed size, refusal of handling string above the allowed size and a special case of null string. As I said – this is an antipattern and is sometimes called a “check-it-all test”. The issue with this kind of Statement is that it can be evaluated to false for at least two reasons – when the allowed string size changes and when null handling is done in another way. Also, xUnit tools by default stop execution on first error, so, assuming that the first assertion fails, we will not know the outcome of the next assertion unless we fix the previous one (does that mean we have to use a single <code>Assert</code> per Statement? We will take care of this question later. For now, let the answer be: “not necessarily”).</p>
<p>On the other hand, Statements with behavior scope do not necessary have to be broader than those with class scope. Let’s take the following example that proves it:</p>
<pre class="sourceCode java"><code class="sourceCode java">[Fact] <span class="kw">public</span> <span class="dt">void</span>
<span class="fu">ShouldReportItIsStartedAndItDoesNotYetTransmitVoiceWhenItStarts</span>()
{
  <span class="co">//GIVEN</span>
  var call = <span class="kw">new</span> <span class="fu">DigitalCall</span>();
  call.<span class="fu">Start</span>();
 
  <span class="co">//WHEN</span>
  var callStarted = call.<span class="fu">IsStarted</span>;
  
  <span class="co">//THEN</span>
  Assert.<span class="fu">True</span>(callStarted);

  <span class="co">//WHEN-THEN</span>
  Assert.<span class="fu">Throws</span>&lt;Exception&gt;(
    () =&gt; call.<span class="fu">Transmit</span>(Any.<span class="fu">InstanceOf</span>&lt;Frame&gt;())
  );
}</code></pre>
<p>Again, there are two behaviors here: reporting the call status after start and not being able to transmit frames after start. That is why this test should be split into two.</p>
<p>How to catch that you are writing a Statement about two or more behaviors rather than one? First, take a look at the test name – if it looks strange and contains some “And” or “Or” words, it may (but does not have to) be about more than one behavior. Another way is to write the description of a behavior in a Given-When-Then way. If you have more than one item in the “When” section or the structure is not Given-When-Then, but rather a “Given-When-Then-When-Then” – that is also a signal.</p>
<h1 id="specifying-boundaries-and-conditions">Specifying Boundaries and Conditions</h1>
<h3 id="a-disclaimer-1">A Disclaimer</h3>
<p>Before I begin, I have to admit that this chapter is mostly based on the material from a series of posts by Scot Bain and Amir Kolsky from the blog Sustainable Test Driven Development and their upcoming book by the same title. I like their idea of boundaries so much that I just follow the guidelines they outlined. This chapter is going to be a rephrase of these guidelines. I placed it here so that you have all the important topics covered in one place, but I encourage you to read the original blog posts on this subject on http://www.sustainabletdd.com (and the upcoming book).</p>
<h2 id="sometimes-anonymous-value-is-not-enough">Sometimes, anonymous value is not enough</h2>
<p>When we specify a behavior, there are times when this behavior should be the same no matter what arguments we pass to the constructor or invoked methods. An example would be an addition of two numbers – whatever numbers we would supply, the answer would always be a sum of those numbers:</p>
<pre class="sourceCode java"><code class="sourceCode java">[Fact] <span class="kw">public</span> <span class="dt">void</span>
<span class="fu">ShouldCalculateTheSumOfTwoNumbers</span>()
{
  <span class="co">//GIVEN</span>
  var a = Any.<span class="fu">Integer</span>();
  var b = Any,Integer();
  
  <span class="co">//WHEN</span>
  var result = <span class="kw">new</span> <span class="fu">Sum</span>().<span class="fu">Of</span>(a, b);
  
  <span class="co">//THEN</span>
  Assert.<span class="fu">Equal</span>(a + b, result);
}</code></pre>
<p>In this case, the integer numbers can really be “any” – the described relationship between input and output is independent of the actual values we use. As indicated in one of the previous chapters, this is the canonical case where Constrained Non-Determinism applies.</p>
<p>Sometimes, however, objects exhibit different behaviors based on what is passed to their constructor and to their methods (OK, we also have static methods and singletons. Longer discussion on those will be included in one of the next chapters – for now we can safely ignore them). For example, in our application we may have a licensing policy where a feature is allowed to use only if the license is valid, and denied after it has expired. Another example would be that some shops are open from 10:00 to 18:00, so if we had a query in our application whether the shop is currently open, we would expect it to be answered differently based on what the current time is.</p>
<p>In such cases, Scott and Amir offer us other guidelines for choosing input values.</p>
<h2 id="exceptions-to-the-rule">Exceptions to the rule</h2>
<p>There are times, when a Statement is true for every value except one (or more) explicitly specified. For example, in Poland, high school students are graded for exams between “mediocre” and “very good”. Every grade means the exam is passed except for “mediocre” grade which means the exam is failed. If we imagine we have to specify an object that decides whether the exam is passed based on rating, we would have to write two Statements: one for the mediocre rating and other for all the others.</p>
<p>Here is the Statement for mediocre grade (let’s imagine that all grades are members of an enum):</p>
<pre class="sourceCode java"><code class="sourceCode java">[Fact] <span class="kw">public</span> <span class="dt">void</span>
<span class="fu">ShouldNotPassTheExamWhenGradeIsMediocre</span>()
{
  <span class="co">//GIVEN</span>
  var decision = <span class="kw">new</span> <span class="fu">PassOrNotDecision</span>();

  <span class="co">//WHEN</span>
  var examPassed = decision.<span class="fu">MakeBasedOn</span>(Grades.<span class="fu">Mediocre</span>);

  <span class="co">//THEN</span>
  Assert.<span class="fu">False</span>(examPassed);
}</code></pre>
<p>Note that here, we used the literal value of <code>Grades.Mediocre</code>. This is because no other value gives the same behavior as this one, so generating the value would not make any sense.</p>
<p>The second Statement is for all the other cases. Here, we are going to use another method of the <code>Any</code> class for generating any enum member other than specified:</p>
<pre class="sourceCode java"><code class="sourceCode java">[Fact] <span class="kw">public</span> <span class="dt">void</span>
<span class="fu">ShouldPassTheExamWhenGradeIsOtherThanMediocre</span>()
{
  <span class="co">//GIVEN</span>
  var decision = <span class="kw">new</span> <span class="fu">PassOrNotDecision</span>();

  <span class="co">//WHEN</span>
  var examPassed 
    = decision.<span class="fu">MakeBasedOn</span>(Any.<span class="fu">Besides</span>(Grades.<span class="fu">Mediocre</span>));
  
  <span class="co">//THEN</span>
  Assert.<span class="fu">True</span>(examPassed);
}</code></pre>
<p>Here, <code>Any.Besides()</code> takes care of the enum value generation, producing a nice, readable code as a side effect.</p>
<p>The example shown above assumes there is only one exception to the rule (the mediocre grade). However, this concept can be scaled up to more values, as long as it is a finished, discrete set. If there are multiple exceptional values that produce the same behavior, a single Statement is sufficient to cover them all (using <code>Any</code> class and making the following call for exception Statement: <code>Any.Of(value1, value2)</code> and the following for the rest: <code>Any.OtherThan(value1, value2)</code>). However, when there are multiple exceptions to the rule and each one triggers a different behavior, each one deserves its own Statement.</p>
<h2 id="rules-valid-within-boundaries">Rules valid within boundaries</h2>
<p>Sometimes, a behavior varies around a numerical boundary. the simplest example would be a set of rules on how to calculate an absolute value of a number:</p>
<ol style="list-style-type: decimal">
<li>for any X less than 0, the result is -X (e.g. absolute value of -1.5 is 1.5)</li>
<li>for any X greater or equal to 0, the result is X (e.g. absolute value of 3 is 3).</li>
</ol>
<p>As you can see, there is a boundary between the two behaviors and the right edge of the boundary is 0. Why do I say “right edge”? That is because the boundary always has two edges and there’s a length between them. If we assume we are talking about the mentioned absolute value calculation and that our numerical domain is that of integer numbers, we can as well use -1 as edge value and say that:</p>
<ol style="list-style-type: decimal">
<li>for any X less or equal to -1, the result is -X (e.g. absolute value of -1.5 is 1.5)</li>
<li>for any X greater than -1, the result is X (e.g. absolute value of 3 is 3).</li>
</ol>
<p>So a boundary is not a single number – it always has a length – the length between last value of the previous behavior and the first value of the next behavior. In case of our example, the length between -1 (left edge – last negated number) and 0 (right edge – first non-negated) is 1.</p>
<p>Now, imagine that we are not talking about integer values anymore, but about floating point values. Then the right edge value would still be 0. But what about left edge? It would not be possible for it to stay -1, because the rule applies to e.g. -0.9 as well. So what is the correct right edge value and the correct length of the boundary? Would the length be 0.1? Or 0.001? Or maybe 0.00000001? This is harder to answer and depends heavily on the context, but it is something that must be answered for each particular case – this way we know what kind of precision is expected of us. In our Specification, we have to document the boundary length somehow.</p>
<p>So the next topic is: how to describe the boundary length with Statements? To illustrate this, I want to show you two Statements assuming we’re implementing the mentioned absolute value calculation for integers. The first Statement is for values smaller than 0 and we want to use the left edge value here ilke this:</p>
<pre class="sourceCode java"><code class="sourceCode java">[Fact] <span class="kw">public</span> <span class="dt">void</span>
<span class="fu">ShouldNegateTheNumberWhenItIsLessThan0</span>()
{
  <span class="co">//GIVEN</span>
  var function = <span class="kw">new</span> <span class="fu">AbsoluteValueCalculation</span>();
  var lessThan0 = <span class="dv">0</span> - <span class="dv">1</span>;

  <span class="co">//WHEN</span>
  var result = function.<span class="fu">PerformFor</span>(lessThan0);

  <span class="co">//THEN</span>
  Assert.<span class="fu">Equal</span>(-lessThan0, result);
}</code></pre>
<p>And the next Statement for values at least 0 and we want to use the right edge value:</p>
<pre class="sourceCode java"><code class="sourceCode java">[Fact] <span class="kw">public</span> <span class="dt">void</span>
<span class="fu">ShouldNotNegateTheNumberWhenItIsGreaterOrEqualTo0</span>()
{
  <span class="co">//GIVEN</span>
  var function = <span class="kw">new</span> <span class="fu">AbsoluteValueCalculation</span>();
  var moreOrEqualTo0 = <span class="dv">0</span>;

  <span class="co">//WHEN</span>
  var result = function.<span class="fu">PerformFor</span>(moreOrEqualTo0);

  <span class="co">//THEN</span>
  Assert.<span class="fu">Equal</span>(moreOrEqualTo0, result);
}</code></pre>
<p>There are two things to note about these examples. The first one is that we don’t use any kind of <code>Any</code> methods. We explicitly take the edges, because they’re the numbers that most strictly define the boundary. This way we document the boundary length.</p>
<p>It is important to understand why we are not using methods like <code>Any.IntegerGreaterOrEqualTo(0)</code>, even though we do use <code>Any</code> in case when we have no boundary. This is because in the latter case, no value is better than the other in any particular way. In case of boundaries, however, the edge values are better in that they more strictly define the boundary and drive the right implementation.</p>
<p>The second thing to note is the usage of literal constant 0 in the above example. In one of the previous chapter, I showed you a technique called <strong>Constant Specification</strong>, where we write an explicit Statement about the value of the named constant and use the named constant everywhere else instead of its literal. So why did i not use this technique?</p>
<p>The only reason is that this might have looked a little bit silly with such extremely trivial example as calculating absolute value. In reality, I should have used the named constant in both Statements and it would show the boundary length even more clearly. Actually, let’s perform this exercise now and see what happens.</p>
<p>First, let’s document the named constant with the following Statement:</p>
<pre class="sourceCode java"><code class="sourceCode java">[Fact] <span class="kw">public</span> <span class="dt">void</span>
<span class="fu">ShouldIncludeSmallestValueNotToNegateSetToZero</span>()
{
  Assert.<span class="fu">Equal</span>(<span class="dv">0</span>, Constants.<span class="fu">SmallestValueNotToNegate</span>);
}</code></pre>
<p>Now we have got everything we need to rewrite the two Statements we wrote earlier. The first would look like this:</p>
<pre class="sourceCode java"><code class="sourceCode java">[Fact] <span class="kw">public</span> <span class="dt">void</span>
<span class="fu">ShouldNegateTheNumberWhenItIsLessThanSmallestValueNotToNegate</span>()
{
  <span class="co">//GIVEN</span>
  var function = <span class="kw">new</span> <span class="fu">AbsoluteValueCalculation</span>();
  var lastNumberToNegate 
    = Constants.<span class="fu">SmallestValueNotToNegate</span> - <span class="dv">1</span>;

  <span class="co">//WHEN</span>
  var result = function.<span class="fu">PerformFor</span>(lastNumberToNegate);

  <span class="co">//THEN</span>
  Assert.<span class="fu">Equal</span>(-lastNumberToNegate, result);
}</code></pre>
<p>And the second Statement for values at least 0:</p>
<pre class="sourceCode java"><code class="sourceCode java">[Fact] <span class="kw">public</span> <span class="dt">void</span>
<span class="fu">ShouldNotNegateNumberWhenItIsGreaterOrEqualToSmallestValueNotToNegate</span>()
{
  <span class="co">//GIVEN</span>
  var function = <span class="kw">new</span> <span class="fu">AbsoluteValueCalculation</span>();

  <span class="co">//WHEN</span>
  var result = function.<span class="fu">PerformFor</span>(
    Constants.<span class="fu">SmallestValueNotToNegate</span>
  );

  <span class="co">//THEN</span>
  Assert.<span class="fu">Equal</span>(
    Constants.<span class="fu">SmallestValueNotToNegate</span>, result);
}</code></pre>
<p>As you can see, the first Statement contains the following expression: <code>Constants.SmallestValueNotToNegate - 1</code>, where 1 is the exact length of the boundary. Like I said, the situation is so trivial that it may look silly and funny, however, in real life scenarios, this is a great technique to apply anytime, anywhere.</p>
<p>Boundaries may look like they apply only to integer input, but they occur at many other places. There are boundaries associated with date/time (e.g. an action is performed again when time from last action is at least 30 seconds – the decision would need to be made whether we need precision in seconds or maybe in ticks), to strings (e.g. validation of user name where it must be at least 2 characters, or password that must contain at least 2 special characters) etc.</p>
<h2 id="combination-of-boundaries-ranges">Combination of boundaries – ranges</h2>
<p>So, what about a behavior that is valid in a range? Let’s assume that we live in a country where a citizen can get a driving license only after their 17th birthday, but before 65th (the government decided that people after 65 have worse sight and it’s safer not to give them new driving licenses). Let’s also assume that we try to develop a class that answers the question whether we can apply for driving license and the return values of this query are as follows:</p>
<ol style="list-style-type: decimal">
<li>Age &lt; 17 – returns enum value <code>QueryResults.TooYoung</code></li>
<li>17 &lt;= age &gt;= 65 – returns enum value <code>QueryResults.AllowedToApply</code></li>
<li>Age &gt; 65 – returns enum value <code>QueryResults.TooOld</code></li>
</ol>
<p>Now, remember I told you that we specify the behaviors near boundaries? This, however, when applied to the situation I just described, would give us the following Statements:</p>
<ol style="list-style-type: decimal">
<li>Age = 17, should yield result <code>QueryResults.TooYoung</code></li>
<li>Age = 18, should yield result <code>QueryResults.AllowedToApply</code></li>
<li>Age = 65, should yield result <code>QueryResults.AllowedToApply</code></li>
<li>Age = 66, should yield result <code>QueryResults.TooOld</code></li>
</ol>
<p>thus, we would describe the behavior where the query should return <code>AllowedToApply</code> value twice, which effectively means that we would copy-paste the Statement and change just one value. How do we deal with this? Thankfully, we have a solution available:</p>
<p>Most xUnit frameworks provide some kind of data-driven test functionality, which we can use to write parameterized Statements. The functionality basically means that we can write the code of the Statement once, but make the xUnit framework invoke it twice with different sets of input values. Let’s see an example in XUnit.net:</p>
<pre class="sourceCode java"><code class="sourceCode java">[Theory]
[<span class="fu">InlineData</span>(<span class="dv">17</span>, QueryResults.<span class="fu">TooYoung</span>)]
[<span class="fu">InlineData</span>(<span class="dv">18</span>, QueryResults.<span class="fu">AllowedToApply</span>)]
[<span class="fu">InlineData</span>(<span class="dv">65</span>, QueryResults.<span class="fu">AllowedToApply</span>)]
[<span class="fu">InlineData</span>(<span class="dv">66</span>, QueryResults.<span class="fu">TooOld</span>)]
<span class="kw">public</span> <span class="dt">void</span> <span class="fu">ShouldYieldResultForAge</span>(<span class="dt">int</span> age, QueryResults expectedResult)
{
  <span class="co">//GIVEN</span>
  var query = <span class="kw">new</span> <span class="fu">DrivingLicenseQuery</span>();

  <span class="co">//WHEN</span>
  var result = query.<span class="fu">ExecuteFor</span>(age);

  <span class="co">//THEN</span>
  Assert.<span class="fu">Equal</span>(expectedResult, result);
}</code></pre>
<p>This way, there is only one Statement executed four times. The case of <code>AllowedToApply</code> is still evaluated twice for both edge cases (so there is more time spent on executing it, which for small cases is not an issue), but the code maintenance issue is gone – we don’t have to copy-paste the code to specify both edges of the behavior.</p>
<p>Note that we’re quite lucky because the specified logic is strictly functional (i.e. returns different results based on different inputs). Thanks to this, we could parameterize input values together with expected results. This is not always the case. For example, let’s imagine that we have a clock class where we can set alarm time. The class allows us to set hour between 0 and 24, but otherwise throws an exception.</p>
<p>While some xUnit frameworks, like NUnit, allow us to handle both cases with one Statement by writing something like this:</p>
<pre class="sourceCode java"><code class="sourceCode java"><span class="co">//NOTE: this is an example in NUnit framework!</span>
[<span class="fu">TestCase</span>(Hours.<span class="fu">Min</span>, Result=Hours.<span class="fu">Min</span>)]
[<span class="fu">TestCase</span>(Hours.<span class="fu">Max</span>, Result=Hours.<span class="fu">Max</span>)]
[<span class="fu">TestCase</span>(Hours.<span class="fu">Min</span><span class="dv">-1</span>, ExpectedException = <span class="fu">typeof</span>(OutOfRangeException))]
[<span class="fu">TestCase</span>(Hours.<span class="fu">Max</span><span class="dv">+1</span>, ExpectedException = <span class="fu">typeof</span>(OutOfRangeException))]
<span class="kw">public</span> <span class="dt">int</span> 
<span class="fu">ShouldBeAbleToSetHourBetweenMinAndMaxButNotOutsideThatRange</span>(
  <span class="dt">int</span> inputHour)
{
  <span class="co">//GIVEN</span>
  var clock = <span class="kw">new</span> <span class="fu">Clock</span>();
  clock.<span class="fu">SetAlarmHour</span>(inputHour);

  <span class="co">//WHEN</span>
  var setHour = clock.<span class="fu">GetAlarmHour</span>();

  <span class="co">//THEN</span>
  <span class="kw">return</span> setHour;
}</code></pre>
<p>Others, like XUnit.NET, don’t (not that it’s a defect of the framework, it’s just that the philosophy behind those two is a little bit different and that some features have hidden price attached to their usage which some frameworks are willing to pay, while others aren’t). Thus, we have to solve it by writing two parameterized Statements – one where a value is returned (for valid cases) and one where exception is thrown (for invalid cases). The first would look like this:</p>
<pre class="sourceCode java"><code class="sourceCode java">[Theory]
[<span class="fu">InlineData</span>(Hours.<span class="fu">Min</span>)]
[<span class="fu">InlineData</span>(Hours.<span class="fu">Max</span>)]
<span class="kw">public</span> <span class="dt">void</span> 
<span class="fu">ShouldBeAbleToSetHourBetweenMinAndMax</span>(<span class="dt">int</span> inputHour)
{
  <span class="co">//GIVEN</span>
  var clock = <span class="kw">new</span> <span class="fu">Clock</span>();
  clock.<span class="fu">SetAlarmHour</span>(inputHour);

  <span class="co">//WHEN</span>
  var setHour = clock.<span class="fu">GetAlarmHour</span>();

  <span class="co">//THEN</span>
  Assert.<span class="fu">Equal</span>(inputHour, setHour);
}</code></pre>
<p>and the second:</p>
<pre class="sourceCode java"><code class="sourceCode java">[Theory]
[<span class="fu">InlineData</span>(Hours.<span class="fu">Min</span><span class="dv">-1</span>)]
[<span class="fu">InlineData</span>(Hours.<span class="fu">Max</span><span class="dv">+1</span>)]
<span class="kw">public</span> <span class="dt">void</span> 
<span class="fu">ShouldThrowOutOfRangeExceptionWhenTryingToSetAlarmHourOutsideValidRange</span>(
  <span class="dt">int</span> inputHour)
{
  <span class="co">//GIVEN</span>
  var clock = <span class="kw">new</span> <span class="fu">Clock</span>();

  <span class="co">//WHEN - THEN</span>
  Assert.<span class="fu">Throws</span>&lt;OutOfRangeException&gt;( 
    ()=&gt; clock.<span class="fu">SetAlarmHour</span>(inputHour)
  );
}</code></pre>
<h2 id="summary-3">Summary</h2>
<p>In this chapter, we covered specifying numerical boundaries with a minimal amount of code, so that the Specification is more maintainable and runs fast. There is one more kind of situation left: when we have compound conditions (e.g. a password must be at least 10 characters and contain at least 2 special characters) – we’ll get back to those when we introduce mocks.</p>
<h1 id="triangulation">Triangulation</h1>
<h3 id="a-disclaimer-2">A disclaimer</h3>
<p>The first occurence of the term triangulation I know about is in Kent Beck’s book <a href="http://www.pearsonhighered.com/educator/product/Test-Driven-Development-By-Example/9780321146533.page">Test Driven Development: By Example</a>).</p>
<p>As one of the last topics of the core TDD techniques that do not require us to delve into the object oriented world, I’d like to show you triangulation.</p>
<p>Triangulation is often described as the most conservative of three approaches of test-driving implementation. These approaches are:</p>
<ol style="list-style-type: decimal">
<li>Type the obvious implementation</li>
<li>Fake it (‘til you make it)</li>
<li>Triangulate</li>
</ol>
<p>All of these techniques are simple (triangulaion being a little more complex), so I’ll show you all of them one by one, putting more emphasis on triangulation:</p>
<h2 id="type-the-obvious-implementation">Type The Obvious Implementation</h2>
<p>The first of the three techniques is just writing an obvious implementation in response to a Statetement. If the implementation is simple, this approach makes a lot of sense. Let’s take a trivial example of adding two numbers:</p>
<pre class="sourceCode java"><code class="sourceCode java">[Fact] <span class="kw">public</span> <span class="dt">void</span>
<span class="fu">ShouldAddTwoNumbersTogether</span>()
{
  <span class="co">//GIVEN</span>
  var sum = <span class="kw">new</span> <span class="fu">Sum</span>();

  <span class="co">//WHEN</span>
  var result = sum.<span class="fu">Of</span>(<span class="dv">3</span>,<span class="dv">5</span>);

  <span class="co">//THEN</span>
  Assert.<span class="fu">Equal</span>(<span class="dv">8</span>, result);
}</code></pre>
<p>You may remember I told you that usually we write the simplest production code that would make the Statement true. This rule would encourage us to just return 8 from the <code>Of</code> method, because it would be sufficient to make the Statement true. Instead, we can decide that the logic is so obvious, that we can just write it based on this one Statement:</p>
<pre class="sourceCode java"><code class="sourceCode java"><span class="kw">public</span> <span class="kw">class</span> Sum
{
  <span class="kw">public</span> <span class="dt">int</span> <span class="fu">Of</span>(<span class="dt">int</span> a, <span class="dt">int</span> b)
  {
    <span class="kw">return</span> a+b;
  }
}</code></pre>
<p>and this is it.</p>
<p>Note that I didn’t use Constrained Non-Determinism here, because its use enforces using “Just write obvious implementation” technique. In fact, most (if not all) Statements we wrote so far in previous chapters, uses this approach because of this fact. Let’s take a look at how the above Statement would look if we used Constrained Non-Determinism:</p>
<pre class="sourceCode java"><code class="sourceCode java">[Fact] <span class="kw">public</span> <span class="dt">void</span>
<span class="fu">ShouldAddTwoNumbersTogether</span>()
{
  <span class="co">//GIVEN</span>
  var a = Any.<span class="fu">Integer</span>();
  var b = Any.<span class="fu">Integer</span>();
  var sum = <span class="kw">new</span> <span class="fu">Sum</span>();

  <span class="co">//WHEN</span>
  var result = sum.<span class="fu">Of</span>(a,b);

  <span class="co">//THEN</span>
  Assert.<span class="fu">Equal</span>(a + b, result);
}</code></pre>
<p>Here, we don’t have any choice. The most obvious implementation that would make this Statement true is the correct implementation. We are unable to return some constant value as we previously could (but we did not), because we just don’t know what the expected result is and it is strictly dependent on the input values which we don’t know as well.</p>
<h2 id="fake-it-til-you-make-it">Fake It (‘Til You Make It)</h2>
<p>This technique is kind of funny. I do not recall myself ever using it, but it is so interesting I want to show it to you anyway. It is so simple you will not regret these few minutes even if just for broadening your horizons.</p>
<p>There are two core things that we need to pay attention when using these technique:</p>
<ol style="list-style-type: decimal">
<li>Start with the simplest implementation possible (i.e. fake it), which usually is returning a literal constant. Then gradually transform the code of both Statement and implementation using variables</li>
<li>When doing it, rely on your sense of duplication between Statement and (fake) implementation</li>
</ol>
<p>Let’s apply Fake It to the same addition example as before (I promise, for triangulation, I will give you better one). The Statement looks the same as before:</p>
<pre class="sourceCode java"><code class="sourceCode java">[Fact] <span class="kw">public</span> <span class="dt">void</span>
<span class="fu">ShouldAddTwoNumbersTogether</span>()
{
  <span class="co">//GIVEN</span>
  var sum = <span class="kw">new</span> <span class="fu">Sum</span>();

  <span class="co">//WHEN</span>
  var result = sum.<span class="fu">Of</span>(<span class="dv">3</span>,<span class="dv">5</span>);

  <span class="co">//THEN</span>
  Assert.<span class="fu">Equal</span>(<span class="dv">8</span>, result);
}</code></pre>
<p>Only this time, we are going to use the simplest implementation possible. As I wrote, this simplest implementation is almost always to return a constant:</p>
<pre class="sourceCode java"><code class="sourceCode java"><span class="kw">public</span> <span class="kw">class</span> Sum
{
  <span class="kw">public</span> <span class="dt">int</span> <span class="fu">Of</span>(<span class="dt">int</span> a, <span class="dt">int</span> b)
  {
    <span class="kw">return</span> <span class="dv">8</span>;
  }
}</code></pre>
<p>The Statement evaluates to true (green) now, though the implementation is obviously wrong. BUT, the TDD cycle is not over yet. Remember that as soon as the Statement is true, refactoring phase kicks in. This is something we were ignoring silently for now (and here we will only slightly lick it). We can use the refactoring phase to remove duplication between the Statement and it’s implementing code.</p>
<p>First, let’s note that the number 8 is duplicated between Statement and implementation – the implementation returns it and the Statement asserts on it. To reduce this duplication, let’s break the 8 in the implementation into a sum:</p>
<pre class="sourceCode java"><code class="sourceCode java"><span class="kw">public</span> <span class="kw">class</span> Sum
{
  <span class="kw">public</span> <span class="dt">int</span> <span class="fu">Of</span>(<span class="dt">int</span> a, <span class="dt">int</span> b)
  {
    <span class="kw">return</span> <span class="dv">3</span> + <span class="dv">5</span>;
  }
}</code></pre>
<p>Note the smart trick I did. I changed duplication between implementation and expected result to duplication between implementation and input values of the Statement. After all, 3 and 5 are the exact values I used in the Statement, right? This kind of duplication is different in that it can be removed using variables (this applies not only to input variables, but basically anything we have access to prior to triggering specified behavior – constructor parameters, fields etc. in contrast to result which we normally do not know until we invoke the behavior). The duplication of number 3 can be eliminated this way:</p>
<pre class="sourceCode java"><code class="sourceCode java"><span class="kw">public</span> <span class="kw">class</span> Sum
{
  <span class="kw">public</span> <span class="dt">int</span> <span class="fu">Of</span>(<span class="dt">int</span> a, <span class="dt">int</span> b)
  {
    <span class="kw">return</span> a + <span class="dv">5</span>;
  }
}</code></pre>
<p>and we have just the number 5 duplicated, because we used variable to transfer the value of 3 from Statement method to the <code>Of</code> implementation, so we have it in one place now. let’s do the same with 5:</p>
<pre class="sourceCode java"><code class="sourceCode java"><span class="kw">public</span> <span class="kw">class</span> Sum
{
  <span class="kw">public</span> <span class="dt">int</span> <span class="fu">Of</span>(<span class="dt">int</span> a, <span class="dt">int</span> b)
  {
    <span class="kw">return</span> a + b;
  }
}</code></pre>
<p>And that’s it. I used a trivial example, since I don’t want to spend too much time on this, but you can find more advanced ones in Kent Beck’s book if you like.</p>
<h2 id="triangulation-1">Triangulation</h2>
<p>As I wrote, triangulation is the most conservative technique, because following it involves the tiniest possible steps to arrive at the right solution. The technique is called triangulation by analogy to <a href="http://encyclopedia2.thefreedictionary.com/radar+triangulation">radar triangulation</a> where outputs from at least two radars must be used to determine the position of a unit. Also, in radar triangulation, the position is measured indirectly, by combining the following data: range (not position!) between two radars, measurement done by each radar and the positions of the radars (which we know, because we are the ones who put the radars there). From this data, we can derive a triangle, so we can use trigonometry to calculate the position of the third point of the triangle, which is the desired position of the unit (two remaining points are the positions of radars). Such measurement is indirect in nature, because we do not measure the position directly, but calculate it from other helper measurements.</p>
<p>These two characteristics: indirect measurement and using at least two sources of information are at the core of TDD triangulation. Basically, it says:</p>
<ol style="list-style-type: decimal">
<li><strong>Indirect measurement</strong>: derive the design from few known examples of its desired external behavior by looking at what varies in these examples and making this variability into something more general</li>
<li><strong>Using at least two sources of information</strong>: start with the simplest possible implementation and make it more general <strong>only</strong> when you have two or more different examples (i.e. Statements that describe the desired functionality for specific inputs). Then new examples can be added and generalization can be done again. This process is repeated until we reach the desired implementation. Robert C. Martin developed a maxim on this, saying that “As the tests get more specific, the code gets more generic.</li>
</ol>
<p>Usually, when TDD is showcased on simple examples, triangulation is the primary technique used, so many novices mistakenly believe TDD is all about triangulation. This isn’t true, although triangulation is important.</p>
<h4 id="example-3">Example</h4>
<p>Suppose we want to write a logic that creates an aggregate sum of the list. Let’s assume that we have no idea how to design the internals of our custom list class so that it fulfills its responsibility. Thus, we start with the simplest example of calculating a sum of 0 elements:</p>
<pre class="sourceCode java"><code class="sourceCode java">[Fact] <span class="kw">public</span> <span class="dt">void</span> 
<span class="fu">ShouldReturn0AsASumOfNoElements</span>()
{
  <span class="co">//GIVEN</span>
  var listWithAggregateOperations 
    = <span class="kw">new</span> <span class="fu">ListWithAggregateOperations</span>();

  <span class="co">//WHEN</span>
  var result = listWithAggregateOperations.<span class="fu">SumOfElements</span>();

  <span class="co">//THEN</span>
  Assert.<span class="fu">Equal</span>(<span class="dv">0</span>, result);
}</code></pre>
<p>Remember we want to write just enough code to make the Statement true. We can achieve it with just returning 0 from the <code>SumOfElements</code> method:</p>
<pre class="sourceCode java"><code class="sourceCode java"><span class="kw">public</span> <span class="kw">class</span> ListWithAggregateOperations
{
  <span class="kw">public</span> <span class="dt">int</span> <span class="fu">SumOfElements</span>()
  {
    <span class="kw">return</span> <span class="dv">0</span>;
  }
}</code></pre>
<p>This is not yet the implementation we are happy with, which makes us add another Statement – this time for a single element:</p>
<pre class="sourceCode java"><code class="sourceCode java">[Fact] <span class="kw">public</span> <span class="dt">void</span> 
<span class="fu">ShouldReturnTheSameElementAsASumOfSingleElement</span>()
{
  <span class="co">//GIVEN</span>
  var singleElement = Any.<span class="fu">Integer</span>();
  var listWithAggregateOperations 
    = <span class="kw">new</span> <span class="fu">ListWithAggregateOperations</span>(singleElement);

  <span class="co">//WHEN</span>
  var result = listWithAggregateOperations.<span class="fu">SumOfElements</span>();

  <span class="co">//THEN</span>
  Assert.<span class="fu">Equal</span>(singleElement, result);
}</code></pre>
<p>The naive implementation can be as follows:</p>
<pre class="sourceCode java"><code class="sourceCode java"><span class="kw">public</span> <span class="kw">class</span> ListWithAggregateOperations
{
  <span class="dt">int</span> _element = <span class="dv">0</span>;

  <span class="kw">public</span> <span class="fu">ListWithAggregateOperations</span>()
  {    
  }

  <span class="kw">public</span> <span class="fu">ListWithAggregateOperations</span>(<span class="dt">int</span> element)
  {
    _element = element;
  }

  <span class="kw">public</span> <span class="dt">int</span> <span class="fu">SumOfElements</span>()
  {
    <span class="kw">return</span> _element;
  }
}</code></pre>
<p>We have two examples, so let’s check whether we can generalize now. We could try to get rid of the two constructors now, but let’s wait just a little bit longer and see if this is the right path to go (after all, I told you that we need <strong>at least</strong> two examples).</p>
<p>Let’s add third example then. What would be the next more complex one? Note that the choice of next example is not random. Triangulation is about considering the axes of variability. If you carefully read the last example, you probably noticed that we already skipped one axis of variability – the value of the element. We used <code>Any.Integer()</code> where we could use a literal value and add a second example with another value to make us turn it into variable. This time, however, I decided to <strong>type the obvious implementation</strong>. The second axis of variability is the number of elements. The third example will move us further along this axis – so it will use two elements instead of one or zero. This is how it looks like:</p>
<pre class="sourceCode java"><code class="sourceCode java">[Fact] <span class="kw">public</span> <span class="dt">void</span> 
<span class="fu">ShouldReturnSumOfTwoElementsAsASumWhenTwoElementsAreSupplied</span>()
{
  <span class="co">//GIVEN</span>
  var firstElement = Any.<span class="fu">Integer</span>();
  var secondElement = Any.<span class="fu">Integer</span>();
  var listWithAggregateOperations 
    = <span class="kw">new</span> <span class="fu">ListWithAggregateOperations</span>(firstElement, secondElement);

  <span class="co">//WHEN</span>
  var result = listWithAggregateOperations.<span class="fu">SumOfElements</span>();

  <span class="co">//THEN</span>
  Assert.<span class="fu">Equal</span>(firstElement + secondElement, result);
}</code></pre>
<p>And the naive implementation will look like this:</p>
<pre class="sourceCode java"><code class="sourceCode java"><span class="kw">public</span> <span class="kw">class</span> ListWithAggregateOperations
{
  <span class="dt">int</span> _element1 = <span class="dv">0</span>;
  <span class="dt">int</span> _element2 = <span class="dv">0</span>;

  <span class="kw">public</span> <span class="fu">ListWithAggregateOperations</span>()
  {
  }

  <span class="kw">public</span> <span class="fu">ListWithAggregateOperations</span>(<span class="dt">int</span> element)
  {
    _element1 = element;
  }

  <span class="co">//added</span>
  <span class="kw">public</span> <span class="fu">ListWithAggregateOperations</span>(<span class="dt">int</span> element1, <span class="dt">int</span> element2)
  {
    _element1 = element1;
    _element2 = element2;
  }

  <span class="kw">public</span> <span class="dt">int</span> <span class="fu">SumOfElements</span>()
  {
    <span class="kw">return</span> _element1 + _element2; <span class="co">//changed</span>
  }
}</code></pre>
<p>After adding and implementing the third example, the variability of elements count becomes obvious. Now that we have three examples, we see even more clearly that we have redundant constructors and redundant fields for each element in the list and if we added a fourth example for three elements, we’d have to add another constructor, another field and another element of the sum computation. Time to generalize!</p>
<p>How do we encapsulate the variability of the element count so that we can get rid of this redundancy? A collection! How do we generalize the addition of multiple elements? A foreach loop through the collection! Thankfully, C# supports <code>params</code> keyword, so let’s use it to remove the redundant constructor like this:</p>
<pre class="sourceCode java"><code class="sourceCode java"><span class="kw">public</span> <span class="kw">class</span> ListWithAggregateOperations
{
  <span class="dt">int</span>[] _elements;  

  <span class="kw">public</span> <span class="fu">ListWithAggregateOperations</span>(params <span class="dt">int</span>[] elements)
  {
    _elements = elements;
  }

  <span class="kw">public</span> <span class="dt">int</span> <span class="fu">SumOfElements</span>()
  {
    <span class="co">//changed</span>
    <span class="dt">int</span> sum = <span class="dv">0</span>;
    <span class="fu">foreach</span>(var element in _elements)
    {
      sum += element;
    }
    <span class="kw">return</span> sum;
  }
}</code></pre>
<p>While the first Statement (“no elements”) seems like a special case, the remaining two – for one and two elements – seem to be just two variations of the same behavior (“some elements”). Thus, it is a good idea to make a more general Statement that describes this logic to replace the two examples. After all, we don’t want more than one failure for the same reason. So as the next step, I will write a Statement to replace these examples (I leave them in though, until I get this one to evaluate to true).</p>
<pre class="sourceCode java"><code class="sourceCode java">[Fact]
<span class="kw">public</span> <span class="dt">void</span> 
<span class="fu">ShouldReturnSumOfAllItsElementsWhenAskedForAggregateSum</span>()
{
  <span class="co">//GIVEN</span>
  var firstElement = Any.<span class="fu">Integer</span>();
  var secondElement = Any.<span class="fu">Integer</span>();
  var thirdElement = Any.<span class="fu">Integer</span>();
  var listWithAggregateOperations 
    = <span class="kw">new</span> <span class="fu">ListWithAggregateOperations</span>(
        firstElement, 
        secondElement, 
        thirdElement);

  <span class="co">//WHEN</span>
  var result = listWithAggregateOperations.<span class="fu">SumOfElements</span>();

  <span class="co">//THEN</span>
  Assert.<span class="fu">Equal</span>(
   firstElement + 
   secondElement + 
   thirdElement, result);
}</code></pre>
<p>This Statement uses three values rather than zero, one or two as in the examples we had. When I need to use collections with deterministic size (and I do prefer to do it everywhere where using collection with non-deterministic size would force me to use a <code>for</code> loop in my Statement), I pick 3, which is the number I got from Mark Seemann and the rationale is that 3 is the smallest number that has distinct head, tail and middle element. One or two elements seem like a special case, while three sounds generic enough.</p>
<p>One more thing we can do is to ensure that we didn’t write a <strong>false positive</strong>, i.e. a Statement that is always true due to being badly written. In other words, we need to ensure that the Statement we just wrote will ever evaluate to false if the implementation is wrong. As we wrote it after the implementation is in place, we do not have this certainty.</p>
<p>What we will do is to modify the implementation slightly to make it badly implemented and see how our Statement will react (we expect it to evaluate to false):</p>
<pre class="sourceCode java"><code class="sourceCode java"><span class="kw">public</span> <span class="dt">int</span> <span class="fu">SumOfElements</span>()
{
  <span class="co">//changed</span>
  <span class="dt">int</span> sum = <span class="dv">0</span>;
  <span class="fu">foreach</span>(var element in _elements)
  {
    sum += element;
  }
  <span class="kw">return</span> sum + <span class="dv">1</span>; <span class="co">//modified with &quot;+1&quot;!</span>
}</code></pre>
<p>When we do this, we can see our last Statement evaluate to false with a message like “expected 21, got 22”. We can now undo this one little change and go back to correct implementation.</p>
<p>The examples (“zero elements”, “one element” and “two elements”) still evaluate to true, but it’s now safe to remove the last two, leaving only the Statement about a behavior we expect when we calculate sum of no elements and the Statement about N elements we just wrote.</p>
<p>And voilà! We have arrived at the final, generic solution. Note that the steps we took were tiny – so you might get the impression that the effort was not worth it. Indeed, this example was only to show the mechanics of triangulation – in real life, if we encountered such simple situation we’d know straight away what the design would be and we’d start with the general Statement straight away and just type in the obvious implementation. Triangulation shows its power in more complex problems with multiple design axes and where taking tiny steps helps avoid “analysis paralysis”.</p>
<h2 id="summary-4">Summary</h2>
<p>As I stated before, triangulation is most useful when you have no idea how the internal design of a piece of functionality will look like (e.g. even if there are work-flows, they cannot be easily derived from your knowledge of the domain) and it’s not obvious along which axes your design must provide generality, but you are able to give some examples of the observable behavior of that functionality given certain inputs. These are usually situations where you need to slow down and take tiny steps that slowly bring you closer to the right design and functionality – and that’s what triangulation is for!</p>
<h1 id="part-2-test-driven-development-in-object-oriented-world">Part 2: Test-Driven Development in Object Oriented World</h1>
<p>Most of the examples I gave you during the previous part were about a single object that did not have dependencies on other objects (with an exception of some values – strings, integers, enums etc.). This is not how a real OO systems are built. In this part, we are finally going to look at scenarios where multiple objects collaborate together as a system.</p>
<p>This brings about some issues that need to be discussed. One of them is the approach to object oriented design and how it influences the tools we use to test-drive our code. You probably heard something about a tool called mock objects (at least from one of the introductory chapters of this book) or, in more broaded sense, test doubles. If you open your web browser and type “mock objects break encapsulation”, you will find a lot of different opinions – some saying that mocks are great, others blaming them for everything bad in the world, and a lot of opinions inbetween those. The discussions are still heated, even though mocks were introduced more than ten years ago. My goal in this chapter is to outline the real context and forces that lead to adoption of mocks and how to use them for your benefit, not failure.</p>
<p>Steve Freeman, one of the godfathers of using mock objects with TDD, <a href="https://groups.google.com/d/msg/growing-object-oriented-software/rwxCURI_3kM/2UcNAlF_Jh4J">wrote</a>: “mocks arise naturally from doing responsibility-driven OO. All these mock/not-mock arguments are completely missing the point. If you’re not writing that kind of code, people, please don’t give me a hard time”. I am going to introduce mocks in a way that will not give Steve a hard time, I hope.</p>
<p>In order to do this, I need to cover some topics of object oriented design. That is why not all chapters in this part are specifically about TDD, but some are about object oriented techniques, practices and qualities you need to know to use TDD effectively in object oriented world. First of them being objects composability.</p>
<blockquote>
<h2 id="teaching-one-thing-at-a-time">Teaching one thing at a time</h2>
<p>For several next chapters, you will see me do a lot of code and design examples without writing any test. This may make you wonder whether you are still reading a TDD book.</p>
<p>I want to make it very clear that by omitting tests in these chapters I am not advocating writing code or refactoring without tests. The only reason I am doing this is that teaching and learning several things at the same time makes everything harder, both for the teacher and for the student. Thus, until I explain the necessary object oriented design topics, I want you to be focused only on them.</p>
<p>Do not worry. After I am done laying ground for mock objects, I am going to re-introduce TDD and write lots of tests. Please trust me and be patient.</p>
</blockquote>
<p>After reading part 2, you will understand how mocks fit into test-driving object oriented code, how to make Statements using mocks maintainable and how some of the practices I introduced in the chapters of part 1 apply to mocks. You will also be able to test-drive simple object oriented systems.</p>
<h1 id="on-objects-composability">On Objects Composability</h1>
<p>In this chapter, I will try to outline briefly why objects’ composability is a goal worth achieving and how it can be achieved. I am going to start with an example of unmaintainable code and will gradually fix its flaws in the next chapters. For now, we are going to fix just one of the flaws, so the code we will end up will not be perfect by any means, still, it will be better by one quality.</p>
<p>In the coming chapters, we will learn more valuable lessons resulting from changing this little piece of code.</p>
<h2 id="another-task-for-johnny-and-benjamin">Another task for Johnny and Benjamin</h2>
<p>Remember Johnny and Benjamin? Looks like they managed their previous task and are up to something else. Let’s listen to their conversation as they are working on another project…</p>
<p><strong>Benjamin:</strong> So, what’s this assignment about?</p>
<p><strong>Johnny:</strong> Actually, it’s nothing exciting – we’ll have to add two features to a legacy application that’s not prepared for the changes.</p>
<p><strong>Benjamin:</strong> What is the code for?</p>
<p><strong>Johnny:</strong> It is a C# class that implements company policies. As the company has just started using this automated system and it was started recently, there is only one policy implemented: yearly incentive plan. Many corporations have what they call incentive plans. These plans are used to promote good behaviors and exceeding expectations by employees of a company.</p>
<p><strong>Benjamin:</strong> You mean, the project has just started and is already in a bad shape?</p>
<p><strong>Johnny:</strong> Yep. The guys writing it wanted to “keep it simple”, whatever that means, and now it looks pretty bad.</p>
<p><strong>Benjamin:</strong> I see…</p>
<p><strong>Johnny:</strong> By the way, do you like riddles?</p>
<p><strong>Benjamin:</strong> Always!</p>
<p><strong>Johnny:</strong> So here’s one: how do you call a development phase when you ensure high code quality?</p>
<p><strong>Benjamin:</strong> … … No clue… So what is it called?</p>
<p><strong>Johnny:</strong> It’s called “now”.</p>
<p><strong>Benjamin:</strong> Oh!</p>
<p><strong>Johnny:</strong> Getting back to the topic, here’s the company incentive plan.</p>
<p>Every employee has a pay grade. An employee can be promoted to a higher pay grade, but the mechanics of how that works is something we will not need to deal with.</p>
<p>Normally, every year, everyone gets a raise by 10%. But to encourage behaviors that give an employee a higher pay grade, such employee cannot get raises indefinitely on a given pay grade. Each grade has its associated maximum pay. If this amount of money is reached, an employee does not get a raise anymore until they reach a higher pay grade.</p>
<p>Additionally, every employee on their 5th anniversary of working for the company, gets a special, one-time bonus which is twice their current payment.</p>
<p><strong>Benjamin:</strong> Looks like the source code repository just finished synchronizing. Let’s take a bite at the code!</p>
<p><strong>Johnny:</strong> Sure, here you go:</p>
<pre class="sourceCode java"><code class="sourceCode java"><span class="kw">public</span> <span class="kw">class</span> CompanyPolicies : IDisposable
{
  readonly SqlRepository _repository
    = <span class="kw">new</span> <span class="fu">SqlRepository</span>();
  
  <span class="kw">public</span> <span class="dt">void</span> <span class="fu">ApplyYearlyIncentivePlan</span>()
  {
    var employees = _repository.<span class="fu">CurrentEmployees</span>();

    <span class="fu">foreach</span>(var employee in employees)
    {
      var payGrade = employee.<span class="fu">GetPayGrade</span>();
      <span class="co">//evaluate raise</span>
      <span class="kw">if</span>(employee.<span class="fu">GetSalary</span>() &lt; payGrade.<span class="fu">Maximum</span>)
      {
        var newSalary 
          = employee.<span class="fu">GetSalary</span>() 
          + employee.<span class="fu">GetSalary</span>() 
          * <span class="fl">0.1</span>;
        employee.<span class="fu">SetSalary</span>(newSalary);
      }
  
      <span class="co">//evaluate one-time bonus</span>
      <span class="kw">if</span>(employee.<span class="fu">GetYearsOfService</span>() == <span class="dv">5</span>)
      {
        var oneTimeBonus = employee.<span class="fu">GetSalary</span>() * <span class="dv">2</span>;
        employee.<span class="fu">SetBonusForYear</span>(<span class="dv">2014</span>, oneTimeBonus);
      }
  
      employee.<span class="fu">Save</span>();
    }
  }
  
  <span class="kw">public</span> <span class="dt">void</span> <span class="fu">Dispose</span>()
  {
    _repository.<span class="fu">Dispose</span>();
  }
}</code></pre>
<p><strong>Benjamin:</strong> Wow, there is a lot of literal constants all around and functional decomposition is barely done!</p>
<p><strong>Johnny:</strong> Yeah. We won’t be fixing all of that today. Still, we will follow the boy scout rule and “leave the campground cleaner than we found it”.</p>
<p><strong>Benjamin:</strong> What’s our assignment?</p>
<p><strong>Johnny:</strong> First of all, we need to provide our users a choice between an SQL database and a NoSQL one. To achieve our goal, we need to be somehow able to make the <code>CompanyPolicies</code> class database type-agnostic. For now, as you can see, the implementation is coupled to the specific <code>SqlRepository</code>, because it creates a specific instance itself:</p>
<pre class="sourceCode java"><code class="sourceCode java"><span class="kw">public</span> <span class="kw">class</span> CompanyPolicies : IDisposable
{
  readonly SqlRepository _repository
    = <span class="kw">new</span> <span class="fu">SqlRepository</span>();</code></pre>
<p>Now, we need to evaluate the options we have to pick the best one. What options do you see, Benjamin?</p>
<p><strong>Benjamin:</strong> Well, we could certainly extract an interface from <code>SqlRepository</code> and introduce an if statement to the constructor like this:</p>
<pre class="sourceCode java"><code class="sourceCode java"><span class="kw">public</span> <span class="kw">class</span> CompanyPolicies : IDisposable
{
  readonly Repository _repository;

  <span class="kw">public</span> <span class="fu">CompanyPolicies</span>()
  {
    <span class="kw">if</span>(...)
    {
      _repository = <span class="kw">new</span> <span class="fu">SqlRepository</span>();
    }
    <span class="kw">else</span>
    {
      _repository = <span class="kw">new</span> <span class="fu">NoSqlRepository</span>();
    }
  }</code></pre>
<p><strong>Johnny:</strong> True, but this option has few deficiencies. First of all, remember we’re trying to follow the boy scout rule and by using this option we introduce more complexity to the CommonPolicies class. Also, let’s say tomorrow someone writes another class for, say, reporting and this class will also need to access the repository – they will need to make the same decision on repositories in their code as we do in ours. This effectively means duplicating code. Thus, I’d rather evaluate further options and check if we can come up with something better. What’s our next option?</p>
<p><strong>Benjamin:</strong> Another option would be to change the SqlRepository itself to be just a wrapper around the actual database access, like this:</p>
<pre class="sourceCode java"><code class="sourceCode java"><span class="kw">public</span> <span class="kw">class</span> SqlRepository : IDisposable
{
  readonly Repository _repository;

  <span class="kw">public</span> <span class="fu">SqlRepository</span>()
  {
    <span class="kw">if</span>(...)
    {
      _repository = <span class="kw">new</span> <span class="fu">RealSqlRepository</span>();
    }
    <span class="kw">else</span>
    {
      _repository = <span class="kw">new</span> <span class="fu">RealNoSqlRepository</span>();
    }
  }

  IList&lt;Employee&gt; <span class="fu">CurrentEmployees</span>()
  {
    <span class="kw">return</span> _repository.<span class="fu">CurrentEmployees</span>();
  }</code></pre>
<p><strong>Johnny:</strong> Sure, this is an approach that could work and would be worth considering for very serious legacy code, as it does not force us to change the <code>CompanyPolicies</code> class at all. However, there are some issues with it. First of all, the <code>SqlRepository</code> name would be misleading. Second, look at the <code>CurrentEmployees()</code> method – all it does is delegating a call to the implementation chosen in the constructor. With every new method required of the repository, we’ll need to add new delegating methods. In reality, it isn’t such a big deal, but maybe we can do better than that?</p>
<p><strong>Benjamin:</strong> Let me think, let me think… I evaluated the option where <code>CompanyPolicies</code> class makes the choice between repositories. I also evaluated the option where we hack the <code>SqlRepository</code> to makes this choice. The last option I can think of is leaving this choice to another, “3rd party” code, that would choose the repository to use and pass it to the <code>CompanyPolicies</code> via constructor, like this:</p>
<pre class="sourceCode java"><code class="sourceCode java"><span class="kw">public</span> <span class="kw">class</span> CompanyPolicies : IDisposable
{
  <span class="kw">private</span> readonly Repository _repository;

  <span class="kw">public</span> <span class="fu">CompanyPolicies</span>(Repository repository)
  {
    _repository = repository;
  }</code></pre>
<p>This way, the <code>CompanyPolicies</code> won’t know what exactly is passed to it via constructor and we can pass whatever we like – either an SQL repository or a NoSQL one!</p>
<p><strong>Johnny:</strong> Great! This is the option we’re looking for! For now, just believe me that this approach will lead us to many good things – you’ll see why later.</p>
<p><strong>Benjamin:</strong> OK, so let me just pull the <code>SqlRepository</code> instance outside the <code>CompanyPolicies</code> class and make it an implementation of <code>Repository</code> interface, then create a constructor and pass the real instance through it…</p>
<p><strong>Johnny:</strong> Sure, I’ll go get some coffee.</p>
<p>… 10 minutes later</p>
<p><strong>Benjamin:</strong> Ha ha! Look at this! I am SUPREME!</p>
<pre class="sourceCode java"><code class="sourceCode java"><span class="kw">public</span> <span class="kw">class</span> CompanyPolicies : IDisposable
{
  <span class="co">//_repository is now an interface</span>
  readonly Repository _repository; 

  <span class="co">// repository is passed from outside.</span>
  <span class="co">// We don&#39;t know what exact implementation it is.</span>
  <span class="kw">public</span> <span class="fu">CompanyPolicies</span>(Repository repository)
  {
    _repository = repository;
  }
  
  <span class="kw">public</span> <span class="dt">void</span> <span class="fu">ApplyYearlyIncentivePlan</span>()
  {
    <span class="co">//... body of the method. Unchanged.</span>
  }
  
  <span class="kw">public</span> <span class="dt">void</span> <span class="fu">Dispose</span>()
  {
    _repository.<span class="fu">Dispose</span>();
  }
}</code></pre>
<p><strong>Johnny:</strong> Hey, hey, hold your horses! There is one thing wrong with this code.</p>
<p><strong>Benjamin:</strong> Huh? I thought this is what we were aiming at.</p>
<p><strong>Johnny:</strong> Yes, with the exception of the <code>Dispose()</code> method. Look closely at the <code>CompanyPolicies</code> class. it is changed so that it is not responsible for creating a repository for itself, but it still disposes of it. This is wrong because <code>CompanyPolicies</code> instance does not have any right to assume it is the only object that is using the repository. If so, then it cannot determine the moment when the repository becomes unnecessary and can be safely disposed of.</p>
<p><strong>Benjamin:</strong> Ok, I get the theory, but why is this bad in practice? Can you give me an example?</p>
<p><strong>Johnny:</strong> Sure, let me sketch a quick example. As soon as you have two instances of <code>CompanyPolicies</code> class, both sharing the same instance of <code>Repository</code>, you’re cooked. This is because one instance of <code>CompanyPolicies</code> may dispose of the repository while the other one may still want to use it.</p>
<p><strong>Benjamin:</strong> So who is going to dispose of the repository?</p>
<p><strong>Johnny:</strong> The same part of the code that creates it, for example the <code>Main</code> method. Let me show you an example of how this may look like:</p>
<pre class="sourceCode java"><code class="sourceCode java"><span class="kw">public</span> <span class="dt">static</span> <span class="dt">void</span> <span class="fu">Main</span>(string[] args)
{
  <span class="fu">using</span>(var repo = <span class="kw">new</span> <span class="fu">SqlRepository</span>())
  {
    var policies = <span class="kw">new</span> <span class="fu">CompanyPolicies</span>(repo);

    <span class="co">//use above created policies </span>
    <span class="co">//for anything you like</span>
  }
}</code></pre>
<p>This way the repository is created at the start of the program and disposed of at the end. Thanks to this, the <code>CompanyPolicies</code> has no disposable fields and it itself does not have to be disposable – we can just delete the <code>Dispose()</code> method:</p>
<pre class="sourceCode java"><code class="sourceCode java"><span class="co">//not implementing IDisposable anymore:</span>
<span class="kw">public</span> <span class="kw">class</span> CompanyPolicies 
{
  <span class="co">//_repository is now an interface</span>
  readonly Repository _repository; 

  <span class="co">//New constructor</span>
  <span class="kw">public</span> <span class="fu">CompanyPolicies</span>(Repository repository)
  {
    _repository = repository;
  }
  
  <span class="kw">public</span> <span class="dt">void</span> <span class="fu">ApplyYearlyIncentivePlan</span>()
  {
    <span class="co">//... body of the method. No changes</span>
  }

  <span class="co">//no Dispose() method anymore</span>
}</code></pre>
<p><strong>Benjamin:</strong> Cool. So, what now? Seems we have the <code>CompanyPolicies</code> class depending on repository abstraction instead of an actual implementation, like SQL repository. My guess is that we will be able to make another class implementing the interface for NoSQL data access and just pass it through the constructor instead of the original one.</p>
<p><strong>Johnny:</strong> Yes. For example, look at <code>CompanyPolicies</code> component. We can compose it with a repository like this:</p>
<pre class="sourceCode java"><code class="sourceCode java">var policies 
  = <span class="kw">new</span> <span class="fu">CompanyPolicies</span>(<span class="kw">new</span> <span class="fu">SqlRepository</span>());</code></pre>
<p>or like this:</p>
<pre class="sourceCode java"><code class="sourceCode java">var policies 
  = <span class="kw">new</span> <span class="fu">CompanyPolicies</span>(<span class="kw">new</span> <span class="fu">NoSqlRepository</span>());</code></pre>
<p>without changing the code of <code>CompanyPolicies</code>. This means that <code>CompanyPolicies</code> does not need to know what <code>Repository</code> exactly it is composed with, as long as this <code>Repository</code> follows the required interface and meets expectations of <code>CompanyPolicies</code> (e.g. does not throw exceptions when it is not supposed to do so). An implementation of <code>Repository</code> may be itself a very complex and composed of another set of classes, for example something like this:</p>
<pre class="sourceCode java"><code class="sourceCode java"><span class="kw">new</span> <span class="fu">SqlRepository</span>(
  <span class="kw">new</span> <span class="fu">ConnectionString</span>(<span class="st">&quot;...&quot;</span>), 
  <span class="kw">new</span> <span class="fu">AccessPrivileges</span>(
    <span class="kw">new</span> Role(<span class="st">&quot;Admin&quot;</span>), 
    <span class="kw">new</span> Role(<span class="st">&quot;Auditor&quot;</span>)
  ),
  <span class="kw">new</span> <span class="fu">InMemoryCache</span>()
);</code></pre>
<p>but the <code>CompanyPolicies</code> neither knows or cares about this, as long as it can use our new <code>Repository</code> implementation just like other repositories.</p>
<p><strong>Benjamin:</strong> I see… So, getting back to our task, shall we proceed with making a NoSQL implementation of the <code>Repository</code> interface?</p>
<p><strong>Johnny:</strong> First, show me the interface that you extracted while I was looking for the coffee.</p>
<p><strong>Benjamin:</strong> Here:</p>
<pre class="sourceCode java"><code class="sourceCode java"><span class="kw">public</span> <span class="kw">interface</span> Repository
{
  IList&lt;Employee&gt; <span class="fu">CurrentEmployees</span>();
}</code></pre>
<p><strong>Johnny:</strong> Ok, so what we need is to create just another implementation and pass it through the constructor depending on what data source is chosen and we’re finished with this part of the task.</p>
<p><strong>Benjamin:</strong> You mean there’s more?</p>
<p><strong>Johnny:</strong> Yeah, but that’s something for tomorrow. I’m exhausted today.</p>
<h2 id="a-quick-retrospective">A Quick Retrospective</h2>
<p>In this chapter, Benjamin learned to appreciate the composability of objects, i.e. the ability to replace object dependencies, providing different behaviors, without the need to change the code of the object class itself. Thus, an object, given replaced dependencies, starts using the new behaviors without noticing that any change occurred at all.</p>
<p>As I said, the code mentioned has some serious flaws. For now, Johnny and Benjamin did not encounter a desperate need to address those flaws, but this is going to change in the next chapter.</p>
<p>Also, after we part again with Johnny and Benjamin, we are going to reiterate the ideas they stumble upon in a more disciplined manner.</p>
<h1 id="telling-not-asking">Telling, not asking</h1>
<p>In this chapter, we’ll get back to Johnny and Benjamin as they introduce another change in the code they are working on. In the process, they discover the impact that return values and getters have on composability of objects.</p>
<h2 id="contractors">Contractors</h2>
<p><strong>Johnny:</strong> G’morning. Ready for another task?</p>
<p><strong>Benjamin:</strong> Of course! What’s next?</p>
<p><strong>Johnny:</strong> Remember the code we worked on yesterday? It contains a policy for regular employees of the company. But the company wants to start hiring contractors as well and needs to include a policy for them in the application.</p>
<p><strong>Benjamin:</strong> So this is what we will be doing today?</p>
<p><strong>Johnny:</strong> That’s right. The policy is going to be different for contractors. While, just as regular employees, they will be receiving raises and bonuses, the rules will be different. I made a small table to allow comparing what we have for regular employees and what we want to add for contractors:</p>
<table>
<thead>
<tr class="header">
<th align="left">Employee Type</th>
<th align="left">Raise</th>
<th align="left">Bonus</th>
</tr>
</thead>
<tbody>
<tr class="odd">
<td align="left">Regular Employee</td>
<td align="left">+10% of current salary if not reached maximum on a given pay grade</td>
<td align="left">+200% of current salary one time after five years</td>
</tr>
<tr class="even">
<td align="left">Contractor</td>
<td align="left">+5% of average salary calculated for last 3 years of service (or all previous years of service if they have worked for less than 3 years</td>
<td align="left">+10% of current salary when a contractor receives score more than 100 for the previous year</td>
</tr>
</tbody>
</table>
<p>So while the workflow is going to be the same for both a regular employee and a contractor:</p>
<ol style="list-style-type: decimal">
<li>Load from repository</li>
<li>Evaluate raise</li>
<li>Evaluate bonus</li>
<li>Save</li>
</ol>
<p>the implementation of some of the steps will be different for each type of employee.</p>
<p><strong>Benjamin:</strong> Correct me if I am wrong, but these “load” and “save” steps do not look like they belong with the remaining two – they describe something technical, while the other steps describe something strictly related to how the company operates…</p>
<p><strong>Johnny:</strong> Good catch, however, this is something we’ll deal with later. Remember the boy scout rule – just don’t make it worse. Still, we’re going to fix some of the design flaws today.</p>
<p><strong>Benjamin:</strong> Aww… I’d just fix all of it right away.</p>
<p><strong>Johnny:</strong> Ha ha, patience, Luke. For now, let’s look at the code we have now before we plan further steps.</p>
<p><strong>Benjamin:</strong> Let me just open my IDE… OK, here it is:</p>
<pre class="sourceCode java"><code class="sourceCode java"><span class="kw">public</span> <span class="kw">class</span> CompanyPolicies 
{
  readonly Repository _repository; 

  <span class="kw">public</span> <span class="fu">CompanyPolicies</span>(Repository repository)
  {
    _repository = repository;
  }
  
  <span class="kw">public</span> <span class="dt">void</span> <span class="fu">ApplyYearlyIncentivePlan</span>()
  {
    var employees = _repository.<span class="fu">CurrentEmployees</span>();

    <span class="fu">foreach</span>(var employee in employees)
    {
      var payGrade = employee.<span class="fu">GetPayGrade</span>();

      <span class="co">//evaluate raise</span>
      <span class="kw">if</span>(employee.<span class="fu">GetSalary</span>() &lt; payGrade.<span class="fu">Maximum</span>)
      {
        var newSalary 
          = employee.<span class="fu">GetSalary</span>() 
          + employee.<span class="fu">GetSalary</span>() 
          * <span class="fl">0.1</span>;
        employee.<span class="fu">SetSalary</span>(newSalary);
      }
  
      <span class="co">//evaluate one-time bonus</span>
      <span class="kw">if</span>(employee.<span class="fu">GetYearsOfService</span>() == <span class="dv">5</span>)
      {
        var oneTimeBonus = employee.<span class="fu">GetSalary</span>() * <span class="dv">2</span>;
        employee.<span class="fu">SetBonusForYear</span>(<span class="dv">2014</span>, oneTimeBonus);
      }
  
      employee.<span class="fu">Save</span>();
    }
  }
}</code></pre>
<p><strong>Benjamin:</strong> Look, Johnny, the class in fact contains all the four steps you mentioned, but they are not named explicitly – instead, their internal implementation for regular employees is just inserted in here. How are we supposed to add the variation of the employee type?</p>
<p><strong>Johnny:</strong> Time to consider our options. We have few of them. Well?</p>
<p><strong>Benjamin:</strong> For now, I can see two. The first one would be to create another class similar to <code>CompanyPolicies</code>, called something like <code>CompanyPoliciesForContractors</code> and implement the new logic there. This would let us leave the original class as is, but we would have to change the places that use <code>CompanyPolicies</code> to use both classes and choose which one to use somehow. Also, we would have to add a separate method to repository for retrieving the contractors.</p>
<p><strong>Johnny:</strong> In addition, we would miss our chance to communicate through the code that the sequence of steps is intentionally similar in both cases. Others who read this code in the future will see that the implementation for regular employees follows the steps: load, evaluate raise, evaluate bonus, save. When they look at the implementation for contractors, they will see the same order of steps, but they will be unable to tell whether the similarity is intentional, or is it there by pure accident.</p>
<p><strong>Benjamin:</strong> So our second option is to put an <code>if</code> statement into the differing steps inside the <code>CompanyPolicies</code> class, to distinguish between regular employees and contractors. The <code>Employee</code> class would have an <code>isContractor()</code> method and depending on what it would return, we would either execute the logic for regular employees or for contractors. Assuming that the current structure of the code looks like this:</p>
<pre class="sourceCode java"><code class="sourceCode java"><span class="fu">foreach</span>(var employee in employees)
{
  <span class="co">//evaluate raise</span>
  ...
  
  <span class="co">//evaluate one-time bonus</span>
  ...
  
  <span class="co">//save employee</span>
}</code></pre>
<p>the new structure would look like this:</p>
<pre class="sourceCode java"><code class="sourceCode java"><span class="fu">foreach</span>(var employee in employees)
{
  <span class="kw">if</span>(employee.<span class="fu">IsContractor</span>())
  {
    <span class="co">//evaluate raise for contractor</span>
    ...
  }
  <span class="kw">else</span>
  {
    <span class="co">//evaluate raise for regular</span>
    ...
  }

  <span class="kw">if</span>(employee.<span class="fu">IsContractor</span>())
  {
    <span class="co">//evaluate one-time bonus for contractor</span>
    ...
  }
  <span class="kw">else</span>
  {
    <span class="co">//evaluate one-time bonus for regular</span>
    ...
  }
  
  <span class="co">//save employee</span>
  ...
}</code></pre>
<p>this way we would show that the steps are the same, but the implementation is different. Also, this would mostly require us to add code and not move the existing code around.</p>
<p><strong>Johnny:</strong> The downside is that we would make the class even uglier than it was when we started. So despite initial easiness, we’ll be doing a huge disservice to future maintainers. We have at least one another option. What would that be?</p>
<p><strong>Benjamin:</strong> Let’s see… we could move all the details concerning the implementation of the steps from <code>CompanyPolicies</code> class into the <code>Employee</code> class itself, leaving only the names and the order of steps in <code>CompanyPolicies</code>:</p>
<pre class="sourceCode java"><code class="sourceCode java"><span class="fu">foreach</span>(var employee in employees)
{
  employee.<span class="fu">EvaluateRaise</span>();
  employee.<span class="fu">EvaluateOneTimeBonus</span>();
  employee.<span class="fu">Save</span>();
}</code></pre>
<p>Then, we could change the <code>Employee</code> into an interface, so that it could be either a <code>RegularEmployee</code> or <code>ContractorEmployee</code> – both classes would have different implementations of the steps, but the <code>CompanyPolicies</code> would not notice, since it would not be coupled to the implementation of the steps anymore – just the names and the order.</p>
<p><strong>Johnny:</strong> This solution would have one downside – we would need to significantly change the current code, but you know what? I’m willing to do it, especially that I was told today that the logic is covered by some tests which we can run to see if a regression was introduced.</p>
<p><strong>Benjamin:</strong> Cool, what do we start with?</p>
<p><strong>Johnny:</strong> The first thing that is between us and our goal are these getters on the <code>Employee</code> class:</p>
<pre class="sourceCode java"><code class="sourceCode java"><span class="fu">GetSalary</span>();
<span class="fu">GetGrade</span>();
<span class="fu">GetYearsOfService</span>();</code></pre>
<p>They just expose too much information specific to the regular employees. It would be impossible to use different implementations when these are around. These setters don’t help much:</p>
<pre class="sourceCode java"><code class="sourceCode java"><span class="fu">SetSalary</span>(newSalary)
<span class="fu">SetBonusForYear</span>(year, amount);</code></pre>
<p>While these are not as bad, we’d better give ourselves more flexibility. Thus, let’s hide all of this behind more abstract methods that hide what actually happens, but reveal our intention.</p>
<p>First, take a look at this code:</p>
<pre class="sourceCode java"><code class="sourceCode java"><span class="co">//evaluate raise</span>
<span class="kw">if</span>(employee.<span class="fu">GetSalary</span>() &lt; payGrade.<span class="fu">Maximum</span>)
{
  var newSalary 
    = employee.<span class="fu">GetSalary</span>() 
    + employee.<span class="fu">GetSalary</span>() 
    * <span class="fl">0.1</span>;
  employee.<span class="fu">SetSalary</span>(newSalary);
}</code></pre>
<p>Each time you see a block of code separated from the rest with blank lines and starting with a comment, you see something screaming “I want to be a separate method that contains this code and has a name after the comment!”. Let’s grant this wish and make it a separate method on the <code>Employee</code> class.</p>
<p><strong>Benjamin:</strong> Ok, wait a minute… here:</p>
<pre class="sourceCode java"><code class="sourceCode java">employee.<span class="fu">EvaluateRaise</span>();</code></pre>
<p><strong>Johnny:</strong> Great! Now, we’ve got another example of this species here:</p>
<pre class="sourceCode java"><code class="sourceCode java"><span class="co">//evaluate one-time bonus</span>
<span class="kw">if</span>(employee.<span class="fu">GetYearsOfService</span>() == <span class="dv">5</span>)
{
  var oneTimeBonus = employee.<span class="fu">GetSalary</span>() * <span class="dv">2</span>;
  employee.<span class="fu">SetBonusForYear</span>(<span class="dv">2014</span>, oneTimeBonus);
}</code></pre>
<p><strong>Benjamin:</strong> This one should be even easier… Ok, take a look:</p>
<pre class="sourceCode java"><code class="sourceCode java">employee.<span class="fu">EvaluateOneTimeBonus</span>();</code></pre>
<p><strong>Johnny:</strong> Almost good. I’d only leave out the information that the bonus is one-time from the name.</p>
<p><strong>Benjamin:</strong> Why? Don’t we want to include what happens in the method name?</p>
<p><strong>Johnny:</strong> Actually, no. What we want to include is our intention. The bonus being one-time is something specific to the regular employees and we want to abstract away the details about this or that kind of employee, so that we can plug in different implementations without making the method name lie. The names should reflect that we want to evaluate a bonus, whatever that means for a particular type of employee. Thus, let’s make it:</p>
<pre class="sourceCode java"><code class="sourceCode java">employee.<span class="fu">EvaluateBonus</span>();</code></pre>
<p><strong>Benjamin:</strong> Ok, I get it. No problem.</p>
<p><strong>Johnny:</strong> Now let’s take a look at the full code of the <code>EvaluateIncentivePlan</code> method to see whether it is still coupled to details specific to regular employees. Here’s the code:</p>
<pre class="sourceCode java"><code class="sourceCode java"><span class="kw">public</span> <span class="dt">void</span> <span class="fu">ApplyYearlyIncentivePlan</span>()
{
  var employees = _repository.<span class="fu">CurrentEmployees</span>();

  <span class="fu">foreach</span>(var employee in employees)
  {
    employee.<span class="fu">EvaluateRaise</span>();
    employee.<span class="fu">EvaluateBonus</span>();
    employee.<span class="fu">Save</span>();
  }
}</code></pre>
<p><strong>Benjamin:</strong> It seems that there is no coupling to the details about regular employees anymore. Thus, we can safely make the repository return a combination of regulars and contractors without this code noticing anything. Now I think I understand what you were trying to achieve. If we make interactions between objects happen on a more abstract level, then we can put in different implementations with less effort.</p>
<p><strong>Johnny:</strong> True. Can you see another thing related to the lack of return values on all of employee’s methods in the current implementation?</p>
<p><strong>Benjamin:</strong> Actually, no. Does it matter?</p>
<p><strong>Johnny:</strong> Well, if <code>Employee</code> methods had return values and this code depended on them, all subclasses of <code>Employee</code> would be forced to supply return values as well and these return values would need to match the expectations of the code that calls these methods, whatever these expectations were. This would make introducing other kinds of employees harder. But now that there are no return values, we can, for example:</p>
<ul>
<li>introduce a <code>TemporaryEmployee</code> that has no raises, by leaving its <code>EvaluateRaise()</code> method empty, and the code that uses employees will not notice.</li>
<li>introduce a <code>ProbationEmployee</code> that has no bonus policy, by leaving its <code>EvaluateBonus()</code> method empty, and the code that uses employees will not notice.</li>
<li>introduce an <code>InMemoryEmployee</code> that has empty <code>Save()</code> method, and the code that uses employees will not notice.</li>
</ul>
<p>As you see, by asking the objects less, and telling it more, we get greater flexibility to create alternative implementations and the composability, which we talked about yesterday, increases!</p>
<p><strong>Benjamin:</strong> I see… So telling objects what to do instead of asking them for their data makes the interactions between objects more abstract, and so, more stable, increasing composability of interacting objects. This is a valuable lesson – it is the first time I hear this and it seems a pretty powerful concept.</p>
<h2 id="a-quick-retrospective-1">A Quick Retrospective</h2>
<p>In this chapter, Benjamin learned that the composability of objects (not to mention clarity) is reinforced when interactions between them are: abstract, logical and stable. Also, he discovered, with Johnny’s help, that it is further strengthened by following a design style where objects are told what to do instead of asked to give away information to somebody who then makes the decision on their behalf. This is because if an API of an abstraction is built around answering to specific questions, the clients of the abstraction tend to ask it a lot of questions and are coupled to both those questions and some aspects of the answers (i.e. what is in the return values). This makes creating another implementation of abstraction harder, because each new implementation of the abstraction needs to not only provide answers to all those questions, but the answers are constrained to what the client expects. When abstraction is merely told what its client wants it to achieve, the clients are decoupled from most of the details of how this happens. This makes introducing new implementations of abstraction easier – it often even lets us define implementations with all methods empty without the client noticing at all.</p>
<p>These are all important conclusions that will lead us towards TDD with mock objects.</p>
<p>Time to leave Johnny and Benjamin for now. In the next chapter, I’m going to reiterate on their discoveries and put them in a broader context.</p>
<h1 id="the-need-for-mock-objects">The need for mock objects</h1>
<p>We already experienced mock objects in the chapter about tools, although at that point, I gave you an oversimplified and deceiving explanation of what a mock object is, promising that I will make up for it later. Now is the time.</p>
<p>Mock objects were made with specific goal in mind. My hope is that when you understand the real goal, you will probably understand the means to the goal far better.</p>
<p>In this chapter, we will explore the qualities of object oriented design which make mock objects a viable tool.</p>
<h2 id="composability-again">Composability… again!</h2>
<p>In the two previous chapters, we followed Johnny and Benjamin in discovering the benefits of and prerequisites for composability of objects. Actually, composability is the number one quality of the design we’re after. After reading Johhny and Benjamin’s story, you might have some questions regarding composability. Hopefully, they are among the ones answered in the next few chapters. Ready?</p>
<h1 id="why-do-we-need-composability">Why do we need composability?</h1>
<p>It might seem stupid to ask this question here – if you have managed to stay with me this long, then you’re probably motivated enough not to need a justification? Well, anyway, it’s still worth discussing it a little. Hopefully, you’ll learn as much reading this back-to-basics chapter as I did writing it.</p>
<h2 id="pre-object-oriented-approaches">Pre-object oriented approaches</h2>
<p>Back in the days of procedural programming<a href="#fn2" class="footnoteRef" id="fnref2"><sup>2</sup></a>, when we wanted to execute a different code based on some factor, it was usually achieved using an ‘if’ statement. For example, if our application was in need to be able to use different kinds of alarms, like a loud alarm (that plays a loud sound) and a silent alarm (that does not play any sound, but instead silently contacts the police) interchangeably, then usually, we could achieve this using a conditional like in the following function:</p>
<pre class="sourceCode c"><code class="sourceCode c"><span class="dt">void</span> triggerAlarm(Alarm* alarm)
{
  <span class="kw">if</span>(alarm-&gt;kind == LOUD_ALARM)
  {
    playLoudSound(alarm);
  }
  <span class="kw">else</span> <span class="kw">if</span>(alarm-&gt;kind == SILENT_ALARM)
  {
    notifyPolice(alarm);
  }
}</code></pre>
<p>The code above makes decision based on the alarm kind which is embedded in the alarm structure:</p>
<pre class="sourceCode c"><code class="sourceCode c"><span class="kw">struct</span> Alarm
{
  <span class="dt">int</span> kind;
  <span class="co">//other data</span>
};</code></pre>
<p>If the alarm kind is the loud one, it executes behavior associated with loud alarm. If this is a silent alarm, the behavior for silent alarms is executed. This seems to work. Unfortunately, if we wanted to make a second decision based on the alarm kind (e.g. we needed to disable the alarm), we would need to query the alarm kind again. This would mean duplicating the conditional code, just with a different set of actions to perform, depending on what kind of alarm we were dealing with:</p>
<pre class="sourceCode c"><code class="sourceCode c"><span class="dt">void</span> disableAlarm(Alarm* alarm)
{
  <span class="kw">if</span>(alarm-&gt;kind == LOUD_ALARM)
  {
    stopLoudSound(alarm);
  }
  <span class="kw">else</span> <span class="kw">if</span>(alarm-&gt;kind == SILENT_ALARM)
  {
    stopNotfyingPolice(alarm);
  }
}</code></pre>
<p>Do I have to say why this duplication is bad? Do I hear a “no”? My apologies then, but I’ll tell you anyway. The duplication means that every time a new kind of alarm is introduced, a developer has to remember to update both places that contain ‘if-else’ – the compiler will not force this. As you are probably aware, in the context of teams, where one developer picks up work that another left and where, from time to time, people leave to find another job, expecting someone to “remember” to update all the places where the logic is duplicated is asking for trouble.</p>
<p>So, we see that the duplication is bad, but can we do something about it? To answer this question, let’s take a look at the reason the duplication was introduced. And the reason is: We have two things we want to be able to do with our alarms: triggering and disabling. In other words, we have a set of questions we want to be able to ask an alarm. Each kind of alarm has a different way of answering these questions – resulting in having a set of “answers” specific to each alarm kind:</p>
<table>
<thead>
<tr class="header">
<th align="left">Alarm Kind</th>
<th align="left">Triggering</th>
<th align="left">Disabling</th>
</tr>
</thead>
<tbody>
<tr class="odd">
<td align="left">Loud Alarm</td>
<td align="left"><code>playLoudSound()</code></td>
<td align="left"><code>stopLoudSound()</code></td>
</tr>
<tr class="even">
<td align="left">Silent Alarm</td>
<td align="left"><code>notifyPolice()</code></td>
<td align="left"><code>stopNotfyingPolice()</code></td>
</tr>
</tbody>
</table>
<p>So, at least conceptually, as soon as we know the alarm kind, we already know which set of behaviors (represented as a row in the above table) it needs. We could just decide the alarm kind once and associate the right set of behaviors with the data structure. Then, we would not have to query the alarm kind in few places as we did, but instead, we could say: “execute triggering behavior from the set of behaviors associated with this alarm, whatever it is”.</p>
<p>Unfortunately, procedural programming does not let’s bind behaviors with data. As a matter of fact, the whole paradigm of procedural programming is about separating behaviors and data! Well, honestly, they had some answers to those concerns, but these answers were mostly awkward (for those of you that still remember C language: I’m talking about macros and function pointers). So, as data and behaviors are separated, we need to query the data each time we want to pick a behavior based on it. That’s why we have the duplication.</p>
<h2 id="object-oriented-programming-to-the-rescue">Object oriented programming to the rescue!</h2>
<p>On the other hand, object oriented programming has for a long time made available two mechanisms that enable what we didn’t have in procedural languages:</p>
<ol style="list-style-type: decimal">
<li>Classes – that allow binding behavior together with data</li>
<li>Polymorphism – allows executing behavior without knowing the exact class that holds them, but knowing only a set of behaviors that it supports. This knowledge is obtained by having an abstract type (interface or an abstract class) define this set of behaviors, with no real implementation. Then we can make other classes that provide their own implementation of the behaviors that are declared to be supported by the abstract type. Finally, we can use the instances of those classes where an instance of the abstract type is expected. In case of statically-typed languages, this requires implementing an interface or inheriting from an abstract class.</li>
</ol>
<p>So, in case of our alarms, we could make an interface with the following signature:</p>
<pre class="sourceCode java"><code class="sourceCode java"><span class="kw">public</span> <span class="kw">interface</span> Alarm
{
  <span class="dt">void</span> <span class="fu">Trigger</span>();
  <span class="dt">void</span> <span class="fu">Disable</span>();
}</code></pre>
<p>and then make two classes: <code>LoudAlarm</code> and <code>SilentAlarm</code>, both implementing the <code>Alarm</code> interface. Example for <code>LoudAlarm</code>:</p>
<pre class="sourceCode java"><code class="sourceCode java"><span class="kw">public</span> <span class="kw">class</span> LoudAlarm : Alarm
{
  <span class="kw">public</span> <span class="dt">void</span> <span class="fu">Trigger</span>()
  {
    <span class="co">//play very loud sound</span>
  }

  <span class="kw">public</span> <span class="dt">void</span> <span class="fu">Disable</span>()
  {
    <span class="co">//stop playing the sound</span>
  }
}</code></pre>
<p>Now, we can make parts of code use the alarm, but by knowing the interface only instead of the concrete classes. This makes the parts of the code that use alarm this way not having to check which alarm they are dealing with. Thus, what previously looked like this:</p>
<pre class="sourceCode c"><code class="sourceCode c"><span class="kw">if</span>(alarm-&gt;kind == LOUD_ALARM)
{
  playLoudSound(alarm);
}
<span class="kw">else</span> <span class="kw">if</span>(alarm-&gt;kind == SILENT_ALARM)
{
  notifyPolice(alarm);
}</code></pre>
<p>becomes just:</p>
<pre class="sourceCode java"><code class="sourceCode java">alarm.<span class="fu">Trigger</span>();</code></pre>
<p>where <code>alarm</code> is either <code>LoudAlarm</code> or <code>SilentAlarm</code>, but seen polymorphically as <code>Alarm</code>, so there’s no need for ‘if-else’ anymore.</p>
<p>But hey, isn’t this cheating? Even provided I can execute the trigger behavior on an alarm without knowing the actual class of the alarm, I still have to decide which class it is in the place where I create the actual instance:</p>
<pre class="sourceCode java"><code class="sourceCode java"><span class="co">// we must know the exact type here:</span>
alarm = <span class="kw">new</span> <span class="fu">LoudAlarm</span>(); </code></pre>
<p>so it looks like I am not eliminating the ‘else-if’ after all, just moving it somewhere else! This may be true (we will talk more about it in future chapters), but the good news is that I eliminated at least the duplication by making our dream of “picking the right set of behaviors to use with certain data once” come true.</p>
<p>Thanks to this, I create the alarm once, and then I can take it and pass it to ten, a hundred or a thousand different places where I will not have to determine the alarm kind anymore to use it correctly.</p>
<p>This allows writing a lot of classes that have no knowledge whatsoever about the real class of the alarm they are dealing with, yet are able to use the alarm just fine only by knowing a common abstract type – <code>Alarm</code>. If we are able to do that, we arrive at a situation where we can add more alarms implementing <code>Alarm</code> and watch existing objects that are already using <code>Alarm</code> work with these new alarms without any change in their source code! There is one condition, however – the <strong>creation of the alarm instances must be moved out of the classes that use them</strong>. That’s because, as we already observed, to create an alarm using a <code>new</code> operator, we have to know the exact type of the alarm we are creating. So whoever creates an instance of <code>LoudAlarm</code> or <code>SilentAlarm</code>, loses its uniformity, since it is not able to depend solely on the <code>Alarm</code> interface.</p>
<h2 id="the-power-of-composition">The power of composition</h2>
<p>Moving creation of alarm instances away from the classes that use those alarms brings up an interesting problem – if an object does not create the objects it uses, then who does it? A solution is to make some special places in the code that are only responsible for composing a system from context-independent objects<a href="#fn3" class="footnoteRef" id="fnref3"><sup>3</sup></a>. We saw this already as Johnny was explaining composability to Benjamin. He used the following example:</p>
<pre class="sourceCode java"><code class="sourceCode java"><span class="kw">new</span> <span class="fu">SqlRepository</span>(
  <span class="kw">new</span> <span class="fu">ConnectionString</span>(<span class="st">&quot;...&quot;</span>), 
  <span class="kw">new</span> <span class="fu">AccessPrivileges</span>(
    <span class="kw">new</span> Role(<span class="st">&quot;Admin&quot;</span>), 
    <span class="kw">new</span> Role(<span class="st">&quot;Auditor&quot;</span>)
  ),
  <span class="kw">new</span> <span class="fu">InMemoryCache</span>()
);</code></pre>
<p>We can do the same with our alarms. Let’s say that we have a secure area that has three buildings with different alarm policies:</p>
<ul>
<li>Office building – the alarm should silently notify guards during the day (to keep office staff from panicking) and loud during the night, when guards are on patrol.</li>
<li>Storage building – as it is quite far and the workers are few, we want to trigger loud and silent alarms at the same time</li>
<li>Guards building – as the guards are there, no need to notify them. However, a silent alarm should call police for help instead, and a loud alarm is desired as well</li>
</ul>
<p>Note that besides just triggering loud or silent alarm, we have a requirement for a combination (“loud and silent alarms at the same time”) and a conditional (“silent during the day and loud during the night”). we could just hardcode some <code>for</code>s and <code>if-else</code>s in our code, but instead, let’s factor out these two operations (combination and choice) into separate classes implementing the alarm interface.</p>
<p>Let’s call the class implementing the choice between two alarms <code>DayNightSwitchedAlarm</code>. Here is the source code:</p>
<pre class="sourceCode java"><code class="sourceCode java"><span class="kw">public</span> <span class="kw">class</span> DayNightSwitchedAlarm : Alarm
{
  <span class="kw">private</span> readonly Alarm _dayAlarm;
  <span class="kw">private</span> readonly Alarm _nightAlarm;
  
  <span class="kw">public</span> <span class="fu">DayNightSwitchedAlarm</span>(
    Alarm dayAlarm,
    Alarm nightAlarm)
  {
    _dayAlarm = dayAlarm;
    _nightAlarm = nightAlarm;
  }
  
  <span class="kw">public</span> <span class="dt">void</span> <span class="fu">Trigger</span>()
  {
    <span class="kw">if</span>(<span class="co">/* is day */</span>)
    {
      _dayAlarm.<span class="fu">Trigger</span>();
    }
    <span class="kw">else</span>
    {
      _nightAlarm.<span class="fu">Trigger</span>();
    }
  }

  <span class="kw">public</span> <span class="dt">void</span> <span class="fu">Disable</span>()
  {
    _dayAlarm.<span class="fu">Disable</span>();
    _nightAlarm.<span class="fu">Disable</span>();
  }
}</code></pre>
<p>Studying the above code, it is apparent that this is not an alarm <em>per se</em>, e.g. it does not raise any sound or notification, but rather, it contains some rules on how to use other alarms. This is the same concept as power splitters in real life, which act as electric devices but do not do anything other than redirecting the electricity to other devices.</p>
<p>Next, let’s use the same approach and model the combination of two alarms as a class called <code>HybridAlarm</code>. Here is the source code:</p>
<pre class="sourceCode java"><code class="sourceCode java"><span class="kw">public</span> <span class="kw">class</span> HybridAlarm : Alarm
{
  <span class="kw">private</span> readonly Alarm _alarm1;
  <span class="kw">private</span> readonly Alarm _alarm2;
  
  <span class="kw">public</span> <span class="fu">HybridAlarm</span>(
    Alarm alarm1,
    Alarm alarm2)
  {
    _alarm1 = alarm1;
    _alarm2 = alarm2;
  }
  
  <span class="kw">public</span> <span class="dt">void</span> <span class="fu">Trigger</span>()
  {
    _alarm1.<span class="fu">Trigger</span>();
    _alarm2.<span class="fu">Trigger</span>();
  }

  <span class="kw">public</span> <span class="dt">void</span> <span class="fu">Disable</span>()
  {
    _alarm1.<span class="fu">Disable</span>();
    _alarm2.<span class="fu">Disable</span>();
  }
}</code></pre>
<p>Using these two classes along with already existing alarms, we can implement the requirements by composing instances of those classes like this:</p>
<pre class="sourceCode java"><code class="sourceCode java"><span class="kw">new</span> <span class="fu">SecureArea</span>(
  <span class="kw">new</span> <span class="fu">OfficeBuilding</span>(
    <span class="kw">new</span> <span class="fu">DayNightSwitchedAlarm</span>(
      <span class="kw">new</span> <span class="fu">SilentAlarm</span>(<span class="st">&quot;222-333-444&quot;</span>), 
      <span class="kw">new</span> <span class="fu">LoudAlarm</span>()
    )
  ),
  <span class="kw">new</span> <span class="fu">StorageBuilding</span>(
    <span class="kw">new</span> <span class="fu">HybridAlarm</span>(
      <span class="kw">new</span> <span class="fu">SilentAlarm</span>(<span class="st">&quot;222-333-444&quot;</span>),
      <span class="kw">new</span> <span class="fu">LoudAlarm</span>()
    )
  ),
  <span class="kw">new</span> <span class="fu">GuardsBuilding</span>(
    <span class="kw">new</span> <span class="fu">HybridAlarm</span>(
      <span class="kw">new</span> <span class="fu">SilentAlarm</span>(<span class="st">&quot;919&quot;</span>), <span class="co">//call police</span>
      <span class="kw">new</span> <span class="fu">LoudAlarm</span>()
    )
  )
);</code></pre>
<p>Note that the fact that we implemented combination and choice of alarms as separate objects implementing the <code>Alarm</code> interface allows us to define new, interesting alarm behaviors using the parts we already have, but composing them together differently. For example, we might have, as in the above example:</p>
<pre class="sourceCode java"><code class="sourceCode java"><span class="kw">new</span> <span class="fu">DayNightSwitchAlarm</span>(
  <span class="kw">new</span> <span class="fu">SilentAlarm</span>(<span class="st">&quot;222-333-444&quot;</span>), 
  <span class="kw">new</span> <span class="fu">LoudAlarm</span>());</code></pre>
<p>which would mean triggering silent alarm during a day and loud one during night. However, instead of this combination, we might use:</p>
<pre class="sourceCode java"><code class="sourceCode java"><span class="kw">new</span> <span class="fu">DayNightSwitchAlarm</span>(
  <span class="kw">new</span> <span class="fu">SilentAlarm</span>(<span class="st">&quot;222-333-444&quot;</span>),
  <span class="kw">new</span> <span class="fu">HybridAlarm</span>(
    <span class="kw">new</span> <span class="fu">SilentAlarm</span>(<span class="st">&quot;919&quot;</span>),
    <span class="kw">new</span> <span class="fu">LoudAlarm</span>()
  )
)</code></pre>
<p>Which would mean that we use silent alarm to notify the guards during the day, but a combination of silent (notifying police) and loud during the night. Of course, we are not limited to combining a silent alarm with a loud one only. We can as well combine two silent ones:</p>
<pre class="sourceCode java"><code class="sourceCode java"><span class="kw">new</span> <span class="fu">HybridAlarm</span>(
  <span class="kw">new</span> <span class="fu">SilentAlarm</span>(<span class="st">&quot;919&quot;</span>),
  <span class="kw">new</span> <span class="fu">SilentAlarm</span>(<span class="st">&quot;222-333-444&quot;</span>)
)</code></pre>
<p>Additionally, if we suddenly decided that we do not want alarm at all during the day, we could use a special class called <code>NoAlarm</code> that would implement <code>Alarm</code> interface, but have both <code>Trigger</code> and <code>Disable</code> methods do nothing. The composition code would look like this:</p>
<pre class="sourceCode java"><code class="sourceCode java"><span class="kw">new</span> <span class="fu">DayNightSwitchAlarm</span>(
  <span class="kw">new</span> <span class="fu">NoAlarm</span>(), <span class="co">// no alarm during the day</span>
  <span class="kw">new</span> <span class="fu">HybridAlarm</span>(
    <span class="kw">new</span> <span class="fu">SilentAlarm</span>(<span class="st">&quot;919&quot;</span>),
    <span class="kw">new</span> <span class="fu">LoudAlarm</span>()
  )
)</code></pre>
<p>And, last but not least, we could completely remove all alarms from the guards building using the following <code>NoAlarm</code> class (which is also an <code>Alarm</code>):</p>
<pre class="sourceCode java"><code class="sourceCode java"><span class="kw">public</span> <span class="kw">class</span> NoAlarm : Alarm
{
  <span class="kw">public</span> <span class="dt">void</span> <span class="fu">Trigger</span>()
  {
  }

  <span class="kw">public</span> <span class="dt">void</span> <span class="fu">Disable</span>()
  {
  }
}</code></pre>
<p>and passing it as the alarm to guards building:</p>
<pre class="sourceCode java"><code class="sourceCode java"><span class="kw">new</span> <span class="fu">GuardsBuilding</span>(
  <span class="kw">new</span> <span class="fu">NoAlarm</span>()
)</code></pre>
<p>Noticed something funny about the last few examples? If not, here goes an explanation: in the last few examples, we have twisted the behaviors of our application in wacky ways, but all of this took place in the composition code! We did not have to modify any other existing classes! True, we had to write a new class called <code>NoAlarm</code>, but did not need to modify any other code than the composition code to make objects of this new class work with objects of existing classes!</p>
<p>This ability to change the behavior of our application just by changing the way objects are composed together is extremely powerful (although you will always be able to achieve it only to certain extent), especially in evolutionary, incremental design, where we want to evolve some pieces of code with as little as possible other pieces of code having to realize that the evolution takes place. This ability can be achieved only if our system consists of composable objects, thus the need for composability – an answer to a question raised at the beginning of this chapter.</p>
<h2 id="summary-are-you-still-with-me">Summary – are you still with me?</h2>
<p>We started with what seemed to be a repetition from basic object oriented programming course, using a basic example. It was necessary though to make a fluent transition to the benefits of composability we eventually introduced at the end. I hope you did not get overwhelmed and can understand now why I am putting so much stress on composability.</p>
<p>In the next chapter, we will take a closer look at composing objects itself.</p>
<h1 id="web-messages-and-protocols">Web, messages and protocols</h1>
<p>In the last chapter, we talked a little bit about why composability is valuable, now let’s flesh a little bit of terminology to get more precise understanding.</p>
<h2 id="so-again-what-does-it-mean-to-compose-objects">So, again, what does it mean to compose objects?</h2>
<p>Basically it means that an object has obtained a reference to another object and is able to invoke methods on it. By being composed together, two objects form a small system that can be expanded with more objects as needed. Thus, a bigger object oriented system forms something similar to a web:</p>
<div class="figure">
<img src="images/WebOfObjects.png" alt="Web of objects – the circles are the objects and the arrows are methods invocations from one object on another" />
<p class="caption">Web of objects – the circles are the objects and the arrows are methods invocations from one object on another</p>
</div>
<p>If we take the web metaphor a little bit further, we can note some similarities to e.g. a TCP/IP network:</p>
<ol style="list-style-type: decimal">
<li>An object can send <strong>messages</strong> to other objects (i.e. call methods on them – arrows on the above diagram) via <strong>interfaces</strong>. Each message has a <strong>sender</strong> and at least one <strong>recipient</strong>.</li>
<li>In order to send a message to a recipient, a sender has to acquire an <strong>address</strong> of the recipient, which, in object oriented world, we call a reference (actually, in languages such as C++, references are just that – addresses in memory).</li>
<li>A communication between sender and recipients has to obey certain <strong>protocol</strong>. For example, a sender usually cannot invoke a method passing nulls as all arguments, or should expect an exception if it does so. Don’t worry if you do not see the analogy now – I’ll follow up with more explanation of this topic later).</li>
</ol>
<h2 id="alarms-again">Alarms, again!</h2>
<p>Let’s try to apply this terminology to an example. Imagine that we have an anti-fire alarm system in an office that, when triggered, makes all lifts go to bottom floor, opens them and then disables them. Among others, the office contains automatic lifts, that contain their own remote control systems and mechanical lifts, that are controlled from the outside by a special custom-made mechanism.</p>
<p>Let’s try to model this behavior in code. As you might have guessed, we will have some objects like alarm, automatic lift and mechanical lift. The alarm will control the lifts when triggered.</p>
<p>First, we do not want the alarm to have to distinguish between an automatic and a mechanical lift – this would only add complexity to alarm system, especially that there are plans to add a third kind of lift – a more modern one, so if we made the alarm aware of the different kinds, we would have to modify it each time a new kind of lift is introduced. Thus, we need a special <strong>interface</strong> (let’s call it <code>Lift</code>) to communicate with both <code>AutoLift</code> and <code>MechanicalLift</code> (and <code>ModernLift</code> in the future). Through this interface, an alarm will be able to send messages to both types of lifts without having to know the difference between them.</p>
<pre class="sourceCode java"><code class="sourceCode java"><span class="kw">public</span> <span class="kw">interface</span> Lift
{
  ...
}

<span class="kw">public</span> <span class="kw">class</span> AutoLift : Lift
{
  ...
}

<span class="kw">public</span> <span class="kw">class</span> MechanicalLift : Lift
{
  ...
}</code></pre>
<p>Next, to be able to communicate with specific lifts through the <code>Lift</code> interface, an alarm object has to acquire <strong>“addresses”</strong> of the lift objects (i.e. references to them). We can pass them e.g. through a constructor:</p>
<pre class="sourceCode java"><code class="sourceCode java"><span class="kw">public</span> <span class="kw">class</span> Alarm
{
  <span class="kw">private</span> readonly IEnumerable&lt;Lift&gt; _lifts;

  <span class="co">//obtain &quot;addresses&quot; through here</span>
  <span class="kw">public</span> <span class="fu">Alarm</span>(IEnumerable&lt;Lift&gt; lifts)
  {
    <span class="co">//store the &quot;addresses&quot; for later use</span>
    _lifts = lifts;
  }
}</code></pre>
<p>Then, the alarm can send three kinds of <strong>messages</strong>: <code>GoToBottomFloor()</code>, <code>OpenDoor()</code>, and <code>DisablePower()</code> to any of the lifts through the <code>Lift</code> interface:</p>
<pre class="sourceCode java"><code class="sourceCode java"><span class="kw">public</span> <span class="kw">interface</span> Lift
{
  <span class="dt">void</span> <span class="fu">GoToBottomFloor</span>();
  <span class="dt">void</span> <span class="fu">OpenDoor</span>();
  <span class="dt">void</span> <span class="fu">DisablePower</span>();
}</code></pre>
<p>and, as a matter of fact, it sends all these messages when triggered. The <code>Trigger()</code> method on the alarm looks like this:</p>
<pre class="sourceCode java"><code class="sourceCode java"><span class="kw">public</span> <span class="dt">void</span> <span class="fu">Trigger</span>()
{
  <span class="fu">foreach</span>(var lift in _lifts)
  {
    lift.<span class="fu">GoToBottomFloor</span>();
    lift.<span class="fu">OpenDoor</span>();
    lift.<span class="fu">DisablePower</span>();
  }
}</code></pre>
<p>By the way, note that the order in which the messages are sent <strong>does</strong> matter. For example, if we disabled the power first, asking the powerless lift to go anywhere would be impossible. This is a first sign of a <strong>protocol</strong> existing between the <code>Alarm</code> and a <code>Lift</code>.</p>
<p>In this communication, <code>Alarm</code> is a <strong>sender</strong> – it knows what it is sending (controlling lifts), it knows why (because the alarm is triggered), but does not know what exactly are the recipients going to do when they receive the message – it only knows what it <strong>wants</strong> them to do, but does not know <strong>how</strong> they are going to achieve it. The rest is left to objects that implement <code>Lift</code> (namely, <code>AutoLift</code> and <code>MechanicalLift</code>). They are <strong>recipients</strong> – they do not know who they got the message from (unless they are told in the content of the message somehow – but even then they can be cheated), but they know how to react, based on who they are (<code>AutoLift</code> has its own way of reacting and <code>MechanicalLift</code> has its own), what kind of the message they received (a lift does different thing when asked to go to bottom floor than when it is asked to open its door) and what’s the message content (i.e. method arguments – in this simplistic example there are none, actually).</p>
<p>To illustrate that this separation between a sender and a recipient does, in fact, exist, it is sufficient to say that we could even write an implementation of <code>Lift</code> interface that would just ignore the messages it got from the <code>Alarm</code> (or fake that it did what it was asked for) and the <code>Alarm</code> will not even notice. We sometimes say that this is not the <code>Alarm</code>’s responsibility.</p>
<div class="figure">
<img src="images/SenderRecipientMessage.png" alt="Sender, interface, and recipient" />
<p class="caption">Sender, interface, and recipient</p>
</div>
<p>Ok, I hope we got that part straight. Time for some new requirements. It has been decided that whenever any malfunction happens in the lift when it is executing the alarm emergency procedure, the lift object should report this by throwing an exception called <code>LiftUnoperationalException</code>. This affects both <code>Alarm</code> and implementations of <code>Lift</code>:</p>
<ol style="list-style-type: decimal">
<li>The <code>Lift</code> implementations need to know that when a malfunction happens, they should report it by throwing the exception.</li>
<li>The <code>Alarm</code> must be ready to handle the exception thrown from lifts and act accordingly (e.g. still try to secure other lifts).</li>
</ol>
<p>Here is an exemplary code of <code>Alarm</code> handling the malfunction reports in its <code>Trigger()</code> method:</p>
<pre class="sourceCode java"><code class="sourceCode java"><span class="kw">public</span> <span class="dt">void</span> <span class="fu">Trigger</span>()
{
  <span class="fu">foreach</span>(var lift in _lifts)
  {
    <span class="kw">try</span>
    {
      lift.<span class="fu">GoToBottomFloor</span>();
      lift.<span class="fu">OpenDoor</span>();
      lift.<span class="fu">DisablePower</span>();
    }
    <span class="kw">catch</span>(LiftUnoperationalException e)
    {
      report.<span class="fu">ThatCannotSecure</span>(lift);
    }
  }
}</code></pre>
<p>This is a second example of a <strong>protocol</strong> existing between <code>Alarm</code> and <code>Lift</code> that must be adhered to by both sides.</p>
<h2 id="summary-5">Summary</h2>
<p>Each of the objects in the web can receive messages and most of them send messages to other objects. Throughout the next chapters, I will refer to an object sending a message as <strong>sender</strong> and an object receiving a message as <strong>recipient</strong>.</p>
<p>For now, it may look unjustified to introduce this metaphor of webs, protocols, interfaces etc. but:</p>
<ul>
<li>This is the way <a href="http://c2.com/cgi/wiki?AlanKayOnMessaging">object oriented programming inventors</a> have thought about object oriented systems</li>
<li>It will prove useful as I explain making connections between objects and achieving strong composability in the next chapters</li>
</ul>
<h1 id="composing-a-web-of-objects">Composing a web of objects</h1>
<h2 id="three-important-questions">Three important questions</h2>
<p>Ok, I told you that such a thing as a web of objects exists, that there are connections, protocols and such, but there is one thing I left out: how does a web of objects come into existence?</p>
<p>This is, of course, a fundamental question, because if we are not able to build a web, we do not have a web. In addition, this is a question that is a little more tricky that you may think and it contains three other questions that we need to answer:</p>
<ol style="list-style-type: decimal">
<li>When are objects composed (i.e. when connections are made)?</li>
<li>How does an object obtain a reference to another one in the web (i.e. how connections made)?</li>
<li>Where are objects composed (i.e. where connections are made)?</li>
</ol>
<p>For now, you may have some trouble understanding the difference between those questions, but the good news is that they are the topic of this chapter, so I hope we will have that cleared shortly. Let’s go!</p>
<h2 id="a-preview">A preview</h2>
<p>Before we take a deep dive, let’s try to answer these three questions for a really simple example code of a console application:</p>
<pre class="sourceCode java"><code class="sourceCode java"><span class="kw">public</span> <span class="dt">static</span> <span class="dt">void</span> <span class="fu">Main</span>(string[] args)
{
  var sender = <span class="kw">new</span> <span class="fu">Sender</span>(<span class="kw">new</span> <span class="fu">Recipient</span>());
  
  sender.<span class="fu">Work</span>();
}</code></pre>
<p>And here are the answers to our questions:</p>
<ol style="list-style-type: decimal">
<li>When are objects composed? Answer: up-front, during application startup.</li>
<li>How does an object (<code>Sender</code>) obtain a reference to another one (<code>Recipient</code>)? Answer: the reference is obtained as a constructor parameter.</li>
<li>Where are objects composed? Answer: at application entry point (<code>Main()</code> method)</li>
</ol>
<p>Depending on circumstances, we have different sets of best answers. To find them, let’s take the questions on one by one.</p>
<h2 id="when-are-objects-composed">When are objects composed?</h2>
<p>The quick answer to this question is: as early as possible. Now, that wasn’t too helpful, was it? So here goes a clarification.</p>
<p>Many of the objects we use in our applications can be created and connected up-front when the application starts and can stay this way until the application finishes executing (unless we are doing a web app – then most of the important stuff happens “per request”). Let’s call this part the <strong>static part</strong> of the web.</p>
<p>Apart from that, there’s a <strong>dynamic part</strong> – a part that undergoes constant changes – objects are created, destroyed, connected temporarily, and then disconnected. There are at least two reasons this dynamic part exists:</p>
<ol style="list-style-type: decimal">
<li>Some objects represent requests or user actions that arrive during the application runtime, are processed and then discarded. These objects cannot be composed up-front (because they do not exist yet), but only as early as the events they represent occur. Also, these objects do not live until the application is terminated, but are discarded as soon as the processing of a request is finished. Other objects represent e.g. items in cache that live for some time and then expire, so, again, we do not have these objects up-front and they often do not live as long as the application itself. All of these objects come and go, making temporary connections.</li>
<li>There are objects that have a life span as long as the application itself, but are connected only for the needs of a single interaction (e.g. when one object is passed to a method of another as an argument) or at some point during the application runtime.</li>
</ol>
<p>It is perfectly possible for an object to be part of both static and dynamic part – some of its connections may be made up-front, while others may be created later, e.g. when it is passed inside a message sent to another object (i.e. passed as method parameter).</p>
<h2 id="how-does-a-sender-obtain-a-reference-to-a-recipient-i.e.how-connections-are-made">How does a sender obtain a reference to a recipient (i.e. how connections are made)?</h2>
<p>There are few ways this can happen, each of them useful in certain circumstances. These ways are:</p>
<ol style="list-style-type: decimal">
<li>Receive as constructor parameter</li>
<li>Receive inside a message (i.e. as a method parameter)</li>
<li>Receive in response to message (i.e. as method return value)</li>
<li>Register a recipient with already created sender</li>
</ol>
<p>Let’s have a closer look at what each of them is about and which one to choose in what circumstances.</p>
<h3 id="receive-as-constructor-parameter">Receive as constructor parameter</h3>
<p>Two objects can be composed by passing one into the constructor of another:</p>
<pre class="sourceCode java"><code class="sourceCode java">sender = <span class="kw">new</span> <span class="fu">Sender</span>(recipient);</code></pre>
<p>A sender that receives the recipient then saves a reference to it in a private field for later, like this:</p>
<pre class="sourceCode java"><code class="sourceCode java"><span class="kw">private</span> Recipient _recipient;

<span class="kw">public</span> <span class="fu">Sender</span>(Recipient recipient)
{
  _recipient = recipient;
}</code></pre>
<p>Starting from this point, the <code>Sender</code> may send messages to <code>Recipient</code> at will:</p>
<pre class="sourceCode java"><code class="sourceCode java"><span class="kw">public</span> <span class="fu">DoSomething</span>()
{
  <span class="co">//... other code</span>
  
  _recipient.<span class="fu">DoSomethingElse</span>();
  
  <span class="co">//... other code</span>
}</code></pre>
<h4 id="advantage-what-you-hide-you-can-change">Advantage: “what you hide, you can change”</h4>
<p>Composing using constructors has one significant advantage. By separating object use from construction, we end up with the code that creates a <code>Sender</code> being in a totally different place than the code that uses it. And, as <code>Recipient</code> is passed to <code>Sender</code> during its creation, it is the only place external to the <code>Sender</code> that needs to know that <code>Sender</code> uses <code>Recipient</code>. The part of code that uses <code>Sender</code> is not aware at all that <code>Sender</code> stores a reference to <code>Recipient</code> inside it. This basically means that when <code>Sender</code> is used, e.g. like this:</p>
<pre class="sourceCode java"><code class="sourceCode java">sender.<span class="fu">DoSomething</span>()</code></pre>
<p>the <code>Sender</code> may then react by sending message to <code>Recipient</code>, but the code invoking the <code>DoSomething()</code> method is completely unaware of that – it is hidden. This is good, because “what you hide, you can change”<a href="#fn4" class="footnoteRef" id="fnref4"><sup>4</sup></a> – e.g. if we decide that the <code>Sender</code> needs not use the <code>Recipient</code> to do its duty, the code that uses <code>Sender</code> does not need to change at all – it still looks the same as before:</p>
<pre class="sourceCode java"><code class="sourceCode java">sender.<span class="fu">DoSomething</span>()</code></pre>
<p>All we have to change is the composition code to remove the <code>Recipient</code>:</p>
<pre class="sourceCode java"><code class="sourceCode java"><span class="co">//no need to pass a reference to Recipient anymore</span>
<span class="kw">new</span> <span class="fu">Sender</span>();</code></pre>
<p>and the <code>Sender</code> class itself will work in a different way.</p>
<h4 id="communication-of-intent-required-recipient">Communication of intent: required recipient</h4>
<p>Another advantage of the constructor approach is that if a reference to <code>Recipient</code> is required for a <code>Sender</code> to work correctly and it does not make sense to create a <code>Sender</code> without a <code>Recipient</code>, the signature of the constructor makes it explicit – the compiler will not let us create a <code>Sender</code> without passing <em>something</em> as a <code>Recipient</code>.</p>
<h4 id="where-to-apply">Where to apply</h4>
<p>Passing into constructor is a great solution in cases we want to compose sender with a recipient permanently (i.e. for the lifetime of <code>Sender</code>). In order to be able to do this, a <code>Recipient</code> must, of course, exist before a <code>Sender</code> does. Another less obvious requirement for this composition is that <code>Recipient</code> must be usable at least as long as <code>Sender</code> is usable. In other words, the following is nonsense:</p>
<pre class="sourceCode java"><code class="sourceCode java">sender = <span class="kw">new</span> <span class="fu">Sender</span>(recipient);
recipient.<span class="fu">Dispose</span>(); <span class="co">//but sender is unaware of it </span>
                     <span class="co">//and may still use recipient in:</span>
sender.<span class="fu">DoSomething</span>();</code></pre>
<h3 id="receive-inside-a-message-i.e.as-a-method-parameter">Receive inside a message (i.e. as a method parameter)</h3>
<p>Another common way of composing objects together is passing one object as a parameter of another object’s method call:</p>
<pre class="sourceCode java"><code class="sourceCode java">sender.<span class="fu">DoSomethingWithHelpOf</span>(recipient);</code></pre>
<p>In such case, the objects are most often composed temporarily, just for the time of execution of this single method:</p>
<pre class="sourceCode java"><code class="sourceCode java"><span class="kw">public</span> <span class="dt">void</span> <span class="fu">DoSomethingWithHelpOf</span>(Recipient recipient)
{
  <span class="co">//... perform some logic</span>
  
  recipient.<span class="fu">HelpMe</span>();
  
  <span class="co">//... perform some logic</span>
}</code></pre>
<h4 id="where-to-apply-1">Where to apply</h4>
<p>Contrary to the constructor approach, where a <code>Sender</code> could hide from its user the fact that it needs <code>Recipient</code>, in this case the user of <code>Sender</code> is explicitly responsible for supplying a <code>Recipient</code>. It may look like the coupling of user to <code>Recipient</code> is a disadvantage, but there are scenarios where it is actually <strong>required</strong> for a code using <code>Sender</code> to be able to provide its own <code>Recipient</code> – it lets us use the same sender with different recipients at different times (most often from different parts of the code):</p>
<pre class="sourceCode java"><code class="sourceCode java"><span class="co">//in one place</span>
sender.<span class="fu">DoSomethingWithHelpOf</span>(recipient);

<span class="co">//in another place:</span>
sender.<span class="fu">DoSomethingWithHelpOf</span>(anotherRecipient);

<span class="co">//in yet another place:</span>
sender.<span class="fu">DoSomethingWithHelpOf</span>(yetAnotherRecipient);</code></pre>
<p>If this ability is not required, the constructor approach is better as it removes the then unnecessary coupling between code using <code>Sender</code> and a <code>Recipient</code>.</p>
<h3 id="receive-in-response-to-a-message-i.e.as-method-return-value">Receive in response to a message (i.e. as method return value)</h3>
<p>This method of composing objects relies on an intermediary object – often an implementation of a <a href="http://www.netobjectivestest.com/PatternRepository/index.php?title=TheAbstractFactoryPattern">factory pattern</a> – to supply recipients on request. To simplify things, I will use factories in examples presented in this section, although what I tell you is true for some other <a href="http://en.wikipedia.org/wiki/Creational_pattern">creational patterns</a> as well (also, later in this chapter, I’ll cover some aspects of factory pattern in depth).</p>
<p>To be able to ask a factory for recipients, the sender needs to obtain a reference to it first. Typically, a factory is composed with a sender through constructor (an approach we already discussed). For example:</p>
<pre class="sourceCode java"><code class="sourceCode java">var sender = <span class="kw">new</span> <span class="fu">Sender</span>(recipientFactory);</code></pre>
<p>The factory can then be used by the <code>Sender</code> at will to get a hold of new recipients:</p>
<pre class="sourceCode java"><code class="sourceCode java"><span class="kw">public</span> <span class="kw">class</span> Sender
{
  <span class="co">//...</span>

  <span class="kw">public</span> <span class="fu">DoSomething</span>() 
  {
    <span class="co">//ask the factory for a recipient:</span>
    var recipient = _recipientFactory.<span class="fu">CreateRecipient</span>();
    
    <span class="co">//use the recipient:</span>
    recipient.<span class="fu">DoSomethingElse</span>();
  }
}</code></pre>
<h4 id="where-to-apply-2">Where to apply</h4>
<p>This kind of composition is beneficial when a new recipient is needed each time <code>DoSomething()</code> is called. In this sense it may look much like in case of previously discussed approach of receiving a recipient inside a message. There is one difference, however. Contrary to passing a recipient inside a message, where the code using the <code>Sender</code> passed a <code>Recipient</code> “from outside” of the <code>Sender</code>, in this approach, we rely on a separate object that is used by a <code>Sender</code> “from the inside”.</p>
<p>To be more clear, let’s compare the two approaches. Passing recipient inside a message looks like this:</p>
<pre class="sourceCode java"><code class="sourceCode java"><span class="co">//Sender gets a Recipient from the &quot;outside&quot;:</span>
<span class="kw">public</span> <span class="fu">DoSomething</span>(Recipient recipient) 
{
  recipient.<span class="fu">DoSomethingElse</span>();
}</code></pre>
<p>and obtaining from factory:</p>
<pre class="sourceCode java"><code class="sourceCode java"><span class="co">//a factory is used &quot;inside&quot; Sender</span>
<span class="co">//to obtain a recipient</span>
<span class="kw">public</span> <span class="fu">DoSomething</span>() 
{
  var recipient = _factory.<span class="fu">CreateRecipient</span>();
  recipient.<span class="fu">DoSomethingElse</span>();
}</code></pre>
<p>So in the first example, the decision on which <code>Recipient</code> is used is made by whoever calls <code>DoSomething()</code>. In the factory example, whoever calls <code>DoSomething()</code> does not know at all about the <code>Recipient</code> and cannot directly influence which <code>Recipient</code> is used. The factory makes this decision.</p>
<h4 id="factories-with-parameters">Factories with parameters</h4>
<p>So far, all the factories we considered had creation methods with empty parameter list, but this is not required. As the factory remains the decision maker on which <code>Recipient</code> is used, it can rely on some external parameters to help it make the decision.</p>
<h4 id="not-only-factories">Not only factories</h4>
<p>Throughout this section, we have used a factory as our role model, but the approach of obtaining a recipient in response to a message is wider than that. Other types of objects that fall into this category include, among others: <a href="http://martinfowler.com/eaaCatalog/repository.html">repositories</a>, <a href="http://en.wikipedia.org/wiki/Cache_(computing)">caches</a>, <a href="http://www.blackwasp.co.uk/Builder.aspx">builders</a>, collections<a href="#fn5" class="footnoteRef" id="fnref5"><sup>5</sup></a>. While they are all important topics (which you can look up on the web if you like), they are not required to progress through this chapter so I won’t go in depth on them.</p>
<h3 id="register-a-recipient-with-already-created-sender">Register a recipient with already created sender</h3>
<p>This means passing a recipient to an <strong>already created</strong> sender (contrary to passing as constructor parameter where recipient was passed <strong>during</strong> creation) as a parameter of a method that stores the reference for later use. This may be a “setter” method, although I do not like naming it according to the convention “setWhatever()” – after Kent Beck<a href="#fn6" class="footnoteRef" id="fnref6"><sup>6</sup></a> I find this convention too much implementation-focused instead of purpose-focused. Thus, I pick different names based on what domain concept is modeled by the registration method or what is its purpose.</p>
<p>Note that there is one similarity to the “passing inside a message” approach – in both, a recipient is passed inside a message. The difference is that this time, contrary to “pass inside a message” approach, the passed recipient is not immediately used (and then forgotten), but rather only remembered (registered) for later use.</p>
<p>I hope I can clear up the confusion with a quick example.</p>
<h4 id="example-4">Example</h4>
<p>Suppose we have a temperature sensor that can report its current and historically mean value to whoever subscribes with it. If no one subscribes, the sensor still does its job, because it still has to collect the data for calculating a history-based mean value in case anyone subscribes later.</p>
<p>We may solve the problem by introducing an <a href="http://www.oodesign.com/observer-pattern.html">observer</a> registration mechanism in the sensor implementation. If no observer is registered, the values are not reported (in other words, a registered observer is not required for the object to function, but if there is one, it can take advantage of the reports). For this purpose, let’s make our sensor depend on an interface called <code>TemperatureObserver</code> that could be implemented by various concrete observer classes. The interface declaration looks like this:</p>
<pre class="sourceCode java"><code class="sourceCode java"><span class="kw">public</span> <span class="kw">interface</span> TemperatureObserver
{
  <span class="dt">void</span> <span class="fu">NotifyOn</span>(
    Temperature currentValue,
    Temperature meanValue);  
}</code></pre>
<p>Now we are ready to look at the implementation of the temperature sensor itself and how it uses this <code>TemperatureObserver</code> interface. Let’s say that the class representing the sensor is called <code>TemperatureSensor</code>. Part of its definition could look like this:</p>
<pre class="sourceCode java"><code class="sourceCode java"><span class="kw">public</span> <span class="kw">class</span> TemperatureSensor
{
  <span class="kw">private</span> TemperatureObserver _observer 
    = <span class="kw">new</span> <span class="fu">NullObserver</span>(); <span class="co">//ignores reported values</span>
    
  <span class="kw">private</span> Temperature _meanValue 
    = Temperature.<span class="fu">Celsius</span>(<span class="dv">0</span>);
  
  <span class="co">// + maybe more fields related to storing historical data</span>

  <span class="kw">public</span> <span class="dt">void</span> <span class="fu">Run</span>()
  {
    <span class="kw">while</span>(<span class="co">/* needs to run */</span>)
    {
      var currentValue = <span class="co">/* get current value somehow */</span>;
      _meanValue = <span class="co">/* update mean value somehow */</span>;

      _observer.<span class="fu">NotifyOn</span>(currentValue, _meanValue);
      
      <span class="fu">WaitUntilTheNextMeasurementTime</span>();
    } 
  }
}</code></pre>
<p>As you can see, by default, the sensor reports its values to nowhere (<code>NullObserver</code>), which is a safe default value (using a <code>null</code> for a default value instead would cause exceptions or force us to put an ugly null check inside the <code>Run()</code> method). We have already seen such “null objects”<a href="#fn7" class="footnoteRef" id="fnref7"><sup>7</sup></a> a few times before (e.g. in the previous chapter, when we introduced the <code>NoAlarm</code> class) – <code>NullObserver</code> is just another incarnation of this pattern.</p>
<h4 id="registering-observers">Registering observers</h4>
<p>Still, we want to be able to supply our own observer one day, when we start caring about the measured and calculated values (the fact that we “started caring” may be indicated to our application e.g. by a network message or an event from the user interface). This means we need to have a method inside the <code>TemperatureSensor</code> class to overwrite this default “do-nothing” observer with a custom one <strong>after</strong> the <code>TemperatureSensor</code> instance is created. As I said, I do not like the “SetXYZ()” convention, so I will name the registration method <code>FromNowOnReportTo()</code> and make the observer an argument. Here are the relevant parts of the <code>TemperatureSensor</code> class:</p>
<pre class="sourceCode java"><code class="sourceCode java"><span class="kw">public</span> <span class="kw">class</span> TemperatureSensor
{
  <span class="kw">private</span> TemperatureObserver _observer 
    = <span class="kw">new</span> <span class="fu">NullObserver</span>(); <span class="co">//ignores reported values</span>

  <span class="co">//... ... ...</span>

  <span class="kw">public</span> <span class="dt">void</span> <span class="fu">FromNowOnReportTo</span>(TemperatureObserver observer)
  {
    _observer = observer;
  }
  
  <span class="co">//... ... ...</span>
}</code></pre>
<p>This lets us overwrite the observer with a new one should we ever need to do it. Note that, as I mentioned, this is the place where registration approach differs from the “pass inside a message” approach, where we also received a recipient in a message, but for immediate use. Here, we don’t use the recipient (i.e. the observer) when we get it, but instead we save it for later use.</p>
<h4 id="communication-of-intent-optional-dependency">Communication of intent: optional dependency</h4>
<p>Allowing registering recipients after a sender is created is a way of saying: “the recipient is optional – if you provide one, fine, if not, I will do my work without it”. Please, do not use this kind of mechanism for <strong>required</strong> recipients – these should all be passed through a constructor, making it harder to create invalid objects that are only partially ready to work. Placing a recipient in a constructor signature is effectively saying that “I will not work without it”. Let’s practice – just look at how the following class members signatures talk to you:</p>
<pre class="sourceCode java"><code class="sourceCode java"><span class="kw">public</span> <span class="kw">class</span> Sender
{
  <span class="co">//&quot;I will not work without a Recipient1&quot;</span>
  <span class="kw">public</span> <span class="fu">Sender</span>(Recipient1 recipient1) {...}
  
  <span class="co">//&quot;I will do fine without Recipient2 but you</span>
  <span class="co">//can overwrite the default here to take advantage</span>
  <span class="co">//of some features&quot;</span>
  <span class="kw">public</span> <span class="dt">void</span> <span class="fu">Register</span>(Recipient2 recipient2) {...}
}</code></pre>
<h4 id="more-than-one-observer">More than one observer</h4>
<p>Now, the observer API we just skimmed over gives us the possibility to have a single observer at any given time. When we register a new observer, the reference to the old one is overwritten. This is not really useful in our context, is it? With real sensors, we often want them to report their measurements to multiple places (e.g. we want the measurements printed on screen, saved to database, used as part of more complex calculations). This can be achieved in two ways.</p>
<p>The first way would be to just hold a collection of observers in our sensor, and add to this collection whenever a new observer is registered:</p>
<pre class="sourceCode java"><code class="sourceCode java"><span class="kw">private</span> IList&lt;TemperatureObserver&gt; _observers 
  = <span class="kw">new</span> List&lt;TemperatureObserver&gt;();

<span class="kw">public</span> <span class="dt">void</span> <span class="fu">FromNowOnReportTo</span>(TemperatureObserver observer)
{
  _observers.<span class="fu">Add</span>(observer);
}</code></pre>
<p>In such case, reporting would mean iterating over the observers list:</p>
<pre class="sourceCode java"><code class="sourceCode java">...
<span class="fu">foreach</span>(var observer in _observers)
{
  observer.<span class="fu">NotifyOn</span>(currentValue, meanValue);
}
...</code></pre>
<p>Another, more flexible option, is to use something like we did in the previous chapter with a <code>HybridAlarm</code> (remember? It was an alarm aggregating other alarms) – i.e. instead of introducing a collection in the sensor, we can create a special kind of observer – a “broadcasting observer” that would itself hold collection of other observers (hurrah composability!) and broadcast the values to them every time it itself receives those values:</p>
<pre class="sourceCode java"><code class="sourceCode java"><span class="kw">public</span> <span class="kw">class</span> BroadcastingObserver 
  : TemperatureObserver
{
  <span class="kw">private</span> readonly 
    TemperatureObserver[] _observers;
  
  <span class="kw">public</span> <span class="fu">BroadcastingObserver</span>(
    params TemperatureObserver[] observers)
  {
    _observers = observers;
  }

  <span class="kw">public</span> <span class="dt">void</span> <span class="fu">NotifyOn</span>(
    Temperature currentValue,
    Temperature meanValue)
  {
    <span class="fu">foreach</span>(var observer in _observers)
    {
      observer.<span class="fu">NotifyOn</span>(currentValue, meanValue);
    }
  }  
} </code></pre>
<p>This <code>BroadcastingObserver</code> could be instantiated and registered like this:</p>
<pre class="sourceCode java"><code class="sourceCode java"><span class="co">//instantiation:</span>
var broadcastingObserver 
  = <span class="kw">new</span> <span class="fu">BroadcastingObserver</span>(
      <span class="kw">new</span> <span class="fu">DisplayingObserver</span>(),
      <span class="kw">new</span> <span class="fu">StoringObserver</span>(),
      <span class="kw">new</span> <span class="fu">CalculatingObserver</span>());

...

<span class="co">//registration:</span>
sensor.<span class="fu">FromNowOnReportTo</span>(broadcastingObserver);</code></pre>
<p>The additional benefit of modeling broadcasting as an observer is that it would let us change the broadcasting policy without touching either the sensor code or the other observers. For example, we might introduce <code>ParallelBroadcastObserver</code> that would notify each observer asynchronously instead of sequentially and put it to use by changing the composition code only:</p>
<pre class="sourceCode java"><code class="sourceCode java"><span class="co">//now using parallel observer</span>
var broadcastingObserver 
  = <span class="kw">new</span> <span class="fu">ParallelBroadcastObserver</span>( <span class="co">//change here!</span>
      <span class="kw">new</span> <span class="fu">DisplayingObserver</span>(),
      <span class="kw">new</span> <span class="fu">StoringObserver</span>(),
      <span class="kw">new</span> <span class="fu">CalculatingObserver</span>());

sensor.<span class="fu">FromNowOnReportTo</span>(broadcastingObserver);</code></pre>
<p>Anyway, as I said, use registering instances very wisely and only if you specifically need it. Also, if you do use it, evaluate how allowing changing observers at runtime is affecting your multithreading scenarios. This is because a collection of observers might potentially be modified by two threads at the same time.</p>
<h2 id="where-are-objects-composed">Where are objects composed?</h2>
<p>Ok, we went through some ways of passing a recipient to a sender. We did it from the “internal” perspective of a sender that is given a recipient. What we left out for the most part is the “external” perspective, i.e. who should pass the recipient into the sender?</p>
<p>For almost all of the approaches described above there is no limitation – you pass the recipient from where you need to pass it.</p>
<p>There is one approach, however, that is more limited, and this approach is <strong>passing as constructor parameter</strong>.</p>
<p>Why is that? Because, we are trying to be true to the principle of “separating objects creation from use” and this, in turn, is a result of us striving for composability.</p>
<p>Anyway, if an object cannot both use and create another object, we have to make special objects just for creating other objects (there are some design patterns for how to design such objects, but the most popular and useful is a <strong>factory</strong>) or defer the creation up to the application entry point (there is also a pattern for this, called <strong>composition root</strong>).</p>
<p>So, we have two cases to consider. I’ll start with the second one.</p>
<h3 id="composition-root">Composition Root</h3>
<p>let’s assume, just for fun, that we are creating a mobile game where a player has to defend a castle. This game has two levels. Each level has a castle to defend. When we manage to defend the castle long enough, the level is considered completed and we move to the next one. So, we can break down the domain logic into three classes: a <code>Game</code> that has two <code>Level</code>s and each of them that contain a <code>Castle</code>. let’s also assume that the first two classes violate the principle of separating use from construction, i.e. that a <code>Game</code> creates its own levels and each <code>Level</code> creates its own castle.</p>
<p>A <code>Game</code> class is created in the <code>Main()</code> method of the application:</p>
<pre class="sourceCode java"><code class="sourceCode java"><span class="kw">public</span> <span class="dt">static</span> <span class="dt">void</span> <span class="fu">Main</span>(string[] args)
{
  var game = <span class="kw">new</span> <span class="fu">Game</span>();
  
  game.<span class="fu">Play</span>();
}</code></pre>
<p>The <code>Game</code> creates its own <code>Level</code> objects of specific classes implementing the <code>Level</code> interface and stores them in an array:</p>
<pre class="sourceCode java"><code class="sourceCode java"><span class="kw">public</span> <span class="kw">class</span> Game
{
  <span class="kw">private</span> Level[] _levels = <span class="kw">new</span>[] { 
    <span class="kw">new</span> <span class="fu">Level1</span>(), <span class="kw">new</span> <span class="fu">Level2</span>()
  };
  
  <span class="co">//some methods here that use the levels</span>
}</code></pre>
<p>And the <code>Level</code> implementations create their own castles and assign them to fields of interface type <code>Castle</code>:</p>
<pre class="sourceCode java"><code class="sourceCode java"><span class="kw">public</span> <span class="kw">class</span> Level1
{
  <span class="kw">private</span> Castle _castle = <span class="kw">new</span> <span class="fu">SmallCastle</span>();
  
  <span class="co">//some methods here that use the castle</span>
}

<span class="kw">public</span> <span class="kw">class</span> Level2
{
  <span class="kw">private</span> Castle _castle = <span class="kw">new</span> <span class="fu">BigCastle</span>();
  
  <span class="co">//some methods here that use the castle</span>
}</code></pre>
<p>Now, I said (and I hope you see it in the code above) that the <code>Game</code>, <code>Level1</code> and <code>Level2</code> classes violate the principle of separating use from construction. We don’t like this, do we? So now we will try to make them more compliant with the principle.</p>
<h4 id="achieving-separation-of-use-from-construction">Achieving separation of use from construction</h4>
<p>First, let’s refactor the <code>Level1</code> and <code>Level2</code> according to the principle by moving instantiation of their castles out. As existence of a castle is required for a level to make sense at all – we will say this in code by using the approach of passing a castle through a <code>Level</code>’s constructor:</p>
<pre class="sourceCode java"><code class="sourceCode java"><span class="kw">public</span> <span class="kw">class</span> Level1
{
  <span class="kw">private</span> Castle _castle;
  
  <span class="co">//now castle is received as</span>
  <span class="co">//constructor parameter</span>
  <span class="kw">public</span> <span class="fu">Level1</span>(Castle castle)
  {
    _castle = castle;
  }
  
  <span class="co">//some methods here that use the castle</span>
}

<span class="kw">public</span> <span class="kw">class</span> Level2
{
  <span class="kw">private</span> Castle _castle;
  
  <span class="co">//now castle is received as</span>
  <span class="co">//constructor parameter</span>
  <span class="kw">public</span> <span class="fu">Level2</span>(Castle castle)
  {
    _castle = castle;
  }
  
  <span class="co">//some methods here that use the castle</span>
}</code></pre>
<p>This was easy, wasn’t it? The only problem is that if the instantiations of castles are not in <code>Level1</code> and <code>Level2</code> anymore, then they have to be passed by whoever creates the levels. In our case, this falls on the shoulders of <code>Game</code> class:</p>
<pre class="sourceCode java"><code class="sourceCode java"><span class="kw">public</span> <span class="kw">class</span> Game
{
  <span class="kw">private</span> Level[] _levels = <span class="kw">new</span>[] {
    <span class="co">//now castles are created here as well: </span>
    <span class="kw">new</span> <span class="fu">Level1</span>(<span class="kw">new</span> <span class="fu">SmallCastle</span>()), 
    <span class="kw">new</span> <span class="fu">Level2</span>(<span class="kw">new</span> <span class="fu">BigCastle</span>())
  };
  
  <span class="co">//some methods here that use the levels</span>
}</code></pre>
<p>But remember – this class suffers from the same violation of not separating objects use from construction as the levels did. Thus, to make this class compliant to the principle as well, we have to do the same to it that we did to the level classes – move the creation of levels out of it:</p>
<pre class="sourceCode java"><code class="sourceCode java"><span class="kw">public</span> <span class="kw">class</span> Game
{
  <span class="kw">private</span> Level[] _levels;
  
  <span class="co">//now levels are received as </span>
  <span class="co">//constructor parameter</span>
  <span class="kw">public</span> <span class="fu">Game</span>(Level[] levels)
  {
    _levels = levels;
  }
  
  <span class="co">//some methods here that use the levels</span>
}</code></pre>
<p>There, we did it, but again, the levels now must be supplied by whoever creates the <code>Game</code>. Where do we put them? In our case, the only choice left is the <code>Main()</code> method of our application, so this is exactly what we are going to do:</p>
<pre class="sourceCode java"><code class="sourceCode java"><span class="kw">public</span> <span class="dt">static</span> <span class="dt">void</span> <span class="fu">Main</span>(string[] args)
{
  var game = 
    <span class="kw">new</span> <span class="fu">Game</span>(
      <span class="kw">new</span> Level[] { 
        <span class="kw">new</span> <span class="fu">Level1</span>(<span class="kw">new</span> <span class="fu">SmallCastle</span>()), 
        <span class="kw">new</span> <span class="fu">Level2</span>(<span class="kw">new</span> <span class="fu">BigCastle</span>())
  });
  
  game.<span class="fu">Play</span>();
}</code></pre>
<p>By the way, the <code>Level1</code> and <code>Level2</code> are differed only by the castle types and this difference is no more as we refactored it out, so we can make them a single class and call it e.g. <code>TimeSurvivalLevel</code> (because such level is considered completed when we manage to defend our castle for a specific period of time). After this move, now we have:</p>
<pre class="sourceCode java"><code class="sourceCode java"><span class="kw">public</span> <span class="dt">static</span> <span class="dt">void</span> <span class="fu">Main</span>(string[] args)
{
  var game = 
    <span class="kw">new</span> <span class="fu">Game</span>(
      <span class="kw">new</span> Level[] { 
        <span class="kw">new</span> <span class="fu">TimeSurvivalLevel</span>(<span class="kw">new</span> <span class="fu">SmallCastle</span>()), 
        <span class="kw">new</span> <span class="fu">TimeSurvivalLevel</span>(<span class="kw">new</span> <span class="fu">BigCastle</span>())
  });
  
  game.<span class="fu">Play</span>();
}</code></pre>
<p>Looking at the code above, we might come to another funny conclusion – this violates the principle of separating use from construction as well! First, we create and connect the web of objects and then send the <code>Play()</code> message to the <code>game</code> object. Shouldn’t we fix this as well?</p>
<p>The answer is “no”, for two reasons:</p>
<ol style="list-style-type: decimal">
<li>There is no further place we can defer the creation. Sure, we could move the creation of the <code>Game</code> object and its dependencies into a separate object responsible only for the creation (we call such object <strong>a factory</strong>, as you already know), but it’s a dead end, because it would leave us with the question: where do we create the factory?</li>
<li>The whole point of the principle we are trying to apply is decoupling, i.e. giving ourselves the ability to change one thing without having to change another. When we think of it, there is no point of decoupling the entry point of the application from the application itself, since this is the most application-specific and non-reusable part of the application we can imagine.</li>
</ol>
<p>What is important is that we reached a place where the web of objects is created using constructor approach and we have no place left to defer the the creation of the web (in other words, it is as close as possible to application entry point). Such a place is called <a href="http://blog.ploeh.dk/2011/07/28/CompositionRoot/"><strong>a composition root</strong></a>.</p>
<p>We say that composition root is “as close as possible” to application entry point, because there may be different frameworks in control of your application and you will not always have the <code>Main()</code> method at your service<a href="#fn8" class="footnoteRef" id="fnref8"><sup>8</sup></a>.</p>
<p>Apart from the constructor invocations, the composition root may also contain, e.g., registrations of observers (see registration approach to passing recipients) if such observers are already known at this point. It is also responsible for disposing of all objects it created that require explicit disposal after the application finishes running. This is because it creates them and thus it is the only place in the code that can safely determine when they are not needed.</p>
<p>The composition root above looks quite small, but you can imagine it growing a lot in bigger applications. There are techniques of refactoring the composition root to make it more readable and cleaner – we will explore such techniques in a dedicated chapter.</p>
<h3 id="factories">Factories</h3>
<p>As I previously said, it is not always possible to pass everything through the constructor. One of the approaches we discussed that we can use in such cases is <strong>a factory</strong>.</p>
<p>When we previously talked about factories, we focused on it being just a source of objects. This time we will have a much closer look at what factory is and what are its benefits.</p>
<p>But first, let’s look at an example of a factory emerging in code that was not using it, as a mere consequence of trying to follow the principle of separating objects use from construction.</p>
<h4 id="emerging-factory-example">Emerging factory – example</h4>
<p>Consider the following code that receives a frame from the network (as raw data), then packs it into an object, validates and applies to the system:</p>
<pre class="sourceCode java"><code class="sourceCode java"><span class="kw">public</span> <span class="kw">class</span> MessageInbound
{
  <span class="co">//...initialization code here...</span>
  
  <span class="kw">public</span> <span class="dt">void</span> <span class="fu">Handle</span>(Frame frame)
  {
    <span class="co">// determine the type of message</span>
    <span class="co">// and wrap it with an object</span>
    ChangeMessage change = <span class="kw">null</span>;
    <span class="kw">if</span>(frame.<span class="fu">Type</span> == FrameTypes.<span class="fu">Update</span>)
    {
      change = <span class="kw">new</span> <span class="fu">UpdateRequest</span>(frame);
    }
    <span class="kw">else</span> <span class="kw">if</span>(frame.<span class="fu">Type</span> == FrameTypes.<span class="fu">Insert</span>)
    {
      change = <span class="kw">new</span> <span class="fu">InsertRequest</span>(frame);
    }  
    <span class="kw">else</span>
    {
      <span class="kw">throw</span> 
        <span class="kw">new</span> <span class="fu">InvalidRequestException</span>(frame.<span class="fu">Type</span>);
    }
    
    change.<span class="fu">ValidateUsing</span>(_validationRules);
    _system.<span class="fu">Apply</span>(change);
  }
}</code></pre>
<p>Note that this code violates the principle of separating use from construction. The <code>change</code> is first created, depending on the frame type, and then used (validated and applied) in the same method. On the other hand, if we wanted to separate the construction of <code>change</code> from its use, we have to note that it is impossible to pass an instance of the <code>ChangeMessage</code> through the <code>MessageInbound</code> constructor, because this would require us to create the <code>ChangeMessage</code> before we create the <code>MessageInbound</code>. Achieving this is impossible, because we can create messages only as soon as we know the frame data which the <code>MessageInbound</code> receives.</p>
<p>Thus, our choice is to make a special object that we would move the creation of new messages into. It would produce the new instances when requested, hence the name <strong>factory</strong>. The factory itself can be passed through constructor, since it does not require a frame to exist – it only needs one when it is asked to create a message.</p>
<p>Knowing this, we can refactor the above code to the following:</p>
<pre class="sourceCode java"><code class="sourceCode java"><span class="kw">public</span> <span class="kw">class</span> MessageInbound
{
  <span class="kw">private</span> readonly 
    MessageFactory _messageFactory;
  <span class="kw">private</span> readonly 
    ValidationRules _validationRules;
  <span class="kw">private</span> readonly 
    ProcessingSystem _system;
  
  <span class="kw">public</span> <span class="fu">MessageInbound</span>(
    <span class="co">//this is the factory:</span>
    MessageFactory messageFactory,
    ValidationRules validationRules,
    ProcessingSystem system)
  {
    _messageFactory = messageFactory;
    _validationRules = validationRules;
    _system = system;
  }
  
  <span class="kw">public</span> <span class="dt">void</span> <span class="fu">Handle</span>(Frame frame)
  {
    var change = _messageFactory.<span class="fu">CreateFrom</span>(frame);  
    change.<span class="fu">ValidateUsing</span>(_validationRules);
    _system.<span class="fu">Apply</span>(change);
  }
}</code></pre>
<p>This way we have separated message construction from its use.</p>
<p>By the way, the factory itself looks like this:</p>
<pre class="sourceCode java"><code class="sourceCode java"><span class="kw">public</span> <span class="kw">class</span> InboundMessageFactory
 : MessageFactory
{
  ChangeMessage <span class="fu">CreateFrom</span>(Frame frame)
  {
    <span class="kw">if</span>(frame.<span class="fu">Type</span> == FrameTypes.<span class="fu">Update</span>)
    {
      <span class="kw">return</span> <span class="kw">new</span> <span class="fu">UpdateRequest</span>(frame);
    }
    <span class="kw">else</span> <span class="kw">if</span>(frame.<span class="fu">Type</span> == FrameTypes.<span class="fu">Insert</span>)
    {
      <span class="kw">return</span> <span class="kw">new</span> <span class="fu">InsertRequest</span>(frame);
    }    
    <span class="kw">else</span>
    {
      <span class="kw">throw</span> 
        <span class="kw">new</span> <span class="fu">InvalidRequestException</span>(frame.<span class="fu">Type</span>);
    }
  }
}</code></pre>
<p>And this is it. We have a factory now and the way we got to this point is by trying to be true to the principle of separating use from construction.</p>
<p>Now that we are through with the example, we are ready for some more general explanation on factories.</p>
<h4 id="reasons-to-use-factories">Reasons to use factories</h4>
<p>As you saw in the example, factories are objects responsible for creating other objects. They are used to achieve the separation of object constructions from their use when not all of the context necessary to create an object is known up-front. We pass the part of the context we know up-front (so called <strong>global context</strong>) in the factory via its constructor and supply the rest that becomes available later (so called <strong>local context</strong>) in a form of factory method parameters when it becomes available:</p>
<pre class="sourceCode java"><code class="sourceCode java">var factory = <span class="kw">new</span> <span class="fu">Factory</span>(globalContextKnownUpFront);

<span class="co">//...</span>

factory.<span class="fu">CreateInstance</span>(localContext);</code></pre>
<p>Another case for using a factory is when we need to create a new object each time some kind of request is made (a message is received from the network or someone clicks a button):</p>
<pre class="sourceCode java"><code class="sourceCode java">var factory = <span class="kw">new</span> <span class="fu">Factory</span>(globalContext);

<span class="co">//...</span>

<span class="co">//we need a fresh instance</span>
factory.<span class="fu">CreateInstance</span>();

<span class="co">//...</span>

<span class="co">//we need another fresh instance</span>
factory.<span class="fu">CreateInstance</span>();</code></pre>
<p>In the above example, two independent instances are created, even though both are created in an identical way (there is no local context that would differ them).</p>
<p>Both these reasons were present in our example:</p>
<ol style="list-style-type: decimal">
<li>We were unable to create a <code>ChangeMessage</code> before knowing the actual <code>Frame</code>.</li>
<li>For each <code>Frame</code> received, we needed to create a new <code>ChangeMessage</code> instance.</li>
</ol>
<h4 id="simplest-factory">Simplest factory</h4>
<p>The simplest possible example of a factory object is something along the following lines:</p>
<pre class="sourceCode java"><code class="sourceCode java"><span class="kw">public</span> <span class="kw">class</span> MyMessageFactory
{
  <span class="kw">public</span> MyMessage <span class="fu">CreateMyMessage</span>()
  {
    <span class="kw">return</span> <span class="kw">new</span> <span class="fu">MyMessage</span>();
  }
}</code></pre>
<p>Even in this primitive shape the factory already has some value (e.g. we can make <code>MyMessage</code> an abstract type and return instances of its subclasses from the factory, and the only place impacted by the change is the factory itself<a href="#fn9" class="footnoteRef" id="fnref9"><sup>9</sup></a>). More often, however, when talking about simple factories, we think about something like this:</p>
<pre class="sourceCode java"><code class="sourceCode java"><span class="co">//Let&#39;s assume MessageFactory </span>
<span class="co">//and Message are interfaces</span>
<span class="kw">public</span> <span class="kw">class</span> XmlMessageFactory : MessageFactory
{
  <span class="kw">public</span> Message <span class="fu">CreateSessionInitialization</span>()
  {
    <span class="kw">return</span> <span class="kw">new</span> <span class="fu">XmlSessionInitialization</span>();
  }
}</code></pre>
<p>Note the two things that the factory in the second example has that the one in the first example does not:</p>
<ul>
<li>it implements an interface (a level of indirection is introduced)</li>
<li>its <code>CreateSessionInitialization()</code> method declares a return type to be an interface (another level of indirection is introduced)</li>
</ul>
<p>In order for you to use factories effectively, I need you to understand why and how these levels of indirection are useful, especially when I talk with people, they often do not understand the benefits of using factories, “because we already have the <code>new</code> operator to create objects”. So, here are these benefits:</p>
<h4 id="factories-allow-creating-objects-polymorphically-encapsulation-of-type">Factories allow creating objects polymorphically (encapsulation of type)</h4>
<p>Each time we invoke a <code>new</code> operator, we have to put a name of a concrete type next to it:</p>
<pre class="sourceCode java"><code class="sourceCode java"><span class="kw">new</span> List&lt;<span class="dt">int</span>&gt;(); <span class="co">//OK!</span>
<span class="kw">new</span> IList&lt;<span class="dt">int</span>&gt;(); <span class="co">//won&#39;t compile...</span></code></pre>
<p>This means that whenver we want to use the class that does this instantiation with another concrete object (e.g. a sorted list), we have to either change the code to delete the old type name and put new type name, or provide some kind of conditional (<code>if-else</code>).</p>
<p>Factories do not have this defficiency. Because we get objects from factories by invoking a method, not by saying explicitly which class we want to get instantiated, we can take advantage of polymorphism, i.e. our factory may have a method like this:</p>
<pre class="sourceCode java"><code class="sourceCode java">IList&lt;<span class="dt">int</span>&gt; <span class="fu">CreateContainerForData</span>() {...}</code></pre>
<p>which returns any instance of a real class that implements <code>IList&lt;int&gt;</code> (say, <code>List&lt;int&gt;</code>):</p>
<pre class="sourceCode java"><code class="sourceCode java"><span class="kw">public</span> IList&lt;<span class="dt">int</span>&gt; <span class="co">/* return type is interface */</span> 
<span class="fu">CreateContainerForData</span>() 
{
  <span class="kw">return</span> <span class="kw">new</span> List&lt;<span class="dt">int</span>&gt;(); <span class="co">/* instance of concrete class */</span>
}</code></pre>
<p>Of course, it makes little sense for the return type of the factory to be a library class or interface (rather, we use factories to create instances of our own classes), but you get the idea, right?</p>
<p>Anyway, it is typical for a return type of a factory to be an interface or, at worst, an abstract class. This means that whoever uses the factory, it knows only that it receives an object of a class that is implementing an interface or is derived from abstract class. But it does not know exactly what <em>concrete</em> type it is. Thus, a factory may return objects of different types at different times, depending on some rules only it knows.</p>
<p>Time to look at some more realistic example of how to apply this. Let’s say we have a factory of messages like this:</p>
<pre class="sourceCode java"><code class="sourceCode java"><span class="kw">public</span> <span class="kw">class</span> Version1ProtocolMessageFactory 
  : MessageFactory
{
  <span class="kw">public</span> Message <span class="fu">NewInstanceFrom</span>(MessageData rawData)
  {
    <span class="kw">switch</span>(rawData.<span class="fu">MessageType</span>)
    {
      <span class="kw">case</span> Messages.<span class="fu">SessionInit</span>:
        <span class="kw">return</span> <span class="kw">new</span> <span class="fu">SessionInit</span>(rawData);
      <span class="kw">case</span> Messages.<span class="fu">SessionEnd</span>:
        <span class="kw">return</span> <span class="kw">new</span> <span class="fu">SessionEnd</span>(rawData);
      <span class="kw">case</span> Messages.<span class="fu">SessionPayload</span>:
        <span class="kw">return</span> <span class="kw">new</span> <span class="fu">SessionPayload</span>(rawData);
      <span class="kw">default</span>:
        <span class="kw">throw</span> <span class="kw">new</span> <span class="fu">UnknownMessageException</span>(rawData);
    }
  }
}</code></pre>
<p>Note that the factory can create many different types of messages depending on what is inside the raw data, but from the perspective of the user of the factory, this is irrelevant. All that it knows is that it gets a <code>Message</code>, thus, it (and the rest of the code operating on messages in the whole application for that matter) can be written as general-purpose logic, containing no “special cases” dependent on type of message:</p>
<pre class="sourceCode java"><code class="sourceCode java">var message = _messageFactory.<span class="fu">NewInstanceFrom</span>(rawData);
message.<span class="fu">ValidateUsing</span>(_primitiveValidations);
message.<span class="fu">ApplyTo</span>(_sessions);</code></pre>
<p>Note that the above code does not need to change in case we want to add a new type of message that is compatible with the existing flow of processing messages<a href="#fn10" class="footnoteRef" id="fnref10"><sup>10</sup></a>. The only place we need to modify in such case is the factory. For example, imagine we decided to add a session refresh message. The modified factory would look like this:</p>
<pre class="sourceCode java"><code class="sourceCode java"><span class="kw">public</span> <span class="kw">class</span> Version1ProtocolMessageFactory
  : MessageFactory
{
  <span class="kw">public</span> Message <span class="fu">NewInstanceFrom</span>(MessageData rawData)
  {
    <span class="kw">switch</span>(rawData.<span class="fu">MessageType</span>)
    {
      <span class="kw">case</span> Messages.<span class="fu">SessionInit</span>:
        <span class="kw">return</span> <span class="kw">new</span> <span class="fu">SessionInit</span>(rawData);
      <span class="kw">case</span> Messages.<span class="fu">SessionEnd</span>:
        <span class="kw">return</span> <span class="kw">new</span> <span class="fu">SessionEnd</span>(rawData);
      <span class="kw">case</span> Messages.<span class="fu">SessionPayload</span>:
        <span class="kw">return</span> <span class="kw">new</span> <span class="fu">SessionPayload</span>(rawData);
      <span class="kw">case</span> Messages.<span class="fu">SessionRefresh</span>: <span class="co">//new message type!</span>
        <span class="kw">return</span> <span class="kw">new</span> <span class="fu">SessionRefresh</span>(rawData);
      <span class="kw">default</span>:
        <span class="kw">throw</span> <span class="kw">new</span> <span class="fu">UnknownMessageException</span>(rawData);
    }
  }
}</code></pre>
<p>and the rest of the code could remain untouched.</p>
<p>Using the factory to hide the real type of message returned makes maintaining the code easier, because there is less code to change when adding new types of messages to the system or removing existing ones (in our example – in case when we do not need to initiate a session anymore) <a href="#fn11" class="footnoteRef" id="fnref11"><sup>11</sup></a> – the factory hides that and the rest of the application is coded against the general scenario.</p>
<h4 id="factories-are-themselves-polymorphic-encapsulation-of-rule">Factories are themselves polymorphic (encapsulation of rule)</h4>
<p>Another benefit of factories over inline constructors is that they are composable. This allows replacing the rule used to create objects with another one, by replacing one factory implementation with another.</p>
<p>In the example from the previous section, we examined a situation where we extended the existing factory with a <code>SessionRefresh</code> message. This was done with assumption that we do not need the previous version of the factory. But consider a situation where we need both versions of the behavior and want to be able to use the old version sometimes, and other times the new one. The “version 1” of the factory (the old one) would look like this:</p>
<pre class="sourceCode java"><code class="sourceCode java"><span class="kw">public</span> <span class="kw">class</span> Version1ProtocolMessageFactory 
  : MessageFactory
{
  <span class="kw">public</span> Message <span class="fu">NewInstanceFrom</span>(MessageData rawData)
  {
    <span class="kw">switch</span>(rawData.<span class="fu">MessageType</span>)
    {
      <span class="kw">case</span> Messages.<span class="fu">SessionInit</span>:
        <span class="kw">return</span> <span class="kw">new</span> <span class="fu">SessionInit</span>(rawData);
      <span class="kw">case</span> Messages.<span class="fu">SessionEnd</span>:
        <span class="kw">return</span> <span class="kw">new</span> <span class="fu">SessionEnd</span>(rawData);
      <span class="kw">case</span> Messages.<span class="fu">SessionPayload</span>:
        <span class="kw">return</span> <span class="kw">new</span> <span class="fu">SessionPayload</span>(rawData);
      <span class="kw">default</span>:
        <span class="kw">throw</span> <span class="kw">new</span> <span class="fu">UnknownMessageException</span>(rawData);
    }
  }
}</code></pre>
<p>and the “version 2” (the new one) would be:</p>
<pre class="sourceCode java"><code class="sourceCode java"><span class="co">//note that now it is a version 2 protocol factory</span>
<span class="kw">public</span> <span class="kw">class</span> Version2ProtocolMessageFactory
  : MessageFactory
{
  <span class="kw">public</span> Message <span class="fu">NewInstanceFrom</span>(MessageData rawData)
  {
    <span class="kw">switch</span>(rawData.<span class="fu">MessageType</span>)
    {
      <span class="kw">case</span> Messages.<span class="fu">SessionInit</span>:
        <span class="kw">return</span> <span class="kw">new</span> <span class="fu">SessionInit</span>(rawData);
      <span class="kw">case</span> Messages.<span class="fu">SessionEnd</span>:
        <span class="kw">return</span> <span class="kw">new</span> <span class="fu">SessionEnd</span>(rawData);
      <span class="kw">case</span> Messages.<span class="fu">SessionPayload</span>:
        <span class="kw">return</span> <span class="kw">new</span> <span class="fu">SessionPayload</span>(rawData);
      <span class="kw">case</span> Messages.<span class="fu">SessionRefresh</span>: <span class="co">//new message type!</span>
        <span class="kw">return</span> <span class="kw">new</span> <span class="fu">SessionRefresh</span>(rawData);
      <span class="kw">default</span>:
        <span class="kw">throw</span> <span class="kw">new</span> <span class="fu">UnknownMessageException</span>(rawData);
    }
  }
}</code></pre>
<p>Depending on what the user chooses in the configuration, we give them either a version 1 protocol support which does not support session refreshing, or a version 2 protocol support that does. Assuming the configuration is only read once during the application start, we may have the following code in our composition root:</p>
<pre class="sourceCode java"><code class="sourceCode java">MessageFactory messageFactory = configuration.<span class="fu">Version</span> == <span class="dv">1</span> ?
  <span class="kw">new</span> <span class="fu">Version1ProtocolMessageFactory</span>() : 
  <span class="kw">new</span> <span class="fu">Version2ProtocolMessageFactory</span>() ;
  
var messageProcessing = <span class="kw">new</span> <span class="fu">MessageProcessing</span>(messageFactory);</code></pre>
<p>The above code composes a <code>MessageProcessing</code> instance with either a <code>Version1ProtocolMessageFactory</code> or a <code>Version2ProtocolMessageFactory</code>, depending on the configuration.</p>
<p>This example shows something I like calling “encapsulation of rule”. The logic inside the factory is actually a rule on how, when and which objects to create. Thus, if we make our factory implement an interface and have other objects depend on this interface, we will be able to switch the rules of object creation without having to modify these objects.</p>
<h4 id="factories-can-hide-some-of-the-created-object-dependencies-encapsulation-of-global-context">Factories can hide some of the created object dependencies (encapsulation of global context)</h4>
<p>Let’s consider another simple example. We have an application that, again, can process messages. One of the things that is done with those messages is saving them in a database and another is validation. The processing of message is, like in previous examples, handled by a <code>MessageProcessing</code> class, which, this time, does not use any factory, but creates the messages based on the frame data itself. let’s look at this class:</p>
<pre class="sourceCode java"><code class="sourceCode java"><span class="kw">public</span> <span class="kw">class</span> MessageProcessing
{
  <span class="kw">private</span> DataDestination _database;
  <span class="kw">private</span> ValidationRules _validation;
  
  <span class="kw">public</span> <span class="fu">MessageProcessing</span>(
    DataDestination database,
    ValidationRules validation)
  {
    _database = database;
    _validation = validation;
  } 
  
  <span class="kw">public</span> <span class="dt">void</span> <span class="fu">ApplyTo</span>(MessageData data)
  {
    <span class="co">//note this creation:</span>
    var message = 
      <span class="kw">new</span> <span class="fu">Message</span>(data, _database, _validation);
    
    message.<span class="fu">Vaidate</span>();
    message.<span class="fu">Persist</span>();
    
    <span class="co">//... other actions </span>
  }
}</code></pre>
<p>There is one noticeable thing about the <code>MessageProcessing</code> class. It depends on both <code>DataDestination</code> and <code>ValidationRules</code> interfaces, but does not use them. The only thing it needs those interfaces for is to supply them as parameters to the constructor of a <code>Message</code>. As a number of <code>Message</code> constructor parameters grows, the <code>MessageProcessing</code> will have to change to take more parameters as well. Thus, the <code>MessageProcessing</code> class gets polluted by something that it does not directly need.</p>
<p>We can remove these dependencies from <code>MessageProcessing</code> by introducing a factory that would take care of creating the messages in its stead. This way, we only need to pass <code>DataDestination</code> and <code>ValidationRules</code> to the factory, because <code>MessageProcessing</code> never needed them for any reason other than creating messages. This factory may look like this:</p>
<pre class="sourceCode java"><code class="sourceCode java"><span class="kw">public</span> <span class="kw">class</span> MessageFactory
{
  <span class="kw">private</span> DataDestination _database;
  <span class="kw">private</span> ValidationRules _validation;
  
  <span class="kw">public</span> MessageFactory(
    DataDestination database,
    ValidationRules validation)
  {
    _database = database;
    _validation = validation;
  } 

  <span class="kw">public</span> Message <span class="fu">CreateFrom</span>(MessageData data)
  {
    <span class="kw">return</span> 
      <span class="kw">new</span> <span class="fu">Message</span>(data, _database, _validation);
  }
}</code></pre>
<p>Now, note that the creation of messages was moved to the factory, along with the dependencies needed for this. The <code>MessageProcessing</code> does not need to take these dependencies anymore, and can stay more true to its real purpose:</p>
<pre class="sourceCode java"><code class="sourceCode java"><span class="kw">public</span> <span class="kw">class</span> MessageProcessing
{
  <span class="kw">private</span> MessageFactory _factory;
  
  <span class="co">//now we depend on the factory only:</span>
  <span class="kw">public</span> <span class="fu">MessageProcessing</span>(
    MessageFactory factory)
  {
    _factory = factory;
  } 
  
  <span class="kw">public</span> <span class="dt">void</span> <span class="fu">ApplyTo</span>(MessageData data)
  {
    <span class="co">//no need to pass database and validation</span>
    <span class="co">//since they already are inside the factory:</span>
    var message = _factory.<span class="fu">CreateFrom</span>(data);
    
    message.<span class="fu">Vaidate</span>();
    message.<span class="fu">Persist</span>();
    
    <span class="co">//... other actions </span>
  }
}</code></pre>
<p>So, instead of <code>DataDestination</code> and <code>ValidationRules</code> interfaces, the <code>MessageProcessing</code> depends only on the factory. This may not sound as a very attractive tradeoff (taking away two dependencies and introducing one), but note that whenever the <code>MessageFactory</code> needs another dependency that is like the existing two, the factory is all that will need to change. The <code>MessageProcessing</code> will remain untouched and still coupled only to the factory.</p>
<p>The last thing that needs to be said is that not all dependencies can be hidden inside a factory. Note that the factory still needs to receive the <code>MessageData</code> from whoever is asking for a <code>Message</code>, because the <code>MessageData</code> is not available when the factory is created. You may remember that I call such dependencies a <strong>local context</strong> (because it is specific to a single use of a factory). On the other hand, what a factory accepts through its constructor can be called a <strong>global context</strong> (because it is the same throughout the factory lifetime). Using this terminology, the local context cannot be hidden from users of the factory, but the global context can. Thanks to this, the classes using the factory do not need to know about the global context and can stay cleaner, coupled to less things and more focused.</p>
<h4 id="factories-can-help-increase-readability-and-reveal-intention-encapsulation-of-terminology">Factories can help increase readability and reveal intention (encapsulation of terminology)</h4>
<p>Let’s assume we are writing an action-RPG game which consists of many game levels (not to be mistaken with experience levels) . Players can start a new game or continue a saved game. When they choose to start a new game, they are immediately taken to the first level with empty inventory and no skills. Otherwise, when they choose to continue an old game, they have to select a file with a saved state (then the game level, skills and inventory are loaded from the file). Thus, we have two separate workflows in our game that end up with two different methods being invoked: <code>OnNewGame()</code> for new game mode and <code>OnContinue()</code> for resuming a saved game:</p>
<pre class="sourceCode java"><code class="sourceCode java"><span class="kw">public</span> <span class="dt">void</span> <span class="fu">OnNewGame</span>()
{
  <span class="co">//...</span>
}

<span class="kw">public</span> <span class="dt">void</span> <span class="fu">OnContinue</span>(PathToFile savedGameFilePath)
{
  <span class="co">//...</span>
}</code></pre>
<p>In each of these methods, we have to somehow assemble a <code>Game</code> class instance. The constructor of <code>Game</code> allows composing it with a starting level, character’s inventory and a set of skills the character can use:</p>
<pre class="sourceCode java"><code class="sourceCode java"><span class="kw">public</span> <span class="kw">class</span> FantasyGame : Game 
{
  <span class="kw">public</span> <span class="fu">FantasyGame</span>(
      Level startingLevel, 
      Inventory inventory, 
      Skills skills)
  {
  }
}</code></pre>
<p>There is no special class for “new game” or for “resumed game” in our code. A new game is just a game starting from the first level with empty inventory and no skills:</p>
<pre class="sourceCode java"><code class="sourceCode java">var newGame = <span class="kw">new</span> <span class="fu">FantasyGame</span>(
  <span class="kw">new</span> <span class="fu">FirstLevel</span>(), 
  <span class="kw">new</span> <span class="fu">BackpackInventory</span>(),
  <span class="kw">new</span> <span class="fu">KnightSkills</span>());</code></pre>
<p>In other words, the “new game” concept is expressed by a composition of objects rather than by a single class, called e.g. <code>NewGame</code>.</p>
<p>Likewise, when we want to create a game object representing resumed game, we do it like this:</p>
<pre class="sourceCode java"><code class="sourceCode java"><span class="kw">try</span>
{
  saveFile.<span class="fu">Open</span>();
  
  var loadedGame = <span class="kw">new</span> <span class="fu">FantasyGame</span>(
    saveFile.<span class="fu">LoadLevel</span>(),
    saveFile.<span class="fu">LoadInventory</span>(),
    saveFile.<span class="fu">LoadSkills</span>());
}
<span class="kw">finally</span>
{  
  saveFile.<span class="fu">Close</span>();
}</code></pre>
<p>Again, the concept of “resumed game” is represented by a composition rather than a single class, just like in case of “new game”. On the other hand, the concepts of “new game” and “resumed game” are part of the domain, so we must make them explicit somehow or we loose readability.</p>
<p>One of the ways to do this is to use a factory<a href="#fn12" class="footnoteRef" id="fnref12"><sup>12</sup></a>. We can create such factory and put inside two methods: one for creating a new game, another for creating a resumed game. The code of the factory could look like this:</p>
<pre class="sourceCode java"><code class="sourceCode java"><span class="kw">public</span> <span class="kw">class</span> FantasyGameFactory : GameFactory
{
  <span class="kw">public</span> Game <span class="fu">NewGame</span>()
  {
    <span class="kw">return</span> <span class="kw">new</span> <span class="fu">FantasyGame</span>(
      <span class="kw">new</span> <span class="fu">FirstLevel</span>(), 
      <span class="kw">new</span> <span class="fu">BackpackInventory</span>(),
      <span class="kw">new</span> <span class="fu">KnightSkills</span>());
  }
  
  <span class="kw">public</span> Game <span class="fu">GameSavedIn</span>(PathToFile savedGameFilePath)
  {
    var saveFile = <span class="kw">new</span> <span class="fu">SaveFile</span>(savedGameFilePath); 
    <span class="kw">try</span>
    {
      saveFile.<span class="fu">Open</span>();
      
      var loadedGame = <span class="kw">new</span> <span class="fu">FantasyGame</span>(
        saveFile.<span class="fu">LoadLevel</span>(),
        saveFile.<span class="fu">LoadInventory</span>(),
        saveFile.<span class="fu">LoadSkills</span>());
      
      <span class="kw">return</span> loadedGame;
    }
    <span class="kw">finally</span>
    {
      saveFile.<span class="fu">Close</span>();
    }    
  }
}</code></pre>
<p>Now we can use the factory in the place where we are notified of the user choice. Remember? This was the place:</p>
<pre class="sourceCode java"><code class="sourceCode java"><span class="kw">public</span> <span class="dt">void</span> <span class="fu">OnNewGame</span>()
{
  <span class="co">//...</span>
}

<span class="kw">public</span> <span class="dt">void</span> <span class="fu">OnContinue</span>(PathToFile savedGameFilePath)
{
  <span class="co">//...</span>
}</code></pre>
<p>When we fill the method bodies with the factory usage, the code ends up like this:</p>
<pre class="sourceCode java"><code class="sourceCode java"><span class="kw">public</span> <span class="dt">void</span> <span class="fu">OnNewGame</span>()
{
  var game = _gameFactory.<span class="fu">NewGame</span>();
  game.<span class="fu">Start</span>();
}

<span class="kw">public</span> <span class="dt">void</span> <span class="fu">OnContinue</span>(PathToFile savedGameFilePath)
{
  var game = _gameFactory.<span class="fu">GameSavedIn</span>(savedGameFilePath);
  game.<span class="fu">Start</span>();
}</code></pre>
<p>Note that using factory helps make the code more readable and intention-revealing. Instead of using a nameless set of connected objects, the two methods shown above ask using terminology from the domain (explicitly requesting either <code>NewGame()</code> or <code>GameSavedIn(path)</code>). Thus, the domain concepts of “new game” and “resumed game” become explicit. This justifies the first part of the name I gave this section (i.e. “Factories can help increase readability and reveal intention”).</p>
<p>There is, however, the second part of the section name: “encapsulating terminology” which I need to explain. Here’s an explanation: note that the factory is responsible for knowing what exactly the terms “new game” and “resumed game” mean. As the meaning of the terms is encapsulated in the factory, we can change the meaning of these terms throughout the application merely by changing the code inside the factory. For example, we can say that new game starts with inventory that is not empty, but contains a basic sword and a shield, by changing the <code>NewGame()</code> method of the factory to this:</p>
<pre class="sourceCode java"><code class="sourceCode java">  <span class="kw">public</span> Game <span class="fu">NewGame</span>()
  {
    <span class="kw">return</span> <span class="kw">new</span> <span class="fu">FantasyGame</span>(
      <span class="kw">new</span> <span class="fu">FirstLevel</span>(), 
      <span class="kw">new</span> <span class="fu">BackpackInventory</span>(
        <span class="kw">new</span> <span class="fu">BasicSword</span>(),
        <span class="kw">new</span> <span class="fu">BasicShield</span>()),
      <span class="kw">new</span> <span class="fu">KnightSkills</span>());
  }</code></pre>
<p>Putting it all together, factories allow giving names to some specific object compositions to increase readability and introducing terminology that can be changed by changing code inside the factory methods.</p>
<h4 id="factories-help-eliminate-redundancy">Factories help eliminate redundancy</h4>
<p>Redundancy in code means that at least two things need to change for the same reason in the same way<a href="#fn13" class="footnoteRef" id="fnref13"><sup>13</sup></a>. Usually it is understood as code duplication, but actually, “conceptual duplication” is a better term. For example, the following two methods are not redundant, even though the code seems duplicated (by the way, the following is not an example of good code, just a simple illustration):</p>
<pre class="sourceCode java"><code class="sourceCode java"><span class="kw">public</span> <span class="dt">int</span> <span class="fu">MetersToCentimeters</span>(<span class="dt">int</span> value)
{
  <span class="kw">return</span> value*<span class="dv">100</span>;
}

<span class="kw">public</span> <span class="dt">int</span> <span class="fu">DollarsToCents</span>(<span class="dt">int</span> value)
{
  <span class="kw">return</span> value*<span class="dv">100</span>;
}</code></pre>
<p>As I said, this is not redundancy, because the two methods represent different concepts that would change for different reasons. Even if we were to extract “common logic” from the two methods, the only sensible name we could come up with would be something like <code>MultiplyBy100()</code> which wouldn’t add any value at all.</p>
<p>Note that up to now, we considered four things factories encapsulate about creation of objects:</p>
<ol style="list-style-type: decimal">
<li>Type</li>
<li>Rule</li>
<li>Global context</li>
<li>Terminology</li>
</ol>
<p>Thus, if factories didn’t exist, all these concepts would leak to surrounding classes (we saw an example when we were talking about encapsulation of global context). Now, as soon as there is more than one class that needs to create instances, these things leak to all of these classes, creating redundancy. In such case, any change to how instances are created would mean a change to all classes needing those instances.</p>
<p>Thankfully, by having a factory – an object that takes care of creating other objects and nothing else, we can reuse the ruleset, the global context and the type-related decisions across many classes without any unnecessary overhead. All we need to do is reference the factory and ask it for an object.</p>
<p>There are more benefits to factories, but I hope I already convinced you that this is a pretty darn beneficial concept for such a reasonably low cost.</p>
<h2 id="summary-6">Summary</h2>
<p>In this chapter, I tried to show you a variety of ways of composing objects together. Do not worry if you feel overwhelmed, for the most part, just remember to follow the principle of separating use from construction and you will be fine.</p>
<p>The rules outlined here apply to the overwhelming part of the objects in our application. Wait, did I say overwhelming? Not all? So there are exceptions? Yes, there are and we’ll talk about them shortly, but first, we need to further examine the influence composability has on our object-oriented design approach.</p>
<h1 id="interfaces">Interfaces</h1>
<p>Some objects are harder to compose with other objects, others are easier. Of course, we are striving for the higher composability. There are numerous factors influencing this. I already discussed some of them indirectly, so time to sum things up and fill in the gaps. This chapter will deal with the role interfaces play in achieving high composability and the next one will deal with a concept of protocols.</p>
<h2 id="classes-vs-interfaces">Classes vs interfaces</h2>
<p>As we said, a sender is composed with a recipient by obtaining a reference to it. Also, we said that we want our senders to be able to send messages to many different recipients. This is, of course, done using polymorphism.</p>
<p>So, one of the questions we have to ask ourselves in our quest for high composability is: on what should a sender depend on to be able to work with as many recipients as possible? Should it depend on classes or interfaces? In other words, when we plug in an object as a message receipient like this:</p>
<pre class="sourceCode java"><code class="sourceCode java"><span class="kw">public</span> <span class="fu">Sender</span>(Recipient recipient)
{
  <span class="kw">this</span>.<span class="fu">_recipient</span> = recipient;
}</code></pre>
<p>Should the <code>Recipient</code> be a class or an interface?</p>
<p>If we assume that <code>Recipient</code> is a class, we can get the composability we want by deriving another class from it and implementing abstract methods or overriding virtual ones. However, depending on a class as a base type for a recipient has the following disadvantages:</p>
<ol style="list-style-type: decimal">
<li>The recipient class may have some real dependencies. For example, if our <code>Recipient</code> depends on Windows Communication Foundation (WCF) stack, then all classes depending directly on <code>Recipient</code> will indirectly depend on WCF, including our <code>Sender</code>. The more damaging version of this problem is where such a <code>Recipient</code> class actually does something like opening a network connection in a constructor – the subclasses are unable to prevent it, no matter if they like it or not, because a subclass has to call a superclass’ constructor.</li>
<li><code>Recipient</code>’s constructor must be invoked by any class deriving from it, which may be smaller or bigger trouble, depending on what kind of parameters the constructor accepts and what it does.</li>
<li>In languages that support single inheritance only, deriving from <code>Recipient</code> class uses up the only inheritance slot, constraining our design.</li>
<li>We must make sure to mark all the methods of <code>Recipient</code> class as <code>virtual</code> to enable overriding them by subclasses. otherwise, we won’t have full composability. Subclasses will not be able to redefine all of the <code>Recipient</code> behaviors, so they will be very constrained in what they can do.</li>
</ol>
<p>As you see, there are some difficulties using classes as “slots for composability”, even if composition is technically possible this way. Interfaces are far better, just because they do not have the above disadvantages:</p>
<p>It is decided then, If a sender wants to be composable with different recipients, it has to accept a reference to a recipient in form of interface reference. We can say that, by being lightweight and behaviorless, <strong>interfaces can be treated as “slots” or “sockets” for plugging in different objects</strong>.</p>
<p>As a matter of fact, on UML diagrams, one way to depict a a class implementing an interface is by drawing it with a plug. Thus, it seems that the “interface as slot for pluggability” concept is not so unusual.</p>
<div class="figure">
<img src="images/lollipop.png" alt="ConcreteRecipient class implementing three interfaces in UML. The interfaces are shown as plugs exposed by the class meaning it can be plugged into anything that uses any of the three interfaces" />
<p class="caption">ConcreteRecipient class implementing three interfaces in UML. The interfaces are shown as “plugs” exposed by the class meaning it can be plugged into anything that uses any of the three interfaces</p>
</div>
<p>As you may have already guessed from the previous chapters, we are taking the idea of pluggability and composability to the extreme, making it one of the top priorities.</p>
<h2 id="eventscallbacks-vs-interfaces-few-words-on-roles">Events/callbacks vs interfaces – few words on roles</h2>
<p>Did I just say that composability is “one of the top priorities” in our design approach? Wow, that’s quite a statement, isn’t it? Unfortunately for me, it also lets you raise the following argument: “Hey, interfaces are not the most extreme way of achieving composability! What about e.g. C# events feature? Or callbacks that are supported by some other languages? Wouldn’t it make the classes even more context-independent and composable, if we connected them through events or callbacks, not interfaces?”</p>
<p>Actually, it would, but it would also strip us from another very important aspect of our design approach that I did not mention explicitly until now. This aspect is: roles. When we use interfaces, we can say that each interface stands for a role for a real object to play. When these roles are explicit, they help design and describe the communication between objects.</p>
<p>Let’s look at an example of how not using defining explicit roles removes some clarity from the design. This is a sample method that sends some messages to two recipients held as interfaces:</p>
<pre class="sourceCode java"><code class="sourceCode java"><span class="co">//role players:</span>
<span class="kw">private</span> readonly Role1 recipient1;
<span class="kw">private</span> readonly Role2 recipient2;

<span class="kw">public</span> <span class="dt">void</span> <span class="fu">SendSomethingToRecipients</span>()
{
  recipient1.<span class="fu">DoX</span>();
  recipient1.<span class="fu">DoY</span>();
  recipient2.<span class="fu">DoZ</span>();
}</code></pre>
<p>and we compare it with similar effect achieved using callback invocation:</p>
<pre class="sourceCode java"><code class="sourceCode java"><span class="co">//callbacks:</span>
<span class="kw">private</span> readonly Action DoX;
<span class="kw">private</span> readonly Action DoY;
<span class="kw">private</span> readonly Action DoZ;

<span class="kw">public</span> <span class="dt">void</span> <span class="fu">SendSomethingToRecipients</span>()
{
  <span class="fu">DoX</span>();
  <span class="fu">DoY</span>();
  <span class="fu">DoZ</span>();
}</code></pre>
<p>We can see that in the second case we are losing the notion of which message belongs to which recipient – each callback is standalone from the point of view of the sender. This is unfortunate, because in our design approach, we want to highlight the roles each recipient plays in the communication, to make the it readable and logical. Also, ironically, decoupling using events or callbacks can make composability harder. This is because roles tell us which sets of behaviors belong together and thus, need to change together. If each behavior is triggered using a separate event or callback, an overhead is placed on us to remember which behaviors should be changed together, and which ones can change independently.</p>
<p>This does not mean that events or callbacks are bad. It’s just that they are not fit for replacing interfaces – in reality, their purpose is a little bit different. We use events or callbacks not to do somebody to do something, but to indicate what happened (that’s why we call them events, after all…). This fits well the observer pattern we already talked about in the previous chapter. So, instead of using observer objects, we may consider using events or callbacks instead (as in everything, there are some tradeoffs for each of the solutions). In other words, events and callbacks have their use in the composition, but they are fit for a case so specific, that they cannot be treated as a default choice. The advantage of interfaces is that they bind together messages that represent a coherent abstractions and convey roles in the communication. This improves readability and clarity.</p>
<h2 id="small-interfaces">Small interfaces</h2>
<p>Ok, so we said that he interfaces are “the way to go” for reaching the strong composability we’re striving for. Does merely using interfaces guarantee us that the composability will be strong? The answer is “no” – while using interfaces as “slots” is a necessary step in the right direction, it alone does not produce the best composability.</p>
<p>One of the other things we need to consider is the size of interfaces. Let’s state one thing that is obvious in regard to this:</p>
<p><strong>All other things equal, smaller interfaces (i.e. with less methods) are easier to implement than bigger interfaces.</strong></p>
<p>The obvious conclusion from this is that if we want to have really strong composability, our “slots”, i.e. interfaces, have to be as small as possible (but not smaller – see previous section on interfaces vs events/callbacks). Of course, we cannot achieve this by blindly removing methods from interfaces, because this would break classes that actually use these methods e.g. when someone is using an interface implementation like this:</p>
<pre class="sourceCode java"><code class="sourceCode java"><span class="kw">public</span> <span class="dt">void</span> Process(Recipient recipient)
{
  recipient.<span class="fu">DoSomething</span>();
  recipient.<span class="fu">DoSomethingElse</span>();
}</code></pre>
<p>It is impossible to remove either of the methods from the <code>Recipient</code> interface, because it would cause a compile error saying that we are trying to use a method that does not exist.</p>
<p>So, what do we do then? We try to separate groups of methods used by different senders and move them to separate interfaces, so that each sender has access only to the methods it needs. After all, a class can implement more than one interface, like this:</p>
<pre class="sourceCode java"><code class="sourceCode java"><span class="kw">public</span> <span class="kw">class</span> ImplementingObject 
: InterfaceForSender1, 
  InterfaceForSender2,
  InterfaceForSender3
{ <span class="kw">... </span>}</code></pre>
<p>This notion of creating a separate interface per sender instead of a single big interface for all senders is known as the Interface Segregation Principle<a href="#fn14" class="footnoteRef" id="fnref14"><sup>14</sup></a>.</p>
<h3 id="a-simple-example-separation-of-reading-from-writing">A simple example: separation of reading from writing</h3>
<p>Let’s assume we have a class in our application that represents enterprise organizational structure. This application exposes two APIs. The first one serves for notifications about changes of organizational structure by an administrator (so that our class can update its data). The second one is for client-side operations on the organizational data, like listing all employees. The interface for the organizational structure class may contain methods used by both these APIs:</p>
<pre class="sourceCode java"><code class="sourceCode java"><span class="kw">public</span> <span class="kw">interface</span> 
OrganizationStructure
{
  <span class="co">//////////////////////</span>
  <span class="co">//used by administrator:</span>
  <span class="co">//////////////////////  </span>
  
  <span class="dt">void</span> <span class="fu">Make</span>(Change change);
  <span class="co">//...other administrative methods</span>
  
  <span class="co">//////////////////////</span>
  <span class="co">//used by clients:</span>
  <span class="co">//////////////////////</span>
  
  <span class="dt">void</span> <span class="fu">ListAllEmployees</span>(
    EmployeeDestination destination);
  <span class="co">//...other client-side methods  </span>
}</code></pre>
<p>However, the administrative API handling is done by a different code than the client-side API handling. Thus, the administrative part has no use of the knowledge about listing employees and vice-versa – the client-side one has no interest in making administrative changes. We can use this knowledge to split our interface into two:</p>
<pre class="sourceCode java"><code class="sourceCode java"><span class="kw">public</span> <span class="kw">interface</span>
OrganizationalStructureAdminCommands
{
  <span class="dt">void</span> <span class="fu">Make</span>(Change change);
  <span class="co">//... other administrative methods</span>
}

<span class="kw">public</span> <span class="kw">interface</span>
OrganizationalStructureClientCommands
{
  <span class="dt">void</span> <span class="fu">ListAllEmployees</span>(
    EmployeeDestination destination);
  <span class="co">//... other client-side methods</span>
}</code></pre>
<p>Note that this does not constrain the implementation of these interfaces – a real class can still implement both of them if this is desired:</p>
<pre class="sourceCode java"><code class="sourceCode java"><span class="kw">public</span> <span class="kw">class</span> InMemoryOrganizationalStructure
: OrganizationalStructureAdminCommands,
  OrganizationalStructureClientCommands
{
  <span class="co">//...</span>
}</code></pre>
<p>In this approach, we create more interfaces (which some of you may not like), but that shouldn’t bother us much, because in return, each interface is easier to implement (because the number of methods to implement is smaller than in case of one big interface). This means that composability is enhanced, which is what we want the most.</p>
<p>It pays off. For example, one day, we may get a requirement that all writes to the organizational structure (i.e. the admin-related operations) have to be traced. In such case, All we have to do is to create a proxy class implementing <code>OrganizationalStructureAdminCommands</code> interface, which wraps the original class’ methods with a notification to an observer (that can be either the trace that is required or anything else we like):</p>
<pre class="sourceCode java"><code class="sourceCode java"><span class="kw">public</span> <span class="kw">class</span> NotifyingAdminComands : OrganizationalStructureAdminCommands
{
  <span class="kw">public</span> <span class="fu">NotifyingCommands</span>(
    OrganizationalStructureAdminCommands wrapped,
    ChangeObserver observer)
  {
    _wrapped = wrapped;
    _observer = observer;
  }

  <span class="dt">void</span> <span class="fu">Make</span>(Change change)
  { 
    _wrapped.<span class="fu">Make</span>(change);
    _observer.<span class="fu">NotifyAbout</span>(change);
  }
  
  <span class="co">//...other administrative methods</span>
}</code></pre>
<p>Note that when defining the above class, we only had to implement one interface: <code>OrganizationalStructureAdminCommands</code>, and could ignore the existence of <code>OrganizationalStructureClientCommands</code>. This is because of the interface split we did before. If we had not separated interfaces for admin and client access, our <code>NotifyingAdminComands</code> class would have to implement the <code>ListAllEmployees</code> method (and others) and make it delegate to the original wrapped instance. This is not difficult, but it’s unnecessary effort. Splitting the interface into two smaller ones spared us this trouble.</p>
<h4 id="interfaces-should-depend-on-abstractions-not-implementation-details">Interfaces should depend on abstractions, not implementation details</h4>
<p>It is tempting to think that every interface is an abstraction by definition. I believe otherwise – while interfaces abstract away the concrete type of the class that implements it, they may still contain some other things not abstracted that are basically implementation details. Let’s look at the following interface:</p>
<pre class="sourceCode java"><code class="sourceCode java"><span class="kw">public</span> <span class="kw">interface</span> Basket
{
  <span class="dt">void</span> <span class="fu">WriteTo</span>(SqlConnection sqlConnection);
  bool <span class="fu">IsAllowedToEditBy</span>(SecurityPrincipal user);
}</code></pre>
<p>See the arguments of those methods? <code>SqlConnection</code> is a library object for interfacing directly with SQL Server database, so it is a very concrete dependency. <code>SecurityPrincipal</code> is one of the core classes of .NET’s authorization library that works with users database on local system or Active Directory. So again, a very concrete dependency. With dependencies like that, it will be very hard to write other implementations of this interface, because we will be forced to drag around concrete dependencies and mostly will not be able to work around that if we want something different. Thus, we may say that these concrete types I mentioned are implementation details exposed in the interface. Thus, this interface is a failed abstraction. It is essential to abstract these implementation details away, e.g. like this:</p>
<pre class="sourceCode java"><code class="sourceCode java"><span class="kw">public</span> <span class="kw">interface</span> Basket
{
  <span class="dt">void</span> <span class="fu">WriteTo</span>(ProductOutput output);
  bool <span class="fu">IsAllowedToEditBy</span>(BasketOwner user);
}</code></pre>
<p>This is better. For example, as <code>ProductOutput</code> is a higher level abstraction (most probably an interface, as we discussed earlier) no implementation of the <code>WriteTo</code> method must be tied to any particular storage kind. This means that we are more free to develop different implementations of this method. In addition, each implementation of the <code>WriteTo</code> method is more useful as it can be reused with different kinds of <code>ProducOutput</code>s.</p>
<p>Another example might be a data interface, i.e. an interface with getters and setters only. Looking at this example:</p>
<pre class="sourceCode java"><code class="sourceCode java"><span class="kw">public</span> <span class="kw">interface</span> Employee
{
  HumanName Name { get; set; }
  HumanAge  Age { get; set; }
  Address Address { get; set; }
  Money Pay { get; set; }
  EmploymentStatus EmploymentStatus { get; set; }
}</code></pre>
<p>in how many different ways can we implement such interface? Not many – the only question we can answer differently in different implementations of <code>Employee</code> is: “what is the data storage?”. Everything besides this question is exposed, making this a very poor abstraction. As a matter of fact, this is similar to what Johnny and Benjamin were battling in the payroll system, when they wanted to introduce another kind of employee – a contractor employee. Thus, most probably, a better abstraction would be something like this:</p>
<pre class="sourceCode java"><code class="sourceCode java"><span class="kw">public</span> <span class="kw">interface</span> Employee
{
  <span class="dt">void</span> <span class="fu">Sign</span>(Document document);
  <span class="dt">void</span> <span class="fu">Send</span>(PayrollReport payrollReport);
  <span class="dt">void</span> <span class="fu">Fire</span>();
  <span class="dt">void</span> <span class="fu">GiveRaiseBy</span>(Percentage percentage);
}</code></pre>
<p>So the general rule is: make interfaces real abstractions by abstracting away the implementation details from them. Only then are you free to create different implementations of the interface that are not constrained by dependencies they do not want or need.</p>
<h1 id="protocols">Protocols</h1>
<p>You already know that objects are connected (composed) together and communicate through interfaces, just as in IP network. There is one more similarity, that’s as important. It’s <em>protocols</em>. In this section, we will look at protocols between objects and their place on our design approach.</p>
<h2 id="protocols-exist">Protocols exist</h2>
<p>I do not want to introduce any scientific definition, so let’s just establish an understanding that protocols are sets of rules about how objects communicate with each other.</p>
<p>Really? Are there any rules? Is it not enough the the objects can be composed together through interfaces, as I explained in previous sections? Well, no, it’s not enough and let me give you a quick example.</p>
<p>Let’s imagine a class <code>Sender</code> that, in one of its methods, asks <code>Recipient</code> (let’s assume <code>Recipient</code> is an interface) to extract status code from some kind of response object and makes a decision based on that code whether or not to notify an observer about an error:</p>
<pre class="sourceCode java"><code class="sourceCode java"><span class="kw">if</span>(recipient.<span class="fu">ExtractStatusCodeFrom</span>(response) == -<span class="dv">1</span>)
{
  observer.<span class="fu">NotifyErrorOccured</span>();
}</code></pre>
<p>This design is a bit simplistic, but never mind. Its role is to make a certain point. Whoever the <code>recipient</code> is, it is expected to report error by returning a value of <code>-1</code>. Otherwise, the <code>Sender</code> (which is explicitly checking for this value) will not be able to react to the error situation appropriately. Similarly, if there is no error, the recipient must not report this by returning <code>-1</code>, because if it does, the <code>Sender</code> will be mistakenly recognize this as error. So for example this implementation of <code>Recipient</code>, although implementing the interface required by <code>Sender</code>, is wrong, because it does not behave as <code>Sender</code> expects it to:</p>
<pre class="sourceCode java"><code class="sourceCode java"><span class="kw">public</span> <span class="kw">class</span> WrongRecipient : Recipient
{
  <span class="kw">public</span> <span class="dt">int</span> <span class="fu">ExtractStatusFrom</span>(Response response)
  {
    <span class="kw">if</span>( <span class="co">/* success */</span> )
    {
      <span class="kw">return</span> -<span class="dv">1</span>; <span class="co">// but -1 is for errors!</span>
    }
    <span class="kw">else</span>
    {
      <span class="kw">return</span> <span class="dv">1</span>; <span class="co">// -1 should be used!</span>
    }
  }
}</code></pre>
<p>So as you see, we cannot just write anything in a class implementing an interface, because of a protocol that imposes certain constraints on both a sender and a recipient.</p>
<p>This protocol may not only determine the return values necessary for two objects to interact properly, it can also determine types of exceptions thrown, or the order of method calls. For example, anybody using some kind of connection object would imagine the following way of using the connection: first open it, then do something with it and close it when finished, e.g.</p>
<pre class="sourceCode java"><code class="sourceCode java">connection.<span class="fu">Open</span>();
connection.<span class="fu">Send</span>(data);
connection.<span class="fu">Close</span>();</code></pre>
<p>Assuming the above <code>connection</code> is an implementation of <code>Connection</code> interface, if we were to implement it like this:</p>
<pre class="sourceCode java"><code class="sourceCode java"><span class="kw">public</span> <span class="kw">class</span> WrongConnection : Connection
{
  <span class="kw">public</span> <span class="dt">void</span> <span class="fu">Open</span>()
  {
    <span class="co">// imagine implementation </span>
    <span class="co">// for *closing* the connection is here!! </span>
  }

  <span class="kw">public</span> <span class="dt">void</span> <span class="fu">Close</span>()
  {
    <span class="co">// imagine implementation for</span>
    <span class="co">// *opening* the connection is here!! </span>
  }
}</code></pre>
<p>it would compile just fine, but fail badly when executed. This is because the behavior would be against the protocol set between <code>Connection</code> abstraction and its user. All implementations of <code>Connection</code> must follow this protocol.</p>
<p>So, again, there are certain rules that restrict the way two objects can communicate. Both sender and recipient of a message must adhere to the rules, or the they will not be able to work together.</p>
<p>The good news is that, most of the time, <em>we</em> are the ones who design these protocols, along with the interfaces, so we can design them to be either easier or harder or to follow by different implementations of an interface. Of course, we are wholeheartedly for the “easier” part.</p>
<h2 id="protocol-stability">Protocol stability</h2>
<p>Remember the last story about Johnny and Benjamin when they had to make a design change in order to add another kind of employees (contractors) to the application? In order to do that, they had to change existing interfaces and add new ones. This was a lot of work. We don’t want to do this much work every time we make a change, especially when we introduce a new variation of a concept that is already present in our design (e.g. Johnny and Benjamin already had the concept of “employee” and they were adding a new variation of it, called “contractor”).</p>
<p>In order to achieve this, we need the protocols to be more stable, i.e. less prone to change. By drawing some conclusions from experiences of Johnny and Benjamin, we can say that they had problems with protocols stability because the protocols were:</p>
<ol style="list-style-type: decimal">
<li>complicated rather than simple</li>
<li>concrete rather than abstract</li>
<li>large rather than small</li>
</ol>
<p>Based on analysis of the factors that make the stability of the protocols bad, we can come up with some conditions under which these protocols could be more stable:</p>
<ol style="list-style-type: decimal">
<li>protocols should be simple</li>
<li>protocols should be abstract</li>
<li>protocols should be logical</li>
<li>protocols should be small</li>
</ol>
<p>And there are some heuristics that let us get closer to these qualities:</p>
<h2 id="craft-messages-to-reflect-senders-intention">Craft messages to reflect sender’s intention</h2>
<p>The protocols are simpler if they are designed from the perspective of the object that sends the message, not the one that receives it. In other words, methods should reflect the intention of senders rather than capabilities of recipients.</p>
<p>As an example, let’s look at a code for logging in that uses an instance of an <code>AccessGuard</code> class:</p>
<pre class="sourceCode java"><code class="sourceCode java">accessGuard.<span class="fu">SetLogin</span>(login);
accessGuard.<span class="fu">SetPassword</span>(password);
accessGuard.<span class="fu">Login</span>();</code></pre>
<p>In this little snippet, the sender must send three messages to the <code>accessGuard</code> object: <code>SetLogin()</code>, <code>SetPassword()</code> and <code>Login()</code>, even though there is no real need to divide the logic into three steps – they are all executed in the same place anyway. The maker of the <code>AccessGuard</code> class might have thought that this division makes the class more “general purpose”, but it seems this is a “premature optimization” that only makes it harder for the sender to work with the <code>accessGuard</code> object. Thus, the protocol that is simpler from the perspective of a sender would be:</p>
<pre class="sourceCode java"><code class="sourceCode java">accessGuard.<span class="fu">LoginWith</span>(login, password);</code></pre>
<h3 id="naming-by-intention">Naming by intention</h3>
<p>Another lesson learned from the above example is: setters (like <code>SetLogin</code> and <code>SetPassword</code> in our example) rarely reflect senders’ intentions – more often they are artificial “things” introduced to directly manage object state. This may also have been the reason why someone introduced three messages instead of one – maybe the <code>AccessGuard</code> class was implemented to hold two fields (login and password) inside, so the programmer might have thought someone would want to manipulate them separately from the login step… Anyway, setters should be either avoided or changed to something that reflects the intention better. For example, when dealing with observer pattern, we don’t want to say: <code>SetObserver(screen)</code>, but rather something like <code>FromNowOnReportCurrentWeatherTo(screen)</code>.</p>
<p>The issue of naming can be summarized as this: a name of an interface should be assigned after the <em>role</em> that its implementations play and methods should be named after the <em>responsibilities</em> we want the role to have. I love the example that Scott Bain gives in his Emergent Design book<a href="#fn15" class="footnoteRef" id="fnref15"><sup>15</sup></a>: if I told you “give me your driving license number”, you might’ve reacted differently based on whether the driving license is in your pocket, or your wallet, or your bag, or in your house (in which case you would need to call someone to read it for you). The point is: I, as a sender of this “give me your driving license number” message, do not care how you get it. I say <code>RetrieveDrivingLicenseNumber()</code>, not <code>OpenYourWalletAndReadTheNumber()</code>.</p>
<p>This is important, because if the name represents the sender’s intention, the method will not have to be renamed when new classes are created that fulfill this intention in a different way.</p>
<h2 id="model-interactions-after-the-problem-domain">Model interactions after the problem domain</h2>
<p>Sometimes at work, I am asked to conduct a design workshop. The example I often give to my colleagues is to design a system for order reservation (customers place orders and shop deliverers can reserve who gets to deliver which order). The thing that struck me the first few times I did this workshop was that even though the application was all about orders and their reservation, nearly none of the attendees introduced any kind of <code>Order</code> interface or class with <code>Reserve()</code> method on it. Most of the attendees assume that <code>Order</code> is a data structure and handle reservation by adding it to a “collection of reserved items” which can be imagined as the following code fragment:</p>
<pre class="sourceCode java"><code class="sourceCode java"><span class="co">// order is just a data structure,</span>
<span class="co">// added to a collection</span>
reservedOrders.<span class="fu">Add</span>(order)</code></pre>
<p>While this achieves the goal in technical terms (i.e. the application works), the code does not reflect the domain.</p>
<p>If roles, responsibilities and collaborations between objects reflect the domain, then any change that is natural in the domain is natural in the code. If this is not the case, then changes that seem small from the perspective of the problem domain end up touching many classes and methods in highly unusual ways. In other words, the interactions between objects becomes less stable (which is exactly what we want to avoid).</p>
<p>On the other hand, let’s assume that we have modeled the design after the domain and have introduced a proper <code>Order</code> role. Then, the logic for reserving an order may look like this:</p>
<pre class="sourceCode java"><code class="sourceCode java">order.<span class="fu">ReserveBy</span>(deliverer);</code></pre>
<p>Note that this line is as stable as the domain itself. It needs to change e.g. when orders are not reserved anymore, or someone other than deliverers starts reserving the orders. Thus, I’d say the stability of this tiny interaction is darn high.</p>
<p>Even in cases when the understanding of the domain evolves and changes rapidly, the stability of the domain, although not as high as usually, is still one of the highest the world around us has to offer.</p>
<h3 id="another-example">Another example</h3>
<p>Let’s assume that we have a code for handling alarms. When alarm is triggered, all gates are closed, sirens are turned on and message is sent to special forces with highest priority to arrive and terminate the intruder. Any error in this procedure leads to shutting down power in the building. If this workflow is coded like this:</p>
<pre class="sourceCode java"><code class="sourceCode java"><span class="kw">try</span>
{
  gates.<span class="fu">CloseAll</span>();
  sirens.<span class="fu">TurnOn</span>();
  specialForces.<span class="fu">NotifyWith</span>(Priority.<span class="fu">High</span>);
} 
<span class="kw">catch</span>(SecurityFailure failure)
{
  powerSystem.<span class="fu">TurnOffBecauseOf</span>(failure);
}</code></pre>
<p>Then the risk of this code changing for other reasons than the change of how domain works (e.g. we do not close the gates anymore but activate laser guns instead) is small. Thus, interactions that use abstractions and methods that directly express domain rules are more stable.</p>
<p>So, to sum up – if a design reflects the domain, it is easier to predict how a change of domain rules will affect the design. This contributes to maintainability and stability of the interactions and the design as a whole.</p>
<h2 id="message-recipients-should-be-told-what-to-do-instead-of-being-asked-for-information">Message recipients should be told what to do, instead of being asked for information</h2>
<p>Let’s say we are paying an annual income tax yearly and are too busy (i.e. have too many responsibilities) to do this ourselves. Thus, we hire a tax expert to calculate and pay the taxes for us. He is an expert on paying taxes, knows how to calculate everything, where to submit it etc. but there is one thing he does not know – the context. In other word, he does not know which bank we are using or what we have earned this year that we need to pay the tax for. This is something we need to give him.</p>
<p>Here’s the deal between us and the tax expert summarized as a table:</p>
<table>
<thead>
<tr class="header">
<th align="left">Who?</th>
<th align="left">Needs</th>
<th align="left">Can provide</th>
</tr>
</thead>
<tbody>
<tr class="odd">
<td align="left">Us</td>
<td align="left">The tax paid</td>
<td align="left">context (bank, income documents)</td>
</tr>
<tr class="even">
<td align="left">Tax Expert</td>
<td align="left">context (bank, income documents)</td>
<td align="left">The service of paying the tax</td>
</tr>
</tbody>
</table>
<p>It is us who hire the expert and us who initiate the deal, so we need to provide the context, as seen in the above table. If we were to model this deal as an interaction between two objects, it could e.g. look like this:</p>
<pre class="sourceCode java"><code class="sourceCode java">taxExpert.<span class="fu">PayAnnualIncomeTax</span>(
  ourIncomeDocuments,
  ourBank);</code></pre>
<p>One day, our friend, Joan, tells us she needs a tax expert as well. We are happy with the one we hired, so we recommend him to Joan. She has her own income documents, but they are functionally similar to ours, just with different numbers here and there and maybe some different formatting. Also, Joan uses a different bank, but interacting with any bank these days is almost identical. Thus, our tax expert knows how to handle her request. If we model this as interaction between objects, it may look like this:</p>
<pre class="sourceCode java"><code class="sourceCode java">taxExpert.<span class="fu">PayAnnualIncomeTax</span>(
  joansIncomeDocuments,
  joansBank);</code></pre>
<p>Thus, when interacting with Joan, the tax expert can still use his abilities to calculate and pay taxes the same way as in our case. This is because his skills are independent of the context.</p>
<p>Another day, we decide we are not happy anymore with our tax expert, so we decide to make a deal with a new one. Thankfully, we do not need to know how tax experts do their work – we just tell them to do it, so we can interact with the new one just as with the previous one:</p>
<pre class="sourceCode java"><code class="sourceCode java"><span class="co">//this is the new tax expert, </span>
<span class="co">//but no change to the way we talk to him:</span>

taxExpert.<span class="fu">PayAnnualIncomeTax</span>(
  ourIncomeDocuments,
  ourBank);</code></pre>
<p>This small example should not be taken literally. Social interactions are far more complicated and complex than what objects usually do. But I hope I managed to illustrate with it an important aspect of the communication style that is preferred in object oriented design: the <em>Tell Don’t Ask</em> heuristic.</p>
<p>Tell Don’t Ask basically means that each object, as an expert in its job, is not doing what is not its job, but instead relying on other objects that are experts in their respective jobs and provide them with all the context they need to achieve the tasks it wants them to do as parameters of the messages it sends to them.</p>
<p>This can be illustrated with a generic code pattern:</p>
<pre class="sourceCode java"><code class="sourceCode java">recipient.<span class="fu">DoSomethingForMe</span>(allTheContextYouNeedToKnow);</code></pre>
<p>This way, a double benefit is gained: 1. Our recipient (e.g. <code>taxExpert</code> from the example) can be used by other senders (e.g. pay tax for Joan) without needing to change. All it needs is a different context passed inside a constructor and messages. 2. We, as senders, can easily use different recipients (e.g. different tax experts that do the task they are assigned with differently) without learning how to interact with each new one.</p>
<p>Actually, if you look at it, as much as bank and documents are a context for the tax expert, the tax expert is a context for us. Thus, we may say that <em>a design that follows the Tell Don’t Ask principle creates classes that are context-independent</em>.</p>
<p>This has very profound influence on the stability of the protocols. As much as objects are context-independent, they (and their interactions) do not need to change when context changes.</p>
<p>Again, quoting Scott Bain, “what you hide, you can change”. Thus, telling an object what to do requires less knowledge than asking for data and information. Again using the driver license metaphor: I may ask another person for a driving license number to actually make sure they have the license and that it is valid (by checking the number somewhere). I may also ask another person to provide me with the directions to the place I want the first person to drive. But isn’t it easier to just tell “buy me some bread and butter”? Then, whoever I ask, has the freedom to either drive, or walk (if they know a good store nearby) or ask yet another person to do it instead. I don’t care as long as tomorrow morning, I find the bread and butter in my fridge.</p>
<p>All of these benefits are, by the way, exactly what Johnny and Benjamin were aiming at when refactoring the payroll system. They went from this code, where they <em>asked</em> <code>employee</code> a lot of questions:</p>
<pre class="sourceCode java"><code class="sourceCode java">var newSalary 
  = employee.<span class="fu">GetSalary</span>() 
  + employee.<span class="fu">GetSalary</span>() 
  * <span class="fl">0.1</span>;
employee.<span class="fu">SetSalary</span>(newSalary);</code></pre>
<p>to this design that <em>told</em> <code>employee</code> do do its job:</p>
<pre class="sourceCode java"><code class="sourceCode java">employee.<span class="fu">EvaluateRaise</span>();</code></pre>
<p>This way, they were able to make this code interact with both <code>RegularEmployee</code> and <code>ContractorEmployee</code> the same way.</p>
<p>This guideline should be treated very, very seriously and applied in almost an extreme way. There are, of course, few places where it does not apply and we’ll get back to them later.</p>
<p>Oh, I almost forgot one thing! The context that we are passing is not necessarily data. It is even more frequent to pass around behavior than to pass data. For example, in our interaction with the tax expert:</p>
<pre class="sourceCode java"><code class="sourceCode java">taxExpert.<span class="fu">PayAnnualIncomeTax</span>(
  ourIncomeDocuments,
  ourBank);</code></pre>
<p>Bank is probably not a piece of data. Rather, I would imagine Bank to implement an interface that looks like this:</p>
<pre class="sourceCode java"><code class="sourceCode java"><span class="kw">public</span> <span class="kw">interface</span> Bank
{
  <span class="dt">void</span> <span class="fu">TransferMoney</span>(
    Amount amount, 
    AccountId sourceAccount,
    AccountId destinationAccount); 
}</code></pre>
<p>So as you can see, this <code>Bank</code> is a piece of behavior, not data, and it itself follows the Tell Don’t Ask style as well (it does something well and takes all the context it needs from outside).</p>
<h3 id="where-tell-dont-ask-does-not-apply">Where Tell Don’t Ask does not apply</h3>
<p>As I already said, there are places where Tell Don’t Ask does not apply. Here are some examples from the top of my head:</p>
<ol style="list-style-type: decimal">
<li>Factories – these are objects that produce other objects for us, so they are inherently “pull-based” – they are always asked to deliver objects.</li>
<li>Collections – they are merely containers for objects, so all we want from them is adding objects and retrieving objects (by index, by predicate, using a key etc.). Note however, that when we write a class that wraps a collection inside, we want this class to expose interface shaped in a Tell Don’t Ask manner.</li>
<li>Data sources, like databases – again, these are storage for data, so it is more probable that we will need to ask for this data to get it.</li>
<li>Some APIs accessed via network – while it is good to use as much Tell Don’t Ask as we can, web APIs have one limitation – it is hard or impossible to pass behaviors as polymorphic objects through them. Usually, we can only pass data.</li>
<li>So called “fluent APIs”, also called “internal domain-specific languages”<a href="#fn16" class="footnoteRef" id="fnref16"><sup>16</sup></a></li>
</ol>
<p>Even in cases where we obtain other objects from a method call, we want to be able to apply Tell Don’t Ask to these other objects. For example, we want to avoid the following chain of calls:</p>
<pre class="sourceCode java"><code class="sourceCode java">Radio radio = <span class="fu">radioRepository</span>().<span class="fu">GetRadio</span>(<span class="dv">12</span>);
var userName = radio.<span class="fu">GetUsers</span>().<span class="fu">First</span>().<span class="fu">GetName</span>();
primaryUsersList.<span class="fu">Add</span>(userName);</code></pre>
<p>This way we make the communication tied to the following assumptions:</p>
<ol style="list-style-type: decimal">
<li>Radio has many users</li>
<li>Radio must have at least one user</li>
<li>Each user must have a name</li>
<li>The name is not null</li>
</ol>
<p>On the other hand, consider this implementation:</p>
<pre class="sourceCode java"><code class="sourceCode java">Radio radio = <span class="fu">radioRepository</span>().<span class="fu">GetRadio</span>(<span class="dv">12</span>);
radio.<span class="fu">AddPrimaryUserNameTo</span>(primaryUsersList);</code></pre>
<p>It does not have any of the weaknesses of the previous example. Thus, it is more stable in face of change.</p>
<h2 id="most-of-the-getters-should-be-removed-return-values-should-be-avoided">Most of the getters should be removed, return values should be avoided</h2>
<p>The above stated guideline of “Tell Don’t Ask” has a practical implication of getting rid of (almost) all the getters. We did say that each object should stick to its work and tell other objects to do their work, passing context to them, didn’t we? If so, then why should we “get” anything from other objects?</p>
<p>For me the idea of no getters was very extreme at first, but in a short time I learned that this is actually how I am supposed to write object-oriented code. You see, I started learning programming using structural languages such as C, where a program was divided into procedures or functions and data structures. Then I moved on to object-oriented languages that had far better mechanisms for abstraction, but my style of coding didn’t really change much. I would still have procedures and functions, just divided into objects. I would still have data structures, but now more abstract, e.g. objects with setters, getters and some other query methods.</p>
<p>But what alternatives do we have? Well, I already introduced Tell Don’t Ask, so you should know the answer. Even though you should, I want to show you another example, this time specifically about getters and setters.</p>
<p>Let’s say that we have a piece of software that handles user sessions. A session is represented in code using a <code>Session</code> class. We want to be able to do three things with our sessions: display them on the GUI, send them through the network and persist them. In our application, we want each of these responsibilities handled by a separate class, because we think it is good if they are not tied together.</p>
<p>So, we need three classes dealing with data owned by the session. This means that each of these classes should somehow obtain access to the data. Otherwise, how can this data be e.g. persisted? It seems we have no choice and we have to expose it using getters.</p>
<p>Of course, we might re-think our choice of creating separate classes for sending, persistence etc. and consider a choice where we put all this logic inside a <code>Session</code> class. If we did that, however, we would make a core domain concept (a session) dependent on a nasty set of third-party libraries (like a particular GUI library), which would mean that e.g. every time some GUI displaying concept changes, we will be forced to tinker in core domain code, which is pretty risky. Also, if we did that, the <code>Session</code> would be hard to reuse, because every place we would want to reuse this class, we would need to take all these heavy libraries it depends on with us. Plus, we would not be able to e.g. use <code>Session</code> with different GUI or persistence libraries. So, again, it seems like our (not so good, as we will see) only choice is to introduce getters for the information pieces stored inside a session, like this:</p>
<pre class="sourceCode java"><code class="sourceCode java"><span class="kw">public</span> <span class="kw">interface</span> Session
{
  string <span class="fu">GetOwner</span>();
  string <span class="fu">GetTarget</span>();
  DateTime <span class="fu">GetExpiryTime</span>();
}</code></pre>
<p>So yeah, in a way, we have decoupled <code>Session</code> from these third-party libraries and we may even say that we have achieved context-independence as far as <code>Session</code> itself is concerned – we can now pull all its data e.g. in a GUI code and display it as a table. The <code>Session</code> does not know anything about it. Let’s see that:</p>
<pre class="sourceCode java"><code class="sourceCode java"><span class="co">// Display sessions as a table on GUI</span>
<span class="fu">foreach</span>(var session in sessions)
{
  var tableRow = TableRow.<span class="fu">Create</span>();
  tableRow.<span class="fu">SetCellContentFor</span>(<span class="st">&quot;owner&quot;</span>, session.<span class="fu">GetOwner</span>());
  tableRow.<span class="fu">SetCellContentFor</span>(<span class="st">&quot;target&quot;</span>, session.<span class="fu">GetTarget</span>());
  tableRow.<span class="fu">SetCellContentFor</span>(<span class="st">&quot;expiryTime&quot;</span>, session.<span class="fu">GetExpiryTime</span>());
  table.<span class="fu">Add</span>(tableRow);
}</code></pre>
<p>It seems we solved the problem, by separating the data from the context it is used in and pulling data to a place that has the context, i.e. knows what to do with this data. Are we happy? We may be unless we look at how the other parts look like – remember that in addition to displaying sessions, we also want to send them and persist them. The sending logic looks like this:</p>
<pre class="sourceCode java"><code class="sourceCode java"><span class="co">//part of sending logic</span>
<span class="fu">foreach</span>(var session in sessions)
{
  var message = SessionMessage.<span class="fu">Blank</span>();
  message.<span class="fu">Owner</span> = session.<span class="fu">GetOwner</span>();
  message.<span class="fu">Target</span> = session.<span class="fu">GetTarget</span>();
  message.<span class="fu">ExpiryTime</span> = session.<span class="fu">GetExpiryTime</span>();
  connection.<span class="fu">Send</span>(message);
}</code></pre>
<p>and the persistence logic like this:</p>
<pre class="sourceCode java"><code class="sourceCode java"><span class="co">//part of storing logic</span>
<span class="fu">foreach</span>(var session in sessions)
{
  var record = Record.<span class="fu">Blank</span>();
  dataRecord.<span class="fu">Owner</span> = session.<span class="fu">GetOwner</span>();
  dataRecord.<span class="fu">Target</span> = session.<span class="fu">GetTarget</span>();
  dataRecord.<span class="fu">ExpiryTime</span> = session.<span class="fu">GetExpiryTime</span>();
  database.<span class="fu">Save</span>(record);
}</code></pre>
<p>See anything disturbing here? If no, then imagine what happens when we add another piece of information to the <code>Session</code>, say, priority. We now have three places to update and we have to remember to update all of them every time. This is called “redundancy” or “asking for trouble”. Also, composability of these three classes is pretty bad, because they will have to change a lot just because data in a session changes.</p>
<p>The reason for this is that we made the <code>Session</code> class effectively a data structure. It does not implement any domain-related behaviors, just exposes data. There are two implications of this:</p>
<ol style="list-style-type: decimal">
<li>This forces all users of this class to define session-related behaviors on behalf of the <code>Session</code>, meaning these behaviors are scattered all over the place<a href="#fn17" class="footnoteRef" id="fnref17"><sup>17</sup></a>. If one is to make change to the session, they must find all related behaviors and correct them.</li>
<li>As a set of object behaviors is generally more stable than its internal data (e.g. a session might have more than one target one day, but we will always be starting and stopping sessions), this leads to brittle interfaces and protocols – certainly the opposite of what we are striving for.</li>
</ol>
<p>Bummer, this solution is pretty bad, but we seem to be out of options. Should we just accept that there will be problems with this implementation and move on? Thankfully, we don’t have to. So far, we have found the following options to be troublesome:</p>
<ol style="list-style-type: decimal">
<li>The <code>Session</code> class containing the display, store and send logic, i.e. all the context needed – too much coupling to heavy dependencies.</li>
<li>The <code>Session</code> class to expose its data via getters, so that we may pull it where we have enough context to know how to use it – communication is too brittle and redundancy creeps in (by the way, this design will also be bad for multithreading, but that’s something for another time).</li>
</ol>
<p>Thankfully, we have a third alternative, which is better than the two we already mentioned. We can just <strong>pass</strong> the context <strong>into</strong> the <code>Session</code> class. “Isn’t this just another way to do what we outlined in point 1? If we pass the context in, isn’t <code>Session</code> still coupled to this context?”, you may ask. The answer is: not necessarily, because we can make <code>Session</code> class depend on interfaces only instead of the real thing to make it context-independent enough.</p>
<p>Let’s see how this plays out in practice. First let’s remove those ugly getters from the <code>Session</code> and introduce new method called <code>DumpInto()</code> that will take a <code>Destination</code> interface implementation as a parameter:</p>
<pre class="sourceCode java"><code class="sourceCode java"><span class="kw">public</span> <span class="kw">interface</span> Session
{
  <span class="dt">void</span> <span class="fu">DumpInto</span>(Destination destination);
}</code></pre>
<p>The implementation of <code>Session</code>, e.g. a <code>RealSession</code> can pass all fields into this destination like so:</p>
<pre class="sourceCode java"><code class="sourceCode java"><span class="kw">public</span> <span class="kw">class</span> RealSession : Session
{
  <span class="co">//...</span>

  <span class="kw">public</span> <span class="dt">void</span> <span class="fu">DumpInto</span>(Destination destination)
  {
    destination.<span class="fu">AcceptOwner</span>(<span class="kw">this</span>.<span class="fu">owner</span>);
    destination.<span class="fu">AcceptTarget</span>(<span class="kw">this</span>.<span class="fu">target</span>);
    destination.<span class="fu">AcceptExpiryTime</span>(<span class="kw">this</span>.<span class="fu">expiryTime</span>);
    destination.<span class="fu">Done</span>();
  }

  <span class="co">//...</span>
}</code></pre>
<p>And the looping through sessions now looks like this:</p>
<pre class="sourceCode java"><code class="sourceCode java"><span class="fu">foreach</span>(var session : sessions)
{
  session.<span class="fu">DumpInto</span>(destination);
}</code></pre>
<p>In this design, <code>RealSession</code> itself decides which parameters to pass and in what order (if that matters) – no one is asking for its data. This <code>DumpInto()</code> method is fairly general, so we can use it to implement all three mentioned behaviors (displaying, persistence, sending), by creating a implementation for each type of destination, e.g. for GUI, it might look like this:</p>
<pre class="sourceCode java"><code class="sourceCode java"><span class="kw">public</span> <span class="kw">class</span> GuiDestination : Destination
{
  <span class="kw">private</span> TableRow _row;
  <span class="kw">private</span> Table _table;
  
  <span class="kw">public</span> <span class="fu">GuiDestination</span>(Table table, TableRow row)
  {
    _table = table;
    _row = row;
  }

  <span class="kw">public</span> <span class="dt">void</span> <span class="fu">AcceptOwner</span>(string owner)
  {
    _row.<span class="fu">SetCellContentFor</span>(<span class="st">&quot;owner&quot;</span>, owner);
  }

  <span class="kw">public</span> <span class="dt">void</span> <span class="fu">AcceptTarget</span>(string target)
  {
    _row.<span class="fu">SetCellContentFor</span>(<span class="st">&quot;target&quot;</span>, target);
  }

  <span class="kw">public</span> <span class="dt">void</span> <span class="fu">AcceptExpiryTime</span>(DateTime expiryTime)
  {
    _row.<span class="fu">SetCellContentFor</span>(<span class="st">&quot;expiryTime&quot;</span>, expiryTime);
  }

  <span class="kw">public</span> <span class="dt">void</span> <span class="fu">Done</span>()
  {
    _table.<span class="fu">Add</span>(_row);
  }
}</code></pre>
<p>The protocol is now more stable as far as the consumers of session data are concerned. Previously, when we had the getters in the <code>Session</code> class:</p>
<pre class="sourceCode java"><code class="sourceCode java"><span class="kw">public</span> <span class="kw">class</span> Session
{
  string <span class="fu">GetOwner</span>();
  string <span class="fu">GetTarget</span>();
  DateTime <span class="fu">GetExpiryTime</span>();
}</code></pre>
<p>the getters <strong>had to</strong> return <strong>something</strong>. So what if we had sessions that could expire and decided we want to ignore them when they do (i.e. do not display, store, send or do anything else with them)? In case of the “getter approach” seen in the snippet above, we would have to add another getter, e.g. called <code>IsExpired()</code> to the session class and remember to update each consumer the same way – to check the expiry before consuming the data… you see where this is going, don’t you? On the other hand, with the current design of the <code>Session</code> interface, we can e.g. introduce a feature where the expired sessions are not processed at all in a single place:</p>
<pre class="sourceCode java"><code class="sourceCode java"><span class="kw">public</span> <span class="kw">class</span> TimedSession : Session
{
  <span class="co">//...</span>

  <span class="kw">public</span> <span class="dt">void</span> <span class="fu">DumpInto</span>(Destination destination)
  {
    <span class="kw">if</span>(!<span class="fu">IsExpired</span>())
    {
      destination.<span class="fu">AcceptOwner</span>(<span class="kw">this</span>.<span class="fu">owner</span>);
      destination.<span class="fu">AcceptTarget</span>(<span class="kw">this</span>.<span class="fu">target</span>);
      destination.<span class="fu">AcceptExpiryTime</span>(<span class="kw">this</span>.<span class="fu">expiryTime</span>);
      destination.<span class="fu">Done</span>();
    }
  }

  <span class="co">//...</span>
}</code></pre>
<p>and there is no need to change any other code to get this working<a href="#fn18" class="footnoteRef" id="fnref18"><sup>18</sup></a>.</p>
<p>Another added bonus of this situation that <code>Session</code> does not have to return anything from methods is that we are free to apply proxy and decorator patterns more freely to the <code>Session</code>. For example, we may have hidden sessions, that are not displayed/stored/sent at all, but retain the rest of the session functionality. We may implement the feature using a proxy, that forwards all messages it receives to the original, wrapped <code>Session</code> object, but discards the <code>DumpInto()</code> calls:</p>
<pre class="sourceCode java"><code class="sourceCode java"><span class="kw">public</span> <span class="kw">class</span> HiddenSession : Session
{
  <span class="kw">private</span> Session _innerSession;

  <span class="kw">public</span> <span class="fu">HiddenSession</span>(Session innerSession)
  {
    _innerSession = innerSession;
  }

  <span class="kw">public</span> <span class="dt">void</span> <span class="fu">DoSomethig</span>()
  {
    <span class="co">// forward the message to wrapped instance:</span>
    _innerSession.<span class="fu">DoSomething</span>();
  }

  <span class="co">//...</span>

  <span class="kw">public</span> <span class="dt">void</span> <span class="fu">DumpInto</span>(Destination destination)
  {
    <span class="co">// discard the message - do nothing</span>
  }

  <span class="co">//...</span>
}</code></pre>
<p>When we are not forced to return anything, we are more free to do as we like. Again, “Tell, don’t ask”.</p>
<h2 id="protocols-should-be-small-and-abstract">Protocols should be small and abstract</h2>
<p>I already said that interfaces should be small and abstract, so am I not just repeating myself here? The answer is: there is a difference between the size of protocols and the size of interfaces. As an extreme example, let’s take the following interface:</p>
<pre class="sourceCode java"><code class="sourceCode java"><span class="kw">public</span> <span class="kw">interface</span> Interpreter
{
  <span class="kw">public</span> <span class="dt">void</span> <span class="fu">Execute</span>(string command);
}</code></pre>
<p>Is the interface small? Of course! Is it abstract? Well, kind of, yes. Tell Don’t Ask? Sure! But let’s see how it’s used by one of its collaborators:</p>
<pre class="sourceCode java"><code class="sourceCode java"><span class="kw">public</span> <span class="dt">void</span> <span class="fu">RunScript</span>()
{
  _interpreter.<span class="fu">Execute</span>(<span class="st">&quot;cd dir1&quot;</span>);
  _interpreter.<span class="fu">Execute</span>(<span class="st">&quot;copy *.cs ../../dir2/src&quot;</span>);
  _interpreter.<span class="fu">Execute</span>(<span class="st">&quot;copy *.xml ../../dir2/config&quot;</span>);
  _interpreter.<span class="fu">Execute</span>(<span class="st">&quot;cd ../../dir2/&quot;</span>);
  _interpreter.<span class="fu">Execute</span>(<span class="st">&quot;compile *.cs&quot;</span>);
  _interpreter.<span class="fu">Execute</span>(<span class="st">&quot;cd dir3&quot;</span>);
  _interpreter.<span class="fu">Execute</span>(<span class="st">&quot;copy *.cs ../../dir4/src&quot;</span>);
  _interpreter.<span class="fu">Execute</span>(<span class="st">&quot;copy *.xml ../../dir4/config&quot;</span>);
  _interpreter.<span class="fu">Execute</span>(<span class="st">&quot;cd ../../dir4/&quot;</span>);
  _interpreter.<span class="fu">Execute</span>(<span class="st">&quot;compile *.cs&quot;</span>);
  _interpreter.<span class="fu">Execute</span>(<span class="st">&quot;cd dir5&quot;</span>);
  _interpreter.<span class="fu">Execute</span>(<span class="st">&quot;copy *.cs ../../dir6/src&quot;</span>);
  _interpreter.<span class="fu">Execute</span>(<span class="st">&quot;copy *.xml ../../dir6/config&quot;</span>);
  _interpreter.<span class="fu">Execute</span>(<span class="st">&quot;cd ../../dir6/&quot;</span>);
  _interpreter.<span class="fu">Execute</span>(<span class="st">&quot;compile *.cs&quot;</span>);
}</code></pre>
<p>The point is: the protocol is neither abstract nor small. Thus, making implementations of interface that is used as such can be pretty painful.</p>
<h2 id="summary-7">Summary</h2>
<p>In this lengthy chapter I tried to show you the often underrated value of designing communication protocols between objects. They are not a “nice thing to have”, but rather a fundamental part of the design approach that makes mock objects useful, as you will see when finally we get to them. But first, I need you to swallow few more object-oriented design ideas. I promise it will pay off.</p>
<h1 id="classes">Classes</h1>
<p>We already covered interfaces and protocols. In our quest for composability, We need to look at classes as well. Classes:</p>
<ul>
<li>implement interfaces (i.e. play roles)</li>
<li>communicate through interfaces to other services</li>
<li>follow protocols in this communication</li>
</ul>
<p>So in a way, what is “inside” a class is a byproduct of how objects of this class acts on the “outside”. Still, it does not mean there is nothing to say about classes themselves that contributes to better composability.</p>
<h2 id="single-responsibility-principle">Single Responsibility Principle</h2>
<p>I already said that we want our system to be a web of composable objects. Obviously, an object is a granule of composability – we cannot e.g. unplug a half of an object and plug in another half. Thus, a valid question to ask is: how big should an object be to make the composability comfortable – to let us unplug as much logic as we want, leaving the rest untouched and ready to work with the new recipients we plug in?</p>
<p>The answer comes with a <em>Single Responsibility Principle</em> (in short: SRP) for classes<a href="#fn19" class="footnoteRef" id="fnref19"><sup>19</sup></a>, which basically says<a href="#fn20" class="footnoteRef" id="fnref20"><sup>20</sup></a>:</p>
<blockquote>
<p>A code of a Class should have only one reason to change.</p>
</blockquote>
<p>There has been a lot written about the principle on the web, so I am not going to be wiser than your favourite web search engine (my recent search yielded over 74 thousands results). Still, I believe it is useful to explain this principle in terms of composability.</p>
<p>Usually, the hard part about this principle is how to understand “a reason to change”. Robert C. Martin explains<a href="#fn21" class="footnoteRef" id="fnref21"><sup>21</sup></a> that this is about a single source of entropy that generates changes to the class. Which leads us to another trouble of defining a “source of entropy”. So I think it’s better to just give you an example.</p>
<h3 id="separating-responsibilities">Separating responsibilities</h3>
<p>Remember the code Johnny and Benjamin used to apply incentive plans to employees? In case you don’t, here it is (it’s just a single method, not a whole class, but it should be enough for our needs):</p>
<pre class="sourceCode java"><code class="sourceCode java"><span class="kw">public</span> <span class="dt">void</span> <span class="fu">ApplyYearlyIncentivePlan</span>()
{
  var employees = _repository.<span class="fu">CurrentEmployees</span>();

  <span class="fu">foreach</span>(var employee in employees)
  {
    employee.<span class="fu">EvaluateRaise</span>();
    employee.<span class="fu">EvaluateBonus</span>();
    employee.<span class="fu">Save</span>();
  }
}</code></pre>
<p>So… how many reasons to change does this piece of code have? If we weren’t talking about “reason to change” but simply a “change”, the answer would be “many”. For example, someone may decide that we are not giving raises anymore and the <code>employee.EvaluateRaise()</code> line would be gone. Likewise, a decision could be made that we are not giving bonuses, then the <code>employee.EvaluateBonus()</code> line would have to be removed. So, there are undoubtedly many ways this method could change. But would it be for different reasons? Actually, no. The reason in both cases would be (probably) that the CEO approved a new incentive plan. So, there is one “source of entropy” for these two changes, although there are many ways the code can change. Hence, the two changes are for the same reason.</p>
<p>Now the more interesting part of the discussion: what about saving the employees – is the reason for changing how we save employees the same as for the bonuses and pays? For example, we may decide that we are not saving each employee separately, because it would cause a huge performance load on our data store, but instead, we will save them together in a single batch after we finish processing the last one. This causes the code to change, e.g. like this:</p>
<pre class="sourceCode java"><code class="sourceCode java"><span class="kw">public</span> <span class="dt">void</span> <span class="fu">ApplyYearlyIncentivePlan</span>()
{
  var employees = _repository.<span class="fu">CurrentEmployees</span>();

  <span class="fu">foreach</span>(var employee in employees)
  {
    employee.<span class="fu">EvaluateRaise</span>();
    employee.<span class="fu">EvaluateBonus</span>();
  }
  
  <span class="co">//now all employees saved once</span>
  _repository.<span class="fu">SaveAll</span>(employees);
}</code></pre>
<p>So, as you might’ve already guessed, the reason for this change is different as for changing incentive plan, thus, it is a separate responsibility and the logic for reading and storing employees should be separated from this class. The method after the separation would look something like this:</p>
<pre class="sourceCode java"><code class="sourceCode java"><span class="kw">public</span> <span class="dt">void</span> <span class="fu">ApplyYearlyIncentivePlanTo</span>(IEnumerable&lt;Employee&gt; employees)
{
  <span class="fu">foreach</span>(var employee in employees)
  {
    employee.<span class="fu">EvaluateRaise</span>();
    employee.<span class="fu">EvaluateBonus</span>();
  }
}</code></pre>
<p>In the example above, we moved reading and writing employees out, so that it is handled by different code – thus, the responsibilities are separated. Do we now have a code that adheres to Single Reponsibility Principle? We may, but consider this situation: the evaluation of the raises and bonuses begins getting slow and, instead of doing this for all employees in a sequential <code>for</code> loop, we would rather parallelize it to process every employee at the same time in a separate thread. After applying this change, the code could look like this (This uses C#-specific API for parallel looping, but I hope you get the idea):</p>
<pre class="sourceCode java"><code class="sourceCode java"><span class="kw">public</span> <span class="dt">void</span> <span class="fu">ApplyYearlyIncentivePlanTo</span>(IEnumerable&lt;Employee&gt; employees)
{
  Parallel.<span class="fu">ForEach</span>(employees, employee =&gt;
  {
    employee.<span class="fu">EvaluateRaise</span>();
    employee.<span class="fu">EvaluateBonus</span>();
  });
}</code></pre>
<p>Is this a new reason to change? Of course it is! Decisions on parallelizing processing come from different source than incentive plan modifications. So, we may say we encountered another responsibility and separate it. The code that remains in the <code>ApplyYearlyIncentivePlanTo()</code> method looks like this now:</p>
<pre class="sourceCode java"><code class="sourceCode java"><span class="kw">public</span> <span class="dt">void</span> <span class="fu">ApplyYearlyIncentivePlanTo</span>(Employee employee)
{
  employee.<span class="fu">EvaluateRaise</span>();
  employee.<span class="fu">EvaluateBonus</span>();
}</code></pre>
<p>The looping, which is a separate responsibility, is now handled by a different class.</p>
<h3 id="how-far-do-we-go">How far do we go?</h3>
<p>The above example begs some questions:</p>
<ol style="list-style-type: decimal">
<li>Can we reach a point where we have separated all responsibilities?</li>
<li>If we can, how can we be sure we have reached it?</li>
</ol>
<p>The answer to the first question is: probably no. While some reasons to change are common sense, and others can be drawn from our experience as developers or knowledge about the domain of the problem, there are always some that are unexpected and until they surface, we cannot foresee them. Thus, the answer for the second question is: “there is no way”. Which does not mean we should not try to separate the different reasons we see – quite the contrary. We just don’t get overzealous trying to predict every possible change.</p>
<p>I like the comparison of responsibilities to our usage of time in real life. Brewing time of black tea is usually around three to five minutes. This is what is usually printed on the package we buy: “3 — 5 minutes”. Nobody gives the time in seconds, because such granularity is not needed. If seconds made a noticeable difference in the process of brewing tea, we would probably be given time in seconds. But they don’t. When we estimate tasks in software engineering, we also use different time granularity depending on the need<a href="#fn22" class="footnoteRef" id="fnref22"><sup>22</sup></a> and the granularity becomes finer as we reach a point where the smaller differences matter more.</p>
<p>Likewise, a simplest software program that prints “hello world” on the screen may fit into a single “main” method and we will probably not see it as several responsibilities. But as soon as we get a requirement to write “hello world” in a native language of the currently running operating system, obtaining the text becomes a separate responsibility from putting it on the screen. It all depends on what granularity we need at the moment (which, as I said, may be spotted from code or, in some cases, known up-front from our experience as developers or domain knowledge).</p>
<h3 id="the-mutual-relationship-between-single-responsibility-principle-and-composability">The mutual relationship between Single Responsibility Principle and composability</h3>
<p>The reason I am writing all this is that responsibilities are the real granules of composability. The composability of objects that I have talked about a lot already is actually a mean to achieve composability of responsibilities. So, this is what’s our real goal. If we have two collaborating objects, each having a single responsibility, we can easily replace the way our application achieves one of these responsibilities without touching the other. Thus, objects conforming to SRP are the most comfortably composable and the right size.<a href="#fn23" class="footnoteRef" id="fnref23"><sup>23</sup></a>.</p>
<p>A good example from another playground where single responsibility goes hand in hand with composability is UNIX. UNIX is famous for its collection of single-purpose command-line tools, like <code>ls</code>, <code>grep</code>, <code>ps</code>, <code>sed</code> etc. The single-purposeness of these utilities along with the ability of UNIX commandline to pass output stream of one command to the input stream of another by using the <code>|</code> (pipe) operator. For example, we may combine three commands: <code>ls</code> (lists contents of directory), <code>sort</code> (sorts passed input) and <code>more</code> (allows comfortably viewing on the screen input that takes more than one screen) into a pipeline:</p>
<pre class="sourceCode bash"><code class="sourceCode bash"><span class="kw">ls</span> <span class="kw">|</span> <span class="kw">sort</span> <span class="kw">|</span> <span class="kw">more</span></code></pre>
<p>Which displays sorted content of current directory for comfortable view. This philosophy of composing a set of single-purpose tools into a more complex and more useful whole is what we are after, only that in object-oriented software development, we’re using objects instead of executables. We will talk more about it in the next chapter.</p>
<h2 id="static-recipients">Static recipients</h2>
<p>While static fields in a class body may sometimes seem like a good idea of “sharing” recipient references between its instances and smart way to make the code more “memory efficient”, they actually hurt composability more often than not. Let’s take a look at a simple example to get a feeling of how static fields constraint our design.</p>
<h3 id="smtp-server">SMTP Server</h3>
<p>Imagine we need to implement an e-mail server that receives and sends SMTP messages<a href="#fn24" class="footnoteRef" id="fnref24"><sup>24</sup></a>. In our code, have an <code>OutboundSmtpMessage</code> class which symbolizes SMTP messages we send to other parties. To send the message, we need to encode it. For now, we always use an encoding called <em>Quoted-Printable</em>, which is declared in a separate class called <code>QuotedPrintableEncoding</code> and the class <code>OutboundSmtpMessage</code> declares a private field of this type:</p>
<pre class="sourceCode java"><code class="sourceCode java"><span class="kw">public</span> <span class="kw">class</span> OutboundSmtpMessage
{
  <span class="co">//... other code</span>
  
  <span class="kw">private</span> Encoding _encoding = <span class="kw">new</span> <span class="fu">QuotedPrintableEncoding</span>();
  
  <span class="co">//... other code</span>
}</code></pre>
<p>Note that each message has its own encoding objects, so when we have, say, 1000000 messages in memory, we also have the same amount of encoding objects.</p>
<h3 id="premature-optimization">Premature optimization</h3>
<p>One day we notice that it is a waste for each message to define its own encoding object, since an encoding is pure algorithm and each use of this encoding does not affect further uses in any way – so we can as well have a single instance and use it in all messages – it will not cause any conflicts. Also, it may save us some CPU cycles, since creating an encoding each time we create a new message has its cost in high throughput scenarios.</p>
<p>But how we make the encoding shared between all instances? Out first thought – static fields! A static field seems fit for the job, since it gives us exactly what we want – a single object shared across many instances of its declaring class. Driven by our (supposedly) excellent idea, we modify our <code>OutboundSmtpMessage</code> message class to hold <code>QuotedPrintableEncoding</code> instance as a static field:</p>
<pre class="sourceCode java"><code class="sourceCode java"><span class="kw">public</span> <span class="kw">class</span> OutboundSmtpMessage
{
  <span class="co">//... other code</span>
  
  <span class="kw">private</span> <span class="dt">static</span> Encoding _encoding = <span class="kw">new</span> <span class="fu">QuotedPrintableEncoding</span>();
  
  <span class="co">//... other code</span>
}</code></pre>
<p>There, we fixed it! But didn’t our mommies tell us not to optimize prematurely? Oh well…</p>
<h3 id="welcome-change">Welcome, change!</h3>
<p>One day it turns out that in our messages, we need to support not only Quoted-Printable encoding but also another one, called <em>Base64</em>. With our current design, we cannot do that, because, as a result of using a static field, a single encoding is shared between all messages. Thus, if we change the encoding for message that requires Base64 encoding, it will also change the encoding for the messages that require Quoted-Printable. This way, we constraint the composability with this premature optimization – we cannot compose each message with the encoding we want. All of the message use either one encoding, or another. A logical conclusion is that no instance of such class is context-independent – it cannot obtain its own context, but rather, context is forced on it.</p>
<h3 id="so-what-about-optimizations">So what about optimizations?</h3>
<p>Are we doomed to return to the previous solution to have one encoding per message? What if this really becomes a performance or memory problem? Is our observation that we don’t need to create the same encoding many times useless?</p>
<p>Not at all. We can still use this observation and get a lot (albeit not all) of the benefits of static field. How do we do it? How do we achieve sharing of encodings without the constraints of static field? Well, we already answered this question few chapters ago – give each message an encoding through its constructor. This way, we can pass the same encoding to many, many <code>OutboundSmtpMessage</code> instances, but if we want, we can always create a message that has another encoding passed. Using this idea, we will try to achieve the sharing of encodings by creating a single instance of each encoding in the composition root and have it passed it to a message through its constructor.</p>
<p>Let’s examine this solution. First, we need to create one of each encoding in the composition root, like this:</p>
<pre class="sourceCode java"><code class="sourceCode java"><span class="co">// We are in a composition root!</span>

<span class="co">//...some initialization</span>

var base64Encoding = <span class="kw">new</span> <span class="fu">Base64Encoding</span>();
var quotedPrintableEncoding = <span class="kw">new</span> <span class="fu">QuotedPrintableEncoding</span>();

<span class="co">//...some more initialization</span></code></pre>
<p>Ok, encodings are created, but we still have to pass them to the messages. In our case, we need to create new <code>OutboundSmtpMessage</code> object at the time we need to send a new message, i.e. on demand, so we need a factory to produce the message objects. This factory can (and should) be created in the composition root. When we create the factory, we can pass both encodings to its constructor as global context (remember that factories encapsulate global context?):</p>
<pre class="sourceCode java"><code class="sourceCode java"><span class="co">// We are in a composition root!</span>

<span class="co">//...some initialization</span>

var messageFactory 
  = <span class="kw">new</span> <span class="fu">StmpMessageFactory</span>(base64Encoding, quotedPrintableEncoding);

<span class="co">//...some more initialization</span></code></pre>
<p>The factory itself can be used for the on-demand message creation that we talked about. As the factory receives both encodings via its constructor, it can store them as private fields and pass whichever one is appropriate to a message object it creates:</p>
<pre class="sourceCode java"><code class="sourceCode java"><span class="kw">public</span> <span class="kw">class</span> SmtpMessageFactory : MessageFactory
{
  <span class="kw">private</span> Encoding _quotedPrintable;
  <span class="kw">private</span> Encoding _base64;
  
  <span class="kw">public</span> <span class="fu">SmtpMessageFactory</span>(
    Encoding quotedPrintable, 
    Encoding base64)
  {
    _quotedPrintable = quotedPrintable;
    _base64 = base64;
  }
  
  <span class="kw">public</span> Message <span class="fu">CreateFrom</span>(string content, MessageLanguage language)
  {
    <span class="kw">if</span>(language.<span class="fu">IsLatinBased</span>)
    {
      <span class="co">//each message gets the same instance of encoding:</span>
      <span class="kw">return</span> <span class="kw">new</span> <span class="fu">StmpMessage</span>(content, _quotedPrintable); 
    }
    <span class="kw">else</span>
    {
      <span class="co">//each message gets the same instance of encoding:</span>
      <span class="kw">return</span> <span class="kw">new</span> <span class="fu">StmpMessage</span>(content, _base64);
    }
  }
}  </code></pre>
<p>The performance and memory saving is not exactly as big as when using a static field (e.g. each <code>OutboundSmtpMessage</code> instance uses must store a separate reference to the received encoding), but it is still a huge improvement over creating a separate encoding object per message.</p>
<h3 id="where-statics-work">Where statics work?</h3>
<p>What I wrote does not mean that statics do not have their uses. They do, but these uses are very specific. I will show you one of such uses in the next chapters after I introduce value objects.</p>
<h2 id="summary-8">Summary</h2>
<p>In this chapter, I tried to give you some advice on designing classes that does not come so naturally from the concept of composability and interactions as those described in previous chapters. Still, as I hope I was able to show, they enhance composability and are valuable to us.</p>
<h1 id="this-is-all-i-have-for-now.-what-follows-is-raw-unordered-material-thats-not-yet-ready-to-be-consumed-as-part-of-this-tutorial">THIS IS ALL I HAVE FOR NOW. WHAT FOLLOWS IS RAW, UNORDERED MATERIAL THAT’S NOT YET READY TO BE CONSUMED AS PART OF THIS TUTORIAL</h1>
<h1 id="object-composition-as-a-language">Object Composition as a Language</h1>
<p>While most of the earlier chapters talked a lot about viewing object composition as a web, this one will take a different view - one of a language. These two views are remarkably similar in nature and complement each other in guiding design.</p>
<p>It might surprise you that I am comparing object composition to a language, but, as I hope you’ll see, there are many similarities. Don’t worry, we’ll get there step by step, the first step being taking a second look at the composition root.</p>
<h2 id="more-readable-composition-root">More readable composition root</h2>
<p>When describing object compositon and composition root in particular, I promised to get back to the topic of making the composition code cleaner and more readable.</p>
<p>Before I do this, however, we need to get one important question answered…</p>
<h3 id="why-bother">Why bother?</h3>
<p>By now you have to be sick and tired of how I stress the importance of composability. I do so, however, because I believe it is one of the most important aspect of well-designed classes. Also, I said that in order to reach high composability of a class, it has to be context-independent. To explain how to reach this independence, I introduced the principle of separating object use from construction, pushing the construction part away into specialized places in code. I also said that a lot can be contributed to this quality by making the interfaces and protocols abstract and having them expose as small amount of implementation details as possible.</p>
<p>All of this has its cost, however. Striving for high context-independence takes away from us the ability to look at a single class and determine its context just by reading its code. Such class is “dumb” about the context it operates in.</p>
<p>TODO example!!</p>
<p>On the other hand, as much as context-independent classes and interfaces are important, the behavior of the application as a whole is important as well. Didn’t I say that the goal of composability is to be able to change the behavior of application more easily? But how can we consciously make decision about changing application behavior when we do not understand it? And no longer than a paragraph ago we came to conclusion that just reading a class after class is not enough. We have to have a view of how these classes work together as a system. So, where is the overall context that defines the behavior of the application?</p>
<p>The context is in the composition code - the code that connects objects together, passing a real context to each object and showing how the overall context looks like.</p>
<h3 id="example-5">Example</h3>
<p>I assume you barely remember the alarms example I gave you in one of the first chapters of this part of the book to explain changing behavior by changing object composition. Anyway, just to remind you, we ended with a code that looked like this:</p>
<pre class="sourceCode java"><code class="sourceCode java"><span class="kw">new</span> <span class="fu">SecureArea</span>(
  <span class="kw">new</span> <span class="fu">OfficeBuilding</span>(
    <span class="kw">new</span> <span class="fu">DayNightSwitchedAlarm</span>(
      <span class="kw">new</span> <span class="fu">SilentAlarm</span>(<span class="st">&quot;222-333-444&quot;</span>), 
      <span class="kw">new</span> <span class="fu">LoudAlarm</span>()
    )
  ),
  <span class="kw">new</span> <span class="fu">StorageBuilding</span>(
    <span class="kw">new</span> <span class="fu">HybridAlarm</span>(
      <span class="kw">new</span> <span class="fu">SilentAlarm</span>(<span class="st">&quot;222-333-444&quot;</span>),
      <span class="kw">new</span> <span class="fu">LoudAlarm</span>()
    )
  ),
  <span class="kw">new</span> <span class="fu">GuardsBuilding</span>(
    <span class="kw">new</span> <span class="fu">HybridAlarm</span>(
      <span class="kw">new</span> <span class="fu">SilentAlarm</span>(<span class="st">&quot;919&quot;</span>), <span class="co">//call police</span>
      <span class="kw">new</span> <span class="fu">LoudAlarm</span>()
    )
  )
);</code></pre>
<p>So we had three buildings all armed with alarms. The nice property of this code was that we could read the alarm setups from it, e.g. the following part of the composition:</p>
<pre class="sourceCode java"><code class="sourceCode java"><span class="kw">new</span> <span class="fu">OfficeBuilding</span>(
  <span class="kw">new</span> <span class="fu">DayNightSwitchedAlarm</span>(
    <span class="kw">new</span> <span class="fu">SilentAlarm</span>(<span class="st">&quot;222-333-444&quot;</span>), 
    <span class="kw">new</span> <span class="fu">LoudAlarm</span>()
  )
),</code></pre>
<p>meant that we were arming an office building with an alarm that calls number <code>222-333-444</code> when triggered during the day, but plays loud sirens when activated during the night. We could read this straight from the composition code, provided we knew what each object added to the overall composite behavior. So, again, composition of parts describes the behavior of the whole. There is, however, one more thing to note about this piece of code: it describes the behavior without explicitly stating its control flow (<code>if</code>, <code>else</code>, <code>for</code>, etc.). Such description is often called <em>declarative</em> - by composing objects, we write <em>what</em> we want to achieve without writing <em>how</em> to achieve it - the control flow itself is hidden inside the objects.</p>
<p>Let’s sum up these two conclusions with the following statement:</p>
<blockquote>
<p>The composition code is a declarative description of the overall behavior of our application.</p>
</blockquote>
<p>Wow, this is quite a statement, isn’t it? But, as we already noticed, it is true. There is, however, one problem with treating the composition code as overall application description: readability. Even though the composition <em>is</em> the description of the system, it does not read naturally. We want to see the description of behavior, but most of what we see is: <code>new</code>, <code>new</code>, <code>new</code>, <code>new</code>, <code>new</code>… There is a lot of syntactic noise involved, especially in real systems, where composition code is much longer than this tiny example. Can’t we do something about it?</p>
<h2 id="refactoring-for-readability">Refactoring for readability</h2>
<p>The declarativeness of composition code goes hand in hand with an approach of defining so called <em>fluent interfaces</em>. A fluent interface is an API made with readability and flow-like reading in mind. It is usually declarative and targeted towards specific domain, thus another name: <em>internal domain specific languages</em>, in short: DSL.</p>
<p>There are some simple patterns for creating such domain-specific languages. One of them that can be applied to our situation is called <em>nested function</em><a href="#fn25" class="footnoteRef" id="fnref25"><sup>25</sup></a>, which, in our context, means wrapping a call to <code>new</code> with a more descriptive method. Don’t worry if that confuses you, we’ll see how it plays out in practice in a second. We will do this step by step, so there will be a lot of repeated code, but hopefully, you will be able to closely watch the process of improving the readability of composition code.</p>
<p>Ok, Let’s see the code again before making any changes to it:</p>
<pre class="sourceCode java"><code class="sourceCode java"><span class="kw">new</span> <span class="fu">SecureArea</span>(
  <span class="kw">new</span> <span class="fu">OfficeBuilding</span>(
    <span class="kw">new</span> <span class="fu">DayNightSwitchedAlarm</span>(
      <span class="kw">new</span> <span class="fu">SilentAlarm</span>(<span class="st">&quot;222-333-444&quot;</span>), 
      <span class="kw">new</span> <span class="fu">LoudAlarm</span>()
    )
  ),
  <span class="kw">new</span> <span class="fu">StorageBuilding</span>(
    <span class="kw">new</span> <span class="fu">HybridAlarm</span>(
      <span class="kw">new</span> <span class="fu">SilentAlarm</span>(<span class="st">&quot;222-333-444&quot;</span>),
      <span class="kw">new</span> <span class="fu">LoudAlarm</span>()
    )
  ),
  <span class="kw">new</span> <span class="fu">GuardsBuilding</span>(
    <span class="kw">new</span> <span class="fu">HybridAlarm</span>(
      <span class="kw">new</span> <span class="fu">SilentAlarm</span>(<span class="st">&quot;919&quot;</span>), <span class="co">//call police</span>
      <span class="kw">new</span> <span class="fu">LoudAlarm</span>()
    )
  )
);</code></pre>
<p>Note that we have few places where we create <code>SilentAlarm</code>. Let’s move creation of these objects into a separate method:</p>
<pre class="sourceCode java"><code class="sourceCode java"><span class="kw">public</span> Alarm <span class="fu">Calls</span>(string number)
{
  <span class="kw">return</span> <span class="kw">new</span> <span class="fu">SilentAlarm</span>(number);
}</code></pre>
<p>This step may look silly, (after all, we are introducing a method wrapping a single line of code), but there is a lot of sense to it. First of all, it lets us reduce the syntax noise - when we need to create a silent alarm, we do not have to say <code>new</code> anymore. Another benefit is that we can describe the role a <code>SilentAlarm</code> instance plays in our composition (I will explain later why we are doing it using passive voice).</p>
<p>After replacing each invocation of <code>SilentAlarm</code> constructor with a call to this method, we get:</p>
<pre class="sourceCode java"><code class="sourceCode java"><span class="kw">new</span> <span class="fu">SecureArea</span>(
  <span class="kw">new</span> <span class="fu">OfficeBuilding</span>(
    <span class="kw">new</span> <span class="fu">DayNightSwitchedAlarm</span>(
      <span class="fu">Calls</span>(<span class="st">&quot;222-333-444&quot;</span>), 
      <span class="kw">new</span> <span class="fu">LoudAlarm</span>()
    )
  ),
  <span class="kw">new</span> <span class="fu">StorageBuilding</span>(
    <span class="kw">new</span> <span class="fu">HybridAlarm</span>(
      <span class="fu">Calls</span>(<span class="st">&quot;222-333-444&quot;</span>),
      <span class="kw">new</span> <span class="fu">LoudAlarm</span>()
    )
  ),
  <span class="kw">new</span> <span class="fu">GuardsBuilding</span>(
    <span class="kw">new</span> <span class="fu">HybridAlarm</span>(
      <span class="fu">Calls</span>(<span class="st">&quot;919&quot;</span>), <span class="co">//police number</span>
      <span class="kw">new</span> <span class="fu">LoudAlarm</span>()
    )
  )
);</code></pre>
<p>Next, let’s do the same with <code>LoudAlarm</code>, wrapping its creation with a method:</p>
<pre class="sourceCode java"><code class="sourceCode java"><span class="kw">public</span> Alarm <span class="fu">MakesLoudNoise</span>()
{
  <span class="kw">return</span> <span class="kw">new</span> <span class="fu">LoudAlarm</span>();
}</code></pre>
<p>and the composition code after applying this method looks like this:</p>
<pre class="sourceCode java"><code class="sourceCode java"><span class="kw">new</span> <span class="fu">SecureArea</span>(
  <span class="kw">new</span> <span class="fu">OfficeBuilding</span>(
    <span class="kw">new</span> <span class="fu">DayNightSwitchedAlarm</span>(
      <span class="fu">Calls</span>(<span class="st">&quot;222-333-444&quot;</span>), 
      <span class="fu">MakesLoudNoise</span>()
    )
  ),
  <span class="kw">new</span> <span class="fu">StorageBuilding</span>(
    <span class="kw">new</span> <span class="fu">HybridAlarm</span>(
      <span class="fu">Calls</span>(<span class="st">&quot;222-333-444&quot;</span>),
      <span class="fu">MakesLoudNoise</span>()
    )
  ),
  <span class="kw">new</span> <span class="fu">GuardsBuilding</span>(
    <span class="kw">new</span> <span class="fu">HybridAlarm</span>(
      <span class="fu">Calls</span>(<span class="st">&quot;919&quot;</span>), <span class="co">//police number</span>
      <span class="fu">MakesLoudNoise</span>()
    )
  )
);</code></pre>
<p>Note that we have removed some more <code>new</code>s in favor of something that’s more readable. This is exactly what I meant by “reducing syntax noise”.</p>
<p>Now let’s focus a bit on this part:</p>
<pre class="sourceCode java"><code class="sourceCode java">  <span class="kw">new</span> <span class="fu">GuardsBuilding</span>(
    <span class="kw">new</span> <span class="fu">HybridAlarm</span>(
      <span class="fu">Calls</span>(<span class="st">&quot;919&quot;</span>), <span class="co">//police number</span>
      <span class="fu">MakesLoudNoise</span>()
    )
  )</code></pre>
<p>and try to apply the same trick of introducing factory method to <code>HybridAlarm</code> creation. You know, we are always told that class names should be nouns and that’s why <code>HybridAlarm</code> is named like this. But it does not act well as a description of what the system does. Its real functionality is to trigger both alarms when it is triggered itself. Thus, we need to come up with a better name. Should we name the method <code>TriggersBothAlarms()</code>? Naah, it’s too much noise - we already know it’s alarms that we are triggering, so we can leave the “alarms” part out. What about “triggers”? It says what the hybrid alarm does, which might seem good, but when we look at the composition, <code>Calls()</code> and <code>MakesLoudNoise()</code> already say what is being done. The <code>HybridAlarm</code> only says that both of those things happen simultaneously. We could leave <code>Trigger</code> if we changed the names of the other methods in the composition to look like this:</p>
<pre class="sourceCode java"><code class="sourceCode java">  <span class="kw">new</span> <span class="fu">GuardsBuilding</span>(
    <span class="fu">TriggersBoth</span>(
      <span class="fu">Calling</span>(<span class="st">&quot;919&quot;</span>), <span class="co">//police number</span>
      <span class="fu">LoudNoise</span>()
    )
  )</code></pre>
<p>But that would make the names <code>Calling()</code> and <code>LoudNoise()</code> out of place everywhere it is not being nested as <code>TriggersBoth()</code> arguments. For example, if we wanted to make another building that would only use a loud alarm, the composition would look like this:</p>
<pre class="sourceCode java"><code class="sourceCode java"><span class="kw">new</span> <span class="fu">OtherBuilding</span>(<span class="fu">LoudNoise</span>());</code></pre>
<p>or if we wanted to use silent one:</p>
<pre class="sourceCode java"><code class="sourceCode java"><span class="kw">new</span> <span class="fu">OtherBuilding</span>(<span class="fu">Calling</span>(<span class="st">&quot;919&quot;</span>));</code></pre>
<p>Instead, let’s try to name the method wrapping construction of <code>HybridAlarm</code> just <code>Both()</code> - it is simple and communicates well the role hybrid alarms play - after all, they are just a kind of combining operators, not real alarms. This way, our composition code is now:</p>
<pre class="sourceCode java"><code class="sourceCode java"><span class="kw">new</span> <span class="fu">GuardsBuilding</span>(
  <span class="fu">Both</span>(
    <span class="fu">Calls</span>(<span class="st">&quot;919&quot;</span>), <span class="co">//police number</span>
    <span class="fu">MakesLoudNoise</span>()
  )
)</code></pre>
<p>and, by the way, the <code>Both()</code> method is defined as:</p>
<pre class="sourceCode java"><code class="sourceCode java"><span class="kw">public</span> Alarm <span class="fu">Both</span>(Alarm alarm1, Alarm alarm2)
{
  <span class="kw">return</span> <span class="kw">new</span> <span class="fu">HybridAlarm</span>(alarm1, alarm2);
}</code></pre>
<p>Remember that <code>HybridAlarm</code> was also used in the <code>StorageBuilding</code> instance composition:</p>
<pre class="sourceCode java"><code class="sourceCode java"><span class="kw">new</span> <span class="fu">StorageBuilding</span>(
  <span class="kw">new</span> <span class="fu">HybridAlarm</span>(
    <span class="fu">Calls</span>(<span class="st">&quot;222-333-444&quot;</span>),
    <span class="fu">MakesLoudNoise</span>()
  )
),</code></pre>
<p>which now becomes:</p>
<pre class="sourceCode java"><code class="sourceCode java"><span class="kw">new</span> <span class="fu">StorageBuilding</span>(
  <span class="fu">Both</span>(
    <span class="fu">Calls</span>(<span class="st">&quot;222-333-444&quot;</span>),
    <span class="fu">MakesLoudNoise</span>()
  )
),</code></pre>
<p>Now the most difficult part - finding a way to make the following piece of code readable:</p>
<pre class="sourceCode java"><code class="sourceCode java"><span class="kw">new</span> <span class="fu">OfficeBuilding</span>(
  <span class="kw">new</span> <span class="fu">DayNightSwitchedAlarm</span>(
    <span class="fu">Calls</span>(<span class="st">&quot;222-333-444&quot;</span>), 
    <span class="fu">MakesLoudNoise</span>()
  )
),</code></pre>
<p>The difficulty here is that <code>DayNightSwitchedAlarm</code> accepts two alarms that are used alternatively. We need to invent a term that:</p>
<ol style="list-style-type: decimal">
<li>Says it’s an alternative.</li>
<li>Says what kind of alternative it is (i.e. that one happens at day, and the other during the night).</li>
<li>Says which alarm is attached to which condition (silent alarm is used during the day and loud alarm is used at night).</li>
</ol>
<p>If we introduce a single name, e.g. <code>FirstDuringDayAndSecondAtNight()</code>, it will feel awkward and we will loose the flow. Just look:</p>
<pre class="sourceCode java"><code class="sourceCode java"><span class="kw">new</span> <span class="fu">OfficeBuilding</span>(
  <span class="fu">FirstDuringDayAndSecondAtNight</span>(
    <span class="fu">Calls</span>(<span class="st">&quot;222-333-444&quot;</span>), 
    <span class="fu">MakesLoudNoise</span>()
  )
),</code></pre>
<p>It just doesn’t feel well… We need to find another approach to this situation. There are two approaches we may consider:</p>
<h3 id="approach-1-use-named-parameters">Approach 1: use named parameters</h3>
<p>Named parameters are a feature of languages like Python or C#. In short, when we have a method like this:</p>
<pre class="sourceCode java"><code class="sourceCode java"><span class="kw">public</span> <span class="dt">void</span> <span class="fu">DoSomething</span>(<span class="dt">int</span> first, <span class="dt">int</span> second)
{
  <span class="co">//...</span>
}</code></pre>
<p>we can call it with the names of its arguments stated explicitly, like this:</p>
<pre class="sourceCode java"><code class="sourceCode java"><span class="fu">DoSomething</span>(first: <span class="dv">12</span>, second: <span class="dv">33</span>);</code></pre>
<p>We can use this technique to refactor the creation of <code>DayNightSwitchedAlarm</code> into the following method:</p>
<pre class="sourceCode java"><code class="sourceCode java"><span class="kw">public</span> Alarm <span class="fu">DependingOnTimeOfDay</span>(
    Alarm duringDay, Alarm atNight)
{
  <span class="kw">return</span> <span class="kw">new</span> <span class="fu">DayNightSwitchedAlarm</span>(duringDay, atNight);
} </code></pre>
<p>This lets us write the composition code like this:</p>
<pre class="sourceCode java"><code class="sourceCode java"><span class="kw">new</span> <span class="fu">OfficeBuilding</span>(
  <span class="fu">DependingOnTimeOfDay</span>(
    duringDay: <span class="fu">Calls</span>(<span class="st">&quot;222-333-444&quot;</span>), 
    atNight: <span class="fu">MakesLoudNoise</span>()
  )
),</code></pre>
<p>which is quite readable. Using named parameters has this small added benefit that it lets us pass the arguments in different order they were declared, thanks to their names stated explicitly. This makes both following invocations valid:</p>
<pre class="sourceCode java"><code class="sourceCode java"><span class="co">//this is valid:</span>
<span class="fu">DependingOnTimeOfDay</span>(
  duringDay: <span class="fu">Calls</span>(<span class="st">&quot;222-333-444&quot;</span>), 
  atNight: <span class="fu">MakesLoudNoise</span>()
)

<span class="co">//arguments in different order,</span>
<span class="co">//but this is valid as well:</span>
<span class="fu">DependingOnTimeOfDay</span>(
  atNight: <span class="fu">MakesLoudNoise</span>(),
  duringDay: <span class="fu">Calls</span>(<span class="st">&quot;222-333-444&quot;</span>)  
)</code></pre>
<p>Now, on to the second approach.</p>
<h3 id="approach-2-use-method-chaining">Approach 2: use method chaining</h3>
<p>This approach is better translatable to different languages and can be used e.g. in Java and C++. This time, before I show you the implementation, let’s look at the final result we want to achieve:</p>
<pre class="sourceCode java"><code class="sourceCode java"><span class="kw">new</span> <span class="fu">OfficeBuilding</span>(
  DependingOnTimeOfDay
    .<span class="fu">DuringDay</span>(<span class="fu">Calls</span>(<span class="st">&quot;222-333-444&quot;</span>))
    .<span class="fu">AtNight</span>(<span class="fu">MakesLoudNoise</span>())
  )
),</code></pre>
<p>So as you see, this is very similar in reading, the main difference being that it’s more work. It might not be obvious from the start how this kind of parameter passing works:</p>
<pre class="sourceCode java"><code class="sourceCode java">DependingOnTimeOfDay
  .<span class="fu">DuringDay</span>(...)
  .<span class="fu">AtNight</span>(...)</code></pre>
<p>so, let’s decipher it. First, <code>DependingOnTimeOfDay</code>. This is just a class:</p>
<pre class="sourceCode java"><code class="sourceCode java"><span class="kw">public</span> <span class="kw">class</span> DependingOnTimeOfDay
{
}</code></pre>
<p>which has a static method called <code>DuringDay()</code>:</p>
<pre class="sourceCode java"><code class="sourceCode java"><span class="co">//note: this method is static</span>
<span class="kw">public</span> <span class="dt">static</span> 
DependingOnTimeOfDay <span class="fu">DuringDay</span>(Alarm alarm)
{
  <span class="kw">return</span> <span class="kw">new</span> <span class="fu">DependingOnTimeOfDay</span>(alarm);
}

<span class="co">//The constructor is private:</span>
<span class="kw">private</span> <span class="fu">DependingOnTimeOfDay</span>(Alarm dayAlarm)
{
  _dayAlarm = dayAlarm;
}</code></pre>
<p>Now, this method seems strange, doesn’t it? It is a static method that returns an instance of its enclosing class (not an actual alarm!). Also, the private constructor stores the passed alarm inside for later… why?</p>
<p>The mystery resolves itself when we look at another method defined in the <code>DependingOnTimeOfDay</code> class:</p>
<pre class="sourceCode java"><code class="sourceCode java"><span class="co">//note: this method is NOT static</span>
<span class="kw">public</span> Alarm <span class="fu">AtNight</span>(Alarm nightAlarm)
{
  <span class="kw">return</span> <span class="kw">new</span> <span class="fu">DayNightSwitchedAlarm</span>(_dayAlarm, nightAlarm);
}</code></pre>
<p>This method is not static and it returns the alarm that we were trying to create. To do so, it uses the first alarm passed through the constructor and the second one passed as its parameter. So if we were to take this construct:</p>
<pre class="sourceCode java"><code class="sourceCode java">DependingOnTimeOfDay <span class="co">//class</span>
  .<span class="fu">DuringDay</span>(dayAlarm) <span class="co">//static method</span>
  .<span class="fu">AtNight</span>(nightAlarm) <span class="co">//non-static method</span></code></pre>
<p>and assign a result of each operation to a separate variable, it would look like this:</p>
<pre class="sourceCode java"><code class="sourceCode java">DependingOnTimeOfDay firstPart = DependingOnTimeOfDay.<span class="fu">DuringDay</span>(dayAlarm);
Alarm alarm = firstPart.<span class="fu">AtNight</span>(nightAlarm);</code></pre>
<p>Now, we can just chaing these calls and get the result we wanted to:</p>
<pre class="sourceCode java"><code class="sourceCode java"><span class="kw">new</span> <span class="fu">OfficeBuilding</span>(
  DependingOnTimeOfDay
    .<span class="fu">DuringDay</span>(<span class="fu">Calls</span>(<span class="st">&quot;222-333-444&quot;</span>))
    .<span class="fu">AtNight</span>(<span class="fu">MakesLoudNoise</span>())
  )
),</code></pre>
<p>The advantage of this solution is that it does not require your programming language of choice to support named parameters. The downside is that the order of the calls is strictly defined. The <code>DuringDay</code> returns an object on which <code>AtNight</code> is invoked, so it must come first.</p>
<h3 id="discussion-continued">Discussion continued</h3>
<p>For now, I will assume we have chosen approach 1 because it is simpler.</p>
<p>Our composition code looks like this so far:</p>
<pre class="sourceCode java"><code class="sourceCode java"><span class="kw">new</span> <span class="fu">SecureArea</span>(
  <span class="kw">new</span> <span class="fu">OfficeBuilding</span>(
    <span class="fu">DependingOnTimeOfDay</span>(
      duringDay: <span class="fu">Calls</span>(<span class="st">&quot;222-333-444&quot;</span>), 
      atNight: <span class="fu">MakesLoudNoise</span>()
    )
  ),
  <span class="kw">new</span> <span class="fu">StorageBuilding</span>(
    <span class="fu">Both</span>(
      <span class="fu">Calls</span>(<span class="st">&quot;222-333-444&quot;</span>),
      <span class="fu">MakesLoudNoise</span>()
    )
  ),
  <span class="kw">new</span> <span class="fu">GuardsBuilding</span>(
    <span class="fu">Both</span>(
      <span class="fu">Calls</span>(<span class="st">&quot;919&quot;</span>), <span class="co">//police number</span>
      <span class="fu">MakesLoudNoise</span>()
    )
  )
);</code></pre>
<p>There are few more finishing touches we need to make. First of all, let’s try and extract these dial numbers like <code>222-333-444</code> into constants. When we do so, then, for example, this code:</p>
<pre class="sourceCode java"><code class="sourceCode java"><span class="fu">Both</span>(
  <span class="fu">Calls</span>(<span class="st">&quot;919&quot;</span>), <span class="co">//police number</span>
  <span class="fu">MakesLoudNoise</span>()
)</code></pre>
<p>becomes</p>
<pre class="sourceCode java"><code class="sourceCode java"><span class="fu">Both</span>(
  <span class="fu">Calls</span>(Police),
  <span class="fu">MakesLoudNoise</span>()
)</code></pre>
<p>And the last thing is to hide creation of the following classes: <code>SecureArea</code>, <code>OfficeBuilding</code>, <code>StorageBuilding</code>, <code>GuardsBuilding</code> and we have this:</p>
<pre class="sourceCode java"><code class="sourceCode java"><span class="fu">SecureAreaContaining</span>(
  <span class="fu">OfficeBuildingWithAlarmThat</span>(
    <span class="fu">DependingOnTimeOfDay</span>(
      duringDay: <span class="fu">Calls</span>(Guards), 
      atNight: <span class="fu">MakesLoudNoise</span>()
    )
  ),
  <span class="fu">StorageBuildingWithAlarmThat</span>(
    <span class="fu">Both</span>(
      <span class="fu">Calls</span>(Guards),
      <span class="fu">MakesLoudNoise</span>()
    )
  ),
  <span class="fu">GuardsBuildingWithAlarmThat</span>(
    <span class="fu">Both</span>(
      <span class="fu">Calls</span>(Police),
      <span class="fu">MakesLoudNoise</span>()
    )
  )
);</code></pre>
<p>And here it is - the real, declarative description of our application! The composition reads better than when we started, doesn’t it?</p>
<h2 id="composition-as-a-language">Composition as a language</h2>
<p>Written this way, object composition has another important property - it is extensible and can be extended using the same terms that are already used (of course we can add new ones as well). For example, using the methods we invented to make the composition more readable, we may write something like this:</p>
<pre class="sourceCode java"><code class="sourceCode java"><span class="fu">Both</span>(
  <span class="fu">Calls</span>(Police),
  <span class="fu">MakesLoudNoise</span>()
)</code></pre>
<p>but, using the same terms, we may as well write this:</p>
<pre class="sourceCode java"><code class="sourceCode java"><span class="fu">Both</span>(
  <span class="fu">Both</span>(
    <span class="fu">Calls</span>(Police),
    <span class="fu">Calls</span>(Security)),
  <span class="fu">Both</span>(
    <span class="fu">Calls</span>(Boss),
    <span class="fu">MakesLoudNoise</span>()))
)</code></pre>
<p>to obtain different behavior. Note that we have invented something that has these properties:</p>
<ol style="list-style-type: decimal">
<li>It defines some kind of <em>vocabulary</em> - in our case, the following “words” are form part of the vocabulary: <code>Both</code>, <code>Calls</code>, <code>MakesLoudNoise</code>, <code>DependingOnTimeOfDay</code>, <code>atNight</code>, <code>duringDay</code>, <code>SecureAreaContaining</code>, <code>GuardsBuildingWithAlarmThat</code>, <code>OfficeBuildingWithAlarmThat</code>.</li>
<li>It allows combining the words from the vocabulary. These combinations have meaning, which is based solely on the meaning of used words and the way they are combined. For example: <code>Both(Calls(Police), Calls(Guards))</code> has the meaning of “calls both police and guards when triggered” - thus, what this thing we invented really does is allowing us to combine words into <em>sentences</em>.</li>
<li>Although we are quite liberal in defining behaviors for alarms, there are some rules as what can be composed with what (for example, we cannot compose guards building with an office, but each of them can only be composed with alarms). Thus, we can say that the <em>sentences</em> we write have to obey certain rules that look a lot like <em>a grammar</em>.</li>
<li>The vocabulary is <em>constrained to the domain</em> of alarms. On the other hand, it <em>is more powerful and expressive</em> as a description of this domain than a combination of <code>if</code> statements, <code>for</code> loops, variable assignments and other elements of a general-purpose language. It is tuned towards describing rules of a domain on a <em>higher level of abstraction</em>.</li>
<li>The sentences written define a behavior of the application - so by writing sentences like this, we still write software! Thus, what we do by combining <em>words</em> into <em>sentences</em> constrained by a <em>grammar</em> is still <em>programming</em>!</li>
</ol>
<p>All of these points suggest that we have created a <em>Domain-Specific Language</em><a href="#fn26" class="footnoteRef" id="fnref26"><sup>26</sup></a>, which, by the way, is a <em>higher-level language</em>, meaning we describe our software on a higher level of abstraction.</p>
<h2 id="the-significance-of-higher-level-language">The significance of higher-level language</h2>
<p>So.. why do we need a higher-level language to describe the behavior of our application? After all, expressions, statements, loops and conditions (and objects and polymorphism) are our daily bread and butter. Why invent something that moves us away from this kind of programming into something “domain-specific”?</p>
<p>My main answer is: to deal with with complexity more effectively.</p>
<p>What’t complexity? For our purpose we can approximate it as a number of different decisions our application needs to make. As we add new features and fix errors or implement missed requirements, the complexity of our software grows. What can we do when it grows so larger than we are able to manage? We have the following choices:</p>
<ol style="list-style-type: decimal">
<li>Remove some decisions - i.e. remove features from our application. This is very cool when we actually <em>can</em> do this, but there are times when this might be unacceptable from the business perspective.</li>
<li>Optimize away redundant decisions - this is about making sure that each decision is made once in the code base - I already showed you some examples how polymorphism can help with that.<br /></li>
<li>Use 3rd party component or a library to handle some of the decisions for us - while this is quite easy for “infrastructure” code and utilities, it is very, very hard (impossible?) to find a library that will describe our “domain rules” for us. So if these rules are where the real complexity lies (and often they are), we are still left alone with our problem.</li>
<li>Hide the decisions by programming on higher level of abstraction – this is what we did in this chapter so far. The advantage is that it allows us to reduce complexity of our domain, by creating a bigger building blocks from which a behavior description can be created.</li>
</ol>
<p>So, as you see, only the last of the above points really helps in reducing domain complexity. This is where the idea of domain-specific languages falls in. If we carefully craft our object composition into a set of domain-specific languages (one is often too little in all but simplest cases), one day we may find that we are adding new features by writing new sentences in these languages in a declarative way rather than adding new imperative code. Thus, if we have a good language and a firm understanding of its vocabulary and grammar, we can program on a higher level of abstraction which is more expressive and less complex.</p>
<p>This is very hard to achieve – it requires, among others:</p>
<ol style="list-style-type: decimal">
<li>A huge discipline across a develoment team.</li>
<li>A sense of direction of how to structure the composition and where to lead the language designs as they evolve.</li>
<li>Merciless refactoring.</li>
<li>Some minimal knowledge of language design and experience in doing so.</li>
<li>Knowledge of some techniques (like the ones we used in our example) that make constructs written in general-purpose language look like another language.</li>
</ol>
<p>Of course, not all parts of the composition make a good material to being structured like a language. Despite these difficulties, I think it’s well worth the effort. Programming on higher level of abstraction with declarative code rather than imperative is where I place my hope for writing maintainable and understandable systems.</p>
<h2 id="some-advice">Some advice</h2>
<p>So, eager to try this approach? Let me give you a few pieces of advice first:</p>
<h3 id="evolve-the-language-as-you-evolve-code">Evolve the language as you evolve code</h3>
<p>At the beginning of this chapter, we achieved our higher-level language by refactoring already existing object composition. This does not at all mean that in real projects we need to wait for a lot of composition code to appear and then try to wrap all of it. It is true that I did just that in the alarm example, but this was just an example and its purpose was mainly didactical.</p>
<p>In reality, the language is better off evolving along the composition it describes. One reason for this is because there is a lot of feedback about the composability of the design gained by actually trying to put a language on top of it. As I said in the chapter on single responsibility, if objects are not comfortably composable, something is probably wrong with the distribution of responsibilities between them (for comparison of wrongly placed responsibilities, imagine a general-purpose language that would not have a separate <code>if</code> and <code>for</code> constructs but only a combination of them called <code>forif</code> :-)). Don’t miss out on this feedback!</p>
<p>The second reason is because even if you can safely refactor all the code because you have an executable Specification protecting you from making mistakes, it’s just too many decisions to handle at once (plus it takes a lot of time and your colleagues keep adding new code, don’t they?). Good language grows and matures organically rather than being created in a big bang effort. Some decisions take time and a lot of thought to be made.</p>
<h3 id="composition-is-not-a-single-dsl-but-a-series-of-mini-dsls">Composition is not a single DSL, but a series of mini DSLs</h3>
<p>I already briefly noted this. While it may be tempting to invent a single DSL to describe whole application, in practice it is hardly possible, because our applications have different subdomains that often use different sets of terms. Rather, it pays off to hunt for such subdomains and create smaller languages for them. The alarm example shown above would probably be just a small part of a real composition. Not all parts would lend themselves to shape this way, at least not instantly. What starts off as a single class might become a subdomain with its own vocabulary at some point. We need to pay attention. Hence, we still want to apply some of the DSL techniques even to those parts of the composition that are not easily turned into DSLs and hunt for an occasion when we are be able to do so.</p>
<p>As <a href="http://www.natpryce.com/articles/000783.html">Nat Pryce beautifully puts it</a>, it’s all about:</p>
<blockquote>
<p>(…) clearly expressing the dependencies between objects in the code that composes them, so that the system structure can easily be refactored, and aggressively refactoring that compositional code to remove duplication and express intent, and thereby raising the abstraction level at which we can program (…). The end goal is to need less and less code to write more and more functionality as the system grows.</p>
</blockquote>
<p>For example, a mini-DSL for setting up handling of an application configuration updates might look like this:</p>
<pre class="sourceCode java"><code class="sourceCode java"><span class="kw">return</span> <span class="fu">ConfigurationUpdates</span>(
  <span class="fu">Of</span>(log),
  <span class="fu">Of</span>(localSettings),
  <span class="fu">OfResource</span>(<span class="fu">Departments</span>()),
  <span class="fu">OfResource</span>(<span class="fu">Projects</span>()));</code></pre>
<p>Reading this code should not be difficult, especially when we know what each term in the composition means. This code returns an object handling configuration updates of four things: application log, local settings, and two resources (in this subdomain, resources mean things that can be added, deleted and modified). These two resources are: departments and projects (e.g. we can add a new project or delete an existing one).</p>
<p>Note that the constructs in this language make sense only in context of creating configuration update handlers. Thus, they should be restricted to this part of composition. Other parts that have nothing to do with configuration updates, should not need to know these constructs.</p>
<h3 id="do-not-use-an-extensive-amount-of-dsl-tricks">Do not use an extensive amount of DSL tricks</h3>
<p>In creating internal DSLs, one can use a lot of neat tricks, some of them being very “hacky”. But remember that the composition code is to be maintained by your team. Unless each and every member of your team is an expert on creating internal DSLs, do not show off with too sophisticated tricks. Keep to few of the proven ones that are simple to use and work, like the ones I have used in the alarm example.</p>
<p>Martin Fowler<a href="#fn27" class="footnoteRef" id="fnref27"><sup>27</sup></a> describes a lot of tricks for creating such DSLs and at the same time warns against using too many of them.</p>
<h3 id="factory-method-nesting-is-your-best-friend">Factory method nesting is your best friend</h3>
<p>One of the DSL techniques, the one I have used the most, is factory method nesting. Basically, it means wrapping a constructor invocation with a method that has a name more fitting a context it is used in (and which hides the obscurity of the <code>new</code> keyword). This technique is what makes this:</p>
<pre class="sourceCode java"><code class="sourceCode java"><span class="kw">new</span> <span class="fu">HybridAlarm</span>(
  <span class="kw">new</span> <span class="fu">SilentAlarm</span>(<span class="st">&quot;222-333-444&quot;</span>),
  <span class="kw">new</span> <span class="fu">LoudAlarm</span>()
)</code></pre>
<p>look like this:</p>
<pre class="sourceCode java"><code class="sourceCode java"><span class="fu">Both</span>(
  <span class="fu">Calls</span>(<span class="st">&quot;222-333-444&quot;</span>),
  <span class="fu">MakesLoudNoise</span>()
)</code></pre>
<p>As you probably remember, each method wraps a constructor, e.g. <code>Calls()</code> is defined as:</p>
<pre class="sourceCode java"><code class="sourceCode java"><span class="kw">public</span> Alarm <span class="fu">Calls</span>(string number)
{
  <span class="kw">return</span> <span class="kw">new</span> <span class="fu">SilentAlarm</span>(number);
}</code></pre>
<p>This technique is great for describing any kind of tree and graph-like structures as each method provides a natural scope for its arguments:</p>
<pre class="sourceCode java"><code class="sourceCode java"><span class="fu">Method1</span>( <span class="co">//beginning of scope</span>
  <span class="fu">NestedMethod1</span>(),
  <span class="fu">NestedMethod2</span>()
);       <span class="co">//end of scope</span></code></pre>
<p>Thus, it is a natural fit for object composition, which <em>is</em> a graph-like structure.</p>
<p>This approach looks great on paper but it’s not like everything just fits all the time. There are two issues with factory methods that need some kind of solution.</p>
<h4 id="where-to-put-these-methods">Where to put these methods?</h4>
<p>In the usual case, we want to be able to invoke these methods without any qualifier before them, i.e. we want to call <code>MakesLoudNoise()</code> instead of <code>alarmsFactory.MakesLoudNoise()</code> or <code>this.MakesLoudNoise()</code> or anything.</p>
<p>If so, where do we put such methods?</p>
<p>There are two options[^staticimports]: 1. Put the methods in the class that performs the composition 1. Put the methods in superclass</p>
<p>Apart from that, we can choose between: 1. Making the factory methods static 1. Making the factory methods non-static</p>
<p>First, let’s consider the first dillema of putting in composing class vs having a superclass. This choice is mainly determined by reuse. The methods that we use in one composition only and do not want to reuse are better off as private methods in the composing class. On the other hand, the methods that we want to reuse (e.g. in other applications or services belonging to the same system), are better put in a superclass which we can inherit from. Also, a combination of the two approaches is possible, where superclass contains a more general method, while composing class wraps it with another method that adjusts the creation to the current context.</p>
<p>The second choice between static and non-static is one of having access to instance fields - instance methods have this access, while static methods do not. Thus, if the following is an instance method of a class called <code>AlarmComposition</code>:</p>
<pre class="sourceCode java"><code class="sourceCode java"><span class="kw">public</span> <span class="kw">class</span> AlarmComposition
{
  <span class="co">//...</span>
  
  <span class="kw">public</span> Alarm <span class="fu">Calls</span>(string number)
  {
    <span class="kw">return</span> <span class="kw">new</span> <span class="fu">SilentAlarm</span>(number);
  }
  
  <span class="co">//...</span>
}</code></pre>
<p>and I need to pass an additional dependency to <code>SilentAlarm</code> that I do not want to show in the main composition code, I am free to change the <code>Calls</code> method to:</p>
<pre class="sourceCode java"><code class="sourceCode java"><span class="kw">public</span> Alarm <span class="fu">Calls</span>(string number)
{
  <span class="kw">return</span> <span class="kw">new</span> <span class="fu">SilentAlarm</span>(number, 
    <span class="kw">this</span>.<span class="fu">_irrelevantDependency</span>)
}</code></pre>
<p>and this new dependency may be passed to the composing object via constructor:</p>
<pre class="sourceCode java"><code class="sourceCode java"><span class="kw">public</span> <span class="fu">AlarmComposition</span>(
  IrrelevantDependency irrelevantDependency)
{
  _irrelevantDependency = irrelevantDependency;
} </code></pre>
<p>This way, I can hide it from the main composition code. This is freedom I do not have with static methods.</p>
<h4 id="use-implicit-collections-instead-of-explicit-ones">Use implicit collections instead of explicit ones</h4>
<p>Most object-oriented languages support passing variable arguments (e.g. in C# this is achieved with <code>params</code> keyword, while Java has <code>...</code> operator). This is valuable in composition, because we often want to be able to pass arbitrary number of objects. Again, coming back to this composition:</p>
<pre class="sourceCode java"><code class="sourceCode java"><span class="kw">return</span> <span class="fu">ConfigurationUpdates</span>(
  <span class="fu">Of</span>(log),
  <span class="fu">Of</span>(localSettings),
  <span class="fu">OfResource</span>(<span class="fu">Departments</span>()),
  <span class="fu">OfResource</span>(<span class="fu">Projects</span>()));</code></pre>
<p>the <code>ConfigurationUpdates()</code> method is using variable argument passing:</p>
<pre class="sourceCode java"><code class="sourceCode java"><span class="kw">public</span> ConfigurationUpdates <span class="fu">ConfigurationUpdates</span>(
  params ConfigurationUpdate[] updates)
{
  <span class="kw">return</span> <span class="kw">new</span> <span class="fu">MyAppConfigurationUpdates</span>(updates);
}</code></pre>
<p>Note that we could, of course, pass the array of <code>ConfigurationUpdate</code> instances as literal array, but that would greatly hinder readabiliyty and flow of this composition. See for yourself:</p>
<pre class="sourceCode java"><code class="sourceCode java"><span class="kw">return</span> <span class="fu">ConfigurationUpdates</span>(
  <span class="kw">new</span> [] {
    <span class="fu">Of</span>(log),
    <span class="fu">Of</span>(localSettings),
    <span class="fu">OfResource</span>(<span class="fu">Departments</span>()),
    <span class="fu">OfResource</span>(<span class="fu">Projects</span>())
  }
);</code></pre>
<p>Not so pretty, huh?</p>
<h4 id="a-single-method-can-create-more-than-one-object">A single method can create more than one object</h4>
<p>No one said each factory method must create one and only one object. For example, take a look again at this method creating configuration updates:</p>
<pre class="sourceCode java"><code class="sourceCode java"><span class="kw">public</span> ConfigurationUpdates <span class="fu">ConfigurationUpdates</span>(
  params ConfigurationUpdate[] updates)
{
  <span class="kw">return</span> <span class="kw">new</span> <span class="fu">MyAppConfigurationUpdates</span>(updates);
}</code></pre>
<p>Now, let’s assume we need to synchronize to the instance of <code>ConfigurationUpdates</code> class and we want to achieve this by wrapping the <code>MyAppConfigurationUpdates</code> instance with a synchronizing proxy. For this purpose, we can reuse the method we already have, just adding the additional object creation there:</p>
<pre class="sourceCode java"><code class="sourceCode java"><span class="kw">public</span> ConfigurationUpdates <span class="fu">ConfigurationUpdates</span>(
  params ConfigurationUpdate[] updates)
{
  <span class="co">//now two objects created instead of one:</span>
  <span class="kw">return</span> <span class="kw">new</span> <span class="fu">SynchronizedConfigurationUpdates</span>(
    <span class="kw">new</span> <span class="fu">MyAppConfigurationUpdates</span>(updates)
  );
}</code></pre>
<h2 id="summary-9">Summary</h2>
<p>While most of the earlier chapters talked a lot about viewing object composition as a web, this one took a different view - one of a language. These two views are remarkably similar in nature and complement each other in guiding design.</p>
<p>This area of treating composition as a language is something I am experimenting with lately and am not as fluent as with other aspects of this book. Expect this chapter to grow or to be clarified in the future. For now, if you feel you need more information, please take a look at the video by Steve Freeman and Nat Pryce called <a href="https://vimeo.com/105785565">“Building on SOLID foundations”</a>.</p>
<p>%% ### Hide irrelevant parts of composition - few levels of composition code is enough %% 1. Factory method &amp; method composition %% - not necessarily one method per each constructor %% - hide ambient context in fields (logger, configuration) e.g. method ConfiguredLength() %% 1. Literal Collections (variadic covering method) – creating collection using %% variadic parameter method or variadic constructors %% 1. Method chaining - expression builders build up context %% 1. variable as terminator ??? Explaining variables - for sharing %% 1. constants - can be useful like Police, but sometimes can be less useful - introducing constant not always leads to more readable code - but do we have another choice? If not, just not name it like pentium2.cores(numberOfCoresInPentium2) %% 1. Explaining method (i.e. returns its argument. Use with care)</p>
<p>[^staticimports] In some languages, there is a third way: Java lets us use static imports which are part of C# as well starting with version 6.0. C++ has always supported bare functions, so it’s not a topic there. .</p>
<h1 id="value-objects">Value Objects</h1>
<p>Hi, today I’m gonna tell a bit about value objects, why they’re so useful and what rules apply to creating and using them. This post is inspired by some work by Kent Beck, Steve Freeman and Nat Pryce.</p>
<h2 id="example-problem">Example problem</h2>
<p>Imagine you’re developing a web shop for your customer. There are different kinds of products sold and your customers have the ability to add new products.</p>
<p>Each product has at least two important attributes: name and price (actually there are others like quantity, but let’s leave them alone for now).</p>
<p>Let’s say that you’ve decided to use <em>a decimal to hold the price</em>, and <em>a string to hold the name</em>. Note that both are generic library types, not connected to any domain. Is it a good choice to use “library types” for domain abstractions? We shall soon find out…</p>
<h3 id="time-passes">Time passes…</h3>
<p>Actually, it turns out that these values must be shared across few subdomains of the system. For example:</p>
<ol style="list-style-type: decimal">
<li>The website needs to display them</li>
<li>They are used in calculations</li>
<li>They are taken into account when defining and checking promotion rules (e.g. “buy three, pay for two”)</li>
<li>They must be supplied when printing invoices</li>
</ol>
<p>etc.</p>
<p>The code grows larger and larger and, as the concepts of product name and price are among the main concepts of the application, they tend to land everywhere.</p>
<p>Now, imagine that one of the following changes must make its way into the system:</p>
<ol style="list-style-type: decimal">
<li>The product name must be compared as case insensitive, since the names of the products are always printed in uppercase on the invoice. Thus, creating two products that differ only in a letter case (eg. “laptop” and “LAPTOP”) would confuse the customers as both these products look the same on the invoice. Also, the only way one would create two products that differ by letter case only is by mistake and we want to avoid that.</li>
<li>The product name is not enough to differentiate a product. For example, a notebook manufacturers have the same models of notebooks in different configurations (e.g. different amount of RAM or different processor models inside). So each product will receive additional identifier that will have to be taken into account during comparisons.</li>
<li>In order to support customers from different countries, new currencies must be supported everywhere money are already used.</li>
</ol>
<p>These changes are a horror to make. Why? It’s because we’re coupled in multiple places to a particular implementation of product name (string) and a particular implementation of money (decimal). This wouldn’t be so bad, if not for the fact that we’re coupled to implementation we cannot change!</p>
<p>From now on, let’s put the money concept aside and consider only the product name, as both of these cases are similar, so it’s sufficient to consider just one of them.</p>
<h3 id="what-options-do-we-have">What options do we have?</h3>
<p>So, what choice do we have now? In order to support new requirements, we have to find all places where we use the product name and price and make the same change. Every time we need to do something like this, it means that <em>we’ve introduced redundancy</em>.</p>
<h4 id="option-one---just-modify-the-implementation-in-all-places">Option one - just modify the implementation in all places</h4>
<p>So let’s say we want to add comparison with letter case ignored. The worst idea to have would be to find all places where we do something like this:</p>
<pre class="sourceCode java"><code class="sourceCode java"><span class="kw">if</span>(productName == productName2))
{
..</code></pre>
<p>And change it to:</p>
<pre class="sourceCode java"><code class="sourceCode java"><span class="kw">if</span>(String.<span class="fu">Equals</span>(productName, productName2, 
   StringComparison.<span class="fu">OrdinalIgnoreCase</span>))
{
..</code></pre>
<p>This is bad for at least three reasons:</p>
<ol style="list-style-type: decimal">
<li>According to <a href="http://www.netobjectives.com/blogs/shalloway%E2%80%99s-law-and-shalloway%E2%80%99s-principle">Shalloway’s Law</a>, it will be very hard to find all these places and chances are you’ll miss at least one.</li>
<li>Everyone who adds new comparisons of product names to the code in the future, will have to remember to use <code>IgnoreCase</code> comparison (TODO). If you want to know my opinion, accidental violation of this convention is just a matter of time.</li>
<li>Even if this time you’ll be able to find and correct all the places, every time this aspect changes (e.g. we’ll have to support <code>InvariantIgnoreCase</code> option instead of OrdinalIgnoreCase for some reasons, or the case I mentioned earlier with comparison including an identifier), you’ll have to do it over.</li>
<li>Also, there are other changes that will be tied to the concept of product name (like generating a hash code or something) and you’ll need to introduce them too in all the places where the product name value is used.</li>
</ol>
<h4 id="option-two---use-a-helper-class">Option two - use a helper class</h4>
<p>We can address the third issue of the above list by moving the comparison operation into a helper class. Thus, the comparison would look like this:</p>
<pre class="sourceCode java"><code class="sourceCode java"><span class="kw">if</span>(ProductName.<span class="fu">Equals</span>(productName, productName2))
{
..</code></pre>
<p>Now, the details of the comparison are hidden inside the newly created class. Each time the comparison needs to change, we have to modify only this one class.</p>
<p>However, while it protects us from the change of comparison policy, it’s still not enough. The concept of product name is not encapsulated - it’s still a string and all its methods are publicly available. Hence, another developer who starts working on the code may not even notice that product names are compared differently than other strings and just use the comparison methods from string type. Other deficiencies of the previous approach apply as well (as I said, except from the issue number 3).</p>
<h4 id="option-three---encapsulate-the-domain-concept-and-create-a-value-object">Option three - encapsulate the domain concept and create a “Value Object”</h4>
<p>I think it’s more than clear now that product name is a not “just a string”, but a domain concept and as such, it deserves its own class. Given this, the comparison snippet is now:</p>
<pre class="sourceCode java"><code class="sourceCode java"><span class="co">//both are of class ProductName</span>
<span class="kw">if</span>(productName.<span class="fu">Equals</span>(productName2))
{
..</code></pre>
<p>How is it different from the previous approach with helper class? While previously the implementation of a product name (a string) was publicly visible and we only added external functionality that operated on this implementation (and anybody could add their own), this time the nature of the product name is completely hidden from the outside world. The only available way of working with product names is through the <code>ProductName</code>’s public interface (which exposes only those methods we want and no more). In other words, whereas before we were dealing with a general-purpose type we couldn’t change, now we have a domain-specific type that’s completely under our control.</p>
<h3 id="how-value-objects-help-dealing-with-change">How value objects help dealing with change</h3>
<p>Let’s see how this move makes it easier to introduce the changes I already mentioned (ignoring case, comparing by ID as well as by string name and getting uppercase version for printing on invoice).</p>
<h4 id="initial-implementation">Initial implementation</h4>
<p>The first implementation may look like this:</p>
<pre class="sourceCode java"><code class="sourceCode java"><span class="kw">public</span> <span class="kw">class</span> ProductName
{
  string _value;

  internal <span class="fu">ProductName</span>(string value)
  {
    _value = value;
  }

  <span class="kw">public</span> <span class="dt">static</span> ProductName <span class="fu">For</span>(string value)
  {
    <span class="kw">if</span>(string.<span class="fu">IsNullOrWhiteSpace</span>(value))
    {
      <span class="kw">throw</span> <span class="kw">new</span> <span class="fu">ArgumentException</span>(
        <span class="st">&quot;Product names must be human readable!&quot;</span>);
    }
    <span class="kw">else</span>
    {
      <span class="kw">return</span> <span class="kw">new</span> <span class="fu">ProductName</span>(value);
    }
  }
  
  <span class="co">//for on-screen printing</span>
  <span class="kw">public</span> string HumanReadablePart
  {
    get
    {
      <span class="kw">return</span> _value;
    }
  }

  <span class="co">//for invoices</span>
  <span class="kw">public</span> string <span class="fu">ToNameForInvoice</span>()
  {
    <span class="kw">return</span> _value.<span class="fu">ToUpper</span>();
  }

  <span class="kw">public</span> override bool <span class="fu">Equals</span>(Object obj)
  {
    <span class="kw">if</span> (obj == <span class="kw">null</span>)
    {
      <span class="kw">return</span> <span class="kw">false</span>;
    }

    var otherProductName = obj as ProductName;
    <span class="kw">if</span> ((Object)otherProductName == <span class="kw">null</span>)
    {
      <span class="kw">return</span> <span class="kw">false</span>;
    }

    <span class="kw">return</span> _value.<span class="fu">Equals</span>(otherProductName.<span class="fu">_value</span>);
  }

  <span class="kw">public</span> override <span class="dt">int</span> <span class="fu">GetHashCode</span>()
  {
    <span class="kw">return</span> _value.<span class="fu">GetHashCode</span>();
  }

  <span class="kw">public</span> <span class="dt">static</span> bool operator ==(ProductName a, ProductName b)
  {
    <span class="kw">if</span> (System.<span class="fu">Object</span>.<span class="fu">ReferenceEquals</span>(a, b))
    {
      <span class="kw">return</span> <span class="kw">true</span>;
    }

    <span class="kw">if</span> (((object)a == <span class="kw">null</span>) || ((object)b == <span class="kw">null</span>))
    {
      <span class="kw">return</span> <span class="kw">false</span>;
    }

    <span class="kw">return</span> a.<span class="fu">Equals</span>(b);
  }

  <span class="kw">public</span> <span class="dt">static</span> bool operator !=(ProductName a, ProductName b)
  {
    <span class="kw">return</span> !(a == b);
  }
}</code></pre>
<p>Note few things about this implementation:</p>
<ol style="list-style-type: decimal">
<li>The class has internal constructor and static factory method for general use. The factory method holds all the rules that must be satisfied in order to create a valid object and the constructor just sets the fields. This is a preferred way for value objects to be created. One reason for this is that the rules for creating valid objects might grow and we don’t want it to cause maintenance burden on our unit tests (we usually don’t mock value objects, so they will be all over our unit testing suite). Thus, the clients will always use the factory methods and unit tests will have the freedom to use the constructor if they wish so. Also, it’s good for readability (e.g. you can write <code>ProductName.For(&quot;Soap&quot;)</code>)</li>
<li>It looks like the effort on creating such a wrapper around just one value is huge, however, most of the methods are straightforward and others can be auto-generated by an IDE (like Equals(), GetHashCode() and equality operators).</li>
<li>Objects of <code>ProductName</code> class behave as if they were values, e.g. comparison is state-based instead of reference-based. Note that this is similar as in case of C# strings, which are a canonical example of value objects.</li>
<li><p>Product names are immutable. There is no operation that can overwrite its state once the object is created. This is on purpose and is a design constraint that we want to maintain. For example, we may want to sell sets of products in the future (“2 in 1” etc.) and treat it as a separate product with a name being a merger of the component names. In such case, we could write:</p>
<pre class="csharp"><code>var productSetName = productName1.MergeWith(productName2);</code></pre>
and this operation would create a new product name instead of modifying any of the component product names. Note that this is also the same as in case of strings, which, in C#, are immutable (every operation like <code>Trim()</code>, <code>Replace()</code> etc. creates a new object).</li>
<li><p>While being freshly created, the ProductName abstraction already contains bits that are domain-specific, namely the <code>ToNameForInvoice()</code> method. Whether it’s a good decision to put such method in here is heavily dependent on the context (there are other interesting options, but I’ll leave this topic for another time).</p></li>
</ol>
<p>Ok, now for the first change:</p>
<h4 id="first-change---case-insensitivity">First change - case-insensitivity</h4>
<p>This is actually very easy to perform - we just have to modify the <code>Equals()</code> and <code>GetHashCode()</code> operations like so:</p>
<pre class="sourceCode java"><code class="sourceCode java"><span class="kw">public</span> override bool <span class="fu">Equals</span>(Object obj)
{
  <span class="kw">if</span> (obj == <span class="kw">null</span>)
  {
    <span class="kw">return</span> <span class="kw">false</span>;
  }

  var otherProductName = obj as ProductName;
  <span class="kw">if</span> ((Object)otherProductName == <span class="kw">null</span>)
  {
    <span class="kw">return</span> <span class="kw">false</span>;
  }

  <span class="kw">return</span> string.<span class="fu">Equals</span>(<span class="kw">this</span>.<span class="fu">_value</span>, 
                       otherProductName.<span class="fu">_value</span>,
                       StringComparison.<span class="fu">OrdinalIgnoreCase</span>);
}

<span class="kw">public</span> override <span class="dt">int</span> <span class="fu">GetHashCode</span>()
{
  <span class="kw">return</span> _value.<span class="fu">ToUpper</span>(
    CultureInfo.<span class="fu">InvariantCulture</span>).<span class="fu">GetHashCode</span>();
}</code></pre>
<p>(a disclaimer - I’m not 100% sure that this implementation deals with all of the weird locale-specific issues, so don’t treat it as a reference implementation, but rather as a simple example)</p>
<p>Thanks to this, no change outside the ProductName class is necessary. Two methods need to be modified, but in just one place, which means that the encapsulation we’ve introduced works out pretty well.</p>
<h4 id="second-change---additional-identifier">Second change - additional identifier</h4>
<p>In order to do this, we’ll have to modify the creation of <code>ProductName</code> classes:</p>
<pre class="sourceCode java"><code class="sourceCode java">internal <span class="fu">ProductName</span>(string value, string id)
{
  _value = value;
  _id = id;
}

<span class="kw">public</span> <span class="dt">static</span> ProductName <span class="fu">For</span>(string value, string id)
{
  <span class="kw">if</span>(string.<span class="fu">IsNullOrWhiteSpace</span>(value))
  {
    <span class="kw">throw</span> <span class="kw">new</span> <span class="fu">ArgumentException</span>(
          <span class="st">&quot;Product names must be human readable!&quot;</span>);
  }
  <span class="kw">else</span> <span class="kw">if</span>(string.<span class="fu">IsNullOrWhiteSpace</span>(id))
  {
    <span class="kw">throw</span> <span class="kw">new</span> <span class="fu">ArgumentException</span>(
          <span class="st">&quot;Identifiers must be human readable!&quot;</span>);
  }
  <span class="kw">else</span>
  {
    <span class="kw">return</span> <span class="kw">new</span> <span class="fu">ProductName</span>(value, id);
  }
}</code></pre>
<p>Note that this modification requires changes all over the code base (because additional argument is needed to create an object), however, this is not the kind of change that we’re afraid of. That’s because the compiler will create a nice little TODO list (i.e. compile errors) for us and won’t let us go further without addressing it first, so there’s no chance the Shalloway’s Law might come to effect. Thus, we’re pretty much safe. By the way, if the requirements change in the future so that we will have to support product names without an ID, this is the only place we’ll need to change.</p>
<p>In addition, <code>Equals()</code> and <code>GetHashCode()</code> will have to be changed again:</p>
<pre class="sourceCode java"><code class="sourceCode java"><span class="kw">public</span> override bool <span class="fu">Equals</span>(Object obj)
{
  <span class="kw">if</span> (obj == <span class="kw">null</span>)
  {
    <span class="kw">return</span> <span class="kw">false</span>;
  }

  var otherProductName = obj as ProductName;
  <span class="kw">if</span> ((Object)otherProductName == <span class="kw">null</span>)
  {
    <span class="kw">return</span> <span class="kw">false</span>;
  }

  var valuesEqual = string.<span class="fu">Equals</span>(<span class="kw">this</span>.<span class="fu">_value</span>, 
                       otherProductName.<span class="fu">_value</span>,
                       StringComparison.<span class="fu">OrdinalIgnoreCase</span>);
  var identifiersEqual = <span class="kw">this</span>.<span class="fu">_id</span>.<span class="fu">Equals</span>(otherProductName.<span class="fu">_id</span>);

  <span class="kw">return</span> valuesEqual &amp;&amp; identifiersEqual;
}

<span class="kw">public</span> override <span class="dt">int</span> <span class="fu">GetHashCode</span>()
{
  <span class="kw">return</span> 
    _value.<span class="fu">ToUpper</span>(CultureInfo.<span class="fu">InvariantCulture</span>).<span class="fu">GetHashCode</span>()
      ^ _id.<span class="fu">GetHashCode</span>();;
}</code></pre>
<p>This modification won’t require any changes to the code outside <code>ProductName</code> class.</p>
<p>The last change is adding a new member for the ID to allow printing on invoices or on screen:</p>
<pre class="sourceCode java"><code class="sourceCode java"><span class="kw">public</span> string Identifier
{
  get
  {
    <span class="kw">return</span> _id;
  }
}</code></pre>
<p>This will probably require changes to the rest of the code base but the change will be for different reason (i.e. that we want to display product identifiers on web page and print them on the invoice), which is OK, since they’re connected to responsibilities beyond those of product name.</p>
<h3 id="summary-10">Summary</h3>
<p>By examining the above example, we can see the following principle emerging:</p>
<blockquote>
<p>When you give a value a name that belongs to the problem domain, it means that its type should be a separate domain-specific class which is under your control instead of a general-purpose library class that’s out of your control.</p>
</blockquote>
<p>And it’s a nice one to remember, especially because we often tend to model such values as a library types and wake up when it’s already too late to make the transition to value object effectively. I’m an example of this and that’s why I re-learned this principle by hard many times.</p>
<p>And that’s it for today. I’ll be happy to hear your thoughts. Until then, see ya!</p>
<p>TODO talk about static const value objects. const can be used only for types that have literals. Thus static readonly is used.</p>
<h1 id="mock-objects">Mock Objects</h1>
<div class="footnotes">
<hr />
<ol>
<li id="fn1"><p>besides, this book is open source, so if you don’t like it, you are free to create a fork and change the terminology! Statement-first programming ===========================<a href="#fnref1">↩</a></p></li>
<li id="fn2"><p>I am simplifying the discussion on purpose, leaving out e.g. functional languages and assuming that “pre-object oriented” means procedural or structural. While this is not true in general, this is how the reality looked like for many of us. If you are good at functional programming, you already understand the benefits of composability.<a href="#fnref2">↩</a></p></li>
<li id="fn3"><p>More on context-independence and what these “special places” are, in the next chapters.<a href="#fnref3">↩</a></p></li>
<li id="fn4"><p>I got this saying from Amir Kolsky and Scott Bain<a href="#fnref4">↩</a></p></li>
<li id="fn5"><p>If you never used collections before and you are not a copy-editor, then you are probably reading the wrong book :-)<a href="#fnref5">↩</a></p></li>
<li id="fn6"><p>Kent Beck, Implementation Patterns<a href="#fnref6">↩</a></p></li>
<li id="fn7"><p>Actually, this pattern has a name and the name is… Null Object (surprise!). You can read more on this pattern at http://www.cs.oberlin.edu/~jwalker/nullObjPattern/ and http://www.cs.oberlin.edu/~jwalker/refs/woolf.ps (a little older document)<a href="#fnref7">↩</a></p></li>
<li id="fn8"><p>For details, check Dependency Injection in .NET by Mark Seemann.<a href="#fnref8">↩</a></p></li>
<li id="fn9"><p>A. Shalloway et al., Essential Skills For The Agile Developer.<a href="#fnref9">↩</a></p></li>
<li id="fn10"><p>although it does need to change when the rule “first validate, then apply to sessions” changes<a href="#fnref10">↩</a></p></li>
<li id="fn11"><p>Note that this is an application of Gang of Four guideline: “encapsulate what varies”.<a href="#fnref11">↩</a></p></li>
<li id="fn12"><p>There are simple ways, yet none is as flexible as using factories.<a href="#fnref12">↩</a></p></li>
<li id="fn13"><p>A. Shalloway et al., Essential Skills For The Agile Developer.<a href="#fnref13">↩</a></p></li>
<li id="fn14"><p>http://www.objectmentor.com/resources/articles/isp.pdf<a href="#fnref14">↩</a></p></li>
<li id="fn15"><p>Scott Bain, Emergent Design<a href="#fnref15">↩</a></p></li>
<li id="fn16"><p>This topic is outside the scope of the book, but you can take a look at: M. Fowler, Domain-Specific Languages, Addison-Wesley 2010<a href="#fnref16">↩</a></p></li>
<li id="fn17"><p>This is sometimes called Feature Envy. It means that a class is more interested in other class’ data than in its own.<a href="#fnref17">↩</a></p></li>
<li id="fn18"><p>We can even further refactor this into a state machine using a Gang of Four <em>State</em> pattern. There would be two states in such a state machine: started and expired.<a href="#fnref18">↩</a></p></li>
<li id="fn19"><p>This principle can be applied to methods as well, but we are not going to cover this part, because it is not directly tied to the notion of composability and this is not a design book ;-).<a href="#fnref19">↩</a></p></li>
<li id="fn20"><p>http://butunclebob.com/ArticleS.UncleBob.PrinciplesOfOod.<a href="#fnref20">↩</a></p></li>
<li id="fn21"><p>https://stackoverflow.fogbugz.com/default.asp?W29030<a href="#fnref21">↩</a></p></li>
<li id="fn22"><p>Provided we are not using a measure such as story points.<a href="#fnref22">↩</a></p></li>
<li id="fn23"><p>Note that I am talking about responsibilities the way SRP talks about them, not the way they are understood by e.g. Responsibility Driven Design. Thus, I am talking about responsibilities of a class, not responsibilities of its API.<a href="#fnref23">↩</a></p></li>
<li id="fn24"><p>SMTP stands for Simple Mail Transfer Protocol and is a standard protocol for sending and receiving e-mail. You can read more on <a href="http://en.wikipedia.org/wiki/Simple_Mail_Transfer_Protocol">Wikipedia</a>.<a href="#fnref24">↩</a></p></li>
<li id="fn25"><p>M. Fowler, Domain-Specific Languages, Addison-Wesley 2010.<a href="#fnref25">↩</a></p></li>
<li id="fn26"><p>M. Fowler, Domain-Specific Languages, Addison-Wesley 2010.<a href="#fnref26">↩</a></p></li>
<li id="fn27"><p>M. Fowler, Domain-Specific Languages, Addison-Wesley 2010.<a href="#fnref27">↩</a></p></li>
</ol>
</div>
</body>
</html>
